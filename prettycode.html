<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Areabase | Code Listings | Filip Wieland (3026 @ 10743)</title>

    <!-- Stylesheet (compiled from Sass) -->
    <link href="./stylesheets/screen.css" rel="stylesheet" type="text/css" media="screen, projection" />
    <link href="./stylesheets/print.css" rel="stylesheet" type="text/css" media="print"/>
	
	<link href="./stylesheets/pygments.css" rel="stylesheet" type="text/css" media="screen, projection, print" />

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
  <a href="https://github.com/FLamparski/areabase" class="visible-lg visible-md hidden-print"><img style="position: absolute; top: 0; right: 0; border: 0; z-index: 2000;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>
    <div class="container">
        <div class="row">
			<div class="jumbotron jumbotron-section">
				<h1>Areabase Code</h1>
				<p>All of the code, pretty printed.</p>
			</div>
		</div>
		
		<div class="row">
		<div class="col-xs-12">
<!-- BEGIN CODE BLOCK -->
<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">Postcode <small>com.uk_postcodes.api</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">uk_postcodes</span><span class="o">.</span><span class="na">api</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.location.Location</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.google.gson.JsonElement</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.gson.JsonParser</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.commons.io.IOUtils</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.net.HttpURLConnection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.URL</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Locale</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.Pattern</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.RegEx</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Contains static functions for working with postcodes.</span>
<span class="cm"> * @author filip</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Postcode</span> <span class="o">{</span>
    <span class="cm">/**</span>
<span class="cm">     * I found this pattern in the archives of the Cabinet Office, and it is verified</span>
<span class="cm">     * as working here: &lt;a href=&quot;http://stackoverflow.com/a/164994&quot;&gt;http://stackoverflow.com/a/164994&lt;/a&gt;</span>
<span class="cm">     */</span>
    <span class="nd">@RegEx</span> <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">POSTCODE_REGEX</span> <span class="o">=</span> <span class="s">&quot;(GIR 0AA)|((([A-Z-[QVX]][0-9][0-9]?)|(([A-Z-[QVX]][A-Z-[IJZ]][0-9][0-9]?)|(([A-Z-[QVX]][0-9][A-HJKSTUW])|([A-Z-[QVX]][A-Z-[IJZ]][0-9][ABEHMNPRVWXY])))) [0-9][A-Z-[CIKMOV]]{2})&quot;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Pattern</span> <span class="n">postcodePattern</span> <span class="o">=</span> <span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="n">POSTCODE_REGEX</span><span class="o">);</span>

    <span class="cm">/**</span>
<span class="cm">     * Format: lat, lng</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">CALL</span> <span class="o">=</span> <span class="s">&quot;http://uk-postcodes.com/latlng/%f,%f.json&quot;</span><span class="o">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Get the postcode closest to the location.</span>
<span class="cm">     * @param location The device&#39;s location</span>
<span class="cm">     * @return the closest postcode</span>
<span class="cm">     * @throws Exception</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">forLocation</span><span class="o">(</span><span class="n">Location</span> <span class="n">location</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">address</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">CALL</span><span class="o">,</span> <span class="n">location</span><span class="o">.</span><span class="na">getLatitude</span><span class="o">(),</span> <span class="n">location</span><span class="o">.</span><span class="na">getLongitude</span><span class="o">());</span>

        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;Postcode&quot;</span><span class="o">,</span> <span class="s">&quot;Calling: &quot;</span> <span class="o">+</span> <span class="n">address</span><span class="o">);</span>

        <span class="n">URL</span> <span class="n">callUrl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
        <span class="n">HttpURLConnection</span> <span class="n">callConnection</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpURLConnection</span><span class="o">)</span> <span class="n">callUrl</span>
                <span class="o">.</span><span class="na">openConnection</span><span class="o">();</span>
        <span class="c1">// The ten-second rule:</span>
        <span class="c1">// If there&#39;s no data in 10s (or TIMEOUT), assume the worst.</span>
        <span class="n">callConnection</span><span class="o">.</span><span class="na">setReadTimeout</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
        <span class="c1">// Set the request method to GET.</span>
        <span class="n">callConnection</span><span class="o">.</span><span class="na">setRequestMethod</span><span class="o">(</span><span class="s">&quot;GET&quot;</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">code</span> <span class="o">=</span> <span class="n">callConnection</span><span class="o">.</span><span class="na">getResponseCode</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">code</span> <span class="o">!=</span> <span class="n">HttpURLConnection</span><span class="o">.</span><span class="na">HTTP_OK</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="o">(</span><span class="s">&quot;A non-200 code was returned: &quot;</span> <span class="o">+</span> <span class="n">code</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">String</span> <span class="n">responseStr</span><span class="o">;</span>
        <span class="n">responseStr</span> <span class="o">=</span> <span class="n">IOUtils</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">callConnection</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
        <span class="n">callConnection</span><span class="o">.</span><span class="na">disconnect</span><span class="o">();</span>

        <span class="n">JsonParser</span> <span class="n">jp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JsonParser</span><span class="o">();</span>
        <span class="n">JsonElement</span> <span class="n">response</span> <span class="o">=</span> <span class="n">jp</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">responseStr</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="na">getAsJsonObject</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;postcode&quot;</span><span class="o">).</span><span class="na">getAsString</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Checks the candidate postcode against the Royal Mail approved regex</span>
<span class="cm">     * @param postcode the postcode to validate</span>
<span class="cm">     * @return true if the postcode is valid</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="n">String</span> <span class="n">postcode</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">postcodePattern</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">postcode</span><span class="o">.</span><span class="na">toUpperCase</span><span class="o">(</span><span class="n">Locale</span><span class="o">.</span><span class="na">UK</span><span class="o">)).</span><span class="na">matches</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">AreaActivity <small>lamparski.areabase</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.app.ActionBar</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.app.Activity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.app.AlertDialog</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.app.AlertDialog.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.app.Dialog</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.app.Fragment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.app.FragmentManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.app.FragmentManager.OnBackStackChangedListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.app.FragmentTransaction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.app.ProgressDialog</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.ComponentName</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.DialogInterface</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Intent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.IntentSender</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.ServiceConnection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.SharedPreferences</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.res.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.location.Location</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.net.Uri</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.AsyncTask</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Environment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Handler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.IBinder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.support.v4.app.ActionBarDrawerToggle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.support.v4.view.GravityCompat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.support.v4.widget.DrawerLayout</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.KeyEvent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.Menu</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.MenuItem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.View.OnClickListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.Window</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.inputmethod.EditorInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.inputmethod.InputMethodManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.EditText</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.LinearLayout</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.Toast</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.google.android.gms.common.ConnectionResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.android.gms.common.GooglePlayServicesClient.ConnectionCallbacks</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.android.gms.common.GooglePlayServicesClient.OnConnectionFailedListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.android.gms.common.GooglePlayServicesUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.android.gms.location.LocationClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.android.gms.location.LocationListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.android.gms.location.LocationRequest</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileNotFoundException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.FileChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">de.keyboardsurfer.android.widget.crouton.Crouton</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">de.keyboardsurfer.android.widget.crouton.Style</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.dummy.mockup_classes.DemoObjectFragment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.fragments.ErrorDialogFragment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.fragments.IAreabaseFragment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.fragments.PoliceDataFragment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.fragments.SubjectListFragment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.fragments.SubjectViewFragment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.fragments.SummaryFragment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.services.AreaDataService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.services.AreaDataService.AreaDataBinder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.services.AreaDataService.AreaListCallbacks</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.services.AreaDataService.AreaLookupCallbacks</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.widgets.CommonDialogHandlers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.widgets.CommonDialogs</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.widgets.RobotoLightTextView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DataSetFamily</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">widgets</span><span class="o">.</span><span class="na">CommonDialogs</span><span class="o">.</span><span class="na">serviceDisconnectAlert</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * The main screen of the application. It contains the fragment host for all of the components which</span>
<span class="cm"> * use the area data provided by the ONS and so on. It contains the reference to the Area object,</span>
<span class="cm"> * and links to display different data about this Area. At present, it only loads the current MSOA</span>
<span class="cm"> * for where the user is standing and has limited support to load other areas based on the text</span>
<span class="cm"> * search, but this could be alleviated...</span>
<span class="cm"> * TODO: Create an issue on this; should be able to view other areas &amp; navigate hierarchy.</span>
<span class="cm"> * ...but not right now.</span>
<span class="cm"> *</span>
<span class="cm"> * @author filip</span>
<span class="cm"> * @see nde2.pull.types.Area</span>
<span class="cm"> * @see lamparski.areabase.fragments.IAreabaseFragment</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AreaActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="kd">implements</span> <span class="n">LocationListener</span><span class="o">,</span>
		<span class="n">ConnectionCallbacks</span><span class="o">,</span>
		<span class="n">OnConnectionFailedListener</span><span class="o">,</span> <span class="n">OnBackStackChangedListener</span><span class="o">,</span> <span class="n">AreaLookupCallbacks</span><span class="o">,</span> <span class="n">AreaListCallbacks</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="n">DrawerLayout</span> <span class="n">mDrawerLayout</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">ActionBarDrawerToggle</span> <span class="n">mDrawerToggle</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">LinearLayout</span> <span class="n">mDrawer</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">CharSequence</span> <span class="n">mTitle</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Location</span> <span class="n">mGeoPoint</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">IAreabaseFragment</span> <span class="n">mContentFragment</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">mFragmentHostId</span><span class="o">;</span>

	<span class="n">SharedPreferences</span> <span class="n">mPref</span><span class="o">;</span>
	<span class="n">SharedPreferences</span><span class="o">.</span><span class="na">Editor</span> <span class="n">mPrefEditor</span><span class="o">;</span>

	<span class="kd">private</span> <span class="n">LocationClient</span> <span class="n">mLocationClient</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">LocationRequest</span> <span class="n">mLocationRequest</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">CONNECTION_FAILURE_RESOLUTION_REQUEST</span> <span class="o">=</span> <span class="mi">9000</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">Area</span> <span class="n">mArea</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">AreaDataService</span> <span class="n">areaDataService</span><span class="o">;</span>
    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="n">isAreaDataServiceBound</span><span class="o">,</span> <span class="n">is_live</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">restoring_from_savestate</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="cm">/**</span>
<span class="cm">     * {@see ServiceConnection}</span>
<span class="cm">     */</span>
    <span class="kd">protected</span> <span class="n">ServiceConnection</span> <span class="n">mAreaDataServiceConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServiceConnection</span><span class="o">()</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceDisconnected</span><span class="o">(</span><span class="n">ComponentName</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">is_live</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;AreaActivity&quot;</span><span class="o">,</span>
                        <span class="s">&quot;The AreaDataService disconnected unexpectedly.&quot;</span><span class="o">);</span>
                <span class="n">isAreaDataServiceBound</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="n">serviceDisconnectAlert</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">AreaActivity</span><span class="o">.</span><span class="na">this</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceConnected</span><span class="o">(</span><span class="n">ComponentName</span> <span class="n">name</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">&quot;AreaActivity&quot;</span><span class="o">,</span> <span class="s">&quot;AreaDataService connected&quot;</span><span class="o">);</span>
            <span class="n">AreaDataBinder</span> <span class="n">binder</span> <span class="o">=</span> <span class="o">(</span><span class="n">AreaDataBinder</span><span class="o">)</span> <span class="n">service</span><span class="o">;</span>
            <span class="n">areaDataService</span> <span class="o">=</span> <span class="n">binder</span><span class="o">.</span><span class="na">getService</span><span class="o">();</span>
            <span class="n">isAreaDataServiceBound</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="k">if</span><span class="o">(</span><span class="n">areaDataService</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">is_live</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">};</span>

	<span class="kd">protected</span> <span class="kt">boolean</span> <span class="n">is_tablet</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="kt">boolean</span> <span class="n">is_landscape</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="kt">boolean</span> <span class="n">request_location_updates</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="kt">boolean</span> <span class="n">is_requesting_updates</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">SUMMARY</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">navdrawer_link_areabaseSummary</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CRIME</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">navdrawer_link_areabaseCrime</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ECONOMY</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">navdrawer_link_areabaseEconomy</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">navdrawer_link_areabaseEnvironment</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">EXPLORE_ONS</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">navdrawer_link_areabaseONSBrowser</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">EXPLORE_POLICE</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">navdrawer_link_areabasePoliceDataBrowser</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">AREA_HIERARCHY</span> <span class="o">=</span> <span class="mi">15</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">AREA_COMPARE</span> <span class="o">=</span> <span class="mi">16</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">GET_HELP</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">navdrawer_link_areabaseHelp</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CURRENT_COORDS</span> <span class="o">=</span> <span class="s">&quot;current-coords&quot;</span><span class="o">;</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">SIS_LOADED_FRAGMENT</span> <span class="o">=</span> <span class="s">&quot;currently-loaded-fragment&quot;</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">SIS_LOADED_COORDS</span> <span class="o">=</span> <span class="s">&quot;currently-loaded-coordinates&quot;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">SIS_LOADED_AREA</span> <span class="o">=</span> <span class="s">&quot;currently-loaded-area&quot;</span><span class="o">;</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="n">Context</span> <span class="n">appCtx</span><span class="o">;</span>

	<span class="kd">private</span> <span class="n">OnClickListener</span> <span class="n">sDrawerLinkListener</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OnClickListener</span><span class="o">()</span> <span class="o">{</span>

		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">View</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">!=</span> <span class="n">GET_HELP</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">changeFragment</span><span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
			<span class="o">}</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">==</span> <span class="n">GET_HELP</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">openHelpPage</span><span class="o">();</span>
			<span class="o">}</span>
			<span class="n">mDrawerLayout</span><span class="o">.</span><span class="na">closeDrawer</span><span class="o">(</span><span class="n">GravityCompat</span><span class="o">.</span><span class="na">START</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">};</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">openHelpPage</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">&quot;AreaActivity navdrawer&quot;</span><span class="o">,</span> <span class="s">&quot;We are getting help!&quot;</span><span class="o">);</span>
        <span class="n">Intent</span> <span class="n">helpIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_VIEW</span><span class="o">);</span>
        <span class="n">helpIntent</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="n">Uri</span>
                <span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">&quot;http://flamparski.github.io/areabase/&quot;</span><span class="o">));</span>
        <span class="n">startActivity</span><span class="o">(</span><span class="n">helpIntent</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>

		<span class="n">appCtx</span> <span class="o">=</span> <span class="n">getApplicationContext</span><span class="o">();</span>

		<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;AreaActivity&quot;</span><span class="o">,</span> <span class="s">&quot;onCreate() called&quot;</span><span class="o">);</span>
		<span class="n">requestWindowFeature</span><span class="o">(</span><span class="n">Window</span><span class="o">.</span><span class="na">FEATURE_INDETERMINATE_PROGRESS</span><span class="o">);</span>

		<span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">area_activity</span><span class="o">);</span>

		<span class="n">mPref</span> <span class="o">=</span> <span class="n">getSharedPreferences</span><span class="o">(</span><span class="s">&quot;lamparski.areabase.SHARED_PREFERENCES&quot;</span><span class="o">,</span>
				<span class="n">Context</span><span class="o">.</span><span class="na">MODE_PRIVATE</span><span class="o">);</span>
		<span class="n">mPrefEditor</span> <span class="o">=</span> <span class="n">mPref</span><span class="o">.</span><span class="na">edit</span><span class="o">();</span>
		<span class="n">mLocationClient</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocationClient</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>

		<span class="n">ActionBar</span> <span class="n">mActionBar</span> <span class="o">=</span> <span class="n">getActionBar</span><span class="o">();</span>
		<span class="n">mActionBar</span><span class="o">.</span><span class="na">setNavigationMode</span><span class="o">(</span><span class="n">ActionBar</span><span class="o">.</span><span class="na">NAVIGATION_MODE_STANDARD</span><span class="o">);</span>
		<span class="n">mActionBar</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">app_name</span><span class="o">);</span>
		<span class="n">mActionBar</span><span class="o">.</span><span class="na">setHomeButtonEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

		<span class="n">mDrawerLayout</span> <span class="o">=</span> <span class="o">(</span><span class="n">DrawerLayout</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">tablet_area_activity_drawerLayout</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">mDrawerLayout</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">mDrawer</span> <span class="o">=</span> <span class="o">(</span><span class="n">LinearLayout</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">navdrawer_layout</span><span class="o">);</span>
			<span class="n">is_tablet</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
			<span class="n">mFragmentHostId</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">tablet_area_activity_frameLayout</span><span class="o">;</span>
			<span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">&quot;AreaActivity&quot;</span><span class="o">,</span>
					<span class="s">&quot;Loading tablet version of AreaActivity&quot;</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="n">mDrawerLayout</span> <span class="o">=</span> <span class="o">(</span><span class="n">DrawerLayout</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">handset_area_activity_drawerLayout_DEFAULT</span><span class="o">);</span>
			<span class="n">mDrawer</span> <span class="o">=</span> <span class="o">(</span><span class="n">LinearLayout</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">navdrawer_layout</span><span class="o">);</span>
			<span class="n">is_tablet</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
			<span class="n">mFragmentHostId</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">handset_area_activity_frameLayout_DEFAULT</span><span class="o">;</span>
			<span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">&quot;AreaActivity&quot;</span><span class="o">,</span>
					<span class="s">&quot;Loading handset version of AreaActivity&quot;</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="n">setUpNavDrawer</span><span class="o">();</span>

		<span class="n">mDrawerLayout</span><span class="o">.</span><span class="na">setDrawerShadow</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">drawer_shadow</span><span class="o">,</span>
				<span class="n">GravityCompat</span><span class="o">.</span><span class="na">START</span><span class="o">);</span>

		<span class="n">mDrawerToggle</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ActionBarDrawerToggle</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">mDrawerLayout</span><span class="o">,</span>
				<span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">ic_drawer</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">drawer_open</span><span class="o">,</span>
				<span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">drawer_close</span><span class="o">)</span> <span class="o">{</span>
			<span class="nd">@Override</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDrawerClosed</span><span class="o">(</span><span class="n">View</span> <span class="n">drawerView</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">getActionBar</span><span class="o">().</span><span class="na">setTitle</span><span class="o">(</span><span class="n">mTitle</span><span class="o">);</span>
			<span class="o">}</span>

			<span class="nd">@Override</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDrawerOpened</span><span class="o">(</span><span class="n">View</span> <span class="n">drawerView</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">getActionBar</span><span class="o">().</span><span class="na">setTitle</span><span class="o">(</span><span class="s">&quot;Areabase&quot;</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">};</span>

		<span class="n">mDrawerLayout</span><span class="o">.</span><span class="na">setDrawerListener</span><span class="o">(</span><span class="n">mDrawerToggle</span><span class="o">);</span>

		<span class="n">mActionBar</span><span class="o">.</span><span class="na">setDisplayHomeAsUpEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
		<span class="n">mDrawerLayout</span><span class="o">.</span><span class="na">closeDrawer</span><span class="o">(</span><span class="n">mDrawer</span><span class="o">);</span>

        <span class="n">getFragmentManager</span><span class="o">().</span><span class="na">addOnBackStackChangedListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">savedInstanceState</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;AreaActivity&quot;</span><span class="o">,</span> <span class="s">&quot;  &gt; savedInstanceState != null&quot;</span><span class="o">);</span>
			<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;AreaActivity&quot;</span><span class="o">,</span>
					<span class="s">&quot;Restoring the reference to currently loaded fragment: &quot;</span>
							<span class="o">+</span> <span class="n">savedInstanceState</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">SIS_LOADED_FRAGMENT</span><span class="o">));</span>
			<span class="n">mContentFragment</span> <span class="o">=</span> <span class="o">(</span><span class="n">IAreabaseFragment</span><span class="o">)</span> <span class="n">getFragmentManager</span><span class="o">()</span>
					<span class="o">.</span><span class="na">findFragmentByTag</span><span class="o">(</span>
							<span class="n">savedInstanceState</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">SIS_LOADED_FRAGMENT</span><span class="o">));</span>
			<span class="n">mGeoPoint</span> <span class="o">=</span> <span class="o">(</span><span class="n">Location</span><span class="o">)</span> <span class="n">savedInstanceState</span>
					<span class="o">.</span><span class="na">getParcelable</span><span class="o">(</span><span class="n">SIS_LOADED_COORDS</span><span class="o">);</span>
            <span class="n">mArea</span> <span class="o">=</span> <span class="o">(</span><span class="n">Area</span><span class="o">)</span> <span class="n">savedInstanceState</span><span class="o">.</span><span class="na">getSerializable</span><span class="o">(</span><span class="n">SIS_LOADED_AREA</span><span class="o">);</span>
            <span class="n">restoring_from_savestate</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">setUpNavDrawer</span><span class="o">()</span> <span class="o">{</span>
		<span class="kt">int</span> <span class="n">drawerChildrenCount</span> <span class="o">=</span> <span class="n">mDrawer</span><span class="o">.</span><span class="na">getChildCount</span><span class="o">();</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">drawerChildrenCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">View</span> <span class="n">v_at_i</span> <span class="o">=</span> <span class="n">mDrawer</span><span class="o">.</span><span class="na">getChildAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
			<span class="c1">// Find me all children that are the links</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">v_at_i</span> <span class="k">instanceof</span> <span class="n">RobotoLightTextView</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">v_at_i</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="n">sDrawerLinkListener</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="c1">// Special case for the &quot;help&quot; link, which is further down the</span>
		<span class="c1">// hierarchy:</span>
		<span class="n">View</span> <span class="n">helplink</span> <span class="o">=</span> <span class="n">mDrawer</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">navdrawer_link_areabaseHelp</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">helplink</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">helplink</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="n">sDrawerLinkListener</span><span class="o">);</span>
        <span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onPostCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
		<span class="n">mDrawerToggle</span><span class="o">.</span><span class="na">syncState</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onStart</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onStart</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">mPref</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;pref_location_backgroundlocate&quot;</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">request_location_updates</span> <span class="o">=</span> <span class="n">mPref</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">&quot;pref_location_backgroundlocate&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">AreaDataService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">getApplicationContext</span><span class="o">().</span><span class="na">bindService</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">mAreaDataServiceConnection</span><span class="o">,</span> <span class="n">BIND_AUTO_CREATE</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onStop</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onStop</span><span class="o">();</span>
		<span class="n">mLocationClient</span><span class="o">.</span><span class="na">disconnect</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPause</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onPause</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">is_requesting_updates</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">is_requesting_updates</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
			<span class="n">mLocationClient</span><span class="o">.</span><span class="na">removeLocationUpdates</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onResume</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onResume</span><span class="o">();</span>
		<span class="n">mLocationClient</span><span class="o">.</span><span class="na">connect</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onConnectionFailed</span><span class="o">(</span><span class="n">ConnectionResult</span> <span class="n">connResult</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">&quot;Google Play services&quot;</span><span class="o">,</span>
				<span class="s">&quot;Service connection failed. Attempting to resolve...&quot;</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">connResult</span><span class="o">.</span><span class="na">hasResolution</span><span class="o">())</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="n">connResult</span><span class="o">.</span><span class="na">startResolutionForResult</span><span class="o">(</span><span class="k">this</span><span class="o">,</span>
						<span class="n">CONNECTION_FAILURE_RESOLUTION_REQUEST</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IntentSender</span><span class="o">.</span><span class="na">SendIntentException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;AreaActivity&quot;</span><span class="o">,</span> <span class="s">&quot;Error when resolving Play Services issue&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="n">showErrorDialog</span><span class="o">(</span><span class="n">connResult</span><span class="o">.</span><span class="na">getErrorCode</span><span class="o">());</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onConnected</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">stuff</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">&quot;Google Play services&quot;</span><span class="o">,</span> <span class="s">&quot;Service connected.&quot;</span><span class="o">);</span>
		<span class="n">mGeoPoint</span> <span class="o">=</span> <span class="n">mLocationClient</span><span class="o">.</span><span class="na">getLastLocation</span><span class="o">();</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">request_location_updates</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">is_requesting_updates</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

			<span class="k">if</span> <span class="o">(</span><span class="n">gServicesConnected</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">mLocationRequest</span> <span class="o">=</span> <span class="n">LocationRequest</span><span class="o">.</span><span class="na">create</span><span class="o">();</span>
				<span class="n">mLocationRequest</span><span class="o">.</span><span class="na">setFastestInterval</span><span class="o">(</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">1000</span><span class="n">l</span><span class="o">);</span>
				<span class="n">mLocationRequest</span>
						<span class="o">.</span><span class="na">setPriority</span><span class="o">(</span><span class="n">LocationRequest</span><span class="o">.</span><span class="na">PRIORITY_HIGH_ACCURACY</span><span class="o">);</span>
				<span class="n">mLocationClient</span><span class="o">.</span><span class="na">requestLocationUpdates</span><span class="o">(</span><span class="n">mLocationRequest</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>

        <span class="k">if</span><span class="o">(</span><span class="n">is_live</span> <span class="o">&amp;&amp;</span> <span class="n">mArea</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">beginAreaFetch</span><span class="o">(</span><span class="n">mGeoPoint</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">restoring_from_savestate</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">doRefreshFragment</span><span class="o">();</span>
        <span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDisconnected</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">&quot;Google Play services&quot;</span><span class="o">,</span> <span class="s">&quot;Service disconnected.&quot;</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onLocationChanged</span><span class="o">(</span><span class="n">Location</span> <span class="n">location</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">&quot;LocationListener&quot;</span><span class="o">,</span>
				<span class="s">&quot;New location received: &quot;</span> <span class="o">+</span> <span class="n">location</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
		<span class="n">mGeoPoint</span> <span class="o">=</span> <span class="n">location</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onActivityResult</span><span class="o">(</span><span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onActivityResult</span><span class="o">(</span><span class="n">requestCode</span><span class="o">,</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
		<span class="k">switch</span> <span class="o">(</span><span class="n">requestCode</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">case</span> <span class="nl">CONNECTION_FAILURE_RESOLUTION_REQUEST:</span>
			<span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">&quot;AreaActivity&quot;</span><span class="o">,</span>
					<span class="s">&quot;Error resolution request. Intent: &quot;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
			<span class="k">switch</span> <span class="o">(</span><span class="n">resultCode</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">case</span> <span class="n">Activity</span><span class="o">.</span><span class="na">RESULT_OK</span><span class="o">:</span>
				<span class="c1">// try again</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="k">break</span><span class="o">;</span>
		<span class="k">default</span><span class="o">:</span>
			<span class="k">break</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * @return True if it is possible to use Google Play Services</span>
<span class="cm">     */</span>
	<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">gServicesConnected</span><span class="o">()</span> <span class="o">{</span>
		<span class="kt">int</span> <span class="n">resultCode</span> <span class="o">=</span> <span class="n">GooglePlayServicesUtil</span>
				<span class="o">.</span><span class="na">isGooglePlayServicesAvailable</span><span class="o">(</span><span class="n">getApplicationContext</span><span class="o">());</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">resultCode</span> <span class="o">==</span> <span class="n">ConnectionResult</span><span class="o">.</span><span class="na">SUCCESS</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;AreaActivity&quot;</span><span class="o">,</span> <span class="s">&quot;We have Google Services!&quot;</span><span class="o">);</span>
			<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Will show an error dialogue from Google Play Services library</span>
<span class="cm">     * @param errorCode used by the library to look up error messages</span>
<span class="cm">     */</span>
	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">showErrorDialog</span><span class="o">(</span><span class="kt">int</span> <span class="n">errorCode</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Dialog</span> <span class="n">dlg</span> <span class="o">=</span> <span class="n">GooglePlayServicesUtil</span><span class="o">.</span><span class="na">getErrorDialog</span><span class="o">(</span><span class="n">errorCode</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span>
				<span class="n">CONNECTION_FAILURE_RESOLUTION_REQUEST</span><span class="o">);</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">dlg</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">ErrorDialogFragment</span> <span class="n">errorFragment</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ErrorDialogFragment</span><span class="o">();</span>
			<span class="n">errorFragment</span><span class="o">.</span><span class="na">setDialog</span><span class="o">(</span><span class="n">dlg</span><span class="o">);</span>
			<span class="n">errorFragment</span><span class="o">.</span><span class="na">show</span><span class="o">(</span><span class="n">getFragmentManager</span><span class="o">(),</span> <span class="n">errorFragment</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span>
					<span class="o">.</span><span class="na">getName</span><span class="o">());</span>
		<span class="o">}</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * @param title New window title</span>
<span class="cm">     */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTitle</span><span class="o">(</span><span class="n">CharSequence</span> <span class="n">title</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">mTitle</span> <span class="o">=</span> <span class="n">title</span><span class="o">;</span>
		<span class="n">getActionBar</span><span class="o">().</span><span class="na">setTitle</span><span class="o">(</span><span class="n">title</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onCreateOptionsMenu</span><span class="o">(</span><span class="n">Menu</span> <span class="n">menu</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// Inflate the menu; this adds items to the action bar if it is present.</span>
		<span class="n">getMenuInflater</span><span class="o">().</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">menu</span><span class="o">.</span><span class="na">areabase_opts_menu</span><span class="o">,</span> <span class="n">menu</span><span class="o">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Search action: Handle expanding the search box and starting the</span>
<span class="cm">		 * search procedure.</span>
<span class="cm">		 */</span>
		<span class="kd">final</span> <span class="n">EditText</span> <span class="n">mSearchBox</span> <span class="o">=</span> <span class="o">(</span><span class="n">EditText</span><span class="o">)</span> <span class="n">menu</span>
				<span class="o">.</span><span class="na">findItem</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">action_search</span><span class="o">).</span><span class="na">getActionView</span><span class="o">();</span>
		<span class="kd">final</span> <span class="n">MenuItem</span> <span class="n">searchMenuItem</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="na">findItem</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">action_search</span><span class="o">);</span>
        <span class="c1">// pretty sure this has no real effect but it gets rid of the ugly yellow highlight</span>
        <span class="k">assert</span> <span class="n">mSearchBox</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">searchMenuItem</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">searchMenuItem</span>
				<span class="o">.</span><span class="na">setOnActionExpandListener</span><span class="o">(</span><span class="k">new</span> <span class="n">MenuItem</span><span class="o">.</span><span class="na">OnActionExpandListener</span><span class="o">()</span> <span class="o">{</span>

					<span class="nd">@Override</span>
					<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onMenuItemActionCollapse</span><span class="o">(</span><span class="n">MenuItem</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
						<span class="c1">// Clear the search box</span>
						<span class="n">mSearchBox</span><span class="o">.</span><span class="na">clearFocus</span><span class="o">();</span>
						<span class="n">mSearchBox</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">);</span>
						<span class="n">InputMethodManager</span> <span class="n">imm</span> <span class="o">=</span> <span class="o">(</span><span class="n">InputMethodManager</span><span class="o">)</span> <span class="n">getSystemService</span><span class="o">(</span><span class="n">INPUT_METHOD_SERVICE</span><span class="o">);</span>
						<span class="n">imm</span><span class="o">.</span><span class="na">toggleSoftInput</span><span class="o">(</span>
								<span class="n">InputMethodManager</span><span class="o">.</span><span class="na">HIDE_IMPLICIT_ONLY</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
						<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
					<span class="o">}</span>

					<span class="nd">@Override</span>
					<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onMenuItemActionExpand</span><span class="o">(</span><span class="n">MenuItem</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
						<span class="c1">// Place cursor in the search box</span>
						<span class="n">mSearchBox</span><span class="o">.</span><span class="na">requestFocus</span><span class="o">();</span>
						<span class="c1">// Make sure the keyboard is displayed.</span>
						<span class="n">InputMethodManager</span> <span class="n">imm</span> <span class="o">=</span> <span class="o">(</span><span class="n">InputMethodManager</span><span class="o">)</span> <span class="n">getSystemService</span><span class="o">(</span><span class="n">INPUT_METHOD_SERVICE</span><span class="o">);</span>
						<span class="n">imm</span><span class="o">.</span><span class="na">toggleSoftInput</span><span class="o">(</span><span class="n">InputMethodManager</span><span class="o">.</span><span class="na">SHOW_FORCED</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
						<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
					<span class="o">}</span>
				<span class="o">});</span>
		<span class="n">mSearchBox</span>
				<span class="o">.</span><span class="na">setOnEditorActionListener</span><span class="o">(</span><span class="k">new</span> <span class="n">TextView</span><span class="o">.</span><span class="na">OnEditorActionListener</span><span class="o">()</span> <span class="o">{</span>

					<span class="nd">@Override</span>
					<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onEditorAction</span><span class="o">(</span><span class="n">TextView</span> <span class="n">v</span><span class="o">,</span> <span class="kt">int</span> <span class="n">actionId</span><span class="o">,</span>
							<span class="n">KeyEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">actionId</span> <span class="o">==</span> <span class="n">EditorInfo</span><span class="o">.</span><span class="na">IME_NULL</span>
								<span class="o">||</span> <span class="n">actionId</span> <span class="o">==</span> <span class="n">EditorInfo</span><span class="o">.</span><span class="na">IME_ACTION_SEARCH</span><span class="o">)</span> <span class="o">{</span>
							<span class="k">if</span> <span class="o">(</span><span class="n">event</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
								<span class="k">if</span> <span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getAction</span><span class="o">()</span> <span class="o">!=</span> <span class="n">KeyEvent</span><span class="o">.</span><span class="na">ACTION_DOWN</span><span class="o">)</span> <span class="o">{</span>
									<span class="k">return</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// Prevents code below from</span>
													<span class="c1">// running twice.</span>
								<span class="o">}</span>
							<span class="o">}</span>
							<span class="cm">/*</span>
<span class="cm">							 * Only execute this if the user has pressed the</span>
<span class="cm">							 * &#39;Search&#39; Enter-like key on the soft keyboard, or</span>
<span class="cm">							 * the hardware Enter key.</span>
<span class="cm">							 */</span>
							<span class="n">searchAreasByText</span><span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
							<span class="n">searchMenuItem</span><span class="o">.</span><span class="na">collapseActionView</span><span class="o">();</span>
							<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
						<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
							<span class="cm">/*</span>
<span class="cm">							 * If the key was anything else, we don&#39;t want to do</span>
<span class="cm">							 * anything, so just return false.</span>
<span class="cm">							 */</span>
							<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
						<span class="o">}</span>
					<span class="o">}</span>
				<span class="o">});</span>

		<span class="cm">/*</span>
<span class="cm">		 * Other actions are much simpler, so they&#39;ll be handled in</span>
<span class="cm">		 * onOptionsItemSelected.</span>
<span class="cm">		 */</span>

		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onOptionsItemSelected</span><span class="o">(</span><span class="n">MenuItem</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">switch</span> <span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getItemId</span><span class="o">())</span> <span class="o">{</span>
		<span class="k">case</span> <span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">home</span><span class="o">:</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">mDrawerLayout</span><span class="o">.</span><span class="na">isDrawerOpen</span><span class="o">(</span><span class="n">mDrawer</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">mDrawerLayout</span><span class="o">.</span><span class="na">closeDrawer</span><span class="o">(</span><span class="n">mDrawer</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!(</span><span class="n">mDrawerLayout</span><span class="o">.</span><span class="na">isDrawerOpen</span><span class="o">(</span><span class="n">mDrawer</span><span class="o">)))</span> <span class="o">{</span>
				<span class="n">mDrawerLayout</span><span class="o">.</span><span class="na">openDrawer</span><span class="o">(</span><span class="n">mDrawer</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">break</span><span class="o">;</span>
		<span class="k">case</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">action_locate</span><span class="o">:</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">gServicesConnected</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">beginAreaFetch</span><span class="o">(</span><span class="n">getLocation</span><span class="o">());</span>
			<span class="o">}</span>
			<span class="k">break</span><span class="o">;</span>
		<span class="k">case</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">action_refresh</span><span class="o">:</span>
			<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;AreaActivity&quot;</span><span class="o">,</span> <span class="s">&quot;Action: refresh&quot;</span><span class="o">);</span>
			<span class="n">doRefreshFragment</span><span class="o">();</span>
			<span class="k">break</span><span class="o">;</span>
		<span class="k">case</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">action_settings</span><span class="o">:</span>
			<span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">SettingsActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
			<span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
			<span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">action_help</span><span class="o">:</span>
            <span class="n">openHelpPage</span><span class="o">();</span>
            <span class="k">break</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">onOptionsItemSelected</span><span class="o">(</span><span class="n">item</span><span class="o">);</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Text search</span>
<span class="cm">     * @param searchQuery the query</span>
<span class="cm">     */</span>
	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">searchAreasByText</span><span class="o">(</span><span class="n">String</span> <span class="n">searchQuery</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">beginAreaFetch</span><span class="o">(</span><span class="n">searchQuery</span><span class="o">);</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Used to keep track of retries</span>
<span class="cm">     */</span>
	<span class="kt">int</span> <span class="n">doRefreshFragment_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Fault-tolerant way of refreshing the content fragment -- will just keep trying</span>
<span class="cm">     */</span>
	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">doRefreshFragment</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">new</span> <span class="nf">Handler</span><span class="o">().</span><span class="na">postDelayed</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
			<span class="nd">@Override</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
				<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;AreaActivity&quot;</span><span class="o">,</span>
						<span class="s">&quot;Attempting to refresh the content fragment...&quot;</span><span class="o">);</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="n">getContentFragment</span><span class="o">().</span><span class="na">refreshContent</span><span class="o">();</span>
					<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;AreaActivity&quot;</span><span class="o">,</span> <span class="s">&quot;Attempt successful!&quot;</span><span class="o">);</span>
					<span class="n">doRefreshFragment_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NullPointerException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">&quot;AreaActivity&quot;</span><span class="o">,</span>
							<span class="s">&quot;Null pointer exception when trying to refresh the fragment, will try again in 500ms&quot;</span><span class="o">);</span>
					<span class="k">if</span> <span class="o">(++</span><span class="n">doRefreshFragment_retries</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">)</span> <span class="o">{</span>
						<span class="n">doRefreshFragment</span><span class="o">();</span>
					<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
						<span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">&quot;AreaActivity&quot;</span><span class="o">,</span>
								<span class="s">&quot;Exceeded maximum number of tries, aborting refresh. Here&#39;s what&#39;s going on:&quot;</span><span class="o">);</span>
						<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;AreaActivity&quot;</span><span class="o">,</span>
								<span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
										<span class="s">&quot;\tgetContentFragment() =&gt; %s\n\tmGeoPoint =&gt; %s&quot;</span><span class="o">,</span>
										<span class="o">(</span><span class="n">getContentFragment</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">&quot;null&quot;</span>
												<span class="o">:</span> <span class="n">getContentFragment</span><span class="o">()</span>
														<span class="o">.</span><span class="na">getClass</span><span class="o">()</span>
														<span class="o">.</span><span class="na">getSimpleName</span><span class="o">()),</span>
										<span class="o">(</span><span class="n">mGeoPoint</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">&quot;null&quot;</span> <span class="o">:</span> <span class="n">mGeoPoint</span>
												<span class="o">.</span><span class="na">toString</span><span class="o">())));</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">},</span> <span class="mi">500</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onConfigurationChanged</span><span class="o">(</span><span class="n">Configuration</span> <span class="n">newConfig</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onConfigurationChanged</span><span class="o">(</span><span class="n">newConfig</span><span class="o">);</span>
		<span class="n">mDrawerToggle</span><span class="o">.</span><span class="na">onConfigurationChanged</span><span class="o">(</span><span class="n">newConfig</span><span class="o">);</span>
		<span class="n">doRefreshFragment</span><span class="o">();</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Will begin to find areas based on the location given</span>
<span class="cm">     * @param location the user&#39;s location</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">beginAreaFetch</span> <span class="o">(</span><span class="kd">final</span> <span class="n">Location</span> <span class="n">location</span><span class="o">){</span>
        <span class="n">areaDataService</span><span class="o">.</span><span class="na">areaForLocation</span><span class="o">(</span><span class="n">location</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Will begin to find areas based on the query string.</span>
<span class="cm">     *</span>
<span class="cm">     * If the query matches the postcode pattern, a postcode lookup</span>
<span class="cm">     * will be performed. Otherwise, the string will be used to</span>
<span class="cm">     * look up areas by name part.</span>
<span class="cm">     * @param query The query string</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">beginAreaFetch</span> <span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">query</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">uk_postcodes</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Postcode</span><span class="o">.</span><span class="na">isValid</span><span class="o">(</span><span class="n">query</span><span class="o">)){</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;AreaActivity&quot;</span><span class="o">,</span> <span class="s">&quot;Text query: &quot;</span> <span class="o">+</span> <span class="n">query</span> <span class="o">+</span> <span class="s">&quot; is a postcode, using Area For Postcode&quot;</span><span class="o">);</span>
            <span class="n">areaDataService</span><span class="o">.</span><span class="na">areaForPostcode</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;AreaActivity&quot;</span><span class="o">,</span> <span class="s">&quot;Text query: &quot;</span> <span class="o">+</span> <span class="n">query</span> <span class="o">+</span> <span class="s">&quot; is not a postcode, using Areas For Name&quot;</span><span class="o">);</span>
            <span class="n">areaDataService</span><span class="o">.</span><span class="na">areasForName</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Checks if the locator service has new location, then saves it and returns</span>
<span class="cm">	 * it.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @return User&#39;s location.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Location</span> <span class="nf">getLocation</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">if</span><span class="o">(</span><span class="n">gServicesConnected</span><span class="o">()){</span>
            <span class="n">mGeoPoint</span> <span class="o">=</span> <span class="n">mLocationClient</span><span class="o">.</span><span class="na">getLastLocation</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">mGeoPoint</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * @return the currently loaded area</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Area</span> <span class="nf">getArea</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">mArea</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * @return true if we are running on a tablet or other large-screen device</span>
<span class="cm">     */</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isTablet</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">is_tablet</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * @return true if we&#39;re running in landscape mode</span>
<span class="cm">     */</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isLandscape</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">getResources</span><span class="o">().</span><span class="na">getConfiguration</span><span class="o">().</span><span class="na">orientation</span> <span class="o">==</span> <span class="n">Configuration</span><span class="o">.</span><span class="na">ORIENTATION_LANDSCAPE</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * @return the currently loaded fragment</span>
<span class="cm">     */</span>
	<span class="kd">private</span> <span class="n">IAreabaseFragment</span> <span class="nf">getContentFragment</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">mContentFragment</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Changes the current fragment.</span>
<span class="cm">     * @param fragId determines which fragment to load</span>
<span class="cm">     */</span>
	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">changeFragment</span><span class="o">(</span><span class="kt">int</span> <span class="n">fragId</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Fragment</span> <span class="n">replacementFragment</span><span class="o">;</span>
		<span class="n">Bundle</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bundle</span><span class="o">();</span>
        <span class="n">args</span><span class="o">.</span><span class="na">putSerializable</span><span class="o">(</span><span class="s">&quot;argument-area&quot;</span><span class="o">,</span> <span class="n">mArea</span><span class="o">);</span>
		<span class="k">switch</span> <span class="o">(</span><span class="n">fragId</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// &quot;THIS AREA&quot;</span>
		<span class="k">case</span> <span class="nl">SUMMARY:</span>
			<span class="n">replacementFragment</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SummaryFragment</span><span class="o">();</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">mGeoPoint</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">args</span><span class="o">.</span><span class="na">putParcelable</span><span class="o">(</span><span class="n">CURRENT_COORDS</span><span class="o">,</span> <span class="n">mGeoPoint</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="n">replacementFragment</span><span class="o">.</span><span class="na">setArguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
			<span class="n">performFragmentTransaction</span><span class="o">(</span><span class="n">replacementFragment</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
			<span class="k">break</span><span class="o">;</span>
		<span class="k">case</span> <span class="nl">CRIME:</span>
			<span class="n">replacementFragment</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SubjectViewFragment</span><span class="o">();</span>
            <span class="n">args</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="s">&quot;argument-subject-name&quot;</span><span class="o">,</span> <span class="s">&quot;Crime and Safety&quot;</span><span class="o">);</span>
			<span class="n">replacementFragment</span><span class="o">.</span><span class="na">setArguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
			<span class="n">performFragmentTransaction</span><span class="o">(</span><span class="n">replacementFragment</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
			<span class="k">break</span><span class="o">;</span>
		<span class="k">case</span> <span class="nl">ECONOMY:</span>
			<span class="n">replacementFragment</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SubjectViewFragment</span><span class="o">();</span>
            <span class="n">args</span><span class="o">.</span><span class="na">putSerializable</span><span class="o">(</span><span class="s">&quot;argument-subject-name&quot;</span><span class="o">,</span> <span class="s">&quot;Economic Deprivation&quot;</span><span class="o">);</span>
            <span class="n">replacementFragment</span><span class="o">.</span><span class="na">setArguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
			<span class="n">performFragmentTransaction</span><span class="o">(</span><span class="n">replacementFragment</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
			<span class="k">break</span><span class="o">;</span>
		<span class="k">case</span> <span class="nl">ENVIRONMENT:</span>
			<span class="n">replacementFragment</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SubjectViewFragment</span><span class="o">();</span>
            <span class="n">args</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="s">&quot;argument-subject-name&quot;</span><span class="o">,</span> <span class="s">&quot;Physical Environment&quot;</span><span class="o">);</span>
            <span class="n">replacementFragment</span><span class="o">.</span><span class="na">setArguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
			<span class="n">performFragmentTransaction</span><span class="o">(</span><span class="n">replacementFragment</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
			<span class="k">break</span><span class="o">;</span>
		<span class="c1">// &quot;EXPLORE DATA&quot;</span>
		<span class="k">case</span> <span class="nl">EXPLORE_ONS:</span>
			<span class="n">replacementFragment</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SubjectListFragment</span><span class="o">();</span>
			<span class="n">replacementFragment</span><span class="o">.</span><span class="na">setArguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
			<span class="n">performFragmentTransaction</span><span class="o">(</span><span class="n">replacementFragment</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
			<span class="k">break</span><span class="o">;</span>
		<span class="k">case</span> <span class="nl">EXPLORE_POLICE:</span>
			<span class="n">replacementFragment</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PoliceDataFragment</span><span class="o">();</span>
			<span class="n">replacementFragment</span><span class="o">.</span><span class="na">setArguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
			<span class="n">performFragmentTransaction</span><span class="o">(</span><span class="n">replacementFragment</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
			<span class="k">break</span><span class="o">;</span>
		<span class="c1">// &quot;MISC.&quot; UNUSED</span>
		<span class="k">case</span> <span class="nl">AREA_HIERARCHY:</span>
			<span class="n">replacementFragment</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DemoObjectFragment</span><span class="o">();</span>
			<span class="n">args</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="n">DemoObjectFragment</span><span class="o">.</span><span class="na">ARGUMENT</span><span class="o">,</span>
					<span class="s">&quot;ONS-extracted hierarchy of this area will be shown&quot;</span><span class="o">);</span>
			<span class="n">args</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="n">DemoObjectFragment</span><span class="o">.</span><span class="na">ARGUMENT2</span><span class="o">,</span> <span class="s">&quot;Hierarchy&quot;</span><span class="o">);</span>
			<span class="n">replacementFragment</span><span class="o">.</span><span class="na">setArguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
			<span class="n">performFragmentTransaction</span><span class="o">(</span><span class="n">replacementFragment</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
			<span class="k">break</span><span class="o">;</span>
		<span class="k">case</span> <span class="nl">AREA_COMPARE:</span>
			<span class="n">replacementFragment</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DemoObjectFragment</span><span class="o">();</span>
			<span class="n">args</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="n">DemoObjectFragment</span><span class="o">.</span><span class="na">ARGUMENT</span><span class="o">,</span>
					<span class="s">&quot;Here are options to compare two areas based on selected datasets.&quot;</span><span class="o">);</span>
			<span class="n">args</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="n">DemoObjectFragment</span><span class="o">.</span><span class="na">ARGUMENT2</span><span class="o">,</span> <span class="s">&quot;Compare&quot;</span><span class="o">);</span>
			<span class="n">replacementFragment</span><span class="o">.</span><span class="na">setArguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
			<span class="n">performFragmentTransaction</span><span class="o">(</span><span class="n">replacementFragment</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
			<span class="k">break</span><span class="o">;</span>
		<span class="k">default</span><span class="o">:</span>
			<span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Unknown link id %d&quot;</span><span class="o">,</span> <span class="n">fragId</span><span class="o">),</span>
					<span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
			<span class="k">break</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onSaveInstanceState</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">outState</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">fragclass</span> <span class="o">=</span> <span class="n">getContentFragment</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">getContentFragment</span><span class="o">().</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onSaveInstanceState</span><span class="o">(</span><span class="n">outState</span><span class="o">);</span>
		<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;AreaActivity&quot;</span><span class="o">,</span>
				<span class="s">&quot;Saving instance state: currently loaded fragment is &quot;</span>
						<span class="o">+</span> <span class="n">fragclass</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">fragclass</span> <span class="o">:</span> <span class="s">&quot;null&quot;</span><span class="o">);</span>
		<span class="n">outState</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="n">SIS_LOADED_FRAGMENT</span><span class="o">,</span> <span class="n">fragclass</span><span class="o">);</span>
		<span class="n">outState</span><span class="o">.</span><span class="na">putParcelable</span><span class="o">(</span><span class="n">SIS_LOADED_COORDS</span><span class="o">,</span> <span class="n">mGeoPoint</span><span class="o">);</span>
        <span class="n">outState</span><span class="o">.</span><span class="na">putSerializable</span><span class="o">(</span><span class="n">SIS_LOADED_AREA</span><span class="o">,</span> <span class="n">mArea</span><span class="o">);</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Handles the actual switching between fragments. Optionally set the back stack.</span>
<span class="cm">     * @param frag the fragment to show in the main view.</span>
<span class="cm">     * @param addToBackStack whether to add this transaction to the back stack (navigation)</span>
<span class="cm">     */</span>
	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">performFragmentTransaction</span><span class="o">(</span><span class="n">Fragment</span> <span class="n">frag</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">addToBackStack</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">FragmentManager</span> <span class="n">fragmentManager</span> <span class="o">=</span> <span class="n">getFragmentManager</span><span class="o">();</span>
		<span class="n">FragmentTransaction</span> <span class="n">transaction</span> <span class="o">=</span> <span class="n">fragmentManager</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">()</span>
				<span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="n">mFragmentHostId</span><span class="o">,</span> <span class="n">frag</span><span class="o">,</span> <span class="n">frag</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
        <span class="k">if</span><span class="o">(</span><span class="n">addToBackStack</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">transaction</span><span class="o">.</span><span class="na">addToBackStack</span><span class="o">(</span><span class="s">&quot;Areabase&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">transaction</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">frag</span> <span class="k">instanceof</span> <span class="n">IAreabaseFragment</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">mContentFragment</span> <span class="o">=</span> <span class="o">(</span><span class="n">IAreabaseFragment</span><span class="o">)</span> <span class="n">frag</span><span class="o">;</span>
            <span class="n">doRefreshFragment</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="n">Context</span> <span class="nf">getAreabaseApplicationContext</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">appCtx</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * A helper method that dumps the database contents into a file on the sd</span>
<span class="cm">	 * card (or the /sdcard folder in the internal storage filesystem)</span>
<span class="cm">	 */</span>
    <span class="nd">@Deprecated</span>
	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">dump_db</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">new</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">,</span> <span class="n">Integer</span><span class="o">,</span> <span class="n">Void</span><span class="o">&gt;()</span> <span class="o">{</span>

			<span class="kd">private</span> <span class="n">ProgressDialog</span> <span class="n">pdialog</span><span class="o">;</span>
			<span class="kd">private</span> <span class="n">File</span> <span class="n">f</span><span class="o">;</span>

			<span class="nd">@Override</span>
			<span class="kd">protected</span> <span class="n">Void</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">Void</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">FileChannel</span> <span class="n">finch</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
				<span class="n">FileChannel</span> <span class="n">fonch</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

				<span class="k">try</span> <span class="o">{</span>
					<span class="n">finch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">f</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
					<span class="n">fonch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">Environment</span>
							<span class="o">.</span><span class="na">getExternalStoragePublicDirectory</span><span class="o">(</span>
									<span class="n">Environment</span><span class="o">.</span><span class="na">DIRECTORY_DOWNLOADS</span><span class="o">)</span>
							<span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">()</span>
							<span class="o">+</span> <span class="s">&quot;/AreabaseCache.db&quot;</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
					<span class="n">fonch</span><span class="o">.</span><span class="na">transferFrom</span><span class="o">(</span><span class="n">finch</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">finch</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">cancel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
				<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
					<span class="k">try</span> <span class="o">{</span>
						<span class="n">finch</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
						<span class="n">fonch</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
					<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
					<span class="o">}</span>
				<span class="o">}</span>
				<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="nd">@Override</span>
			<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPreExecute</span><span class="o">()</span> <span class="o">{</span>
				<span class="kd">super</span><span class="o">.</span><span class="na">onPreExecute</span><span class="o">();</span>
				<span class="n">pdialog</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProgressDialog</span><span class="o">(</span><span class="n">AreaActivity</span><span class="o">.</span><span class="na">this</span><span class="o">);</span>
				<span class="n">f</span> <span class="o">=</span> <span class="n">getDatabasePath</span><span class="o">(</span><span class="s">&quot;CacheDb&quot;</span><span class="o">);</span>
				<span class="n">pdialog</span><span class="o">.</span><span class="na">setIndeterminate</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
				<span class="n">pdialog</span><span class="o">.</span><span class="na">setProgressStyle</span><span class="o">(</span><span class="n">ProgressDialog</span><span class="o">.</span><span class="na">STYLE_HORIZONTAL</span><span class="o">);</span>
				<span class="n">pdialog</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="s">&quot;Dumping database to sdcard&quot;</span><span class="o">);</span>
				<span class="n">pdialog</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
			<span class="o">}</span>

			<span class="nd">@Override</span>
			<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onProgressUpdate</span><span class="o">(</span><span class="n">Integer</span><span class="o">...</span> <span class="n">values</span><span class="o">)</span> <span class="o">{</span>
				<span class="kd">super</span><span class="o">.</span><span class="na">onProgressUpdate</span><span class="o">(</span><span class="n">values</span><span class="o">);</span>
				<span class="c1">// pdialog.setProgress(values[0]);</span>
			<span class="o">}</span>

			<span class="nd">@Override</span>
			<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="n">Void</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
				<span class="kd">super</span><span class="o">.</span><span class="na">onPostExecute</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
				<span class="n">pdialog</span><span class="o">.</span><span class="na">dismiss</span><span class="o">();</span>
			<span class="o">}</span>

			<span class="nd">@Override</span>
			<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCancelled</span><span class="o">()</span> <span class="o">{</span>
				<span class="kd">super</span><span class="o">.</span><span class="na">onCancelled</span><span class="o">();</span>
				<span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">appCtx</span><span class="o">,</span> <span class="s">&quot;DB dump error&quot;</span><span class="o">,</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">)</span>
						<span class="o">.</span><span class="na">show</span><span class="o">();</span>
				<span class="n">pdialog</span><span class="o">.</span><span class="na">dismiss</span><span class="o">();</span>
			<span class="o">}</span>
		<span class="o">}.</span><span class="na">execute</span><span class="o">();</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Proxy for SubjectViewFragment generation</span>
<span class="cm">     * @param area the area to get the subject for</span>
<span class="cm">     * @param subjectName the subject to get</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">showSubjectView</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">,</span> <span class="n">String</span> <span class="n">subjectName</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Bundle</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bundle</span><span class="o">();</span>
        <span class="n">Fragment</span> <span class="n">replacementFragment</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SubjectViewFragment</span><span class="o">();</span>
        <span class="n">args</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="s">&quot;argument-subject-name&quot;</span><span class="o">,</span> <span class="n">subjectName</span><span class="o">);</span>
        <span class="n">args</span><span class="o">.</span><span class="na">putSerializable</span><span class="o">(</span><span class="s">&quot;argument-area&quot;</span><span class="o">,</span> <span class="n">area</span><span class="o">);</span>
        <span class="n">replacementFragment</span><span class="o">.</span><span class="na">setArguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
        <span class="n">performFragmentTransaction</span><span class="o">(</span><span class="n">replacementFragment</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onBackStackChanged</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// Ensure the correct fragment is referenced</span>
        <span class="n">mContentFragment</span> <span class="o">=</span> <span class="o">(</span><span class="n">IAreabaseFragment</span><span class="o">)</span> <span class="n">getFragmentManager</span><span class="o">().</span><span class="na">findFragmentById</span><span class="o">(</span><span class="n">mFragmentHostId</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">mGeoPoint</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">mContentFragment</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mContentFragment</span><span class="o">.</span><span class="na">refreshContent</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * This gets called when the area requested is ready.</span>
<span class="cm">     * @param area the area that was retrieved by AreaDataService</span>
<span class="cm">     * @see lamparski.areabase.services.AreaDataService.AreaLookupCallbacks#areaReady(nde2.pull.types.Area)</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">areaReady</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">area</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">Crouton</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error_cannot_fetch_area_data</span><span class="o">,</span> <span class="n">Style</span><span class="o">.</span><span class="na">ALERT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">mArea</span> <span class="o">=</span> <span class="n">area</span><span class="o">;</span>
        <span class="n">setTitle</span><span class="o">(</span><span class="n">area</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="n">changeFragment</span><span class="o">(</span><span class="n">SUMMARY</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * This gets called when a list of areas is ready for processing</span>
<span class="cm">     * @param areas the areas fetched</span>
<span class="cm">     * @see lamparski.areabase.services.AreaDataService.AreaListCallbacks#areasReady(java.util.List)</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">areasReady</span><span class="o">(</span><span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;</span> <span class="n">areas</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">areas</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">Crouton</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">&quot;Please type more than 2 characters&quot;</span><span class="o">,</span> <span class="n">Style</span><span class="o">.</span><span class="na">INFO</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;AreaActivity&quot;</span><span class="o">,</span> <span class="s">&quot;Text query: &quot;</span> <span class="o">+</span> <span class="n">areas</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; areas to choose from.&quot;</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">areas</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
            <span class="n">AlertDialog</span><span class="o">.</span><span class="na">Builder</span> <span class="n">fnf_bld</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Builder</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
            <span class="n">fnf_bld</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">areas_not_found</span><span class="o">);</span>
            <span class="n">fnf_bld</span><span class="o">.</span><span class="na">setNeutralButton</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">ok</span><span class="o">,</span> <span class="n">CommonDialogHandlers</span><span class="o">.</span><span class="na">JUST_DISMISS</span><span class="o">);</span>
            <span class="n">fnf_bld</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">areaNames</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">areas</span><span class="o">.</span><span class="na">size</span><span class="o">()];</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">areas</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++){</span>
            <span class="n">areaNames</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">areas</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">getName</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">AlertDialog</span><span class="o">.</span><span class="na">Builder</span> <span class="n">bld</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Builder</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="n">bld</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">select_area_from_list</span><span class="o">);</span>
        <span class="n">bld</span><span class="o">.</span><span class="na">setItems</span><span class="o">(</span><span class="n">areaNames</span><span class="o">,</span> <span class="k">new</span> <span class="n">DialogInterface</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">DialogInterface</span> <span class="n">dialog</span><span class="o">,</span> <span class="kt">int</span> <span class="n">which</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="n">Area</span> <span class="n">area</span> <span class="o">=</span> <span class="n">areas</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">which</span><span class="o">);</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;AreaActivity&quot;</span><span class="o">,</span>
                        <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Text query: choice %d (=&gt; %s)&quot;</span><span class="o">,</span> <span class="n">which</span><span class="o">,</span> <span class="n">area</span><span class="o">.</span><span class="na">getName</span><span class="o">()));</span>
                <span class="n">areaReady</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">bld</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Generic callback for when errors happen</span>
<span class="cm">     * @param tr the throwable that caused the error</span>
<span class="cm">     * @see lamparski.areabase.utils.OnError#onError(Throwable)</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="kd">final</span> <span class="n">Throwable</span> <span class="n">tr</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">runOnUiThread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">if</span><span class="o">(</span><span class="n">tr</span> <span class="k">instanceof</span> <span class="n">FileNotFoundException</span><span class="o">){</span>
                    <span class="n">Crouton</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">AreaActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">file_not_found_msg</span><span class="o">,</span> <span class="n">Style</span><span class="o">.</span><span class="na">INFO</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">CommonDialogs</span><span class="o">.</span><span class="na">areaDataServiceError</span><span class="o">(</span><span class="n">tr</span><span class="o">,</span> <span class="n">AreaActivity</span><span class="o">.</span><span class="na">this</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * This gets called by chartlinks in SubjectViewFragment. It will launch a new Activity</span>
<span class="cm">     * that shows a graph of the given dataset. Refer to {@link lamparski.areabase.GraphActivity}</span>
<span class="cm">     * for more information.</span>
<span class="cm">     * @param family the dataset family to generate a graph for</span>
<span class="cm">     * @param area the area to generate a graph of family for</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">startGraphActivity</span><span class="o">(</span><span class="n">DataSetFamily</span> <span class="n">family</span><span class="o">,</span> <span class="n">Area</span> <span class="n">area</span><span class="o">){</span>
        <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">GraphActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">Bundle</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bundle</span><span class="o">();</span>
        <span class="n">args</span><span class="o">.</span><span class="na">putSerializable</span><span class="o">(</span><span class="n">GraphActivity</span><span class="o">.</span><span class="na">GRAPH_AREA</span><span class="o">,</span> <span class="n">area</span><span class="o">);</span>
        <span class="n">args</span><span class="o">.</span><span class="na">putSerializable</span><span class="o">(</span><span class="n">GraphActivity</span><span class="o">.</span><span class="na">GRAPH_DATASET_FAMILY</span><span class="o">,</span> <span class="n">family</span><span class="o">);</span>
        <span class="n">intent</span><span class="o">.</span><span class="na">putExtras</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
        <span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">CacheContentProvider <small>lamparski.areabase</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.content.ContentProvider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.ContentValues</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.database.Cursor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.database.sqlite.SQLiteDatabase</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.net.Uri</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lamparski.areabase.CacheDbOpenHelper.AreaRankTable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.CacheDbOpenHelper.OnsCacheTable</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Good for caching purposes.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CacheContentProvider</span> <span class="kd">extends</span> <span class="n">ContentProvider</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="n">CacheDbOpenHelper</span> <span class="n">helper</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">AUTHORITY</span> <span class="o">=</span> <span class="s">&quot;lamparski.areabase.content&quot;</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Uri</span> <span class="n">CONTENT_URI</span> <span class="o">=</span> <span class="n">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">&quot;content://&quot;</span> <span class="o">+</span> <span class="n">AUTHORITY</span><span class="o">);</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Uri</span> <span class="n">ONS_CACHE_URI</span> <span class="o">=</span> <span class="n">Uri</span><span class="o">.</span><span class="na">withAppendedPath</span><span class="o">(</span><span class="n">CONTENT_URI</span><span class="o">,</span>
			<span class="n">OnsCacheTable</span><span class="o">.</span><span class="na">TABLE_NAME</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Uri</span> <span class="n">POLICE_CACHE_URI</span> <span class="o">=</span> <span class="n">Uri</span><span class="o">.</span><span class="na">withAppendedPath</span><span class="o">(</span><span class="n">CONTENT_URI</span><span class="o">,</span>
            <span class="n">CacheDbOpenHelper</span><span class="o">.</span><span class="na">PoliceCacheTable</span><span class="o">.</span><span class="na">TABLE_NAME</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Uri</span> <span class="n">MAPIT_CACHE_URI</span> <span class="o">=</span> <span class="n">Uri</span><span class="o">.</span><span class="na">withAppendedPath</span><span class="o">(</span><span class="n">CONTENT_URI</span><span class="o">,</span>
            <span class="n">CacheDbOpenHelper</span><span class="o">.</span><span class="na">MapitCacheTable</span><span class="o">.</span><span class="na">TABLE_NAME</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Uri</span> <span class="n">AREARANK_CACHE_URI</span> <span class="o">=</span> <span class="n">Uri</span><span class="o">.</span><span class="na">withAppendedPath</span><span class="o">(</span><span class="n">CONTENT_URI</span><span class="o">,</span>
            <span class="n">AreaRankTable</span><span class="o">.</span><span class="na">TABLE_NAME</span><span class="o">);</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">delete</span><span class="o">(</span><span class="n">Uri</span> <span class="n">uri</span><span class="o">,</span> <span class="n">String</span> <span class="n">selection</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">selectionArgs</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">SQLiteDatabase</span> <span class="n">db</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">getWritableDatabase</span><span class="o">();</span>
		<span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">getTableName</span><span class="o">(</span><span class="n">uri</span><span class="o">),</span> <span class="n">selection</span><span class="o">,</span> <span class="n">selectionArgs</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getType</span><span class="o">(</span><span class="n">Uri</span> <span class="n">uri</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">Uri</span> <span class="nf">insert</span><span class="o">(</span><span class="n">Uri</span> <span class="n">uri</span><span class="o">,</span> <span class="n">ContentValues</span> <span class="n">values</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">tbl</span> <span class="o">=</span> <span class="n">getTableName</span><span class="o">(</span><span class="n">uri</span><span class="o">);</span>
		<span class="n">SQLiteDatabase</span> <span class="n">db</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">getWritableDatabase</span><span class="o">();</span>
		<span class="kt">long</span> <span class="n">newrow</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">tbl</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">values</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">Uri</span><span class="o">.</span><span class="na">withAppendedPath</span><span class="o">(</span><span class="n">CONTENT_URI</span><span class="o">,</span> <span class="n">Long</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">newrow</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onCreate</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CacheDbOpenHelper</span><span class="o">(</span><span class="n">getContext</span><span class="o">());</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">Cursor</span> <span class="nf">query</span><span class="o">(</span><span class="n">Uri</span> <span class="n">uri</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">projection</span><span class="o">,</span> <span class="n">String</span> <span class="n">selection</span><span class="o">,</span>
			<span class="n">String</span><span class="o">[]</span> <span class="n">selectionArgs</span><span class="o">,</span> <span class="n">String</span> <span class="n">sortOrder</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">SQLiteDatabase</span> <span class="n">db</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">getReadableDatabase</span><span class="o">();</span>
		<span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">getTableName</span><span class="o">(</span><span class="n">uri</span><span class="o">),</span> <span class="n">projection</span><span class="o">,</span> <span class="n">selection</span><span class="o">,</span>
				<span class="n">selectionArgs</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">sortOrder</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="n">Uri</span> <span class="n">uri</span><span class="o">,</span> <span class="n">ContentValues</span> <span class="n">values</span><span class="o">,</span> <span class="n">String</span> <span class="n">selection</span><span class="o">,</span>
			<span class="n">String</span><span class="o">[]</span> <span class="n">selectionArgs</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">tbl</span> <span class="o">=</span> <span class="n">getTableName</span><span class="o">(</span><span class="n">uri</span><span class="o">);</span>
		<span class="n">SQLiteDatabase</span> <span class="n">db</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">getWritableDatabase</span><span class="o">();</span>
		<span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">tbl</span><span class="o">,</span> <span class="n">values</span><span class="o">,</span> <span class="n">selection</span><span class="o">,</span> <span class="n">selectionArgs</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="n">String</span> <span class="nf">getTableName</span><span class="o">(</span><span class="n">Uri</span> <span class="n">uri</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">uriv</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="na">getPath</span><span class="o">();</span>
		<span class="k">return</span> <span class="n">uriv</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">CacheDbOpenHelper <small>lamparski.areabase</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.content.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.database.sqlite.SQLiteDatabase</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.database.sqlite.SQLiteOpenHelper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CacheDbOpenHelper</span> <span class="kd">extends</span> <span class="n">SQLiteOpenHelper</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">BaseCacheTable</span> <span class="o">{</span>
		<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">FIELD_ID</span> <span class="o">=</span> <span class="s">&quot;_id&quot;</span><span class="o">;</span>
		<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">FIELD_URL</span> <span class="o">=</span> <span class="s">&quot;url&quot;</span><span class="o">;</span>
		<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">FIELD_CACHED_OBJECT</span> <span class="o">=</span> <span class="s">&quot;cachedObject&quot;</span><span class="o">;</span>
		<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">FIELD_RETRIEVED_ON</span> <span class="o">=</span> <span class="s">&quot;retrievedOn&quot;</span><span class="o">;</span>
		<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">PROJECTION_ALL</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span> <span class="n">FIELD_ID</span><span class="o">,</span>
				<span class="n">FIELD_URL</span><span class="o">,</span> <span class="n">FIELD_CACHED_OBJECT</span><span class="o">,</span> <span class="n">FIELD_RETRIEVED_ON</span> <span class="o">};</span>

        <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getSchema</span><span class="o">(</span><span class="n">String</span> <span class="n">TABLE_NAME</span><span class="o">){</span>
            <span class="k">return</span> <span class="s">&quot;CREATE TABLE &quot;</span> <span class="o">+</span> <span class="n">TABLE_NAME</span> <span class="o">+</span> <span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="n">FIELD_ID</span>
                    <span class="o">+</span> <span class="s">&quot; INTEGER PRIMARY KEY AUTOINCREMENT,&quot;</span> <span class="o">+</span> <span class="n">FIELD_URL</span>
                    <span class="o">+</span> <span class="s">&quot; TEXT,&quot;</span> <span class="o">+</span> <span class="n">FIELD_RETRIEVED_ON</span> <span class="o">+</span> <span class="s">&quot; INTEGER,&quot;</span>
                    <span class="o">+</span> <span class="n">FIELD_CACHED_OBJECT</span> <span class="o">+</span> <span class="s">&quot; TEXT)&quot;</span><span class="o">;</span>
        <span class="o">}</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * AreaRankTable stores some area scores.</span>
<span class="cm">     *</span>
<span class="cm">     * DEFINITION:</span>
<span class="cm">     * CREATE TABLE areaRank (</span>
<span class="cm">     *     _id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="cm">     *     areaId INTEGER,</span>
<span class="cm">     *     score REAL,</span>
<span class="cm">     *     computedOn INTEGER);</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AreaRankTable</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">FIELD_ID</span> <span class="o">=</span> <span class="s">&quot;_id&quot;</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">FIELD_RETRIEVED_ON</span> <span class="o">=</span> <span class="s">&quot;computedOn&quot;</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">FIELD_AREA_ID</span> <span class="o">=</span> <span class="s">&quot;areaId&quot;</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">FIELD_AREA_RANK</span> <span class="o">=</span> <span class="s">&quot;score&quot;</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TABLE_NAME</span> <span class="o">=</span> <span class="s">&quot;areaRank&quot;</span><span class="o">;</span>

        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">SQLiteDatabase</span> <span class="n">db</span><span class="o">){</span>
            <span class="n">db</span><span class="o">.</span><span class="na">execSQL</span><span class="o">(</span><span class="s">&quot;CREATE TABLE &quot;</span> <span class="o">+</span> <span class="n">TABLE_NAME</span> <span class="o">+</span> <span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="n">FIELD_ID</span>
                    <span class="o">+</span> <span class="s">&quot; INTEGER PRIMARY KEY AUTOINCREMENT,&quot;</span> <span class="o">+</span> <span class="n">FIELD_AREA_ID</span>
                    <span class="o">+</span> <span class="s">&quot; INTEGER,&quot;</span> <span class="o">+</span> <span class="n">FIELD_RETRIEVED_ON</span> <span class="o">+</span> <span class="s">&quot; INTEGER,&quot;</span>
                    <span class="o">+</span> <span class="n">FIELD_AREA_RANK</span> <span class="o">+</span> <span class="s">&quot; REAL)&quot;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">onUpgrade</span><span class="o">(</span><span class="n">SQLiteDatabase</span> <span class="n">db</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">&quot;AreaRankTable&quot;</span><span class="o">,</span>
                    <span class="s">&quot;Upgrading the cache table, entries will be deleted.&quot;</span><span class="o">);</span>
            <span class="n">db</span><span class="o">.</span><span class="na">execSQL</span><span class="o">(</span><span class="s">&quot;DROP TABLE IF EXISTS &quot;</span> <span class="o">+</span> <span class="n">TABLE_NAME</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">OnsCacheTable</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TABLE_NAME</span> <span class="o">=</span> <span class="s">&quot;onsCache&quot;</span><span class="o">;</span>

        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">SQLiteDatabase</span> <span class="n">db</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">db</span><span class="o">.</span><span class="na">execSQL</span><span class="o">(</span><span class="n">BaseCacheTable</span><span class="o">.</span><span class="na">getSchema</span><span class="o">(</span><span class="n">TABLE_NAME</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">onUpgrade</span><span class="o">(</span><span class="n">SQLiteDatabase</span> <span class="n">db</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">&quot;OnsCacheTable&quot;</span><span class="o">,</span>
                    <span class="s">&quot;Upgrading the cache table, entries will be deleted.&quot;</span><span class="o">);</span>
            <span class="n">db</span><span class="o">.</span><span class="na">execSQL</span><span class="o">(</span><span class="s">&quot;DROP TABLE IF EXISTS &quot;</span> <span class="o">+</span> <span class="n">TABLE_NAME</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">PoliceCacheTable</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TABLE_NAME</span> <span class="o">=</span> <span class="s">&quot;policeCache&quot;</span><span class="o">;</span>

        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">SQLiteDatabase</span> <span class="n">db</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">db</span><span class="o">.</span><span class="na">execSQL</span><span class="o">(</span><span class="n">BaseCacheTable</span><span class="o">.</span><span class="na">getSchema</span><span class="o">(</span><span class="n">TABLE_NAME</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">onUpgrade</span><span class="o">(</span><span class="n">SQLiteDatabase</span> <span class="n">db</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">&quot;PoliceCacheTable&quot;</span><span class="o">,</span>
                    <span class="s">&quot;Upgrading the cache table, entries will be deleted.&quot;</span><span class="o">);</span>
            <span class="n">db</span><span class="o">.</span><span class="na">execSQL</span><span class="o">(</span><span class="s">&quot;DROP TABLE IF EXISTS &quot;</span> <span class="o">+</span> <span class="n">TABLE_NAME</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MapitCacheTable</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TABLE_NAME</span> <span class="o">=</span> <span class="s">&quot;mapitCache&quot;</span><span class="o">;</span>

        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">SQLiteDatabase</span> <span class="n">db</span><span class="o">){</span>
            <span class="n">db</span><span class="o">.</span><span class="na">execSQL</span><span class="o">(</span><span class="n">BaseCacheTable</span><span class="o">.</span><span class="na">getSchema</span><span class="o">(</span><span class="n">TABLE_NAME</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">onUpgrade</span><span class="o">(</span><span class="n">SQLiteDatabase</span> <span class="n">db</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">&quot;MapitCacheTable&quot;</span><span class="o">,</span>
                    <span class="s">&quot;Upgrading the cache table, entries will be deleted.&quot;</span><span class="o">);</span>
            <span class="n">db</span><span class="o">.</span><span class="na">execSQL</span><span class="o">(</span><span class="s">&quot;DROP TABLE IF EXISTS &quot;</span> <span class="o">+</span> <span class="n">TABLE_NAME</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">VERSION</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">CacheDbOpenHelper</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="s">&quot;CacheDb&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">VERSION</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">SQLiteDatabase</span> <span class="n">db</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">OnsCacheTable</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">db</span><span class="o">);</span>
        <span class="n">PoliceCacheTable</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">db</span><span class="o">);</span>
        <span class="n">MapitCacheTable</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">db</span><span class="o">);</span>
        <span class="n">AreaRankTable</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">db</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onUpgrade</span><span class="o">(</span><span class="n">SQLiteDatabase</span> <span class="n">db</span><span class="o">,</span> <span class="kt">int</span> <span class="n">oldVersion</span><span class="o">,</span> <span class="kt">int</span> <span class="n">newVersion</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">OnsCacheTable</span><span class="o">.</span><span class="na">onUpgrade</span><span class="o">(</span><span class="n">db</span><span class="o">);</span>
        <span class="n">PoliceCacheTable</span><span class="o">.</span><span class="na">onUpgrade</span><span class="o">(</span><span class="n">db</span><span class="o">);</span>
        <span class="n">MapitCacheTable</span><span class="o">.</span><span class="na">onUpgrade</span><span class="o">(</span><span class="n">db</span><span class="o">);</span>
        <span class="n">AreaRankTable</span><span class="o">.</span><span class="na">onUpgrade</span><span class="o">(</span><span class="n">db</span><span class="o">);</span>
		<span class="n">onCreate</span><span class="o">(</span><span class="n">db</span><span class="o">);</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">GraphActivity <small>lamparski.areabase</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.app.ActionBar</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.app.Activity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.ComponentName</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Intent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.ServiceConnection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.database.DataSetObserver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.IBinder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.Menu</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.MenuItem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.ViewGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.Window</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.SpinnerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.google.common.collect.BiMap</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">de.keyboardsurfer.android.widget.crouton.Crouton</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">de.keyboardsurfer.android.widget.crouton.Style</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.fragments.DatasetGraphFragment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.services.AreaDataService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.services.AreaDataService.AreaDataBinder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.services.AreaDataService.DatasetDumpCallbacks</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.helpers.ArrayHelpers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DataSetFamily</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DateRange</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">widgets</span><span class="o">.</span><span class="na">CommonDialogs</span><span class="o">.</span><span class="na">serviceDisconnectAlert</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Activity dedicated to viewing a single dataset as a graph. Generally this is not very different</span>
<span class="cm"> * from a Subject View, except that it shows a single dataset, enables the user to browse time</span>
<span class="cm"> * periods for which the data is available, and displays a graph of the dataset.</span>
<span class="cm"> *</span>
<span class="cm"> * Some dataset items are excluded (namely the totals) from generating the graph.</span>
<span class="cm"> *</span>
<span class="cm"> * @author filip</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GraphActivity</span> <span class="kd">extends</span> <span class="n">Activity</span>
        <span class="kd">implements</span> <span class="n">ActionBar</span><span class="o">.</span><span class="na">OnNavigationListener</span><span class="o">,</span> <span class="n">DatasetDumpCallbacks</span> <span class="o">{</span>

    <span class="cm">/**</span>
<span class="cm">     * The serialization (saved instance state) Bundle key representing the</span>
<span class="cm">     * current dropdown position.</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">STATE_SELECTED_NAVIGATION_ITEM</span> <span class="o">=</span> <span class="s">&quot;selected_navigation_item&quot;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">GRAPH_AREA</span> <span class="o">=</span> <span class="s">&quot;current_area&quot;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">GRAPH_DATASET_FAMILY</span> <span class="o">=</span> <span class="s">&quot;dataset_family&quot;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">STATE_DATASETS</span> <span class="o">=</span> <span class="s">&quot;current_datasets&quot;</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">Area</span> <span class="n">area</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">DataSetFamily</span> <span class="n">family</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">DateRange</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">datasets</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">BiMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">DateRange</span><span class="o">&gt;</span> <span class="n">dateRangeTable</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span><span class="o">[]</span> <span class="n">dateLabelsArray</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">ActionBar</span> <span class="n">actionBar</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">AreaDataService</span> <span class="n">areaDataService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">is_live</span><span class="o">,</span> <span class="n">isAreaDataServiceBound</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">dbgDatasetPullStart</span><span class="o">;</span>
    <span class="kd">protected</span> <span class="n">ServiceConnection</span> <span class="n">mAreaDataServiceConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServiceConnection</span><span class="o">()</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceDisconnected</span><span class="o">(</span><span class="n">ComponentName</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">is_live</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;GraphActivity&quot;</span><span class="o">,</span>
                        <span class="s">&quot;The AreaDataService disconnected unexpectedly.&quot;</span><span class="o">);</span>
                <span class="n">isAreaDataServiceBound</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="n">serviceDisconnectAlert</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">GraphActivity</span><span class="o">.</span><span class="na">this</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceConnected</span><span class="o">(</span><span class="n">ComponentName</span> <span class="n">name</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">&quot;GraphActivity&quot;</span><span class="o">,</span> <span class="s">&quot;AreaDataService connected&quot;</span><span class="o">);</span>
            <span class="n">AreaDataBinder</span> <span class="n">binder</span> <span class="o">=</span> <span class="o">(</span><span class="n">AreaDataBinder</span><span class="o">)</span> <span class="n">service</span><span class="o">;</span>
            <span class="n">areaDataService</span> <span class="o">=</span> <span class="n">binder</span><span class="o">.</span><span class="na">getService</span><span class="o">();</span>
            <span class="n">isAreaDataServiceBound</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="k">if</span><span class="o">(</span><span class="n">areaDataService</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">is_live</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">dbgDatasetPullStart</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
            <span class="n">areaDataService</span><span class="o">.</span><span class="na">datasetDump</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="n">family</span><span class="o">,</span> <span class="n">GraphActivity</span><span class="o">.</span><span class="na">this</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">};</span>
    <span class="kd">private</span> <span class="n">GraphActivityNavigationSpinnerAdapter</span> <span class="n">actionBarNavListAdapter</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">requestWindowFeature</span><span class="o">(</span><span class="n">Window</span><span class="o">.</span><span class="na">FEATURE_INDETERMINATE_PROGRESS</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_graph</span><span class="o">);</span>

        <span class="n">setProgressBarIndeterminateVisibility</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

        <span class="k">if</span><span class="o">(</span><span class="n">getIntent</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">getIntent</span><span class="o">().</span><span class="na">getExtras</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">if</span><span class="o">(</span><span class="n">getIntent</span><span class="o">().</span><span class="na">getExtras</span><span class="o">().</span><span class="na">containsKey</span><span class="o">(</span><span class="n">GRAPH_DATASET_FAMILY</span><span class="o">)){</span>
                <span class="n">family</span> <span class="o">=</span> <span class="o">(</span><span class="n">DataSetFamily</span><span class="o">)</span> <span class="n">getIntent</span><span class="o">().</span><span class="na">getExtras</span><span class="o">().</span><span class="na">getSerializable</span><span class="o">(</span><span class="n">GRAPH_DATASET_FAMILY</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span><span class="o">(</span><span class="n">getIntent</span><span class="o">().</span><span class="na">getExtras</span><span class="o">().</span><span class="na">containsKey</span><span class="o">(</span><span class="n">GRAPH_AREA</span><span class="o">)){</span>
                <span class="n">area</span> <span class="o">=</span> <span class="o">(</span><span class="n">Area</span><span class="o">)</span> <span class="n">getIntent</span><span class="o">().</span><span class="na">getExtras</span><span class="o">().</span><span class="na">getSerializable</span><span class="o">(</span><span class="n">GRAPH_AREA</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;Cannot initialise without correct arguments!&quot;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">dateRangeTable</span> <span class="o">=</span> <span class="n">ArrayHelpers</span><span class="o">.</span><span class="na">remapDateRanges</span><span class="o">(</span><span class="n">family</span><span class="o">.</span><span class="na">getDateRanges</span><span class="o">());</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">dateLabels</span> <span class="o">=</span> <span class="n">dateRangeTable</span><span class="o">.</span><span class="na">keySet</span><span class="o">();</span>
        <span class="n">dateLabelsArray</span> <span class="o">=</span> <span class="n">dateLabels</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">dateLabels</span><span class="o">.</span><span class="na">size</span><span class="o">()]);</span>

        <span class="k">if</span><span class="o">(</span><span class="n">savedInstanceState</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">savedInstanceState</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">GRAPH_AREA</span><span class="o">)){</span>
                <span class="n">area</span> <span class="o">=</span> <span class="o">(</span><span class="n">Area</span><span class="o">)</span> <span class="n">savedInstanceState</span><span class="o">.</span><span class="na">getSerializable</span><span class="o">(</span><span class="n">GRAPH_AREA</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">savedInstanceState</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">STATE_DATASETS</span><span class="o">)){</span>
                <span class="n">datasets</span> <span class="o">=</span> <span class="o">(</span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">DateRange</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;)</span> <span class="n">savedInstanceState</span><span class="o">.</span><span class="na">getSerializable</span><span class="o">(</span><span class="n">STATE_DATASETS</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">savedInstanceState</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">GRAPH_DATASET_FAMILY</span><span class="o">)){</span>
                <span class="n">family</span> <span class="o">=</span> <span class="o">(</span><span class="n">DataSetFamily</span><span class="o">)</span> <span class="n">savedInstanceState</span><span class="o">.</span><span class="na">getSerializable</span><span class="o">(</span><span class="n">GRAPH_DATASET_FAMILY</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">// Set up the action bar to show a dropdown list.</span>
        <span class="n">actionBar</span> <span class="o">=</span> <span class="n">getActionBar</span><span class="o">();</span>
        <span class="n">actionBar</span><span class="o">.</span><span class="na">setNavigationMode</span><span class="o">(</span><span class="n">ActionBar</span><span class="o">.</span><span class="na">NAVIGATION_MODE_LIST</span><span class="o">);</span>
        <span class="n">actionBar</span><span class="o">.</span><span class="na">setDisplayShowTitleEnabled</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="c1">// Show the Up button in the action bar.</span>
        <span class="n">actionBar</span><span class="o">.</span><span class="na">setDisplayHomeAsUpEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

        <span class="c1">// Set up the action bar list adapter</span>
        <span class="n">actionBarNavListAdapter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GraphActivityNavigationSpinnerAdapter</span><span class="o">();</span>
        <span class="n">actionBar</span><span class="o">.</span><span class="na">setListNavigationCallbacks</span><span class="o">(</span>
                <span class="c1">// Specify a SpinnerAdapter to populate the dropdown list.</span>
                <span class="n">actionBarNavListAdapter</span><span class="o">,</span>
                <span class="k">this</span><span class="o">);</span>

        <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">AreaDataService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">datasets</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">getApplicationContext</span><span class="o">().</span><span class="na">bindService</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">mAreaDataServiceConnection</span><span class="o">,</span> <span class="n">BIND_AUTO_CREATE</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">actionBar</span><span class="o">.</span><span class="na">setSelectedNavigationItem</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRestoreInstanceState</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Restore the previously serialized current dropdown position.</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">savedInstanceState</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">STATE_SELECTED_NAVIGATION_ITEM</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">getActionBar</span><span class="o">().</span><span class="na">setSelectedNavigationItem</span><span class="o">(</span>
                    <span class="n">savedInstanceState</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="n">STATE_SELECTED_NAVIGATION_ITEM</span><span class="o">));</span>
            <span class="n">setProgressBarIndeterminateVisibility</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSaveInstanceState</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">outState</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Serialize the current dropdown position.</span>
        <span class="n">outState</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="n">STATE_SELECTED_NAVIGATION_ITEM</span><span class="o">,</span>
                <span class="n">getActionBar</span><span class="o">().</span><span class="na">getSelectedNavigationIndex</span><span class="o">());</span>
        <span class="n">outState</span><span class="o">.</span><span class="na">putSerializable</span><span class="o">(</span><span class="n">STATE_DATASETS</span><span class="o">,</span> <span class="n">datasets</span><span class="o">);</span>
        <span class="n">outState</span><span class="o">.</span><span class="na">putSerializable</span><span class="o">(</span><span class="n">GRAPH_AREA</span><span class="o">,</span> <span class="n">area</span><span class="o">);</span>
        <span class="n">outState</span><span class="o">.</span><span class="na">putSerializable</span><span class="o">(</span><span class="n">GRAPH_DATASET_FAMILY</span><span class="o">,</span> <span class="n">family</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onCreateOptionsMenu</span><span class="o">(</span><span class="n">Menu</span> <span class="n">menu</span><span class="o">)</span> <span class="o">{</span>
        
        <span class="c1">// Inflate the menu; this adds items to the action bar if it is present.</span>
        <span class="n">getMenuInflater</span><span class="o">().</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">menu</span><span class="o">.</span><span class="na">graph</span><span class="o">,</span> <span class="n">menu</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onOptionsItemSelected</span><span class="o">(</span><span class="n">MenuItem</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Handle action bar item clicks here. The action bar will</span>
        <span class="c1">// automatically handle clicks on the Home/Up button, so long</span>
        <span class="c1">// as you specify a parent activity in AndroidManifest.xml.</span>
        <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="na">getItemId</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">action_settings</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">onOptionsItemSelected</span><span class="o">(</span><span class="n">item</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onNavigationItemSelected</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;GraphActivity&quot;</span><span class="o">,</span> <span class="s">&quot;onNavigationItemSelected(position = &quot;</span><span class="o">+</span><span class="n">position</span><span class="o">+</span><span class="s">&quot;)&quot;</span><span class="o">);</span>
        <span class="c1">// When the given dropdown item is selected, show its contents in the</span>
        <span class="c1">// container view.</span>
        <span class="k">if</span><span class="o">(</span><span class="n">datasets</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">datasets</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()){</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;GraphActivity&quot;</span><span class="o">,</span> <span class="s">&quot;Selecting dataset with position &quot;</span> <span class="o">+</span> <span class="n">position</span><span class="o">);</span>
            <span class="n">Dataset</span> <span class="n">dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">dateRangeTable</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">dateLabelsArray</span><span class="o">[</span><span class="n">position</span><span class="o">]));</span>
            <span class="n">getFragmentManager</span><span class="o">().</span><span class="na">beginTransaction</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">container</span><span class="o">,</span> <span class="n">DatasetGraphFragment</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">dataset</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">commit</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Gets called when the datasets from the current dataset family are ready for processing.</span>
<span class="cm">     * @param datasets the datasets, referenced by date ranges</span>
<span class="cm">     * @see lamparski.areabase.services.AreaDataService.DatasetDumpCallbacks#datasetsDownloaded(java.util.HashMap)</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">datasetsDownloaded</span><span class="o">(</span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">DateRange</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">datasets</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">&quot;GraphActivity&quot;</span><span class="o">,</span>
                <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%d datasets arrived in %dms, enabling navigation...&quot;</span><span class="o">,</span>
                        <span class="n">datasets</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">dbgDatasetPullStart</span><span class="o">));</span>
        <span class="n">setProgressBarIndeterminateVisibility</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">datasets</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">;</span>
        <span class="n">actionBarNavListAdapter</span><span class="o">.</span><span class="na">notifyDatasetChanged</span><span class="o">();</span>
        <span class="n">actionBar</span><span class="o">.</span><span class="na">setSelectedNavigationItem</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Generic callback for when errors happen</span>
<span class="cm">     * @param tr the throwable that caused the error</span>
<span class="cm">     * @see lamparski.areabase.utils.OnError#onError(Throwable)</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">tr</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Crouton</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error_cannot_fetch_area_data</span><span class="o">),</span> <span class="n">Style</span><span class="o">.</span><span class="na">ALERT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;GraphActivity&quot;</span><span class="o">,</span> <span class="s">&quot;Error downloading datasets&quot;</span><span class="o">,</span> <span class="n">tr</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * A SpinnerAdapter for the navigation between the time periods for which data is available.</span>
<span class="cm">     *</span>
<span class="cm">     * @see android.widget.SpinnerAdapter</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">GraphActivityNavigationSpinnerAdapter</span> <span class="kd">implements</span> <span class="n">SpinnerAdapter</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">DataSetObserver</span><span class="o">&gt;</span> <span class="n">observers</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">GraphActivityNavigationSpinnerAdapter</span><span class="o">(){</span>
            <span class="n">observers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">DataSetObserver</span><span class="o">&gt;();</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">View</span> <span class="nf">getDropDownView</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="n">View</span> <span class="n">convertView</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">getView</span><span class="o">(</span><span class="n">position</span><span class="o">,</span> <span class="n">convertView</span><span class="o">,</span> <span class="n">parent</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerDataSetObserver</span><span class="o">(</span><span class="n">DataSetObserver</span> <span class="n">observer</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;GraphActivity&quot;</span><span class="o">,</span> <span class="s">&quot;SpinnerAdapter: request to register observer &quot;</span> <span class="o">+</span> <span class="n">observer</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="n">observers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">observer</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unregisterDataSetObserver</span><span class="o">(</span><span class="n">DataSetObserver</span> <span class="n">observer</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;GraphActivity&quot;</span><span class="o">,</span> <span class="s">&quot;SpinnerAdapter: request to unregister observer &quot;</span> <span class="o">+</span> <span class="n">observer</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="n">observers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">observer</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getCount</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">datasets</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">datasets</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">:</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getItem</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">datasets</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">dateRangeTable</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">dateLabelsArray</span><span class="o">[</span><span class="n">position</span><span class="o">]));</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getItemId</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">position</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasStableIds</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">View</span> <span class="nf">getView</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="n">View</span> <span class="n">convertView</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;GraphActivity&quot;</span><span class="o">,</span>
                    <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;actionbar list getView(position = %d, convertView = %s); datasets: %s&quot;</span><span class="o">,</span>
                            <span class="n">position</span><span class="o">,</span>
                            <span class="n">convertView</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">convertView</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span> <span class="o">:</span> <span class="s">&quot;null&quot;</span><span class="o">,</span>
                            <span class="n">datasets</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">datasets</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; items&quot;</span> <span class="o">:</span> <span class="s">&quot;null&quot;</span><span class="o">));</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;GraphActivity&quot;</span><span class="o">,</span>
                    <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;... dateLabelsArray.length = %d, dateLabelsArray[position] = %s&quot;</span><span class="o">,</span>
                            <span class="n">dateLabelsArray</span><span class="o">.</span><span class="na">length</span><span class="o">,</span>
                            <span class="n">dateLabelsArray</span><span class="o">[</span><span class="n">position</span><span class="o">]));</span>
            <span class="k">if</span><span class="o">(</span><span class="n">convertView</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
                <span class="n">convertView</span> <span class="o">=</span> <span class="n">getLayoutInflater</span><span class="o">().</span><span class="na">inflate</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">simple_dropdown_item_1line</span><span class="o">,</span> <span class="n">parent</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">text1</span><span class="o">)).</span><span class="na">setText</span><span class="o">(</span><span class="n">dateLabelsArray</span><span class="o">[</span><span class="n">position</span><span class="o">]);</span>

            <span class="k">return</span> <span class="n">convertView</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getItemViewType</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getViewTypeCount</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEmpty</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">datasets</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">datasets</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="cm">/**</span>
<span class="cm">         * This should get called when the underlying dataset for this adapter</span>
<span class="cm">         * (note that this means the list of available time periods and NOT the actual dataesets)</span>
<span class="cm">         * has changed (ie. the asynchronous fetch operation has finished). This will</span>
<span class="cm">         * notify the action bar ListView spinner thingy</span>
<span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">notifyDatasetChanged</span><span class="o">(){</span>
            <span class="k">if</span><span class="o">(</span><span class="n">datasets</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                <span class="k">for</span><span class="o">(</span><span class="n">DataSetObserver</span> <span class="n">observer</span> <span class="o">:</span> <span class="n">observers</span><span class="o">){</span>
                    <span class="n">observer</span><span class="o">.</span><span class="na">onChanged</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">SettingsActivity <small>lamparski.areabase</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.annotation.TargetApi</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.app.FragmentManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Build</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.preference.Preference</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.preference.Preference.OnPreferenceClickListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.preference.PreferenceActivity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.preference.PreferenceFragment</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">de.keyboardsurfer.android.widget.crouton.Crouton</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">de.keyboardsurfer.android.widget.crouton.Style</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Handles settings.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SettingsActivity</span> <span class="kd">extends</span> <span class="n">PreferenceActivity</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">ALWAYS_SIMPLE_PREFERENCES</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">UNIX_30_DAYS</span> <span class="o">=</span> <span class="mi">1000</span><span class="n">l</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">30</span><span class="o">;</span>

	<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isSimplePrefs</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">ALWAYS_SIMPLE_PREFERENCES</span>
				<span class="o">||</span> <span class="n">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&lt;</span> <span class="n">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">HONEYCOMB</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see android.preference.PreferenceActivity#isMultiPane()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isMultiPane</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">// TODO Auto-generated method stub</span>
		<span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">isMultiPane</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see android.preference.PreferenceActivity#onCreate(android.os.Bundle)</span>
<span class="cm">	 */</span>
	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;deprecation&quot;</span><span class="o">)</span>
	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// TODO Auto-generated method stub</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">isSimplePrefs</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">addPreferencesFromResource</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">preferences</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="n">createPreferencesFragment</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@TargetApi</span><span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">HONEYCOMB</span><span class="o">)</span>
	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">createPreferencesFragment</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">FragmentManager</span> <span class="n">mgr</span> <span class="o">=</span> <span class="n">getFragmentManager</span><span class="o">();</span>
		<span class="n">mgr</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">()</span>
				<span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">content</span><span class="o">,</span> <span class="k">new</span> <span class="n">MyPreferenceFragment</span><span class="o">())</span>
				<span class="o">.</span><span class="na">commit</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@TargetApi</span><span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">HONEYCOMB</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MyPreferenceFragment</span> <span class="kd">extends</span> <span class="n">PreferenceFragment</span> <span class="o">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * (non-Javadoc)</span>
<span class="cm">		 * </span>
<span class="cm">		 * @see</span>
<span class="cm">		 * android.preference.PreferenceFragment#onCreate(android.os.Bundle)</span>
<span class="cm">		 */</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
			<span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
			<span class="n">addPreferencesFromResource</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">preferences</span><span class="o">);</span>
            <span class="n">Preference</span> <span class="n">clearOldData</span> <span class="o">=</span> <span class="o">(</span><span class="n">Preference</span><span class="o">)</span> <span class="n">findPreference</span><span class="o">(</span><span class="s">&quot;pref_storage_remove_old_data&quot;</span><span class="o">);</span>
            <span class="k">assert</span> <span class="n">clearOldData</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">clearOldData</span><span class="o">.</span><span class="na">setOnPreferenceClickListener</span><span class="o">(</span><span class="k">new</span> <span class="n">OnPreferenceClickListener</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onPreferenceClick</span><span class="o">(</span><span class="n">Preference</span> <span class="n">preference</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                        <span class="n">String</span><span class="o">[]</span> <span class="n">whereArgs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span> <span class="n">Long</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">UNIX_30_DAYS</span><span class="o">)</span> <span class="o">};</span>
                        <span class="n">getActivity</span><span class="o">().</span><span class="na">getContentResolver</span><span class="o">().</span><span class="na">delete</span><span class="o">(</span><span class="n">CacheContentProvider</span><span class="o">.</span><span class="na">AREARANK_CACHE_URI</span><span class="o">,</span> <span class="s">&quot;computedOn &lt; ?&quot;</span><span class="o">,</span> <span class="n">whereArgs</span><span class="o">);</span>
                        <span class="n">getActivity</span><span class="o">().</span><span class="na">getContentResolver</span><span class="o">().</span><span class="na">delete</span><span class="o">(</span><span class="n">CacheContentProvider</span><span class="o">.</span><span class="na">ONS_CACHE_URI</span><span class="o">,</span> <span class="s">&quot;retrievedOn &lt; ?&quot;</span><span class="o">,</span> <span class="n">whereArgs</span><span class="o">);</span>
                        <span class="n">getActivity</span><span class="o">().</span><span class="na">getContentResolver</span><span class="o">().</span><span class="na">delete</span><span class="o">(</span><span class="n">CacheContentProvider</span><span class="o">.</span><span class="na">MAPIT_CACHE_URI</span><span class="o">,</span> <span class="s">&quot;retrievedOn &lt; ?&quot;</span><span class="o">,</span> <span class="n">whereArgs</span><span class="o">);</span>
                        <span class="n">getActivity</span><span class="o">().</span><span class="na">getContentResolver</span><span class="o">().</span><span class="na">delete</span><span class="o">(</span><span class="n">CacheContentProvider</span><span class="o">.</span><span class="na">POLICE_CACHE_URI</span><span class="o">,</span> <span class="s">&quot;retrievedOn &lt; ?&quot;</span><span class="o">,</span> <span class="n">whereArgs</span><span class="o">);</span>
                        <span class="n">Crouton</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="s">&quot;All done!&quot;</span><span class="o">,</span> <span class="n">Style</span><span class="o">.</span><span class="na">CONFIRM</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
                        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">Preference</span> <span class="n">clearScores</span> <span class="o">=</span> <span class="o">(</span><span class="n">Preference</span><span class="o">)</span> <span class="n">findPreference</span><span class="o">(</span><span class="s">&quot;pref_storage_reset_scores&quot;</span><span class="o">);</span>
            <span class="k">assert</span> <span class="n">clearScores</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">clearScores</span><span class="o">.</span><span class="na">setOnPreferenceClickListener</span><span class="o">(</span><span class="k">new</span> <span class="n">OnPreferenceClickListener</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onPreferenceClick</span><span class="o">(</span><span class="n">Preference</span> <span class="n">preference</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                        <span class="cm">/**</span>
<span class="cm">                         * DELETE FROM areaRank;</span>
<span class="cm">                         */</span>
                        <span class="n">getActivity</span><span class="o">().</span><span class="na">getContentResolver</span><span class="o">().</span><span class="na">delete</span><span class="o">(</span><span class="n">CacheContentProvider</span><span class="o">.</span><span class="na">AREARANK_CACHE_URI</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]{});</span>
                        <span class="n">Crouton</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="s">&quot;All done!&quot;</span><span class="o">,</span> <span class="n">Style</span><span class="o">.</span><span class="na">CONFIRM</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
                        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">});</span>
		<span class="o">}</span>

	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">CrimeCardProvider <small>lamparski.areabase.cardproviders</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">cardproviders</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.content.res.Resources</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.fima.cardsui.objects.CardModel</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.mysociety.mapit.Mapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xml.sax.SAXException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParserException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Locale</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map.Entry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.NoSuchElementException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.xml.parsers.ParserConfigurationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.xpath.XPathExpressionException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lamparski.areabase.R</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.cards.PlayCard</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.map_support.HoloCSSColourValues</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.errors.NDE2Exception</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.helpers.ArrayHelpers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.helpers.CensusHelpers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.helpers.Statistics</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.methodcalls.delivery.GetTables</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.methodcalls.discovery.GetCompatibleSubjects</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.methodcalls.discovery.GetDatasetFamilies</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DataSetFamily</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DateRange</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Subject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Topic</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">police.errors.APIException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">police.methodcalls.CrimeAvailabilityMethodCall</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">police.methodcalls.CrimeCategoriesMethodCall</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">police.methodcalls.StreetLevelCrimeMethodCall</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">police.types.Crime</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Contains functions that perform crime data analysis, and provide</span>
<span class="cm"> * a card model for the summary card.</span>
<span class="cm"> *</span>
<span class="cm"> * @author filip</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CrimeCardProvider</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">double</span> <span class="n">TREND_STABLE_UPPER_THRESHOLD</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">double</span> <span class="n">TREND_STABLE_LOWER_THRESHOLD</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">double</span> <span class="n">TREND_RAPID_UPPER_THRESHOLD</span> <span class="o">=</span> <span class="mi">40</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">double</span> <span class="n">TREND_RAPID_LOWER_THRESHOLD</span> <span class="o">=</span> <span class="o">-</span><span class="mi">40</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">UNIX_30_DAYS</span> <span class="o">=</span> <span class="mi">1000</span><span class="n">l</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">30</span><span class="o">;</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ONS_NOTIFIABLE_OFFENCES_RECORDED_BY_POLICE</span> <span class="o">=</span> <span class="mi">904</span><span class="o">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * Generates a summary of crime data for the area</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param area</span>
<span class="cm">	 *            The area to query.</span>
<span class="cm">	 * @param res</span>
<span class="cm">	 *            Used to build the text.</span>
<span class="cm">	 * @return A card containing the summary of crime in the area.</span>
<span class="cm">	 * @throws Exception</span>
<span class="cm">	 * @throws NDE2Exception</span>
<span class="cm">	 * @throws IOException</span>
<span class="cm">	 * @throws SAXException</span>
<span class="cm">	 * @throws ParserConfigurationException</span>
<span class="cm">	 * @throws XPathExpressionException</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="n">CardModel</span> <span class="nf">crimeCardForArea</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">,</span> <span class="n">Resources</span> <span class="n">res</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">XPathExpressionException</span><span class="o">,</span> <span class="n">ParserConfigurationException</span><span class="o">,</span>
			<span class="n">SAXException</span><span class="o">,</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">NDE2Exception</span><span class="o">,</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="kt">double</span><span class="o">[][]</span> <span class="n">areaPolygon</span> <span class="o">=</span> <span class="n">Mapper</span><span class="o">.</span><span class="na">getGeometryForArea</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
		<span class="kt">double</span><span class="o">[][]</span> <span class="n">simplifiedPolygon</span> <span class="o">=</span> <span class="n">ArrayHelpers</span><span class="o">.</span><span class="na">every_nth_pair</span><span class="o">(</span><span class="n">areaPolygon</span><span class="o">,</span>
				<span class="mi">10</span><span class="o">);</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="n">Collection</span><span class="o">&lt;</span><span class="n">Crime</span><span class="o">&gt;</span> <span class="n">policeDataCrimes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StreetLevelCrimeMethodCall</span><span class="o">()</span>
					<span class="o">.</span><span class="na">addAreaPolygon</span><span class="o">(</span><span class="n">simplifiedPolygon</span><span class="o">).</span><span class="na">getStreetLevelCrime</span><span class="o">();</span>
			<span class="n">CardModel</span> <span class="n">mdl</span> <span class="o">=</span> <span class="n">crimeCardForArea_policeData</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="n">policeDataCrimes</span><span class="o">,</span>
					<span class="n">simplifiedPolygon</span><span class="o">,</span> <span class="n">res</span><span class="o">);</span>
			<span class="n">mdl</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="n">areaPolygon</span><span class="o">);</span>
			<span class="k">return</span> <span class="n">mdl</span><span class="o">;</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">APIException</span> <span class="n">apiex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="nf">crimeCardForArea_censusData</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="n">res</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="n">CardModel</span> <span class="nf">crimeCardForArea_policeData</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">,</span>
			<span class="n">Collection</span><span class="o">&lt;</span><span class="n">Crime</span><span class="o">&gt;</span> <span class="n">policeDataCrimes</span><span class="o">,</span> <span class="kt">double</span><span class="o">[][]</span> <span class="n">areaPolygon</span><span class="o">,</span>
			<span class="n">Resources</span> <span class="n">res</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">dataCube</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;();</span>
		<span class="n">CrimeAvailabilityMethodCall</span> <span class="n">avail</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CrimeAvailabilityMethodCall</span><span class="o">();</span>
		<span class="n">Date</span> <span class="n">latestAvailable</span> <span class="o">=</span> <span class="n">avail</span><span class="o">.</span><span class="na">getLastUpdated</span><span class="o">();</span>
		<span class="n">List</span><span class="o">&lt;</span><span class="n">Date</span><span class="o">&gt;</span> <span class="n">availableDates</span> <span class="o">=</span> <span class="n">avail</span><span class="o">.</span><span class="na">getAvailableDates</span><span class="o">();</span>
		<span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">common_crime_array</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">firstSlice</span> <span class="o">=</span> <span class="n">crimeSlice</span><span class="o">(</span><span class="n">policeDataCrimes</span><span class="o">);</span>
		<span class="n">dataCube</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">latestAvailable</span><span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">/</span> <span class="n">UNIX_30_DAYS</span><span class="o">,</span> <span class="n">firstSlice</span><span class="o">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * This will ensure we only take last 12 months, not the whole available</span>
<span class="cm">		 * range.</span>
<span class="cm">		 */</span>
		<span class="n">Collections</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">availableDates</span><span class="o">);</span>
		<span class="n">Collections</span><span class="o">.</span><span class="na">reverse</span><span class="o">(</span><span class="n">availableDates</span><span class="o">);</span>
		<span class="n">availableDates</span> <span class="o">=</span> <span class="n">availableDates</span><span class="o">.</span><span class="na">subList</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">12</span><span class="o">);</span>

		<span class="n">Date</span> <span class="n">earliestDate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">();</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">Date</span> <span class="n">n</span> <span class="o">:</span> <span class="n">availableDates</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">slice</span> <span class="o">=</span> <span class="n">firstSlice</span><span class="o">;</span>
			<span class="k">if</span> <span class="o">(!(</span><span class="n">n</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">latestAvailable</span><span class="o">)))</span> <span class="o">{</span>
				<span class="n">Collection</span><span class="o">&lt;</span><span class="n">Crime</span><span class="o">&gt;</span> <span class="n">crimesForDate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StreetLevelCrimeMethodCall</span><span class="o">()</span>
						<span class="o">.</span><span class="na">addAreaPolygon</span><span class="o">(</span><span class="n">areaPolygon</span><span class="o">).</span><span class="na">addDate</span><span class="o">(</span><span class="n">n</span><span class="o">)</span>
						<span class="o">.</span><span class="na">getStreetLevelCrime</span><span class="o">();</span>
				<span class="n">slice</span> <span class="o">=</span> <span class="n">crimeSlice</span><span class="o">(</span><span class="n">crimesForDate</span><span class="o">);</span>
				<span class="n">dataCube</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">n</span><span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">/</span> <span class="n">UNIX_30_DAYS</span><span class="o">,</span> <span class="n">slice</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">n</span><span class="o">.</span><span class="na">before</span><span class="o">(</span><span class="n">earliestDate</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">earliestDate</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="n">common_crime_array</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">mostCommonCrime_police</span><span class="o">(</span><span class="n">slice</span><span class="o">));</span>
		<span class="o">}</span>

		<span class="kt">double</span> <span class="n">gradient</span> <span class="o">=</span> <span class="n">calculateCrimeGradient</span><span class="o">(</span><span class="n">dataCube</span><span class="o">);</span>
		<span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">&quot;linear-regression&quot;</span><span class="o">,</span>
				<span class="s">&quot;The OLS linear regression for this dataset is &quot;</span> <span class="o">+</span> <span class="n">gradient</span><span class="o">);</span>

		<span class="n">String</span> <span class="n">most_common_crime</span> <span class="o">=</span> <span class="n">ArrayHelpers</span><span class="o">.</span><span class="na">mostCommon</span><span class="o">(</span><span class="n">common_crime_array</span><span class="o">);</span>

		<span class="k">return</span> <span class="nf">makeCard</span><span class="o">(</span><span class="n">res</span><span class="o">,</span> <span class="n">area</span><span class="o">,</span> <span class="n">most_common_crime</span><span class="o">,</span> <span class="n">gradient</span><span class="o">);</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Calculates the crime trend. This is used by AreaRank.</span>
<span class="cm">     * @param area the area to find the trend for.</span>
<span class="cm">     * @return linear regression trend (the b in y = a + bx)</span>
<span class="cm">     * @throws Exception</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">double</span> <span class="nf">getCrimeTrend</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="kt">double</span><span class="o">[][]</span> <span class="n">areaPolygon</span> <span class="o">=</span> <span class="n">Mapper</span><span class="o">.</span><span class="na">getGeometryForArea</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
        <span class="kt">double</span><span class="o">[][]</span> <span class="n">simplifiedPolygon</span> <span class="o">=</span> <span class="n">ArrayHelpers</span><span class="o">.</span><span class="na">every_nth_pair</span><span class="o">(</span><span class="n">areaPolygon</span><span class="o">,</span>
                <span class="mi">10</span><span class="o">);</span>

        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Crime</span><span class="o">&gt;</span> <span class="n">policeDataCrimes</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="n">policeDataCrimes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StreetLevelCrimeMethodCall</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">addAreaPolygon</span><span class="o">(</span><span class="n">simplifiedPolygon</span><span class="o">).</span><span class="na">getStreetLevelCrime</span><span class="o">();</span>
            <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">dataCube</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;();</span>
            <span class="n">CrimeAvailabilityMethodCall</span> <span class="n">avail</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CrimeAvailabilityMethodCall</span><span class="o">();</span>
            <span class="n">Date</span> <span class="n">latestAvailable</span> <span class="o">=</span> <span class="n">avail</span><span class="o">.</span><span class="na">getLastUpdated</span><span class="o">();</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">Date</span><span class="o">&gt;</span> <span class="n">availableDates</span> <span class="o">=</span> <span class="n">avail</span><span class="o">.</span><span class="na">getAvailableDates</span><span class="o">();</span>
            <span class="n">dataCube</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">latestAvailable</span><span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">/</span> <span class="n">UNIX_30_DAYS</span><span class="o">,</span> <span class="n">crimeSlice</span><span class="o">(</span><span class="n">policeDataCrimes</span><span class="o">));</span>

            <span class="cm">/*</span>
<span class="cm">             * This will ensure we only take last 12 months, not the whole available</span>
<span class="cm">             * range.</span>
<span class="cm">             */</span>
            <span class="n">Collections</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">availableDates</span><span class="o">);</span>
            <span class="n">Collections</span><span class="o">.</span><span class="na">reverse</span><span class="o">(</span><span class="n">availableDates</span><span class="o">);</span>
            <span class="n">availableDates</span> <span class="o">=</span> <span class="n">availableDates</span><span class="o">.</span><span class="na">subList</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">12</span><span class="o">);</span>

            <span class="n">Date</span> <span class="n">earliestDate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">Date</span> <span class="n">n</span> <span class="o">:</span> <span class="n">availableDates</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!(</span><span class="n">n</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">latestAvailable</span><span class="o">)))</span> <span class="o">{</span>
                    <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Crime</span><span class="o">&gt;</span> <span class="n">crimesForDate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StreetLevelCrimeMethodCall</span><span class="o">()</span>
                            <span class="o">.</span><span class="na">addAreaPolygon</span><span class="o">(</span><span class="n">simplifiedPolygon</span><span class="o">).</span><span class="na">addDate</span><span class="o">(</span><span class="n">n</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">getStreetLevelCrime</span><span class="o">();</span>
                    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">slice</span> <span class="o">=</span> <span class="n">crimeSlice</span><span class="o">(</span><span class="n">crimesForDate</span><span class="o">);</span>
                    <span class="n">dataCube</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">n</span><span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">/</span> <span class="n">UNIX_30_DAYS</span><span class="o">,</span> <span class="n">slice</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">n</span><span class="o">.</span><span class="na">before</span><span class="o">(</span><span class="n">earliestDate</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">earliestDate</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="k">return</span> <span class="nf">calculateCrimeGradient</span><span class="o">(</span><span class="n">dataCube</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">APIException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">DataSetFamily</span> <span class="n">crimeFamily</span> <span class="o">=</span> <span class="n">getCrimeFamily</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
            <span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">theDatasets</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;();</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">DateRange</span> <span class="n">r</span> <span class="o">:</span> <span class="n">crimeFamily</span><span class="o">.</span><span class="na">getDateRanges</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">currentDataset</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GetTables</span><span class="o">().</span><span class="na">forArea</span><span class="o">(</span><span class="n">area</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">inFamily</span><span class="o">(</span><span class="n">crimeFamily</span><span class="o">).</span><span class="na">inDateRange</span><span class="o">(</span><span class="n">r</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>
                <span class="n">theDatasets</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">currentDataset</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="kt">long</span> <span class="n">earliestDate</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">latestDate</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

            <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">onsDatacube</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;();</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">Dataset</span> <span class="n">d</span> <span class="o">:</span> <span class="n">theDatasets</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">long</span> <span class="n">date</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="na">getPeriods</span><span class="o">().</span><span class="na">values</span><span class="o">().</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">().</span><span class="na">getEndDate</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">getTime</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">earliestDate</span> <span class="o">&amp;&amp;</span> <span class="n">earliestDate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">earliestDate</span> <span class="o">=</span> <span class="n">date</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">date</span> <span class="o">&gt;</span> <span class="n">latestDate</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">latestDate</span> <span class="o">=</span> <span class="n">date</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">crimeSlice</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;();</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">Topic</span> <span class="n">t</span> <span class="o">:</span> <span class="n">d</span><span class="o">.</span><span class="na">getTopics</span><span class="o">().</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">();</span>
                    <span class="kt">int</span> <span class="n">value</span><span class="o">;</span>
                    <span class="k">try</span><span class="o">{</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">d</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">().</span><span class="na">getValue</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchElementException</span> <span class="n">nsee</span><span class="o">){</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">crimeSlice</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">onsDatacube</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">date</span><span class="o">,</span> <span class="n">crimeSlice</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="k">return</span> <span class="nf">calculateCrimeGradient</span><span class="o">(</span><span class="n">onsDatacube</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * This method uses Ordinary Least Squares linear regression</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param dataCube datacube (a map of dates to the crimes that happened)</span>
<span class="cm">	 * @return b of the OLS for dataCube</span>
<span class="cm">	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">double</span> <span class="nf">calculateCrimeGradient</span><span class="o">(</span>
			<span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">dataCube</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">crimesForDate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;();</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;calculateCrimeGradient&quot;</span><span class="o">,</span> <span class="s">&quot;Date;Total crimes&quot;</span><span class="o">);</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">sliceWithDate</span> <span class="o">:</span> <span class="n">dataCube</span>
				<span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">totalForDate</span> <span class="o">=</span> <span class="n">totalCrimes</span><span class="o">(</span><span class="n">sliceWithDate</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
			<span class="n">crimesForDate</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">sliceWithDate</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span>
					<span class="n">totalForDate</span><span class="o">);</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;calculateCrimeGradient&quot;</span><span class="o">,</span>
                    <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%d;%d&quot;</span><span class="o">,</span> <span class="n">sliceWithDate</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">totalForDate</span><span class="o">));</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="n">Statistics</span><span class="o">.</span><span class="na">linearRegressionGradient</span><span class="o">(</span><span class="n">crimesForDate</span><span class="o">);</span>
	<span class="o">}</span>


    <span class="kd">private</span> <span class="kd">static</span> <span class="n">DataSetFamily</span> <span class="nf">getCrimeFamily</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">NDE2Exception</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Subject</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">subjects</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GetCompatibleSubjects</span><span class="o">(</span><span class="n">area</span><span class="o">)</span>
                <span class="o">.</span><span class="na">execute</span><span class="o">();</span>
        <span class="n">Subject</span> <span class="n">crimeSubject</span> <span class="o">=</span> <span class="n">CensusHelpers</span><span class="o">.</span><span class="na">findSubject</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="s">&quot;Crime and Safety&quot;</span><span class="o">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">&gt;</span> <span class="n">families</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GetDatasetFamilies</span><span class="o">(</span><span class="n">crimeSubject</span><span class="o">)</span>
                <span class="o">.</span><span class="na">forArea</span><span class="o">(</span><span class="n">area</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>
        <span class="n">DataSetFamily</span> <span class="n">crimeFamily</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">DataSetFamily</span> <span class="n">f</span> <span class="o">:</span> <span class="n">families</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">getFamilyId</span><span class="o">()</span> <span class="o">==</span> <span class="n">ONS_NOTIFIABLE_OFFENCES_RECORDED_BY_POLICE</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">crimeFamily</span> <span class="o">=</span> <span class="n">f</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">crimeFamily</span><span class="o">;</span>
    <span class="o">}</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="n">CardModel</span> <span class="nf">crimeCardForArea_censusData</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">,</span>
			<span class="n">Resources</span> <span class="n">res</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span><span class="o">,</span>
			<span class="n">NDE2Exception</span> <span class="o">{</span>
		<span class="n">DataSetFamily</span> <span class="n">crimeFamily</span> <span class="o">=</span> <span class="n">getCrimeFamily</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>

		<span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">theDatasets</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;();</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">DateRange</span> <span class="n">r</span> <span class="o">:</span> <span class="n">crimeFamily</span><span class="o">.</span><span class="na">getDateRanges</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">currentDataset</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GetTables</span><span class="o">().</span><span class="na">forArea</span><span class="o">(</span><span class="n">area</span><span class="o">)</span>
					<span class="o">.</span><span class="na">inFamily</span><span class="o">(</span><span class="n">crimeFamily</span><span class="o">).</span><span class="na">inDateRange</span><span class="o">(</span><span class="n">r</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>
			<span class="n">theDatasets</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">currentDataset</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="kt">long</span> <span class="n">earliestDate</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">latestDate</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">most_common_array</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>

		<span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">onsDatacube</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;();</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">Dataset</span> <span class="n">d</span> <span class="o">:</span> <span class="n">theDatasets</span><span class="o">)</span> <span class="o">{</span>
			<span class="kt">long</span> <span class="n">date</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="na">getPeriods</span><span class="o">().</span><span class="na">values</span><span class="o">().</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">().</span><span class="na">getEndDate</span><span class="o">()</span>
					<span class="o">.</span><span class="na">getTime</span><span class="o">();</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">earliestDate</span> <span class="o">&amp;&amp;</span> <span class="n">earliestDate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">earliestDate</span> <span class="o">=</span> <span class="n">date</span><span class="o">;</span>
            <span class="o">}</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">date</span> <span class="o">&gt;</span> <span class="n">latestDate</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">latestDate</span> <span class="o">=</span> <span class="n">date</span><span class="o">;</span>
            <span class="o">}</span>
			<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">crimeSlice</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;();</span>
			<span class="k">for</span> <span class="o">(</span><span class="n">Topic</span> <span class="n">t</span> <span class="o">:</span> <span class="n">d</span><span class="o">.</span><span class="na">getTopics</span><span class="o">().</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">();</span>
                <span class="k">try</span><span class="o">{</span>
				    <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">d</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">().</span><span class="na">getValue</span><span class="o">();</span>
                    <span class="n">crimeSlice</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchElementException</span> <span class="n">ex</span><span class="o">){</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="o">}</span>
			<span class="o">}</span>
			<span class="n">most_common_array</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">mostCommonCrime_ons</span><span class="o">(</span><span class="n">crimeSlice</span><span class="o">));</span>
			<span class="n">onsDatacube</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">date</span><span class="o">,</span> <span class="n">crimeSlice</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="n">String</span> <span class="n">most_common_crime</span> <span class="o">=</span> <span class="n">ArrayHelpers</span><span class="o">.</span><span class="na">mostCommon</span><span class="o">(</span><span class="n">most_common_array</span><span class="o">);</span>

		<span class="kt">double</span> <span class="n">dYdX</span> <span class="o">=</span> <span class="n">calculateCrimeGradient</span><span class="o">(</span><span class="n">onsDatacube</span><span class="o">);</span>

		<span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">&quot;linear-regression&quot;</span><span class="o">,</span>
				<span class="s">&quot;The OLS linear regression for this dataset is &quot;</span> <span class="o">+</span> <span class="n">dYdX</span><span class="o">);</span>

		<span class="k">return</span> <span class="nf">makeCard</span><span class="o">(</span><span class="n">res</span><span class="o">,</span> <span class="n">area</span><span class="o">,</span> <span class="n">most_common_crime</span><span class="o">,</span> <span class="n">dYdX</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="n">CardModel</span> <span class="nf">makeCard</span><span class="o">(</span><span class="n">Resources</span> <span class="n">res</span><span class="o">,</span> <span class="n">Area</span> <span class="n">area</span><span class="o">,</span>
			<span class="n">String</span> <span class="n">most_common_crime</span><span class="o">,</span> <span class="kt">double</span> <span class="n">gradient</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">TrendDescription</span> <span class="n">trend_desc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TrendDescription</span><span class="o">();</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">gradient</span> <span class="o">&gt;</span> <span class="n">TREND_RAPID_LOWER_THRESHOLD</span>
				<span class="o">&amp;&amp;</span> <span class="n">gradient</span> <span class="o">&lt;=</span> <span class="n">TREND_STABLE_LOWER_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">trend_desc</span><span class="o">.</span><span class="na">which</span> <span class="o">=</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">FALLING</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">gradient</span> <span class="o">&gt;</span> <span class="n">TREND_STABLE_LOWER_THRESHOLD</span>
				<span class="o">&amp;&amp;</span> <span class="n">gradient</span> <span class="o">&lt;=</span> <span class="n">TREND_STABLE_UPPER_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">trend_desc</span><span class="o">.</span><span class="na">which</span> <span class="o">=</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">STABLE</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">gradient</span> <span class="o">&gt;</span> <span class="n">TREND_STABLE_UPPER_THRESHOLD</span>
				<span class="o">&amp;&amp;</span> <span class="n">gradient</span> <span class="o">&lt;=</span> <span class="n">TREND_RAPID_UPPER_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">trend_desc</span><span class="o">.</span><span class="na">which</span> <span class="o">=</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">RISING</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">gradient</span> <span class="o">&gt;</span> <span class="n">TREND_RAPID_UPPER_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">trend_desc</span><span class="o">.</span><span class="na">which</span> <span class="o">=</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">RISING_RAPIDLY</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">trend_desc</span><span class="o">.</span><span class="na">which</span> <span class="o">=</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">FALLING_RAPIDLY</span><span class="o">;</span>
        <span class="o">}</span>

		<span class="n">String</span> <span class="n">trend_desc_s</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="na">getStringArray</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">array</span><span class="o">.</span><span class="na">card_crime_real_trend</span><span class="o">)[</span><span class="n">trend_desc</span><span class="o">.</span><span class="na">which</span> <span class="o">+</span> <span class="mi">2</span><span class="o">];</span>
		<span class="n">String</span> <span class="n">body_s</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">card_crime_real_body_base</span><span class="o">,</span>
				<span class="n">most_common_crime</span><span class="o">,</span> <span class="n">trend_desc_s</span><span class="o">);</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">CardModel</span><span class="o">(</span><span class="n">res</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">card_crime_real_title</span><span class="o">,</span>
				<span class="n">area</span><span class="o">.</span><span class="na">getName</span><span class="o">()),</span> <span class="n">body_s</span><span class="o">,</span>
				<span class="n">HoloCSSColourValues</span><span class="o">.</span><span class="na">PINK</span><span class="o">.</span><span class="na">getCssValue</span><span class="o">(),</span>
				<span class="n">HoloCSSColourValues</span><span class="o">.</span><span class="na">PINK</span><span class="o">.</span><span class="na">getCssValue</span><span class="o">(),</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span>
				<span class="n">PlayCard</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">mostCommonCrime_police</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">slice</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">rawname</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">category</span> <span class="o">:</span> <span class="n">slice</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="n">slice</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">category</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">rawname</span> <span class="o">=</span> <span class="n">category</span><span class="o">;</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">slice</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">category</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">CrimeCategoriesMethodCall</span><span class="o">().</span><span class="na">getCrimeCategories</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">rawname</span><span class="o">).</span><span class="na">toLowerCase</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">mostCommonCrime_ons</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">slice</span><span class="o">)</span> <span class="o">{</span>
		<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">rawname</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">category</span> <span class="o">:</span> <span class="n">slice</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="n">slice</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">category</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">rawname</span> <span class="o">=</span> <span class="n">category</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">rawname</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">(</span><span class="n">Locale</span><span class="o">.</span><span class="na">UK</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">crimeSlice</span><span class="o">(</span>
			<span class="n">Collection</span><span class="o">&lt;</span><span class="n">Crime</span><span class="o">&gt;</span> <span class="n">policeDataCrimes</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">categoryTally</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;();</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">Crime</span> <span class="n">crime</span> <span class="o">:</span> <span class="n">policeDataCrimes</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(!(</span><span class="n">categoryTally</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">crime</span><span class="o">.</span><span class="na">getCategory</span><span class="o">())))</span> <span class="o">{</span>
				<span class="cm">/* Have we encountered a new category? */</span>
				<span class="n">categoryTally</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">crime</span><span class="o">.</span><span class="na">getCategory</span><span class="o">(),</span> <span class="mi">1</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
				<span class="cm">/* No? Increment an existing one then */</span>
				<span class="n">Integer</span> <span class="n">t</span> <span class="o">=</span> <span class="n">categoryTally</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">crime</span><span class="o">.</span><span class="na">getCategory</span><span class="o">());</span>
				<span class="n">t</span><span class="o">++;</span>
				<span class="n">categoryTally</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">crime</span><span class="o">.</span><span class="na">getCategory</span><span class="o">(),</span> <span class="n">t</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="n">categoryTally</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">totalCrimes</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">slice</span><span class="o">)</span> <span class="o">{</span>
		<span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

		<span class="k">for</span> <span class="o">(</span><span class="n">Integer</span> <span class="n">c</span> <span class="o">:</span> <span class="n">slice</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">sum</span> <span class="o">+=</span> <span class="n">c</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="n">sum</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">DemographicsCardProvider <small>lamparski.areabase.cardproviders</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">cardproviders</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.annotation.SuppressLint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.res.Resources</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.fima.cardsui.objects.CardModel</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParserException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.Matcher</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.Pattern</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lamparski.areabase.R</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.cards.PlayCard</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.map_support.HoloCSSColourValues</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.errors.InvalidParameterException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.errors.NDE2Exception</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.errors.ValueNotAvailable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.methodcalls.delivery.GetTables</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DataSetFamily</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DataSetItem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Subject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Topic</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">nde2</span><span class="o">.</span><span class="na">helpers</span><span class="o">.</span><span class="na">CensusHelpers</span><span class="o">.</span><span class="na">findRequiredFamilies</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">nde2</span><span class="o">.</span><span class="na">helpers</span><span class="o">.</span><span class="na">CensusHelpers</span><span class="o">.</span><span class="na">findSubject</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Provides key demographic information, used by AreaRank and the Summary Fragment.</span>
<span class="cm"> *</span>
<span class="cm"> * @author filip</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DemographicsCardProvider</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">DATASET_KEYWORDS</span> <span class="o">=</span> <span class="o">{</span> <span class="s">&quot;Population Density&quot;</span><span class="o">,</span>
			<span class="s">&quot;Sex&quot;</span><span class="o">,</span> <span class="s">&quot;Age by Single Year&quot;</span> <span class="o">};</span>

	<span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">float</span> <span class="n">POP_STABLE_LOWER_THRESHOLD</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.005f</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">float</span> <span class="n">POP_STABLE_UPPER_THRESHOLD</span> <span class="o">=</span> <span class="mf">0.005f</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">float</span> <span class="n">POP_RAPID_UPPER_THRESHOLD</span> <span class="o">=</span> <span class="mf">0.3f</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">float</span> <span class="n">POP_RAPID_LOWER_THRESHOLD</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.3f</span><span class="o">;</span>

	<span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">float</span> <span class="n">DENS_VDENSE_LOWER_THRESHOLD</span> <span class="o">=</span> <span class="mi">3844</span><span class="n">f</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">float</span> <span class="n">DENS_DENSE_LOWER_THRESHOLD</span> <span class="o">=</span> <span class="mi">1286</span><span class="n">f</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">float</span> <span class="n">DENS_NORMAL_LOWER_THRESHOLD</span> <span class="o">=</span> <span class="mi">360</span><span class="n">f</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">float</span> <span class="n">DENS_SPARSE_LOWER_THRESHOLD</span> <span class="o">=</span> <span class="mi">134</span><span class="n">f</span><span class="o">;</span>

	<span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">float</span> <span class="n">GENDER_MORE_MALES_LOWER_THRESHOLD</span> <span class="o">=</span> <span class="mf">1.03f</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">float</span> <span class="n">GENDER_MORE_FEMALES_UPPER_THRESHOLD</span> <span class="o">=</span> <span class="mf">0.97f</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">float</span> <span class="n">GENDER_MORE_FEMALES_LOWER_THRESHOLD</span> <span class="o">=</span> <span class="mf">0.8f</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">float</span> <span class="n">GENDER_MORE_MALES_UPPER_THRESHOLD</span> <span class="o">=</span> <span class="mf">1.2f</span><span class="o">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * Generates a card containing a summary of the demographic information</span>
<span class="cm">	 * about the supplied area.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param area</span>
<span class="cm">	 *            The area to query.</span>
<span class="cm">	 * @param res</span>
<span class="cm">	 *            Format strings to appear on the card.</span>
<span class="cm">	 * @return A card containing demographics summary.</span>
<span class="cm">	 * @throws InvalidParameterException</span>
<span class="cm">	 * @throws IOException</span>
<span class="cm">	 * @throws XmlPullParserException</span>
<span class="cm">	 * @throws NDE2Exception</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="n">CardModel</span> <span class="nf">demographicsCardForArea</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">,</span> <span class="n">Resources</span> <span class="n">res</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">InvalidParameterException</span><span class="o">,</span> <span class="n">IOException</span><span class="o">,</span>
			<span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">NDE2Exception</span> <span class="o">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Step 1: Demographics data is located under Census category. We need</span>
<span class="cm">		 * to retrieve it and then get the necessary datasets.</span>
<span class="cm">		 */</span>
		<span class="n">Subject</span> <span class="n">censusSubject</span> <span class="o">=</span> <span class="n">findSubject</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="s">&quot;Census&quot;</span><span class="o">);</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">censusSubject</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ValueNotAvailable</span><span class="o">(</span>
                    <span class="s">&quot;Cannot find Census subject for this area.&quot;</span><span class="o">);</span>
        <span class="o">}</span>

		<span class="n">List</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">&gt;</span> <span class="n">requiredFamilies</span> <span class="o">=</span> <span class="n">findRequiredFamilies</span><span class="o">(</span><span class="n">area</span><span class="o">,</span>
				<span class="n">censusSubject</span><span class="o">,</span> <span class="n">DATASET_KEYWORDS</span><span class="o">);</span>

		<span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">theDatasets</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GetTables</span><span class="o">().</span><span class="na">forArea</span><span class="o">(</span><span class="n">area</span><span class="o">)</span>
				<span class="o">.</span><span class="na">inFamilies</span><span class="o">(</span><span class="n">requiredFamilies</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>

		<span class="n">TrendDescription</span> <span class="n">popSizeTrendDesc</span> <span class="o">=</span> <span class="n">calculatePopulationTrend</span><span class="o">(</span><span class="n">theDatasets</span><span class="o">);</span>
		<span class="kt">int</span> <span class="n">whichPopDensityDescriptor</span> <span class="o">=</span> <span class="n">popDensityDescriptor</span><span class="o">(</span><span class="n">getPopulationDensity</span><span class="o">(</span><span class="n">theDatasets</span><span class="o">));</span>
		<span class="kt">int</span> <span class="n">whichGenderRatioDescriptor</span> <span class="o">=</span> <span class="n">genderRatioDescriptor</span><span class="o">(</span><span class="n">calculateGenderRatio</span><span class="o">(</span><span class="n">theDatasets</span><span class="o">));</span>
		<span class="kt">float</span> <span class="n">avgAge</span> <span class="o">=</span> <span class="n">calculateAverageAge</span><span class="o">(</span><span class="n">theDatasets</span><span class="o">);</span>

		<span class="n">String</span> <span class="n">card_title</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">card_demographics_title</span><span class="o">,</span>
				<span class="n">area</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>

		<span class="n">String</span> <span class="n">card_description</span> <span class="o">=</span> <span class="n">res</span>
				<span class="o">.</span><span class="na">getString</span><span class="o">(</span>
						<span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">card_demographics_title_base</span><span class="o">,</span>
						<span class="n">area</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
						<span class="n">res</span><span class="o">.</span><span class="na">getStringArray</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">array</span><span class="o">.</span><span class="na">card_demographics_pop_size_trend_descriptors</span><span class="o">)[</span><span class="n">popSizeTrendDesc</span><span class="o">.</span><span class="na">which</span> <span class="o">+</span> <span class="mi">2</span><span class="o">]);</span>
		<span class="n">card_description</span> <span class="o">+=</span> <span class="s">&quot; &quot;</span>
				<span class="o">+</span> <span class="n">res</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span>
						<span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">card_demographics_body_base</span><span class="o">,</span>
						<span class="n">res</span><span class="o">.</span><span class="na">getStringArray</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">array</span><span class="o">.</span><span class="na">card_demographics_sex_dominance_descriptors</span><span class="o">)[</span><span class="n">whichGenderRatioDescriptor</span><span class="o">],</span>
						<span class="n">avgAge</span><span class="o">,</span>
						<span class="n">res</span><span class="o">.</span><span class="na">getStringArray</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">array</span><span class="o">.</span><span class="na">card_demographics_pop_density_descriptors</span><span class="o">)[</span><span class="n">whichPopDensityDescriptor</span><span class="o">]);</span>

		<span class="k">return</span> <span class="nf">makeCard</span><span class="o">(</span><span class="n">card_title</span><span class="o">,</span> <span class="n">card_description</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="n">CardModel</span> <span class="nf">makeCard</span><span class="o">(</span><span class="n">String</span> <span class="n">card_title</span><span class="o">,</span> <span class="n">String</span> <span class="n">card_description</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">CardModel</span><span class="o">(</span><span class="n">card_title</span><span class="o">,</span> <span class="n">card_description</span><span class="o">,</span>
				<span class="n">HoloCSSColourValues</span><span class="o">.</span><span class="na">AQUAMARINE</span><span class="o">.</span><span class="na">getCssValue</span><span class="o">(),</span>
				<span class="n">HoloCSSColourValues</span><span class="o">.</span><span class="na">AQUAMARINE</span><span class="o">.</span><span class="na">getCssValue</span><span class="o">(),</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span>
				<span class="n">PlayCard</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Calculates the average age (from the 2011 dataset)</span>
<span class="cm">     * @param theDatasets prefetched datasets for the area</span>
<span class="cm">     * @return the average age</span>
<span class="cm">     * @throws ValueNotAvailable</span>
<span class="cm">     */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">float</span> <span class="nf">calculateAverageAge</span><span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">theDatasets</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">ValueNotAvailable</span> <span class="o">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The &quot;Age by Single Year, 2011&quot; dataset contains almost everything</span>
<span class="cm">		 * that I might need to calculate the average age. Nevertheless, it</span>
<span class="cm">		 * actually lists the *number of people who happened to be n years old*</span>
<span class="cm">		 * at the census, and 0 &lt;= n &lt;= 99 and a column for ages 100 &lt;= x &lt; 115.</span>
<span class="cm">		 * The &quot;Age 2001&quot; dataset SUCKS because it&#39;s weird and histogram like</span>
<span class="cm">		 * and messy.</span>
<span class="cm">		 */</span>
		<span class="kt">float</span> <span class="n">avgAge</span> <span class="o">=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>
		<span class="kd">final</span> <span class="n">Pattern</span> <span class="n">REGEX_AGE</span> <span class="o">=</span> <span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">&quot;Age( Under)? (\\d+)&quot;</span><span class="o">);</span>
		<span class="kt">int</span> <span class="n">year</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">Dataset</span> <span class="n">ds</span> <span class="o">:</span> <span class="n">theDatasets</span><span class="o">)</span> <span class="o">{</span>

			<span class="k">if</span> <span class="o">(</span><span class="n">ds</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;Age by Single Year&quot;</span><span class="o">))</span> <span class="o">{</span>
				<span class="kt">int</span> <span class="n">cyr</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">ds</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="mi">20</span><span class="o">,</span> <span class="mi">24</span><span class="o">));</span>

				<span class="k">if</span> <span class="o">(</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">cyr</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">year</span> <span class="o">=</span> <span class="n">cyr</span><span class="o">;</span>
					<span class="kt">float</span> <span class="n">rollingAge</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
					<span class="kt">float</span> <span class="n">rollingPopulation</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
					<span class="k">for</span> <span class="o">(</span><span class="n">Topic</span> <span class="n">t</span> <span class="o">:</span> <span class="n">ds</span><span class="o">.</span><span class="na">getTopics</span><span class="o">().</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
						<span class="n">Matcher</span> <span class="n">titleMatcher</span> <span class="o">=</span> <span class="n">REGEX_AGE</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">());</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">titleMatcher</span><span class="o">.</span><span class="na">matches</span><span class="o">())</span> <span class="o">{</span>
							<span class="kt">float</span> <span class="n">curAge</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="na">parseFloat</span><span class="o">(</span><span class="n">titleMatcher</span>
									<span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">2</span><span class="o">));</span>
							<span class="kt">float</span> <span class="n">curPop</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">()</span>
									<span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
							<span class="n">rollingAge</span> <span class="o">+=</span> <span class="n">curAge</span> <span class="o">*</span> <span class="n">curPop</span><span class="o">;</span>
							<span class="n">rollingPopulation</span> <span class="o">+=</span> <span class="n">curPop</span><span class="o">;</span>
						<span class="o">}</span>
					<span class="o">}</span>
					<span class="n">avgAge</span> <span class="o">=</span> <span class="n">rollingAge</span> <span class="o">/</span> <span class="n">rollingPopulation</span><span class="o">;</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">avgAge</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">genderRatioDescriptor</span><span class="o">(</span><span class="kt">float</span> <span class="n">genderRatio</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">genderRatio</span> <span class="o">&gt;=</span> <span class="n">GENDER_MORE_FEMALES_UPPER_THRESHOLD</span>
				<span class="o">&amp;&amp;</span> <span class="n">genderRatio</span> <span class="o">&lt;=</span> <span class="n">GENDER_MORE_MALES_LOWER_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="mi">2</span><span class="o">;</span> <span class="c1">// balance</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">genderRatio</span> <span class="o">&lt;</span> <span class="n">GENDER_MORE_FEMALES_UPPER_THRESHOLD</span>
				<span class="o">&amp;&amp;</span> <span class="n">genderRatio</span> <span class="o">&gt;=</span> <span class="n">GENDER_MORE_FEMALES_LOWER_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="mi">1</span><span class="o">;</span> <span class="c1">// more females</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">genderRatio</span> <span class="o">&lt;</span> <span class="n">GENDER_MORE_FEMALES_LOWER_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="mi">0</span><span class="o">;</span> <span class="c1">// significantly more females</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">genderRatio</span> <span class="o">&gt;</span> <span class="n">GENDER_MORE_MALES_UPPER_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="mi">4</span><span class="o">;</span> <span class="c1">// significantly more males</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="k">return</span> <span class="mi">3</span><span class="o">;</span> <span class="c1">// more males</span>
		<span class="o">}</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Calculates the ratio of males to females in the area</span>
<span class="cm">     * @param theDatasets prefetched datasets for the area</span>
<span class="cm">     * @return gender ratio</span>
<span class="cm">     * @throws ValueNotAvailable</span>
<span class="cm">     */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">float</span> <span class="nf">calculateGenderRatio</span><span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">theDatasets</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">ValueNotAvailable</span> <span class="o">{</span>
		<span class="kt">float</span> <span class="n">ratio</span> <span class="o">=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">year</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">Dataset</span> <span class="n">ds</span> <span class="o">:</span> <span class="n">theDatasets</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">ds</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;Sex&quot;</span><span class="o">))</span> <span class="o">{</span>
				<span class="kt">int</span> <span class="n">males</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">females</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
				<span class="kt">int</span> <span class="n">cyr</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">ds</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="mi">9</span><span class="o">));</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">cyr</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">year</span> <span class="o">=</span> <span class="n">cyr</span><span class="o">;</span>
					<span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Topic</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="na">getTopics</span><span class="o">().</span><span class="na">values</span><span class="o">()</span>
							<span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
					<span class="k">while</span> <span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
						<span class="n">Topic</span> <span class="n">t</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;Males&quot;</span><span class="o">))</span> <span class="o">{</span>
							<span class="n">males</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">ds</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">()</span>
									<span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
						<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;Females&quot;</span><span class="o">))</span> <span class="o">{</span>
							<span class="n">females</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">ds</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">()</span>
									<span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
						<span class="o">}</span>
					<span class="o">}</span>

				<span class="o">}</span>
				<span class="n">ratio</span> <span class="o">=</span> <span class="o">((</span><span class="kt">float</span><span class="o">)</span> <span class="n">males</span><span class="o">)</span> <span class="o">/</span> <span class="o">((</span><span class="kt">float</span><span class="o">)</span> <span class="n">females</span><span class="o">);</span>

			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">ratio</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">popDensityDescriptor</span><span class="o">(</span><span class="kt">float</span> <span class="n">populationDensity</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">populationDensity</span> <span class="o">&gt;=</span> <span class="n">DENS_VDENSE_LOWER_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="mi">4</span><span class="o">;</span> <span class="c1">// very dense</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">populationDensity</span> <span class="o">&gt;=</span> <span class="n">DENS_DENSE_LOWER_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="mi">3</span><span class="o">;</span> <span class="c1">// dense</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">populationDensity</span> <span class="o">&gt;=</span> <span class="n">DENS_NORMAL_LOWER_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="mi">2</span><span class="o">;</span> <span class="c1">// normal</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">populationDensity</span> <span class="o">&gt;=</span> <span class="n">DENS_SPARSE_LOWER_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="mi">1</span><span class="o">;</span> <span class="c1">// sparse</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="o">;</span> <span class="c1">// very sparse</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Finds the population density for the area</span>
<span class="cm">     * @param theDatasets prefetched datasets for the area</span>
<span class="cm">     * @return population density, in persons / km. sq.</span>
<span class="cm">     * @throws ValueNotAvailable</span>
<span class="cm">     */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">float</span> <span class="nf">getPopulationDensity</span><span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">theDatasets</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">ValueNotAvailable</span> <span class="o">{</span>
		<span class="kt">int</span> <span class="n">year</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="kt">float</span> <span class="n">density</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

		<span class="k">for</span> <span class="o">(</span><span class="n">Dataset</span> <span class="n">ds</span> <span class="o">:</span> <span class="n">theDatasets</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">ds</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;Population Density&quot;</span><span class="o">))</span> <span class="o">{</span>
				<span class="kt">int</span> <span class="n">cyr</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">ds</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="mi">20</span><span class="o">,</span> <span class="mi">24</span><span class="o">));</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">cyr</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">year</span> <span class="o">=</span> <span class="n">cyr</span><span class="o">;</span>
					<span class="n">Topic</span> <span class="n">pdTopic</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
					<span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Topic</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="na">getTopics</span><span class="o">().</span><span class="na">values</span><span class="o">()</span>
							<span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
					<span class="k">while</span> <span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">pdTopic</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="n">Topic</span> <span class="n">t</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;Density&quot;</span><span class="o">))</span> <span class="o">{</span>
							<span class="n">pdTopic</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
						<span class="o">}</span>
					<span class="o">}</span>
					<span class="n">density</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">pdTopic</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">().</span><span class="na">getValue</span><span class="o">();</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="nf">personPerHectareToPersonPerSqKm</span><span class="o">(</span><span class="n">density</span><span class="o">);</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Calculates the population trend for the area (between 2001 and 2011 datasets)</span>
<span class="cm">     * @param theDatasets prefetched datasets for the area</span>
<span class="cm">     * @return the trend description of the population</span>
<span class="cm">     * @throws ValueNotAvailable</span>
<span class="cm">     */</span>
	<span class="nd">@SuppressLint</span><span class="o">(</span><span class="s">&quot;UseSparseArrays&quot;</span><span class="o">)</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="n">TrendDescription</span> <span class="nf">calculatePopulationTrend</span><span class="o">(</span>
			<span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">theDatasets</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ValueNotAvailable</span> <span class="o">{</span>
		<span class="n">TrendDescription</span> <span class="n">desc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TrendDescription</span><span class="o">();</span>
		<span class="kt">int</span> <span class="n">mostRecentYear</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="cm">/**</span>
<span class="cm">		 * where key is year and value is the population</span>
<span class="cm">		 */</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">popPerYear</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;();</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">Dataset</span> <span class="n">ds</span> <span class="o">:</span> <span class="n">theDatasets</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">ds</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;Sex&quot;</span><span class="o">))</span> <span class="o">{</span>
				<span class="kt">int</span> <span class="n">year</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">ds</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="mi">9</span><span class="o">));</span>
				<span class="k">if</span> <span class="o">(!(</span><span class="n">popPerYear</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">year</span><span class="o">)))</span> <span class="o">{</span>
					<span class="n">Topic</span> <span class="n">allPeople</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
					<span class="cm">/*</span>
<span class="cm">					 * exit condition: found relevant topic or no more topics</span>
<span class="cm">					 * left</span>
<span class="cm">					 */</span>
					<span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Topic</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="na">getTopics</span><span class="o">().</span><span class="na">values</span><span class="o">()</span>
							<span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
					<span class="k">while</span> <span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">allPeople</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="n">Topic</span> <span class="n">t</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;All&quot;</span><span class="o">))</span> <span class="o">{</span>
                            <span class="n">allPeople</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
                        <span class="o">}</span>
					<span class="o">}</span>
					<span class="n">Set</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;</span> <span class="n">relevants</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">allPeople</span><span class="o">);</span>
					<span class="n">popPerYear</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">year</span><span class="o">,</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">relevants</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">()</span>
							<span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">year</span> <span class="o">&gt;</span> <span class="n">mostRecentYear</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">mostRecentYear</span> <span class="o">=</span> <span class="n">year</span><span class="o">;</span>
                <span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="kt">float</span> <span class="n">avgPercentageChange</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * We need a sorted collection here</span>
<span class="cm">		 */</span>
		<span class="n">Set</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">years_set</span> <span class="o">=</span> <span class="n">popPerYear</span><span class="o">.</span><span class="na">keySet</span><span class="o">();</span>
		<span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">years</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;(</span><span class="n">years_set</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">Integer</span> <span class="n">y</span> <span class="o">:</span> <span class="n">years_set</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">years</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">y</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="n">Collections</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">years</span><span class="o">);</span>

		<span class="kt">int</span> <span class="n">previous_year</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">Integer</span> <span class="n">current_year</span> <span class="o">:</span> <span class="n">years</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">previous_year</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">previous_year</span> <span class="o">=</span> <span class="n">current_year</span><span class="o">;</span>
				<span class="k">continue</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="kt">int</span> <span class="n">oldPop</span> <span class="o">=</span> <span class="n">popPerYear</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">previous_year</span><span class="o">);</span>
			<span class="kt">int</span> <span class="n">newPop</span> <span class="o">=</span> <span class="n">popPerYear</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">current_year</span><span class="o">);</span>
			<span class="kt">float</span> <span class="n">percentageChange</span> <span class="o">=</span> <span class="o">((</span><span class="kt">float</span><span class="o">)</span> <span class="n">newPop</span> <span class="o">-</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">oldPop</span><span class="o">)</span>
					<span class="o">/</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">oldPop</span><span class="o">;</span>
			<span class="c1">// System.err</span>
			<span class="c1">// .println(String</span>
			<span class="c1">// .format(&quot;Percentage difference between %d (in %d) and %d (in %d) = %f&quot;,</span>
			<span class="c1">// oldPop, previous_year, newPop,</span>
			<span class="c1">// current_year, percentageChange * 100f));</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">avgPercentageChange</span> <span class="o">==</span> <span class="mi">0</span><span class="n">f</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">avgPercentageChange</span> <span class="o">=</span> <span class="n">percentageChange</span><span class="o">;</span>
			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
				<span class="n">avgPercentageChange</span> <span class="o">=</span> <span class="o">(</span><span class="n">avgPercentageChange</span> <span class="o">+</span> <span class="n">percentageChange</span><span class="o">)</span> <span class="o">/</span> <span class="mi">2</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="n">desc</span><span class="o">.</span><span class="na">currentValue</span> <span class="o">=</span> <span class="n">popPerYear</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">mostRecentYear</span><span class="o">);</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">avgPercentageChange</span> <span class="o">&gt;</span> <span class="n">POP_STABLE_LOWER_THRESHOLD</span>
				<span class="o">&amp;&amp;</span> <span class="n">avgPercentageChange</span> <span class="o">&lt;</span> <span class="n">POP_STABLE_UPPER_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">desc</span><span class="o">.</span><span class="na">which</span> <span class="o">=</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">STABLE</span><span class="o">;</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">avgPercentageChange</span> <span class="o">&lt;=</span> <span class="n">POP_STABLE_LOWER_THRESHOLD</span>
				<span class="o">&amp;&amp;</span> <span class="n">avgPercentageChange</span> <span class="o">&gt;</span> <span class="n">POP_RAPID_LOWER_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">desc</span><span class="o">.</span><span class="na">which</span> <span class="o">=</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">FALLING</span><span class="o">;</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">avgPercentageChange</span> <span class="o">&lt;=</span> <span class="n">POP_RAPID_LOWER_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">desc</span><span class="o">.</span><span class="na">which</span> <span class="o">=</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">FALLING_RAPIDLY</span><span class="o">;</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">avgPercentageChange</span> <span class="o">&gt;=</span> <span class="n">POP_STABLE_UPPER_THRESHOLD</span>
				<span class="o">&amp;&amp;</span> <span class="n">avgPercentageChange</span> <span class="o">&lt;</span> <span class="n">POP_RAPID_UPPER_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">desc</span><span class="o">.</span><span class="na">which</span> <span class="o">=</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">RISING</span><span class="o">;</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="n">desc</span><span class="o">.</span><span class="na">which</span> <span class="o">=</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">RISING_RAPIDLY</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="n">desc</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">float</span> <span class="nf">personPerHectareToPersonPerSqKm</span><span class="o">(</span><span class="kt">float</span> <span class="n">pph</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="o">(</span><span class="n">pph</span> <span class="o">*</span> <span class="mi">100</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">EconomyCardProvider <small>lamparski.areabase.cardproviders</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">cardproviders</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.content.res.Resources</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.fima.cardsui.objects.CardModel</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParserException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Locale</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map.Entry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.NoSuchElementException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lamparski.areabase.R</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.cards.PlayCard</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.map_support.HoloCSSColourValues</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.errors.InvalidParameterException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.errors.NDE2Exception</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.errors.ValueNotAvailable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.helpers.Statistics</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.methodcalls.delivery.GetTables</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DataSetFamily</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DataSetItem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DateRange</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Subject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Topic</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">nde2</span><span class="o">.</span><span class="na">helpers</span><span class="o">.</span><span class="na">CensusHelpers</span><span class="o">.</span><span class="na">findRequiredFamilies</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">nde2</span><span class="o">.</span><span class="na">helpers</span><span class="o">.</span><span class="na">CensusHelpers</span><span class="o">.</span><span class="na">findSubject</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Functions to find economic trends and variables for a given area.</span>
<span class="cm"> *</span>
<span class="cm"> * @author filip</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EconomyCardProvider</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">CENSUS_KEYWORDS</span> <span class="o">=</span> <span class="o">{</span> <span class="s">&quot;KS601EW&quot;</span><span class="o">,</span> <span class="s">&quot;QS605EW&quot;</span> <span class="o">};</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">ECONOMY_KEYWORDS</span> <span class="o">=</span> <span class="o">{</span> <span class="s">&quot;Worklessness: Economic Activity&quot;</span> <span class="o">};</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">WORKLESSNESS_DATASET_ID</span> <span class="o">=</span> <span class="mi">2212</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">UNIX_30_DAYS</span> <span class="o">=</span> <span class="mi">1000</span><span class="n">l</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">30</span><span class="o">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * Generates a summary of economic data for the supplied area.</span>
<span class="cm">	 * @param area The area to query.</span>
<span class="cm">	 * @param res Used to build the text on the card.</span>
<span class="cm">	 * @return A card with the summary of the economic activity within the area.</span>
<span class="cm">	 * @throws InvalidParameterException</span>
<span class="cm">	 * @throws IOException</span>
<span class="cm">	 * @throws XmlPullParserException</span>
<span class="cm">	 * @throws NDE2Exception</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="n">CardModel</span> <span class="nf">economyCardForArea</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">,</span> <span class="n">Resources</span> <span class="n">res</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">InvalidParameterException</span><span class="o">,</span> <span class="n">IOException</span><span class="o">,</span>
			<span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">NDE2Exception</span> <span class="o">{</span>

		<span class="c1">// The data we need is split between two subjects,</span>
		<span class="c1">// so both need to be fetched. We&#39;ll sort that out later.</span>
		<span class="n">Subject</span> <span class="n">economySubject</span> <span class="o">=</span> <span class="n">findSubject</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="s">&quot;Economic Deprivation&quot;</span><span class="o">);</span>
		<span class="n">Subject</span> <span class="n">censusSubject</span> <span class="o">=</span> <span class="n">findSubject</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="s">&quot;Census&quot;</span><span class="o">);</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">economySubject</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">censusSubject</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ValueNotAvailable</span><span class="o">(</span>
                    <span class="s">&quot;Cannot find the required subjects for the area&quot;</span><span class="o">);</span>
        <span class="o">}</span>

		<span class="c1">// Coalesce the required families into a single list.</span>
		<span class="n">List</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">&gt;</span> <span class="n">requiredFamilies</span> <span class="o">=</span> <span class="n">findRequiredFamilies</span><span class="o">(</span><span class="n">area</span><span class="o">,</span>
				<span class="n">censusSubject</span><span class="o">,</span> <span class="n">CENSUS_KEYWORDS</span><span class="o">);</span>

		<span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">theDatasets</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GetTables</span><span class="o">().</span><span class="na">forArea</span><span class="o">(</span><span class="n">area</span><span class="o">)</span>
				<span class="o">.</span><span class="na">inFamilies</span><span class="o">(</span><span class="n">requiredFamilies</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>

		<span class="n">String</span> <span class="n">type_of_economic_activity</span> <span class="o">=</span> <span class="n">getTypeOfEconomicActivity</span><span class="o">(</span><span class="n">theDatasets</span><span class="o">);</span>
		<span class="n">String</span> <span class="n">biggest_sector</span> <span class="o">=</span> <span class="n">getBiggestEconomySector</span><span class="o">(</span><span class="n">theDatasets</span><span class="o">);</span>
		<span class="n">TrendDescription</span> <span class="n">unemploymentDescription</span> <span class="o">=</span> <span class="n">getUnemploymentRate</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
		<span class="kt">float</span> <span class="n">unempl_val</span> <span class="o">=</span> <span class="n">unemploymentDescription</span><span class="o">.</span><span class="na">currentValue</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">unempl_trend</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="na">getStringArray</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">array</span><span class="o">.</span><span class="na">card_economy_unemployment_trend</span><span class="o">)[</span><span class="n">unemploymentDescription</span><span class="o">.</span><span class="na">which</span> <span class="o">+</span> <span class="mi">2</span><span class="o">];</span>

		<span class="n">String</span> <span class="n">card_title</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">card_economy_title</span><span class="o">,</span>
				<span class="n">area</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
		<span class="n">String</span> <span class="n">card_body</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">card_economy_body_base</span><span class="o">,</span>
				<span class="n">area</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">type_of_economic_activity</span><span class="o">,</span> <span class="n">biggest_sector</span><span class="o">,</span>
				<span class="n">unempl_val</span><span class="o">,</span> <span class="n">unempl_trend</span><span class="o">);</span>
		<span class="k">return</span> <span class="nf">makeCard</span><span class="o">(</span><span class="n">card_title</span><span class="o">,</span> <span class="n">card_body</span><span class="o">);</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Gets the unemployment figure for the given area. While unemployment may not be the best</span>
<span class="cm">     * indicator of the economic health of an area, it is the most up-to-date one on the system.</span>
<span class="cm">     * @param area the area to find unemployment for.</span>
<span class="cm">     * @return Trend Description of the unemployment rate.</span>
<span class="cm">     * @throws XmlPullParserException</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     * @throws NDE2Exception</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">TrendDescription</span> <span class="nf">getUnemploymentRate</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">NDE2Exception</span> <span class="o">{</span>
        <span class="n">TrendDescription</span> <span class="n">unemploymentTrendDescription</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TrendDescription</span><span class="o">();</span>

        <span class="n">Subject</span> <span class="n">econSubject</span> <span class="o">=</span> <span class="n">findSubject</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="s">&quot;Economic Deprivation&quot;</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">&gt;</span> <span class="n">dataSetFamilies</span> <span class="o">=</span> <span class="n">findRequiredFamilies</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="n">econSubject</span><span class="o">,</span> <span class="n">ECONOMY_KEYWORDS</span><span class="o">);</span>
        <span class="n">DataSetFamily</span> <span class="n">worklessnessFamily</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">for</span><span class="o">(</span><span class="n">DataSetFamily</span> <span class="n">f</span> <span class="o">:</span> <span class="n">dataSetFamilies</span><span class="o">){</span>
            <span class="k">if</span><span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">getFamilyId</span><span class="o">()</span> <span class="o">==</span> <span class="n">WORKLESSNESS_DATASET_ID</span><span class="o">){</span>
                <span class="n">worklessnessFamily</span> <span class="o">=</span> <span class="n">f</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">DateRange</span><span class="o">[]</span> <span class="n">periods</span> <span class="o">=</span> <span class="n">worklessnessFamily</span><span class="o">.</span><span class="na">getDateRanges</span><span class="o">();</span>
        <span class="n">DateRange</span> <span class="n">mostRecent</span> <span class="o">=</span> <span class="n">DateRange</span><span class="o">.</span><span class="na">mostRecent</span><span class="o">(</span><span class="n">periods</span><span class="o">);</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">DateRange</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">datasets</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">DateRange</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">DateRange</span> <span class="n">p</span> <span class="o">:</span> <span class="n">periods</span><span class="o">){</span>
            <span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">ds</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GetTables</span><span class="o">().</span><span class="na">forArea</span><span class="o">(</span><span class="n">area</span><span class="o">).</span><span class="na">inFamily</span><span class="o">(</span><span class="n">worklessnessFamily</span><span class="o">).</span><span class="na">inDateRange</span><span class="o">(</span><span class="n">p</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>
            <span class="n">datasets</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">ds</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="kt">float</span> <span class="n">currentLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Float</span><span class="o">&gt;</span> <span class="n">datapoints</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Float</span><span class="o">&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">DateRange</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">datasets</span><span class="o">.</span><span class="na">entrySet</span><span class="o">()){</span>
            <span class="n">DateRange</span> <span class="n">drkey</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">intkey</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">drkey</span><span class="o">.</span><span class="na">getEndDate</span><span class="o">().</span><span class="na">getTime</span><span class="o">()</span> <span class="o">/</span> <span class="o">(</span><span class="n">UNIX_30_DAYS</span> <span class="o">*</span> <span class="mi">4</span><span class="n">l</span><span class="o">));</span>
            <span class="n">Dataset</span> <span class="n">daval</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
            <span class="kt">float</span> <span class="n">fval</span> <span class="o">=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>
            <span class="k">for</span><span class="o">(</span><span class="n">Topic</span> <span class="n">t</span> <span class="o">:</span> <span class="n">daval</span><span class="o">.</span><span class="na">getTopics</span><span class="o">().</span><span class="na">values</span><span class="o">()){</span>
                <span class="k">if</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;Unemployment Rate; Aged 16-64&quot;</span><span class="o">)){</span>
                    <span class="n">DataSetItem</span> <span class="n">item</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="k">try</span><span class="o">{</span>
                        <span class="n">item</span> <span class="o">=</span> <span class="n">daval</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchElementException</span> <span class="n">e</span><span class="o">){</span>
                        <span class="cm">/*</span>
<span class="cm">                        This can occur when there is no data for the given point in time, in which</span>
<span class="cm">                        case skip to next data point.</span>
<span class="cm">                         */</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">fval</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">mostRecent</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">drkey</span><span class="o">)){</span>
                        <span class="n">currentLevel</span> <span class="o">=</span> <span class="n">fval</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">datapoints</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">intkey</span><span class="o">,</span> <span class="n">fval</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kt">double</span> <span class="n">ols</span> <span class="o">=</span> <span class="n">Statistics</span><span class="o">.</span><span class="na">linearRegressionGradient</span><span class="o">(</span><span class="n">datapoints</span><span class="o">);</span>

        <span class="k">if</span><span class="o">(</span><span class="n">ols</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">0.75</span><span class="o">){</span>
            <span class="n">unemploymentTrendDescription</span><span class="o">.</span><span class="na">which</span> <span class="o">=</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">FALLING_RAPIDLY</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">ols</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">0.05</span><span class="o">){</span>
            <span class="n">unemploymentTrendDescription</span><span class="o">.</span><span class="na">which</span> <span class="o">=</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">FALLING</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">ols</span> <span class="o">&lt;=</span> <span class="mf">0.05</span><span class="o">){</span>
            <span class="n">unemploymentTrendDescription</span><span class="o">.</span><span class="na">which</span> <span class="o">=</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">STABLE</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">ols</span> <span class="o">&lt;=</span> <span class="mf">0.75</span><span class="o">){</span>
            <span class="n">unemploymentTrendDescription</span><span class="o">.</span><span class="na">which</span> <span class="o">=</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">RISING</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">unemploymentTrendDescription</span><span class="o">.</span><span class="na">which</span> <span class="o">=</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">RISING_RAPIDLY</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">unemploymentTrendDescription</span><span class="o">.</span><span class="na">currentValue</span> <span class="o">=</span> <span class="n">currentLevel</span><span class="o">;</span>

        <span class="k">return</span> <span class="n">unemploymentTrendDescription</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Finds which economy sector employs the most people in this area.</span>
<span class="cm">     * @param theDatasets prefetched datasets for the area</span>
<span class="cm">     * @return appropriately processed sector name</span>
<span class="cm">     */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getBiggestEconomySector</span><span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">theDatasets</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">largestEconomySector</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">count_lES</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

		<span class="k">for</span> <span class="o">(</span><span class="n">Dataset</span> <span class="n">ds</span> <span class="o">:</span> <span class="n">theDatasets</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">ds</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&quot;(QS605EW)&quot;</span><span class="o">))</span> <span class="o">{</span>
				<span class="k">for</span> <span class="o">(</span><span class="n">Topic</span> <span class="n">t</span> <span class="o">:</span> <span class="n">ds</span><span class="o">.</span><span class="na">getTopics</span><span class="o">().</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
					<span class="k">if</span> <span class="o">(!(</span><span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;All Usual Residents&quot;</span><span class="o">)))</span> <span class="o">{</span>
						<span class="c1">// ^[A-Z](,[A-Z])?(\\d+\\W+)*\\W?</span>
						<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">ds</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">()</span>
								<span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">count_lES</span><span class="o">)</span> <span class="o">{</span>
							<span class="n">largestEconomySector</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">replaceAll</span><span class="o">(</span>
									<span class="s">&quot;^[A-Z](,[A-Z])?(\\d+\\W+)*\\W?&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">);</span>
							<span class="n">count_lES</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
						<span class="o">}</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">largestEconomySector</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">(</span><span class="n">Locale</span><span class="o">.</span><span class="na">UK</span><span class="o">);</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Finds the most dominant type of economic activity in the area.</span>
<span class="cm">     * @param theDatasets prefetched datasets for the area</span>
<span class="cm">     * @return the type of economic activity.</span>
<span class="cm">     */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getTypeOfEconomicActivity</span><span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">theDatasets</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// The answer variable</span>
		<span class="n">String</span> <span class="n">answer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="c1">// Largest type of economic activity</span>
		<span class="n">String</span> <span class="n">largestEconomicActivity</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">count_lEA</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="c1">// Largest type of economic inactivity</span>
		<span class="n">String</span> <span class="n">largestEconomicInactivity</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">count_lEI</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="c1">// Tally it up</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">Dataset</span> <span class="n">ds</span> <span class="o">:</span> <span class="n">theDatasets</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">ds</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&quot;(KS601EW)&quot;</span><span class="o">))</span> <span class="o">{</span>
				<span class="k">for</span> <span class="o">(</span><span class="n">Topic</span> <span class="n">t</span> <span class="o">:</span> <span class="n">ds</span><span class="o">.</span><span class="na">getTopics</span><span class="o">().</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
					<span class="c1">// Compare raw count of persons</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;Economically Active; &quot;</span><span class="o">)</span>
							<span class="o">&amp;&amp;</span> <span class="n">t</span><span class="o">.</span><span class="na">getCoinageUnit</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Count&quot;</span><span class="o">))</span> <span class="o">{</span>
						<span class="cm">/*</span>
<span class="cm">						 * Why substring and not replace: Substrings share the</span>
<span class="cm">						 * same base character array as their parent string,</span>
<span class="cm">						 * whereas upon replacing, a new array is created and</span>
<span class="cm">						 * data copied. I think. Thus, using substring may be</span>
<span class="cm">						 * faster.</span>
<span class="cm">						 */</span>
						<span class="n">String</span> <span class="n">econActivity</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span>
								<span class="s">&quot;Economically Active; &quot;</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
						<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">ds</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">()</span>
								<span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">count_lEA</span><span class="o">)</span> <span class="o">{</span>
							<span class="n">count_lEA</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
							<span class="n">largestEconomicActivity</span> <span class="o">=</span> <span class="n">econActivity</span><span class="o">;</span>
						<span class="o">}</span>
					<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span>
							<span class="s">&quot;Economically Inactive; &quot;</span><span class="o">)</span>
							<span class="o">&amp;&amp;</span> <span class="n">t</span><span class="o">.</span><span class="na">getCoinageUnit</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Count&quot;</span><span class="o">))</span> <span class="o">{</span>
						<span class="n">String</span> <span class="n">econInactivity</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span>
								<span class="s">&quot;Economically Inactive; &quot;</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
						<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">ds</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">()</span>
								<span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">count_lEI</span><span class="o">)</span> <span class="o">{</span>
							<span class="n">count_lEI</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
							<span class="n">largestEconomicInactivity</span> <span class="o">=</span> <span class="n">econInactivity</span><span class="o">;</span>
						<span class="o">}</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">count_lEI</span> <span class="o">&gt;</span> <span class="n">count_lEA</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">largestEconomicInactivity</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Retired&quot;</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="s">&quot;retired&quot;</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">largestEconomicInactivity</span>
					<span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Student (Including Full-Time Students)&quot;</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="s">&quot;economically inactive full-time students&quot;</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">largestEconomicInactivity</span>
					<span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Looking After Home or Family&quot;</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="s">&quot;homemakers&quot;</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">largestEconomicInactivity</span>
					<span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Long-Term Sick or Disabled&quot;</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="s">&quot;disabled&quot;</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="s">&quot;economically inactive*&quot;</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">largestEconomicActivity</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;Employee; &quot;</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">String</span> <span class="n">employeeType</span> <span class="o">=</span> <span class="n">largestEconomicActivity</span>
						<span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="s">&quot;Employee; &quot;</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">employeeType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Part-Time&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">answer</span> <span class="o">=</span> <span class="s">&quot;part-time employees&quot;</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">employeeType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Full-Time&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">answer</span> <span class="o">=</span> <span class="s">&quot;full-time employees&quot;</span><span class="o">;</span>
                <span class="o">}</span>
			<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">largestEconomicActivity</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Self-Employed&quot;</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="s">&quot;self-employed&quot;</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">largestEconomicActivity</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Unemployed&quot;</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="s">&quot;unemployed&quot;</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">largestEconomicActivity</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Full-Time Student&quot;</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="s">&quot;full-time students&quot;</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="s">&quot;economically active*&quot;</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="n">answer</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="n">CardModel</span> <span class="nf">makeCard</span><span class="o">(</span><span class="n">String</span> <span class="n">card_title</span><span class="o">,</span> <span class="n">String</span> <span class="n">card_description</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">CardModel</span><span class="o">(</span><span class="n">card_title</span><span class="o">,</span> <span class="n">card_description</span><span class="o">,</span>
				<span class="n">HoloCSSColourValues</span><span class="o">.</span><span class="na">GREEN</span><span class="o">.</span><span class="na">getCssValue</span><span class="o">(),</span>
				<span class="n">HoloCSSColourValues</span><span class="o">.</span><span class="na">GREEN</span><span class="o">.</span><span class="na">getCssValue</span><span class="o">(),</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span>
				<span class="n">PlayCard</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">EnvironmentCardProvider <small>lamparski.areabase.cardproviders</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">cardproviders</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.annotation.SuppressLint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.res.Resources</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.fima.cardsui.objects.CardModel</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParserException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lamparski.areabase.R</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.cards.PlayCard</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.errors.InvalidParameterException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.errors.NDE2Exception</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.helpers.DateFormat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.helpers.Statistics</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.methodcalls.delivery.GetTables</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DataSetFamily</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DataSetItem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DateRange</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Subject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Topic</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">nde2</span><span class="o">.</span><span class="na">helpers</span><span class="o">.</span><span class="na">CensusHelpers</span><span class="o">.</span><span class="na">findRequiredFamilies</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">nde2</span><span class="o">.</span><span class="na">helpers</span><span class="o">.</span><span class="na">CensusHelpers</span><span class="o">.</span><span class="na">findSubject</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EnvironmentCardProvider</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">REQUIRED_FAMILIES</span> <span class="o">=</span> <span class="o">{</span> <span class="s">&quot;Land Use&quot;</span><span class="o">,</span>
			<span class="s">&quot;Domestic Energy Consumption&quot;</span> <span class="o">};</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ENVIRONMENT_SUBJECT</span> <span class="o">=</span> <span class="s">&quot;Physical Environment&quot;</span><span class="o">;</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">AREA_RURAL</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">AREA_URBAN</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">AREA_EXTRA_URBAN</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">UNIX_30_DAYS</span> <span class="o">=</span> <span class="mi">1000</span><span class="n">l</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">30</span><span class="o">;</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="n">CardModel</span> <span class="nf">environmentCardForArea</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">,</span> <span class="n">Resources</span> <span class="n">res</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">NDE2Exception</span> <span class="o">{</span>
		<span class="n">Subject</span> <span class="n">environmentSubject</span> <span class="o">=</span> <span class="n">findSubject</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="n">ENVIRONMENT_SUBJECT</span><span class="o">);</span>

		<span class="n">List</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">&gt;</span> <span class="n">families</span> <span class="o">=</span> <span class="n">findRequiredFamilies</span><span class="o">(</span><span class="n">area</span><span class="o">,</span>
				<span class="n">environmentSubject</span><span class="o">,</span> <span class="n">REQUIRED_FAMILIES</span><span class="o">);</span>

		<span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">theDatasets</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GetTables</span><span class="o">().</span><span class="na">inFamilies</span><span class="o">(</span><span class="n">families</span><span class="o">)</span>
				<span class="o">.</span><span class="na">forArea</span><span class="o">(</span><span class="n">area</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>

		<span class="kt">int</span> <span class="n">urbanisationType</span> <span class="o">=</span> <span class="n">getUrbanisationType</span><span class="o">(</span><span class="n">theDatasets</span><span class="o">);</span>
		<span class="n">String</span> <span class="n">urbanisationTypeString</span> <span class="o">=</span> <span class="n">res</span>
				<span class="o">.</span><span class="na">getStringArray</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">array</span><span class="o">.</span><span class="na">card_environ_area_types</span><span class="o">)[</span><span class="n">urbanisationType</span><span class="o">];</span>

		<span class="kt">float</span><span class="o">[]</span> <span class="n">energyCurrentUse</span> <span class="o">=</span> <span class="n">getLatestEnergyUse</span><span class="o">(</span><span class="n">theDatasets</span><span class="o">);</span>
		<span class="n">String</span> <span class="n">energyUseTrendString</span> <span class="o">=</span> <span class="n">res</span>
				<span class="o">.</span><span class="na">getStringArray</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">array</span><span class="o">.</span><span class="na">card_environ_energy_trend</span><span class="o">)[</span><span class="n">getEnergyTrend</span><span class="o">(</span>
				<span class="n">area</span><span class="o">,</span> <span class="n">families</span><span class="o">).</span><span class="na">which</span> <span class="o">+</span> <span class="mi">2</span><span class="o">];</span>

		<span class="n">String</span> <span class="n">title</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">card_environ_title</span><span class="o">,</span>
				<span class="n">area</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
		<span class="n">String</span> <span class="n">descr</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">card_environ_body_base</span><span class="o">,</span>
				<span class="n">area</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">urbanisationTypeString</span><span class="o">,</span>
				<span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="n">energyCurrentUse</span><span class="o">[</span><span class="mi">0</span><span class="o">]),</span>
				<span class="n">energyCurrentUse</span><span class="o">[</span><span class="mi">1</span><span class="o">],</span> <span class="n">energyUseTrendString</span><span class="o">);</span>
		<span class="k">return</span> <span class="nf">makeCard</span><span class="o">(</span><span class="n">title</span><span class="o">,</span> <span class="n">descr</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="n">CardModel</span> <span class="nf">makeCard</span><span class="o">(</span><span class="n">String</span> <span class="n">title</span><span class="o">,</span> <span class="n">String</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">CardModel</span><span class="o">(</span><span class="n">title</span><span class="o">,</span> <span class="n">description</span><span class="o">,</span> <span class="s">&quot;#BADA55&quot;</span><span class="o">,</span> <span class="s">&quot;#7F992C&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span>
				<span class="kc">false</span><span class="o">,</span> <span class="n">PlayCard</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">getUrbanisationType</span><span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">theDatasets</span><span class="o">)</span> <span class="o">{</span>
		<span class="kt">float</span> <span class="n">greenspaceArea</span> <span class="o">=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>
		<span class="kt">float</span> <span class="n">domesticBuildingsArea</span> <span class="o">=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>
		<span class="kt">float</span> <span class="n">nonDomesticBuildingsArea</span> <span class="o">=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>
		<span class="kt">float</span> <span class="n">roadsArea</span> <span class="o">=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>
		<span class="kt">float</span> <span class="n">totalNonAdminArea</span> <span class="o">=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>

		<span class="k">for</span> <span class="o">(</span><span class="n">Dataset</span> <span class="n">ds</span> <span class="o">:</span> <span class="n">theDatasets</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">ds</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="n">REQUIRED_FAMILIES</span><span class="o">[</span><span class="mi">0</span><span class="o">]))</span> <span class="o">{</span>
				<span class="k">for</span> <span class="o">(</span><span class="n">Topic</span> <span class="n">t</span> <span class="o">:</span> <span class="n">ds</span><span class="o">.</span><span class="na">getTopics</span><span class="o">().</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;Total Area of All Land Types&quot;</span><span class="o">))</span> <span class="o">{</span>
						<span class="n">totalNonAdminArea</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">()</span>
								<span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
					<span class="o">}</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;Area of Domestic Buildings&quot;</span><span class="o">))</span> <span class="o">{</span>
						<span class="n">domesticBuildingsArea</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">()</span>
								<span class="o">.</span><span class="na">next</span><span class="o">().</span><span class="na">getValue</span><span class="o">();</span>
					<span class="o">}</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;Area of Non Domestic Buildings&quot;</span><span class="o">))</span> <span class="o">{</span>
						<span class="n">nonDomesticBuildingsArea</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">()</span>
								<span class="o">.</span><span class="na">next</span><span class="o">().</span><span class="na">getValue</span><span class="o">();</span>
					<span class="o">}</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;Area of Road&quot;</span><span class="o">))</span> <span class="o">{</span>
						<span class="n">roadsArea</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">().</span><span class="na">getValue</span><span class="o">();</span>
					<span class="o">}</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;Area of Greenspace&quot;</span><span class="o">))</span> <span class="o">{</span>
						<span class="n">greenspaceArea</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">()</span>
								<span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(((</span><span class="n">domesticBuildingsArea</span> <span class="o">+</span> <span class="n">nonDomesticBuildingsArea</span> <span class="o">+</span> <span class="n">roadsArea</span><span class="o">)</span> <span class="o">/</span> <span class="n">totalNonAdminArea</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">AREA_EXTRA_URBAN</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">greenspaceArea</span> <span class="o">/</span> <span class="n">totalNonAdminArea</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">AREA_URBAN</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">AREA_RURAL</span><span class="o">;</span>
        <span class="o">}</span>

	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param theDatasets datasets that has the actual data</span>
<span class="cm">	 * @return the latest year at index 0, the actual energy use at index 1.</span>
<span class="cm">	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">float</span><span class="o">[]</span> <span class="nf">getLatestEnergyUse</span><span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">theDatasets</span><span class="o">)</span> <span class="o">{</span>
		<span class="kt">float</span><span class="o">[]</span> <span class="n">retval</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>

		<span class="k">for</span> <span class="o">(</span><span class="n">Dataset</span> <span class="n">ds</span> <span class="o">:</span> <span class="n">theDatasets</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">ds</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;Domestic Energy Consumption&quot;</span><span class="o">))</span> <span class="o">{</span>
				<span class="k">for</span> <span class="o">(</span><span class="n">Topic</span> <span class="n">t</span> <span class="o">:</span> <span class="n">ds</span><span class="o">.</span><span class="na">getTopics</span><span class="o">().</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">()</span>
							<span class="o">.</span><span class="na">contains</span><span class="o">(</span>
									<span class="s">&quot;Total Consumption of Domestic Electricity and Gas&quot;</span><span class="o">))</span> <span class="o">{</span>
						<span class="n">DataSetItem</span> <span class="n">item</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">();</span>
						<span class="n">retval</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">DateFormat</span><span class="o">.</span><span class="na">getYear</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getPeriod</span><span class="o">()</span>
								<span class="o">.</span><span class="na">getEndDate</span><span class="o">());</span>
						<span class="n">retval</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="n">retval</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@SuppressLint</span><span class="o">(</span><span class="s">&quot;UseSparseArrays&quot;</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="n">TrendDescription</span> <span class="nf">getEnergyTrend</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">,</span>
			<span class="n">List</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">&gt;</span> <span class="n">fams</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InvalidParameterException</span><span class="o">,</span>
			<span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">NDE2Exception</span> <span class="o">{</span>
		<span class="n">TrendDescription</span> <span class="n">ans</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TrendDescription</span><span class="o">();</span>
		<span class="n">DataSetFamily</span> <span class="n">fam</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">DataSetFamily</span> <span class="n">f</span> <span class="o">:</span> <span class="n">fams</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;Domestic Energy Consumption&quot;</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">fam</span> <span class="o">=</span> <span class="n">f</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span>

		<span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">theDatasets</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;();</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">DateRange</span> <span class="n">rng</span> <span class="o">:</span> <span class="n">fam</span><span class="o">.</span><span class="na">getDateRanges</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">theDatasets</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="k">new</span> <span class="n">GetTables</span><span class="o">().</span><span class="na">forArea</span><span class="o">(</span><span class="n">area</span><span class="o">).</span><span class="na">inFamily</span><span class="o">(</span><span class="n">fam</span><span class="o">)</span>
					<span class="o">.</span><span class="na">inDateRange</span><span class="o">(</span><span class="n">rng</span><span class="o">).</span><span class="na">execute</span><span class="o">());</span>
		<span class="o">}</span>

		<span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Float</span><span class="o">&gt;</span> <span class="n">datapoints</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Float</span><span class="o">&gt;();</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">Dataset</span> <span class="n">ds</span> <span class="o">:</span> <span class="n">theDatasets</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">for</span> <span class="o">(</span><span class="n">Topic</span> <span class="n">t</span> <span class="o">:</span> <span class="n">ds</span><span class="o">.</span><span class="na">getTopics</span><span class="o">().</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span>
						<span class="s">&quot;Total Consumption of Domestic Electricity and Gas&quot;</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">DataSetItem</span> <span class="n">item</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">();</span>
					<span class="kt">int</span> <span class="n">shortDate</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getPeriod</span><span class="o">().</span><span class="na">getEndDate</span><span class="o">()</span>
							<span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">/</span> <span class="n">UNIX_30_DAYS</span><span class="o">);</span>
					<span class="kt">float</span> <span class="n">value</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
					<span class="n">datapoints</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">shortDate</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="kt">double</span> <span class="n">gradient</span> <span class="o">=</span> <span class="n">Statistics</span><span class="o">.</span><span class="na">linearRegressionGradient</span><span class="o">(</span><span class="n">datapoints</span><span class="o">);</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">gradient</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">1.2</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ans</span><span class="o">.</span><span class="na">which</span> <span class="o">=</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">FALLING_RAPIDLY</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">gradient</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">1.2</span> <span class="o">&amp;&amp;</span> <span class="n">gradient</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">0.1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ans</span><span class="o">.</span><span class="na">which</span> <span class="o">=</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">FALLING</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">gradient</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">0.1</span> <span class="o">&amp;&amp;</span> <span class="n">gradient</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ans</span><span class="o">.</span><span class="na">which</span> <span class="o">=</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">STABLE</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">gradient</span> <span class="o">&gt;</span> <span class="mf">0.1</span> <span class="o">&amp;&amp;</span> <span class="n">gradient</span> <span class="o">&lt;=</span> <span class="mf">1.2</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ans</span><span class="o">.</span><span class="na">which</span> <span class="o">=</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">RISING</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">ans</span><span class="o">.</span><span class="na">which</span> <span class="o">=</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">RISING_RAPIDLY</span><span class="o">;</span>
        <span class="o">}</span>

		<span class="k">return</span> <span class="n">ans</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">TrendDescription <small>lamparski.areabase.cardproviders</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">cardproviders</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TrendDescription</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">FALLING_RAPIDLY</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">FALLING</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">STABLE</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">RISING</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">RISING_RAPIDLY</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="n">which</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kt">float</span> <span class="n">currentValue</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">AreaRankCard <small>lamparski.areabase.cards</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">cards</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.graphics.Color</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.fima.cardsui.objects.RecyclableCard</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lamparski.areabase.R</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * A Card that displays the AreaRank of an area. The area name should go into &quot;titlePlay&quot;,</span>
<span class="cm"> * and the score should go into &quot;description&quot;.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AreaRankCard</span> <span class="kd">extends</span> <span class="n">RecyclableCard</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">applyTo</span><span class="o">(</span><span class="n">View</span> <span class="n">convertView</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">card_arearank_text</span><span class="o">)).</span><span class="na">setText</span><span class="o">(</span><span class="n">titlePlay</span><span class="o">);</span>
        <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">card_arearank_text</span><span class="o">)).</span><span class="na">setTextColor</span><span class="o">(</span><span class="n">Color</span><span class="o">.</span><span class="na">parseColor</span><span class="o">(</span><span class="n">color</span><span class="o">));</span>
        <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">card_arearank_score</span><span class="o">)).</span><span class="na">setText</span><span class="o">(</span><span class="n">description</span><span class="o">);</span>
        <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">card_arearank_score</span><span class="o">)).</span><span class="na">setBackgroundColor</span><span class="o">(</span><span class="n">Color</span><span class="o">.</span><span class="na">parseColor</span><span class="o">(</span><span class="n">color</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">int</span> <span class="nf">getCardLayoutId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">card_arearank</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">BasicCard <small>lamparski.areabase.cards</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">cards</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.fima.cardsui.objects.RecyclableCard</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lamparski.areabase.R</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BasicCard</span> <span class="kd">extends</span> <span class="n">RecyclableCard</span> <span class="o">{</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param title title of the card</span>
<span class="cm">	 * @param desc text on the card</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">BasicCard</span><span class="o">(</span><span class="n">String</span> <span class="n">title</span><span class="o">,</span> <span class="n">String</span> <span class="n">desc</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">title</span><span class="o">,</span> <span class="n">desc</span><span class="o">);</span>
		<span class="c1">// TODO Auto-generated constructor stub</span>
		<span class="c1">// setBackgroundResource(R.drawable.card);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">BasicCard</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">applyTo</span><span class="o">(</span><span class="n">View</span> <span class="n">convertCardView</span><span class="o">)</span> <span class="o">{</span>
		<span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertCardView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">card_basic_title</span><span class="o">))</span>
				<span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">title</span><span class="o">);</span>
		<span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertCardView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">card_basic_text</span><span class="o">))</span>
				<span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">desc</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">int</span> <span class="nf">getCardLayoutId</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">card_ex</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">ErrorCard <small>lamparski.areabase.cards</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">cards</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.ImageView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.fima.cardsui.objects.RecyclableCard</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lamparski.areabase.R</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * An attempt at user-friendly error messages.</span>
<span class="cm"> *</span>
<span class="cm"> * Of course it doesn&#39;t work all the time, but hey.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ErrorCard</span> <span class="kd">extends</span> <span class="n">RecyclableCard</span> <span class="o">{</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">applyTo</span><span class="o">(</span><span class="n">View</span> <span class="n">convertView</span><span class="o">)</span> <span class="o">{</span>
		<span class="o">((</span><span class="n">ImageView</span><span class="o">)</span> <span class="n">convertView</span>
				<span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">cardsui_error_placeholder_icon</span><span class="o">))</span>
				<span class="o">.</span><span class="na">setImageResource</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">imageRes</span><span class="o">);</span>
		<span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertView</span>
				<span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">cardsui_error_placeholder_title</span><span class="o">))</span>
				<span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">titlePlay</span><span class="o">);</span>
		<span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertView</span>
				<span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">cardsui_error_placeholder_msg</span><span class="o">))</span>
				<span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">description</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">int</span> <span class="nf">getCardLayoutId</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">card_error</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">EventfulArrayList <small>lamparski.areabase.cards</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">cards</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * An {@link java.util.ArrayList} that also emits an event when an item is added.</span>
<span class="cm"> * @param &lt;E&gt; Element type.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EventfulArrayList</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mh">0xC0C4133</span><span class="n">L</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">OnItemAddedListener</span> <span class="n">addCb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OnItemAddedListener</span><span class="o">()</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onItemAdded</span><span class="o">(</span><span class="n">Object</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Gets activated when an item is added to the list. The handler</span>
<span class="cm">     * can actually veto the add.</span>
<span class="cm">     */</span>
	<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OnItemAddedListener</span> <span class="o">{</span>
		<span class="cm">/**</span>
<span class="cm">		 * Called when an item is added to the list</span>
<span class="cm">		 * </span>
<span class="cm">		 * @param item</span>
<span class="cm">		 *            The item being added</span>
<span class="cm">		 * @return false if you want to veto this.</span>
<span class="cm">		 */</span>
		<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onItemAdded</span><span class="o">(</span><span class="n">Object</span> <span class="n">item</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">     * In addition to adding an element, will also emit an event.</span>
<span class="cm">	 * {@inheritDoc}</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="n">E</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">addCb</span><span class="o">.</span><span class="na">onItemAdded</span><span class="o">(</span><span class="n">object</span><span class="o">)</span> <span class="o">?</span> <span class="kd">super</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">object</span><span class="o">)</span> <span class="o">:</span> <span class="kc">false</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * In addition to adding an element, will also emit an event.</span>
<span class="cm">     * {@inheritDoc}</span>
<span class="cm">     */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="n">E</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">addCb</span><span class="o">.</span><span class="na">onItemAdded</span><span class="o">(</span><span class="n">object</span><span class="o">))</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="n">object</span><span class="o">);</span>
        <span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setOnItemAddedListener</span><span class="o">(</span><span class="n">OnItemAddedListener</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">addCb</span> <span class="o">=</span> <span class="n">listener</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addSilent</span><span class="o">(</span><span class="n">E</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">PlayCard <small>lamparski.areabase.cards</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">cards</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.graphics.Color</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.ImageView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.LinearLayout</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.fima.cardsui.objects.RecyclableCard</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lamparski.areabase.R</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PlayCard</span> <span class="kd">extends</span> <span class="n">RecyclableCard</span> <span class="o">{</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param titlePlay card title</span>
<span class="cm">	 * @param description card body</span>
<span class="cm">	 * @param color overall colour of the card</span>
<span class="cm">	 * @param titleColor title colour</span>
<span class="cm">	 * @param hasOverflow display the overflow icon?</span>
<span class="cm">	 * @param isClickable is card clickable?</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">PlayCard</span><span class="o">(</span><span class="n">String</span> <span class="n">titlePlay</span><span class="o">,</span> <span class="n">String</span> <span class="n">description</span><span class="o">,</span> <span class="n">String</span> <span class="n">color</span><span class="o">,</span>
			<span class="n">String</span> <span class="n">titleColor</span><span class="o">,</span> <span class="n">Boolean</span> <span class="n">hasOverflow</span><span class="o">,</span> <span class="n">Boolean</span> <span class="n">isClickable</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">titlePlay</span><span class="o">,</span> <span class="n">description</span><span class="o">,</span> <span class="n">color</span><span class="o">,</span> <span class="n">titleColor</span><span class="o">,</span> <span class="n">hasOverflow</span><span class="o">,</span>
				<span class="n">isClickable</span><span class="o">);</span>
	<span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unused&quot;</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nf">PlayCard</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">applyTo</span><span class="o">(</span><span class="n">View</span> <span class="n">playCardView</span><span class="o">)</span> <span class="o">{</span>
		<span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">playCardView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">card_play_title</span><span class="o">))</span>
				<span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">titlePlay</span><span class="o">);</span>
		<span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">playCardView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">card_play_title</span><span class="o">))</span>
				<span class="o">.</span><span class="na">setTextColor</span><span class="o">(</span><span class="n">Color</span><span class="o">.</span><span class="na">parseColor</span><span class="o">(</span><span class="n">titleColor</span><span class="o">));</span>

		<span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">playCardView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">card_play_text</span><span class="o">))</span>
				<span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">description</span><span class="o">);</span>

		<span class="n">playCardView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">card_play_stripe</span><span class="o">).</span><span class="na">setBackgroundColor</span><span class="o">(</span>
				<span class="n">Color</span><span class="o">.</span><span class="na">parseColor</span><span class="o">(</span><span class="n">color</span><span class="o">));</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">isClickable</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">((</span><span class="n">LinearLayout</span><span class="o">)</span> <span class="n">playCardView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">contentLayout</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">setBackgroundResource</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">selectable_background_cardbank</span><span class="o">);</span>
        <span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">hasOverflow</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">((</span><span class="n">ImageView</span><span class="o">)</span> <span class="n">playCardView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">card_play_overflow</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">VISIBLE</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="o">((</span><span class="n">ImageView</span><span class="o">)</span> <span class="n">playCardView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">card_play_overflow</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">GONE</span><span class="o">);</span>
        <span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">int</span> <span class="nf">getCardLayoutId</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">card_play</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">DemoObjectFragment <small>lamparski.areabase.dummy.mockup_classes</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">dummy</span><span class="o">.</span><span class="na">mockup_classes</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.app.Fragment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.LayoutInflater</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.ViewGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lamparski.areabase.R</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Dummy fragment. Shows an integer.</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="nd">@Deprecated</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DemoObjectFragment</span> <span class="kd">extends</span> <span class="n">Fragment</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ARGUMENT</span> <span class="o">=</span> <span class="s">&quot;fragment-content&quot;</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ARGUMENT2</span> <span class="o">=</span> <span class="s">&quot;fragment-title&quot;</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">DemoObjectFragment</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">View</span> <span class="nf">onCreateView</span><span class="o">(</span><span class="n">LayoutInflater</span> <span class="n">inflater</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">container</span><span class="o">,</span>
			<span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">View</span> <span class="n">myView</span> <span class="o">=</span> <span class="n">inflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">fragment_collection_object</span><span class="o">,</span>
				<span class="n">container</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
		<span class="n">Bundle</span> <span class="n">args</span> <span class="o">=</span> <span class="n">getArguments</span><span class="o">();</span>
		<span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">myView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">objectIdTextView</span><span class="o">)).</span><span class="na">setText</span><span class="o">(</span><span class="n">args</span>
				<span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">ARGUMENT</span><span class="o">));</span>
		<span class="n">getActivity</span><span class="o">().</span><span class="na">setTitle</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">ARGUMENT2</span><span class="o">));</span>
		<span class="k">return</span> <span class="n">myView</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">DummyData <small>ense-block</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*//**</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">dummy</span><span class="o">.</span><span class="na">mockup_classes</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Indicates that whatever code is annotated by this is a placeholder or uses</span>
<span class="cm"> * dummy data.</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">DummyData</span> <span class="o">{</span>
	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @return The reason for using dummy data.</span>
<span class="cm">	 */</span>
	<span class="n">String</span> <span class="nf">why</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;Will implement later&quot;</span><span class="o">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @return What real data should be used.</span>
<span class="cm">	 */</span>
	<span class="n">String</span> <span class="nf">replace_with</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;Something that does what it says on the tin.&quot;</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">DatasetGraphFragment <small>lamparski.areabase.fragments</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">fragments</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.app.Fragment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.LayoutInflater</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.ViewGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.AdapterView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.AdapterView.OnItemSelectedListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.BaseAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.ListView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TabHost</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.echo.holographlibrary.Bar</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.echo.holographlibrary.BarGraph</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.echo.holographlibrary.BarGraph.OnBarClickedListener</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lamparski.areabase.R</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.helpers.CensusHelpers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DataSetItem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Topic</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Displays data from a single dataset as a graph with a legend.</span>
<span class="cm"> *</span>
<span class="cm"> * @author filip</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DatasetGraphFragment</span> <span class="kd">extends</span> <span class="n">Fragment</span>
        <span class="kd">implements</span> <span class="n">OnItemSelectedListener</span><span class="o">,</span> <span class="n">OnBarClickedListener</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">MListAdapter</span> <span class="kd">extends</span> <span class="n">BaseAdapter</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getCount</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">dataSetItems</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getItem</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">dataSetItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getItemId</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">position</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">View</span> <span class="nf">getView</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="n">View</span> <span class="n">convertView</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">convertView</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">getActivity</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                <span class="n">LayoutInflater</span> <span class="n">inflater</span> <span class="o">=</span> <span class="n">LayoutInflater</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">getActivity</span><span class="o">());</span>
                <span class="n">convertView</span> <span class="o">=</span> <span class="n">inflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">subject_view_listitem</span><span class="o">,</span> <span class="n">parent</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">DataSetItem</span> <span class="n">item</span> <span class="o">=</span> <span class="n">dataSetItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
            <span class="n">Topic</span> <span class="n">topic</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="na">getTopic</span><span class="o">();</span>
            <span class="n">String</span> <span class="n">valstr</span> <span class="o">=</span> <span class="n">CensusHelpers</span><span class="o">.</span><span class="na">getValueString</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getValue</span><span class="o">(),</span> <span class="n">topic</span><span class="o">.</span><span class="na">getCoinageUnit</span><span class="o">());</span>

            <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_listitem_title</span><span class="o">)).</span><span class="na">setText</span><span class="o">(</span><span class="n">topic</span><span class="o">.</span><span class="na">getTitle</span><span class="o">());</span>
            <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_listitem_subtitle</span><span class="o">)).</span><span class="na">setText</span><span class="o">(</span><span class="n">topic</span><span class="o">.</span><span class="na">getDescription</span><span class="o">());</span>
            <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_listitem_count</span><span class="o">)).</span><span class="na">setText</span><span class="o">(</span><span class="n">valstr</span><span class="o">);</span>

            <span class="k">return</span> <span class="n">convertView</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEnabled</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEGEND</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">GRAPH</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">Dataset</span> <span class="n">dataset</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;</span> <span class="n">dataSetItems</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Bar</span><span class="o">&gt;</span> <span class="n">bars</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">currentTab</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">ListView</span> <span class="n">legend</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">BarGraph</span> <span class="n">graph</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">TabHost</span> <span class="n">tabHost</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">DatasetGraphFragment</span><span class="o">(){</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">graph</span><span class="o">.</span><span class="na">getBars</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">).</span><span class="na">setColor</span><span class="o">(</span><span class="n">getResources</span><span class="o">().</span><span class="na">getColor</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">color</span><span class="o">.</span><span class="na">holo_green_dark</span><span class="o">));</span>
        <span class="n">legend</span><span class="o">.</span><span class="na">setSelection</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">tabHost</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">)</span> <span class="o">{</span> <span class="n">tabHost</span><span class="o">.</span><span class="na">setCurrentTab</span><span class="o">(</span><span class="n">LEGEND</span><span class="o">);</span> <span class="o">}</span>
        <span class="n">legend</span><span class="o">.</span><span class="na">smoothScrollToPosition</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onItemSelected</span><span class="o">(</span><span class="n">AdapterView</span><span class="o">&lt;?&gt;</span> <span class="n">parent</span><span class="o">,</span> <span class="n">View</span> <span class="n">view</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">graph</span><span class="o">.</span><span class="na">getBars</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">).</span><span class="na">setColor</span><span class="o">(</span><span class="n">getResources</span><span class="o">().</span><span class="na">getColor</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">color</span><span class="o">.</span><span class="na">holo_green_dark</span><span class="o">));</span>
        <span class="k">if</span><span class="o">(</span><span class="n">tabHost</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">)</span> <span class="o">{</span> <span class="n">tabHost</span><span class="o">.</span><span class="na">setCurrentTab</span><span class="o">(</span><span class="n">GRAPH</span><span class="o">);</span> <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onNothingSelected</span><span class="o">(</span><span class="n">AdapterView</span><span class="o">&lt;?&gt;</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Bar</span> <span class="n">bar</span> <span class="o">:</span> <span class="n">graph</span><span class="o">.</span><span class="na">getBars</span><span class="o">()){</span>
            <span class="n">bar</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">getResources</span><span class="o">().</span><span class="na">getColor</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">color</span><span class="o">.</span><span class="na">holo_blue_dark</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">View</span> <span class="nf">onCreateView</span><span class="o">(</span><span class="n">LayoutInflater</span> <span class="n">inflater</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">container</span><span class="o">,</span> <span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;DatasetGraphFragment&quot;</span><span class="o">,</span> <span class="s">&quot;Creating view...&quot;</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">getArguments</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">getArguments</span><span class="o">().</span><span class="na">containsKey</span><span class="o">(</span><span class="s">&quot;dataset&quot;</span><span class="o">)){</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="o">(</span><span class="n">Dataset</span><span class="o">)</span> <span class="n">getArguments</span><span class="o">().</span><span class="na">getSerializable</span><span class="o">(</span><span class="s">&quot;dataset&quot;</span><span class="o">);</span>
            <span class="n">dataSetItems</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;(</span><span class="n">dataset</span><span class="o">.</span><span class="na">getItems</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;Need to have a Dataset specified&quot;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">View</span> <span class="n">theView</span> <span class="o">=</span> <span class="n">inflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">fragment_graphactivity</span><span class="o">,</span> <span class="n">container</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>

        <span class="n">tabHost</span> <span class="o">=</span> <span class="o">(</span><span class="n">TabHost</span><span class="o">)</span> <span class="n">theView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">graph_activity_tabhost</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">tabHost</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">if</span><span class="o">(</span><span class="n">savedInstanceState</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">savedInstanceState</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">&quot;which-tab&quot;</span><span class="o">)){</span>
                <span class="n">currentTab</span> <span class="o">=</span> <span class="n">savedInstanceState</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;which-tab&quot;</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">tabHost</span><span class="o">.</span><span class="na">setup</span><span class="o">();</span>

            <span class="n">TabHost</span><span class="o">.</span><span class="na">TabSpec</span> <span class="n">graphTabspec</span> <span class="o">=</span> <span class="n">tabHost</span><span class="o">.</span><span class="na">newTabSpec</span><span class="o">(</span><span class="s">&quot;tab-graph&quot;</span><span class="o">);</span>
            <span class="n">graphTabspec</span><span class="o">.</span><span class="na">setIndicator</span><span class="o">(</span><span class="n">getResources</span><span class="o">().</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">tab_graph</span><span class="o">));</span>
            <span class="n">graphTabspec</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">graph_activity_tab1</span><span class="o">);</span>

            <span class="n">TabHost</span><span class="o">.</span><span class="na">TabSpec</span> <span class="n">legendTabspec</span> <span class="o">=</span> <span class="n">tabHost</span><span class="o">.</span><span class="na">newTabSpec</span><span class="o">(</span><span class="s">&quot;tab-legend&quot;</span><span class="o">);</span>
            <span class="n">legendTabspec</span><span class="o">.</span><span class="na">setIndicator</span><span class="o">(</span><span class="n">getResources</span><span class="o">().</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">tab_legend</span><span class="o">));</span>
            <span class="n">legendTabspec</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">graph_activity_tab2</span><span class="o">);</span>

            <span class="n">tabHost</span><span class="o">.</span><span class="na">addTab</span><span class="o">(</span><span class="n">graphTabspec</span><span class="o">);</span>
            <span class="n">tabHost</span><span class="o">.</span><span class="na">addTab</span><span class="o">(</span><span class="n">legendTabspec</span><span class="o">);</span>

            <span class="k">if</span><span class="o">(</span><span class="n">currentTab</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="o">){</span>
                <span class="n">tabHost</span><span class="o">.</span><span class="na">setCurrentTab</span><span class="o">(</span><span class="n">currentTab</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">MListAdapter</span> <span class="n">adapter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MListAdapter</span><span class="o">();</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="o">(</span><span class="n">ListView</span><span class="o">)</span> <span class="n">theView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">graph_activity_legend_list</span><span class="o">);</span>
        <span class="n">legend</span><span class="o">.</span><span class="na">setAdapter</span><span class="o">(</span><span class="n">adapter</span><span class="o">);</span>
        <span class="n">legend</span><span class="o">.</span><span class="na">setChoiceMode</span><span class="o">(</span><span class="n">ListView</span><span class="o">.</span><span class="na">CHOICE_MODE_SINGLE</span><span class="o">);</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="o">(</span><span class="n">BarGraph</span><span class="o">)</span> <span class="n">theView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">graph_activity_bargraph</span><span class="o">);</span>

        <span class="n">bars</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Bar</span><span class="o">&gt;(</span><span class="n">dataSetItems</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="k">for</span><span class="o">(</span><span class="n">DataSetItem</span> <span class="n">item</span> <span class="o">:</span> <span class="n">dataSetItems</span><span class="o">){</span>
            <span class="k">if</span><span class="o">(</span><span class="n">canGraph</span><span class="o">(</span><span class="n">item</span><span class="o">)){</span>
                <span class="n">Bar</span> <span class="n">bar</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bar</span><span class="o">();</span>
                <span class="n">bar</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getTopic</span><span class="o">().</span><span class="na">getTitle</span><span class="o">());</span>
                <span class="n">bar</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
                <span class="n">bar</span><span class="o">.</span><span class="na">setValueString</span><span class="o">(</span><span class="n">CensusHelpers</span><span class="o">.</span><span class="na">getValueString</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getValue</span><span class="o">(),</span> <span class="n">item</span><span class="o">.</span><span class="na">getTopic</span><span class="o">().</span><span class="na">getCoinageUnit</span><span class="o">()));</span>
                <span class="n">bar</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">getResources</span><span class="o">().</span><span class="na">getColor</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">color</span><span class="o">.</span><span class="na">holo_blue_dark</span><span class="o">));</span>
                <span class="n">bars</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">bar</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">graph</span><span class="o">.</span><span class="na">setBars</span><span class="o">(</span><span class="n">bars</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">theView</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Determines if this dataset item should go onto graph. Functions as a sort of blacklist,</span>
<span class="cm">     * in that it tries its best to exclude totals from the graph.</span>
<span class="cm">     * @param item the item</span>
<span class="cm">     * @return whether it should be shown on graph.</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">canGraph</span><span class="o">(</span><span class="n">DataSetItem</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">title</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="na">getTopic</span><span class="o">().</span><span class="na">getTitle</span><span class="o">().</span><span class="na">toLowerCase</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">title</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;all people&quot;</span><span class="o">)){</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">title</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;all usual residents&quot;</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">title</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;all households&quot;</span><span class="o">)){</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSaveInstanceState</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">outState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onSaveInstanceState</span><span class="o">(</span><span class="n">outState</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">tabHost</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">outState</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="s">&quot;which-tab&quot;</span><span class="o">,</span> <span class="n">tabHost</span><span class="o">.</span><span class="na">getCurrentTab</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onActivityCreated</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onActivityCreated</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">getView</span><span class="o">().</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_header</span><span class="o">)).</span><span class="na">setText</span><span class="o">(</span><span class="n">dataset</span><span class="o">.</span><span class="na">getTitle</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Create a new DatasetGraphFragment for the given Dataset.</span>
<span class="cm">     * @param dataset The dataset to display</span>
<span class="cm">     * @return the fragment</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">DatasetGraphFragment</span> <span class="nf">newInstance</span><span class="o">(</span><span class="n">Dataset</span> <span class="n">dataset</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;DatasetGraphFragment&quot;</span><span class="o">,</span>
                <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;static newInstance called with %s&quot;</span><span class="o">,</span> <span class="n">dataset</span><span class="o">.</span><span class="na">toString</span><span class="o">()));</span>
        <span class="n">DatasetGraphFragment</span> <span class="n">fragment</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DatasetGraphFragment</span><span class="o">();</span>
        <span class="n">Bundle</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bundle</span><span class="o">();</span>
        <span class="n">args</span><span class="o">.</span><span class="na">putSerializable</span><span class="o">(</span><span class="s">&quot;dataset&quot;</span><span class="o">,</span> <span class="n">dataset</span><span class="o">);</span>
        <span class="n">fragment</span><span class="o">.</span><span class="na">setArguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">fragment</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">DemographicsDetailFragment <small>lamparski.areabase.fragments</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">fragments</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.os.AsyncTask</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lamparski.areabase.AreaActivity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.R</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.cardproviders.DemographicsCardProvider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.helpers.CensusHelpers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.methodcalls.delivery.GetTables</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DataSetFamily</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Subject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Topic</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Keeping this one around as it may come in handy.</span>
<span class="cm"> *</span>
<span class="cm"> * Displays slightly more detailed information about the demographics in the area.</span>
<span class="cm"> *</span>
<span class="cm"> * @see lamparski.areabase.fragments.SummaryFragment</span>
<span class="cm"> */</span>
<span class="nd">@Deprecated</span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unused&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">DemographicsDetailFragment</span> <span class="kd">extends</span> <span class="n">DetailViewFragment</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="n">View</span> <span class="n">myView</span><span class="o">;</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStart</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onStart</span><span class="o">();</span>

		<span class="n">myView</span> <span class="o">=</span> <span class="n">getView</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Sets a label with id whichLabel to targetText. This is a helper function</span>
<span class="cm">	 * to help deal with cross-thread communication.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param whichLabel</span>
<span class="cm">	 *            The R.id of the label to set</span>
<span class="cm">	 * @param targetText</span>
<span class="cm">	 *            new text to set</span>
<span class="cm">	 */</span>
	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">setLabelOnUiThread</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">whichLabel</span><span class="o">,</span>
			<span class="kd">final</span> <span class="n">String</span> <span class="n">targetText</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">getActivity</span><span class="o">().</span><span class="na">runOnUiThread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">myView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">whichLabel</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">targetText</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">refreshContent</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">if</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">area</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="o">((</span><span class="n">AreaActivity</span><span class="o">)</span> <span class="n">getActivity</span><span class="o">()).</span><span class="na">setTitle</span><span class="o">(</span><span class="n">area</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="o">((</span><span class="n">AreaActivity</span><span class="o">)</span> <span class="n">getActivity</span><span class="o">()).</span><span class="na">setTitle</span><span class="o">(</span><span class="s">&quot;Demographics view&quot;</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
		<span class="k">new</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">Void</span><span class="o">&gt;()</span> <span class="o">{</span>
			<span class="nd">@Override</span>
			<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPreExecute</span><span class="o">()</span> <span class="o">{</span>
				<span class="c1">// do something to show the progress indicator on action bar</span>
			<span class="o">}</span>

			<span class="nd">@Override</span>
			<span class="kd">protected</span> <span class="n">Void</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">Area</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="n">Area</span> <span class="n">theArea</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
					<span class="n">Subject</span> <span class="n">subj</span> <span class="o">=</span> <span class="n">CensusHelpers</span><span class="o">.</span><span class="na">findSubject</span><span class="o">(</span><span class="n">theArea</span><span class="o">,</span> <span class="s">&quot;Census&quot;</span><span class="o">);</span>
					<span class="n">List</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">&gt;</span> <span class="n">dsfamilies</span> <span class="o">=</span> <span class="n">CensusHelpers</span>
							<span class="o">.</span><span class="na">findRequiredFamilies</span><span class="o">(</span><span class="n">theArea</span><span class="o">,</span> <span class="n">subj</span><span class="o">,</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span>
									<span class="s">&quot;Population Density&quot;</span><span class="o">,</span> <span class="s">&quot;Sex&quot;</span><span class="o">,</span>
									<span class="s">&quot;Age by Single Year&quot;</span><span class="o">,</span> <span class="s">&quot;Country of Birth&quot;</span><span class="o">,</span>
									<span class="s">&quot;Ethnic Group&quot;</span> <span class="o">});</span>

					<span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">datasets</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GetTables</span><span class="o">().</span><span class="na">forArea</span><span class="o">(</span><span class="n">theArea</span><span class="o">)</span>
							<span class="o">.</span><span class="na">inFamilies</span><span class="o">(</span><span class="n">dsfamilies</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>

					<span class="n">String</span> <span class="n">popdens</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%.2f&quot;</span><span class="o">,</span>
							<span class="n">findPopulationDensity</span><span class="o">(</span><span class="n">theArea</span><span class="o">,</span> <span class="n">datasets</span><span class="o">));</span>
					<span class="n">setLabelOnUiThread</span><span class="o">(</span>
							<span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">demographics_summary_pop_density_val</span><span class="o">,</span> <span class="n">popdens</span><span class="o">);</span>

					<span class="n">String</span> <span class="n">avgage</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%.1f&quot;</span><span class="o">,</span>
							<span class="n">findAverageAge</span><span class="o">(</span><span class="n">theArea</span><span class="o">,</span> <span class="n">datasets</span><span class="o">));</span>
					<span class="n">setLabelOnUiThread</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">demographics_summary_avg_age_val</span><span class="o">,</span>
							<span class="n">avgage</span><span class="o">);</span>

					<span class="n">String</span> <span class="n">popsize</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">findPopulationSize</span><span class="o">(</span>
							<span class="n">theArea</span><span class="o">,</span> <span class="n">datasets</span><span class="o">));</span>
					<span class="n">setLabelOnUiThread</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">demographics_summary_pop_size_val</span><span class="o">,</span>
							<span class="n">popsize</span><span class="o">);</span>

					<span class="n">String</span> <span class="n">women</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%.1f&quot;</span><span class="o">,</span>
							<span class="n">findWomenPercentage</span><span class="o">(</span><span class="n">theArea</span><span class="o">,</span> <span class="n">datasets</span><span class="o">));</span>
					<span class="n">setLabelOnUiThread</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">demographics_summary_pop_women_val</span><span class="o">,</span>
							<span class="n">women</span><span class="o">);</span>

					<span class="n">String</span> <span class="n">main_ethnic_group</span> <span class="o">=</span> <span class="n">findMainEthnicGroup</span><span class="o">(</span><span class="n">theArea</span><span class="o">,</span>
							<span class="n">datasets</span><span class="o">);</span>
					<span class="n">setLabelOnUiThread</span><span class="o">(</span>
							<span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">demographics_summary_ethnic_group_val</span><span class="o">,</span>
							<span class="n">main_ethnic_group</span><span class="o">);</span>

					<span class="n">String</span> <span class="n">immigration</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%.1f&quot;</span><span class="o">,</span>
							<span class="n">findImmigration</span><span class="o">(</span><span class="n">theArea</span><span class="o">,</span> <span class="n">datasets</span><span class="o">));</span>
					<span class="n">setLabelOnUiThread</span><span class="o">(</span>
							<span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">demographics_summary_immigration_val</span><span class="o">,</span>
							<span class="n">immigration</span><span class="o">);</span>
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="kd">final</span> <span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">showCroutonCrossThread</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
				<span class="o">}</span>

				<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="n">Void</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// hide the progress indicator</span>
			<span class="o">}</span>

		<span class="o">}.</span><span class="na">execute</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">protected</span> <span class="kt">float</span> <span class="nf">findImmigration</span><span class="o">(</span><span class="n">Area</span> <span class="n">theArea</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">datasets</span><span class="o">)</span> <span class="o">{</span>
		<span class="kt">float</span> <span class="n">percentage</span> <span class="o">=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>

		<span class="kt">float</span> <span class="n">all</span> <span class="o">=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>
		<span class="kt">float</span> <span class="n">nonuk</span> <span class="o">=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">Dataset</span> <span class="n">ds</span> <span class="o">:</span> <span class="n">datasets</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">ds</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;Country of Birth&quot;</span><span class="o">))</span> <span class="o">{</span>
				<span class="k">for</span> <span class="o">(</span><span class="n">Topic</span> <span class="n">t</span> <span class="o">:</span> <span class="n">ds</span><span class="o">.</span><span class="na">getTopics</span><span class="o">().</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;All Usual Residents&quot;</span><span class="o">))</span> <span class="o">{</span>
						<span class="n">all</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">().</span><span class="na">getValue</span><span class="o">();</span>
					<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Europe; Other Europe&quot;</span><span class="o">)</span>
							<span class="o">||</span> <span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Europe; Ireland&quot;</span><span class="o">)</span>
							<span class="o">||</span> <span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Africa&quot;</span><span class="o">)</span>
							<span class="o">||</span> <span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Middle East and Asia&quot;</span><span class="o">)</span>
							<span class="o">||</span> <span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span>
									<span class="s">&quot;The Americas and the Caribbean&quot;</span><span class="o">)</span>
							<span class="o">||</span> <span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Antarctica and Oceania&quot;</span><span class="o">))</span> <span class="o">{</span>
						<span class="n">nonuk</span> <span class="o">+=</span> <span class="n">ds</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">().</span><span class="na">getValue</span><span class="o">();</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="n">percentage</span> <span class="o">=</span> <span class="o">(</span><span class="n">nonuk</span> <span class="o">/</span> <span class="n">all</span><span class="o">)</span> <span class="o">*</span> <span class="mi">100</span><span class="o">;</span>

		<span class="k">return</span> <span class="n">percentage</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">protected</span> <span class="n">String</span> <span class="nf">findMainEthnicGroup</span><span class="o">(</span><span class="n">Area</span> <span class="n">theArea</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">datasets</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">ethnicGroup</span> <span class="o">=</span> <span class="s">&quot;Undetermined&quot;</span><span class="o">;</span>
		<span class="kt">float</span> <span class="n">all</span> <span class="o">=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>
		<span class="kt">float</span> <span class="n">cEthnicGroup</span> <span class="o">=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>

		<span class="k">for</span> <span class="o">(</span><span class="n">Dataset</span> <span class="n">ds</span> <span class="o">:</span> <span class="n">datasets</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">ds</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;Ethnic Group&quot;</span><span class="o">))</span> <span class="o">{</span>
				<span class="k">for</span> <span class="o">(</span><span class="n">Topic</span> <span class="n">t</span> <span class="o">:</span> <span class="n">ds</span><span class="o">.</span><span class="na">getTopics</span><span class="o">().</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;All People&quot;</span><span class="o">))</span> <span class="o">{</span>
						<span class="n">all</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">().</span><span class="na">getValue</span><span class="o">();</span>
					<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
						<span class="kt">float</span> <span class="n">curval</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">()</span>
								<span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">curval</span> <span class="o">&gt;</span> <span class="n">cEthnicGroup</span><span class="o">)</span> <span class="o">{</span>
							<span class="n">cEthnicGroup</span> <span class="o">=</span> <span class="n">curval</span><span class="o">;</span>
							<span class="n">ethnicGroup</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">();</span>
						<span class="o">}</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%s (%.1f)&quot;</span><span class="o">,</span> <span class="n">ethnicGroup</span><span class="o">,</span>
				<span class="o">(</span><span class="n">cEthnicGroup</span> <span class="o">/</span> <span class="n">all</span><span class="o">)</span> <span class="o">*</span> <span class="mi">100</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">protected</span> <span class="kt">float</span> <span class="nf">findWomenPercentage</span><span class="o">(</span><span class="n">Area</span> <span class="n">theArea</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">datasets</span><span class="o">)</span> <span class="o">{</span>
		<span class="kt">float</span> <span class="n">percentage</span> <span class="o">=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>

		<span class="kt">float</span> <span class="n">women</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="kt">float</span> <span class="n">all</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

		<span class="k">for</span> <span class="o">(</span><span class="n">Dataset</span> <span class="n">ds</span> <span class="o">:</span> <span class="n">datasets</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">ds</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;Sex&quot;</span><span class="o">))</span> <span class="o">{</span>
				<span class="k">for</span> <span class="o">(</span><span class="n">Topic</span> <span class="n">t</span> <span class="o">:</span> <span class="n">ds</span><span class="o">.</span><span class="na">getTopics</span><span class="o">().</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;All&quot;</span><span class="o">))</span> <span class="o">{</span>
						<span class="n">all</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">().</span><span class="na">getValue</span><span class="o">();</span>
					<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;Females&quot;</span><span class="o">))</span> <span class="o">{</span>
						<span class="n">women</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">().</span><span class="na">getValue</span><span class="o">();</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="n">percentage</span> <span class="o">=</span> <span class="o">(</span><span class="n">women</span> <span class="o">/</span> <span class="n">all</span><span class="o">)</span> <span class="o">*</span> <span class="mi">100</span><span class="n">f</span><span class="o">;</span>
		<span class="k">return</span> <span class="n">percentage</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">protected</span> <span class="kt">int</span> <span class="nf">findPopulationSize</span><span class="o">(</span><span class="n">Area</span> <span class="n">theArea</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">datasets</span><span class="o">)</span> <span class="o">{</span>
		<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

		<span class="k">for</span> <span class="o">(</span><span class="n">Dataset</span> <span class="n">ds</span> <span class="o">:</span> <span class="n">datasets</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">ds</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;Sex&quot;</span><span class="o">))</span> <span class="o">{</span>
				<span class="k">for</span> <span class="o">(</span><span class="n">Topic</span> <span class="n">t</span> <span class="o">:</span> <span class="n">ds</span><span class="o">.</span><span class="na">getTopics</span><span class="o">().</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;All&quot;</span><span class="o">))</span> <span class="o">{</span>
						<span class="n">size</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">ds</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">()</span>
								<span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="n">size</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">protected</span> <span class="kt">float</span> <span class="nf">findAverageAge</span><span class="o">(</span><span class="n">Area</span> <span class="n">theArea</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">datasets</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// code reuse, ugly but should work</span>
		<span class="k">return</span> <span class="n">DemographicsCardProvider</span><span class="o">.</span><span class="na">calculateAverageAge</span><span class="o">(</span><span class="n">datasets</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">protected</span> <span class="kt">float</span> <span class="nf">findPopulationDensity</span><span class="o">(</span><span class="n">Area</span> <span class="n">theArea</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">datasets</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">DemographicsCardProvider</span><span class="o">.</span><span class="na">getPopulationDensity</span><span class="o">(</span><span class="n">datasets</span><span class="o">);</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">DetailViewFragment <small>lamparski.areabase.fragments</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">fragments</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.app.Fragment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.ComponentName</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Intent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.ServiceConnection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.IBinder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.LayoutInflater</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.ViewGroup</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">de.keyboardsurfer.android.widget.crouton.Crouton</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">de.keyboardsurfer.android.widget.crouton.Style</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.AreaActivity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.R</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.services.AreaDataService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.services.AreaDataService.AreaDataBinder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.services.AreaDataService.AreaLookupCallbacks</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">widgets</span><span class="o">.</span><span class="na">CommonDialogs</span><span class="o">.</span><span class="na">serviceDisconnectAlert</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * A base class for all fragments that deal with {@link nde2.pull.types.Area} objects and/or</span>
<span class="cm"> * @{link Subject}s but are not {@link lamparski.areabase.fragments.SummaryFragment}s. This offers</span>
<span class="cm"> * a way of connecting to the {@link lamparski.areabase.services.AreaDataService} and retains the</span>
<span class="cm"> * area information, however most implementations usually just go for getting the area from</span>
<span class="cm"> * AreaActivity.</span>
<span class="cm"> *</span>
<span class="cm"> * @author filip</span>
<span class="cm"> * @see lamparski.areabase.services.AreaDataService</span>
<span class="cm"> * @see lamparski.areabase.AreaActivity</span>
<span class="cm"> * @see lamparski.areabase.fragments.SummaryFragment</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">DetailViewFragment</span> <span class="kd">extends</span> <span class="n">Fragment</span> <span class="kd">implements</span>
		<span class="n">IAreabaseFragment</span> <span class="o">{</span>

	<span class="kd">protected</span> <span class="n">Area</span> <span class="n">area</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="n">String</span> <span class="n">subjectName</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

	<span class="kd">protected</span> <span class="n">AreaDataService</span> <span class="n">mService</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="kt">boolean</span> <span class="n">isServiceBound</span><span class="o">,</span> <span class="n">is_live</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="n">ServiceConnection</span> <span class="n">mServiceConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServiceConnection</span><span class="o">()</span> <span class="o">{</span>

		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceDisconnected</span><span class="o">(</span><span class="n">ComponentName</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">is_live</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span>
						<span class="s">&quot;The AreaDataService disconnected unexpectedly.&quot;</span><span class="o">);</span>
				<span class="n">isServiceBound</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
				<span class="n">serviceDisconnectAlert</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">getActivity</span><span class="o">());</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceConnected</span><span class="o">(</span><span class="n">ComponentName</span> <span class="n">name</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span> <span class="s">&quot;AreaDataService connected&quot;</span><span class="o">);</span>
			<span class="n">AreaDataBinder</span> <span class="n">binder</span> <span class="o">=</span> <span class="o">(</span><span class="n">AreaDataBinder</span><span class="o">)</span> <span class="n">service</span><span class="o">;</span>
			<span class="n">mService</span> <span class="o">=</span> <span class="n">binder</span><span class="o">.</span><span class="na">getService</span><span class="o">();</span>
			<span class="n">isServiceBound</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="k">if</span><span class="o">(</span><span class="n">area</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">subjectName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">refreshContent</span><span class="o">();</span>
            <span class="o">}</span>
		<span class="o">}</span>
	<span class="o">};</span>

	<span class="kd">protected</span> <span class="n">AreaLookupCallbacks</span> <span class="n">mAreaLookupCallbacks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AreaLookupCallbacks</span><span class="o">()</span> <span class="o">{</span>

		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">tr</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;DetailViewFragment&quot;</span><span class="o">,</span> <span class="s">&quot;AreaLookupCallbacks onError()&quot;</span><span class="o">,</span> <span class="n">tr</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">areaReady</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">assert</span> <span class="n">area</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
			<span class="n">DetailViewFragment</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">area</span> <span class="o">=</span> <span class="n">area</span><span class="o">;</span>
            <span class="k">if</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="o">{</span>
                    <span class="o">((</span><span class="n">AreaActivity</span><span class="o">)</span> <span class="n">getActivity</span><span class="o">()).</span><span class="na">setTitle</span><span class="o">(</span><span class="n">area</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
			<span class="n">refreshContent</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Do something with the area that has been fetched/the user has requsted a refresh/...</span>
<span class="cm">     *</span>
<span class="cm">     * Often the workflow would include continuously post a runnable to the queue until all the</span>
<span class="cm">     * execution conditions are met.</span>
<span class="cm">     */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">refreshContent</span><span class="o">();</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">searchByText</span><span class="o">(</span><span class="n">String</span> <span class="n">query</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span><span class="o">(</span><span class="n">isServiceBound</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">{</span>
                <span class="n">mService</span><span class="o">.</span><span class="na">areaForName</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="n">mAreaLookupCallbacks</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Helper method to simplify toasts cross-platform</span>
<span class="cm">     * @param text the text to be displayed</span>
<span class="cm">     */</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">showCroutonCrossThread</span><span class="o">(</span><span class="kd">final</span> <span class="n">CharSequence</span> <span class="n">text</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">getActivity</span><span class="o">().</span><span class="na">runOnUiThread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">Crouton</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="n">text</span><span class="o">,</span> <span class="n">Style</span><span class="o">.</span><span class="na">INFO</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
		<span class="n">is_live</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
		<span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="n">AreaDataService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="k">try</span><span class="o">{</span>
            <span class="n">getActivity</span><span class="o">().</span><span class="na">getApplicationContext</span><span class="o">().</span><span class="na">bindService</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span>
                    <span class="n">mServiceConnection</span><span class="o">,</span> <span class="n">Context</span><span class="o">.</span><span class="na">BIND_AUTO_CREATE</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NullPointerException</span> <span class="n">npe</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;DetailViewFragment&quot;</span><span class="o">,</span> <span class="s">&quot;Cannot bind AreaDataService: NullPointerException&quot;</span> <span class="o">+</span>
                    <span class="s">&quot;on either getActivity() or getApplicationContext()&quot;</span><span class="o">,</span> <span class="n">npe</span><span class="o">);</span>
        <span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">savedInstanceState</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">savedInstanceState</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">&quot;saved-area&quot;</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">area</span> <span class="o">=</span> <span class="o">(</span><span class="n">Area</span><span class="o">)</span> <span class="n">savedInstanceState</span><span class="o">.</span><span class="na">getSerializable</span><span class="o">(</span><span class="s">&quot;saved-area&quot;</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">savedInstanceState</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">&quot;saved-subject-name&quot;</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">subjectName</span> <span class="o">=</span> <span class="n">savedInstanceState</span>
						<span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;saved-subject-name&quot;</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="k">if</span><span class="o">(</span><span class="n">getArguments</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">getArguments</span><span class="o">().</span><span class="na">containsKey</span><span class="o">(</span><span class="s">&quot;argument-area&quot;</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">area</span> <span class="o">=</span> <span class="o">(</span><span class="n">Area</span><span class="o">)</span> <span class="n">getArguments</span><span class="o">().</span><span class="na">getSerializable</span><span class="o">(</span><span class="s">&quot;argument-area&quot;</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">getArguments</span><span class="o">().</span><span class="na">containsKey</span><span class="o">(</span><span class="s">&quot;argument-subject-name&quot;</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">subjectName</span> <span class="o">=</span> <span class="n">getArguments</span><span class="o">().</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;argument-subject-name&quot;</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStart</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onStart</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSaveInstanceState</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">outState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onSaveInstanceState</span><span class="o">(</span><span class="n">outState</span><span class="o">);</span>
		<span class="n">outState</span><span class="o">.</span><span class="na">putSerializable</span><span class="o">(</span><span class="s">&quot;saved-area&quot;</span><span class="o">,</span> <span class="n">area</span><span class="o">);</span>
		<span class="n">outState</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="s">&quot;saved-subject-name&quot;</span><span class="o">,</span> <span class="n">subjectName</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kd">abstract</span> <span class="n">View</span> <span class="nf">onCreateView</span><span class="o">(</span><span class="n">LayoutInflater</span> <span class="n">inflater</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">container</span><span class="o">,</span>
			<span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">);</span>

    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onIOError</span><span class="o">(){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">getActivity</span><span class="o">().</span><span class="na">runOnUiThread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">Crouton</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">io_exception_generic_message</span><span class="o">,</span> <span class="n">Style</span><span class="o">.</span><span class="na">ALERT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">ErrorDialogFragment <small>lamparski.areabase.fragments</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">fragments</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.app.Dialog</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.app.DialogFragment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Something the framework requires, not even sure what it is...</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ErrorDialogFragment</span> <span class="kd">extends</span> <span class="n">DialogFragment</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="n">Dialog</span> <span class="n">mDialog</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">ErrorDialogFragment</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">();</span>
		<span class="n">mDialog</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDialog</span><span class="o">(</span><span class="n">Dialog</span> <span class="n">dialog</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">mDialog</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">Dialog</span> <span class="nf">onCreateDialog</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">mDialog</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">IAreabaseFragment <small>lamparski.areabase.fragments</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">fragments</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.support.v4.app.Fragment</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lamparski.areabase.AreaActivity</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Specifies the methods that any {@link Fragment} that wants to call itself an</span>
<span class="cm"> * Areabase content fragment must implement, even as no-ops. Also means that the</span>
<span class="cm"> * fragments can have some degree of autonomy, and {@link AreaActivity} only has</span>
<span class="cm"> * to know that they&#39;re self-respecting content fragments.</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IAreabaseFragment</span> <span class="o">{</span>
	<span class="cm">/**</span>
<span class="cm">	 * On fragments that support it, refresh the current content. Called when</span>
<span class="cm">	 * the user selects the &quot;Refresh&quot; action on the parent {@link AreaActivity}.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">refreshContent</span><span class="o">();</span>

	<span class="cm">/**</span>
<span class="cm">	 * On fragments that support it, perform a text-based search. Called when</span>
<span class="cm">	 * the user performs the &quot;Search&quot; action on the parent {@link AreaActivity}.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param query the query string entered by the user</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">searchByText</span><span class="o">(</span><span class="n">String</span> <span class="n">query</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">PoliceDataFragment <small>lamparski.areabase.fragments</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">fragments</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.app.AlertDialog</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.app.AlertDialog.Builder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.graphics.Color</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.AsyncTask</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Handler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.LayoutInflater</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.ViewGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.BaseAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.ImageView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.ListView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.echo.holographlibrary.PieGraph</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.echo.holographlibrary.PieSlice</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.mysociety.mapit.Mapper</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">de.keyboardsurfer.android.widget.crouton.Crouton</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">de.keyboardsurfer.android.widget.crouton.Style</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.AreaActivity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.R</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.cardproviders.CrimeCardProvider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.widgets.CommonDialogHandlers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.helpers.ArrayHelpers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">police.errors.APIException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">police.methodcalls.CrimeCategoriesMethodCall</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">police.methodcalls.StreetLevelCrimeMethodCall</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">police.types.Crime</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Shows the breakdown of crimes for the past 12 months for this area.</span>
<span class="cm"> *</span>
<span class="cm"> * @author filip</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PoliceDataFragment</span> <span class="kd">extends</span> <span class="n">DetailViewFragment</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">categoryMap</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">CrimeLegendEntry</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">category</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="n">colour</span><span class="o">;</span>

        <span class="kd">private</span> <span class="nf">CrimeLegendEntry</span><span class="o">(</span><span class="n">String</span> <span class="n">category</span><span class="o">,</span> <span class="kt">int</span> <span class="n">count</span><span class="o">,</span> <span class="kt">int</span> <span class="n">colour</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">category</span> <span class="o">=</span> <span class="n">category</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">colour</span> <span class="o">=</span> <span class="n">colour</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * This exists because I can only return one value from an AsyncTask,</span>
<span class="cm">     * and did not feel like returning a Void or a Boolean and doing actual</span>
<span class="cm">     * result return by the way of a callback.</span>
<span class="cm">     *</span>
<span class="cm">     * @author filip</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">CrimeDataTaskResult</span> <span class="o">{</span>
        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Crime</span><span class="o">&gt;</span> <span class="n">theCrimes</span><span class="o">;</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">humanReadableCategoryNames</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">CrimeListAdapter</span> <span class="kd">extends</span> <span class="n">BaseAdapter</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getCount</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">mCrimeList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getItem</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">mCrimeList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getItemId</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">position</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">View</span> <span class="nf">getView</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="n">View</span> <span class="n">convertView</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">convertView</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
                <span class="n">convertView</span> <span class="o">=</span> <span class="n">LayoutInflater</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()).</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">subject_view_groupitem</span><span class="o">,</span> <span class="n">parent</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">CrimeLegendEntry</span> <span class="n">category</span> <span class="o">=</span> <span class="n">mCrimeList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>

            <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_groupitem_title</span><span class="o">)).</span><span class="na">setText</span><span class="o">(</span><span class="n">categoryMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">category</span><span class="o">.</span><span class="na">category</span><span class="o">));</span>
            <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_groupitem_count</span><span class="o">)).</span><span class="na">setText</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">category</span><span class="o">.</span><span class="na">count</span><span class="o">));</span>
            <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_groupitem_count</span><span class="o">)).</span><span class="na">setTextColor</span><span class="o">(</span><span class="n">category</span><span class="o">.</span><span class="na">colour</span><span class="o">);</span>
            <span class="o">((</span><span class="n">ImageView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_groupitem_graphability_indicator</span><span class="o">)).</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">GONE</span><span class="o">);</span>

            <span class="k">return</span> <span class="n">convertView</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">FetchCrimeDataTask</span> <span class="kd">extends</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">CrimeDataTaskResult</span><span class="o">&gt;{</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPreExecute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">.</span><span class="na">onPreExecute</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                <span class="n">getActivity</span><span class="o">().</span><span class="na">setProgressBarIndeterminateVisibility</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="n">CrimeDataTaskResult</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">Area</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">CrimeDataTaskResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CrimeDataTaskResult</span><span class="o">();</span>
            <span class="kt">double</span><span class="o">[][]</span> <span class="n">areaPoly</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">double</span><span class="o">[</span><span class="mi">0</span><span class="o">][];</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">areaPoly</span> <span class="o">=</span> <span class="n">Mapper</span><span class="o">.</span><span class="na">getGeometryForArea</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;PoliceDataFragment&quot;</span><span class="o">,</span> <span class="s">&quot;Error when fetching area geometry&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
                <span class="n">onIOError</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="kt">double</span><span class="o">[][]</span> <span class="n">simplerPoly</span> <span class="o">=</span> <span class="n">ArrayHelpers</span><span class="o">.</span><span class="na">every_nth_pair</span><span class="o">(</span><span class="n">areaPoly</span><span class="o">,</span> <span class="mi">10</span><span class="o">);</span>

            <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Crime</span><span class="o">&gt;</span> <span class="n">crimes</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">crimes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StreetLevelCrimeMethodCall</span><span class="o">().</span><span class="na">addAreaPolygon</span><span class="o">(</span><span class="n">simplerPoly</span><span class="o">).</span><span class="na">getStreetLevelCrime</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;PoliceDataFragment&quot;</span><span class="o">,</span> <span class="s">&quot;IO exception when fetching area crimes&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
                <span class="n">onIOError</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">APIException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;PoliceDataFragment&quot;</span><span class="o">,</span> <span class="s">&quot;API exception when fetching area crimes&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
                <span class="n">onPoliceApiError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">result</span><span class="o">.</span><span class="na">theCrimes</span> <span class="o">=</span> <span class="n">crimes</span><span class="o">;</span>

            <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">catDict</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">try</span><span class="o">{</span>
                <span class="n">catDict</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CrimeCategoriesMethodCall</span><span class="o">().</span><span class="na">getCrimeCategories</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;PoliceDataFragment&quot;</span><span class="o">,</span> <span class="s">&quot;IO exception when fetching area crimes&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
                <span class="n">onIOError</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">APIException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;PoliceDataFragment&quot;</span><span class="o">,</span> <span class="s">&quot;API exception when fetching area crimes&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
                <span class="n">onPoliceApiError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;PoliceDataFragment&quot;</span><span class="o">,</span> <span class="s">&quot;Exception when fetching area crimes&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
                <span class="n">showCroutonCrossThread</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="n">result</span><span class="o">.</span><span class="na">humanReadableCategoryNames</span> <span class="o">=</span> <span class="n">catDict</span><span class="o">;</span>

            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="n">CrimeDataTaskResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">.</span><span class="na">onPostExecute</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                <span class="n">getActivity</span><span class="o">().</span><span class="na">setProgressBarIndeterminateVisibility</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">onCategoryDescriptionsFound</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">humanReadableCategoryNames</span><span class="o">);</span>
            <span class="n">onCrimeDataFound</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">theCrimes</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">SLICE_COLOURS</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">5</span><span class="o">];</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">currentSliceColour</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">PieGraph</span> <span class="n">mGraph</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">CrimeListAdapter</span> <span class="n">mListAdapter</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">CrimeLegendEntry</span><span class="o">&gt;</span> <span class="n">mCrimeList</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">SLICE_COLOURS</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">getResources</span><span class="o">().</span><span class="na">getColor</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">color</span><span class="o">.</span><span class="na">holo_blue_bright</span><span class="o">);</span>
        <span class="n">SLICE_COLOURS</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">getResources</span><span class="o">().</span><span class="na">getColor</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">color</span><span class="o">.</span><span class="na">holo_green_light</span><span class="o">);</span>
        <span class="n">SLICE_COLOURS</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">=</span> <span class="n">getResources</span><span class="o">().</span><span class="na">getColor</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">color</span><span class="o">.</span><span class="na">holo_orange_light</span><span class="o">);</span>
        <span class="n">SLICE_COLOURS</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="o">=</span> <span class="n">getResources</span><span class="o">().</span><span class="na">getColor</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">color</span><span class="o">.</span><span class="na">holo_red_light</span><span class="o">);</span>
        <span class="n">SLICE_COLOURS</span><span class="o">[</span><span class="mi">4</span><span class="o">]</span> <span class="o">=</span> <span class="n">getResources</span><span class="o">().</span><span class="na">getColor</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">color</span><span class="o">.</span><span class="na">holo_purple</span><span class="o">);</span>
        <span class="n">mCrimeList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">CrimeLegendEntry</span><span class="o">&gt;();</span>
        <span class="n">mListAdapter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CrimeListAdapter</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">Runnable</span> <span class="n">refreshContentAction</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span><span class="o">(</span><span class="n">area</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
                    <span class="n">area</span> <span class="o">=</span> <span class="o">((</span><span class="n">AreaActivity</span><span class="o">)</span> <span class="n">getActivity</span><span class="o">()).</span><span class="na">getArea</span><span class="o">();</span>
                <span class="o">}</span>

                <span class="k">new</span> <span class="nf">FetchCrimeDataTask</span><span class="o">().</span><span class="na">execute</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">&quot;PoliceDataFragment&quot;</span><span class="o">,</span> <span class="s">&quot;Refresh try #&quot;</span> <span class="o">+</span> <span class="n">refreshContentTries</span>
                        <span class="o">+</span> <span class="s">&quot; failed because of an Exception&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
                <span class="n">refreshContent</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">};</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">refreshContentTries</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">refreshContent</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">is_live</span><span class="o">){</span>
            <span class="k">new</span> <span class="nf">Handler</span><span class="o">().</span><span class="na">postDelayed</span><span class="o">(</span><span class="n">refreshContentAction</span><span class="o">,</span> <span class="mi">100</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(++</span><span class="n">refreshContentTries</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="o">){</span>
                <span class="n">refreshContent</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">View</span> <span class="nf">onCreateView</span><span class="o">(</span><span class="n">LayoutInflater</span> <span class="n">inflater</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">container</span><span class="o">,</span> <span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">View</span> <span class="n">theView</span> <span class="o">=</span> <span class="n">inflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">police_data_fragment</span><span class="o">,</span> <span class="n">container</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>

        <span class="n">mGraph</span> <span class="o">=</span> <span class="o">(</span><span class="n">PieGraph</span><span class="o">)</span> <span class="n">theView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">police_data_fragment_crime_graph</span><span class="o">);</span>
        <span class="n">ListView</span> <span class="n">crimeList</span> <span class="o">=</span> <span class="o">(</span><span class="n">ListView</span><span class="o">)</span> <span class="n">theView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">listView</span><span class="o">);</span>
        <span class="n">crimeList</span><span class="o">.</span><span class="na">setAdapter</span><span class="o">(</span><span class="n">mListAdapter</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">theView</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCategoryDescriptionsFound</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">categoryMap</span><span class="o">){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">categoryMap</span> <span class="o">=</span> <span class="n">categoryMap</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCrimeDataFound</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">Crime</span><span class="o">&gt;</span> <span class="n">mostRecentCrimes</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">mostRecentCrimes</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">crimeSlice</span> <span class="o">=</span> <span class="n">CrimeCardProvider</span><span class="o">.</span><span class="na">crimeSlice</span><span class="o">(</span><span class="n">mostRecentCrimes</span><span class="o">);</span>
            <span class="n">mCrimeList</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
            <span class="n">mGraph</span><span class="o">.</span><span class="na">removeSlices</span><span class="o">();</span>
            <span class="k">for</span><span class="o">(</span><span class="n">String</span> <span class="n">category</span> <span class="o">:</span> <span class="n">crimeSlice</span><span class="o">.</span><span class="na">keySet</span><span class="o">()){</span>
                <span class="n">CrimeLegendEntry</span> <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CrimeLegendEntry</span><span class="o">(</span><span class="n">category</span><span class="o">,</span> <span class="n">crimeSlice</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">category</span><span class="o">),</span> <span class="n">nextSliceColour</span><span class="o">());</span>
                <span class="n">PieSlice</span> <span class="n">sForE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PieSlice</span><span class="o">();</span>
                <span class="n">sForE</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">colour</span><span class="o">);</span>
                <span class="n">sForE</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">count</span><span class="o">);</span>
                <span class="n">sForE</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="n">categoryMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">category</span><span class="o">));</span>
                <span class="n">mGraph</span><span class="o">.</span><span class="na">addSlice</span><span class="o">(</span><span class="n">sForE</span><span class="o">);</span>
                <span class="n">mCrimeList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="n">mListAdapter</span><span class="o">.</span><span class="na">notifyDataSetChanged</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">Crouton</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="s">&quot;No crime information received&quot;</span><span class="o">,</span> <span class="n">Style</span><span class="o">.</span><span class="na">INFO</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPoliceApiError</span><span class="o">(</span><span class="kd">final</span> <span class="n">APIException</span> <span class="n">error</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">getActivity</span><span class="o">().</span><span class="na">runOnUiThread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">AlertDialog</span> <span class="n">dlg</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Builder</span><span class="o">(</span><span class="n">getActivity</span><span class="o">())</span>
                            <span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error_police_api</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">getResources</span><span class="o">().</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error_police_api_body</span><span class="o">,</span> <span class="n">error</span><span class="o">.</span><span class="na">toString</span><span class="o">()))</span>
                            <span class="o">.</span><span class="na">setNeutralButton</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">ok</span><span class="o">,</span> <span class="n">CommonDialogHandlers</span><span class="o">.</span><span class="na">JUST_DISMISS</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">create</span><span class="o">();</span>
                    <span class="n">dlg</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">&quot;PoliceDataFragment&quot;</span><span class="o">,</span> <span class="s">&quot;Police API error&quot;</span><span class="o">,</span> <span class="n">error</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">nextSliceColour</span><span class="o">(){</span>
        <span class="kt">int</span> <span class="n">baseColor</span> <span class="o">=</span> <span class="n">SLICE_COLOURS</span><span class="o">[</span><span class="n">currentSliceColour</span><span class="o">++</span> <span class="o">%</span> <span class="n">SLICE_COLOURS</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
        <span class="kt">int</span> <span class="n">variation</span> <span class="o">=</span> <span class="n">currentSliceColour</span> <span class="o">/</span> <span class="n">SLICE_COLOURS</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="kt">float</span><span class="o">[]</span> <span class="n">hsv</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="o">[</span><span class="mi">3</span><span class="o">];</span>
        <span class="n">Color</span><span class="o">.</span><span class="na">colorToHSV</span><span class="o">(</span><span class="n">baseColor</span><span class="o">,</span> <span class="n">hsv</span><span class="o">);</span>
        <span class="n">hsv</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="o">(</span><span class="n">hsv</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">+</span> <span class="o">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">variation</span><span class="o">));</span>
        <span class="n">hsv</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="o">(</span><span class="n">hsv</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">+</span> <span class="o">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">variation</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">Color</span><span class="o">.</span><span class="na">HSVToColor</span><span class="o">(</span><span class="n">hsv</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">SubjectListFragment <small>lamparski.areabase.fragments</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">fragments</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.os.AsyncTask</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Handler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.LayoutInflater</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.ViewGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.AdapterView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.AdapterView.OnItemClickListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.BaseAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.ListView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map.Entry</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lamparski.areabase.AreaActivity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.R</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DetailedSubject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Subject</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Shows a list of subjects (and the number of datasets they contain) for a given {@link nde2.pull.types.Area}.</span>
<span class="cm"> * The items are links which, when clicked, should take the user to the {@link lamparski.areabase.fragments.SubjectViewFragment}</span>
<span class="cm"> * for the corresponding {@link nde2.pull.types.Subject}.</span>
<span class="cm"> *</span>
<span class="cm"> * @author filip</span>
<span class="cm"> * @see nde2.pull.types.Subject</span>
<span class="cm"> * @see lamparski.areabase.fragments.SubjectViewFragment</span>
<span class="cm"> * @see nde2.pull.types.Area</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SubjectListFragment</span> <span class="kd">extends</span> <span class="n">DetailViewFragment</span> <span class="kd">implements</span> <span class="n">OnItemClickListener</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">SubjectListAdapter</span> <span class="kd">extends</span> <span class="n">BaseAdapter</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getCount</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">subjects</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getItem</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">subjects</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getItemId</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">position</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">View</span> <span class="nf">getView</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="n">View</span> <span class="n">convertView</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">convertView</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
                <span class="n">convertView</span> <span class="o">=</span> <span class="n">LayoutInflater</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()).</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">subject_view_listitem</span><span class="o">,</span> <span class="n">parent</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">DetailedSubject</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">subjects</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
            <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_listitem_title</span><span class="o">)).</span><span class="na">setText</span><span class="o">(</span><span class="n">subject</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_listitem_subtitle</span><span class="o">)).</span><span class="na">setText</span><span class="o">(</span><span class="n">subject</span><span class="o">.</span><span class="na">getDescription</span><span class="o">());</span>
            <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_listitem_count</span><span class="o">)).</span><span class="na">setText</span><span class="o">(</span><span class="n">subjectsWithCount</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">subject</span><span class="o">).</span><span class="na">toString</span><span class="o">());</span>

            <span class="k">return</span> <span class="n">convertView</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">Runnable</span> <span class="n">refreshContentAction</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">area</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
                <span class="n">area</span> <span class="o">=</span> <span class="o">((</span><span class="n">AreaActivity</span><span class="o">)</span> <span class="n">getActivity</span><span class="o">()).</span><span class="na">getArea</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="k">new</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">DetailedSubject</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>

                <span class="nd">@Override</span>
                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPreExecute</span><span class="o">()</span> <span class="o">{</span>
                    <span class="kd">super</span><span class="o">.</span><span class="na">onPreExecute</span><span class="o">();</span>
                    <span class="n">getActivity</span><span class="o">().</span><span class="na">setProgressBarIndeterminateVisibility</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="nd">@Override</span>
                <span class="kd">protected</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">DetailedSubject</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">doInBackground</span><span class="o">(</span><span class="n">Area</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">Area</span> <span class="n">myArea</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
                    <span class="n">Map</span><span class="o">&lt;</span><span class="n">DetailedSubject</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">targetHash</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">DetailedSubject</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;();</span>

                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Subject</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">baseHash</span> <span class="o">=</span> <span class="n">myArea</span><span class="o">.</span><span class="na">getCompatibleSubjects</span><span class="o">();</span>
                        <span class="k">for</span> <span class="o">(</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">Subject</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">baseHash</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
                            <span class="n">DetailedSubject</span> <span class="n">detailedSubject</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">().</span><span class="na">getDetailed</span><span class="o">();</span>
                            <span class="n">targetHash</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">detailedSubject</span><span class="o">,</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
                        <span class="o">}</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;SubjectListFragment&quot;</span><span class="o">,</span> <span class="s">&quot;IO exception when fetching the subject list&quot;</span><span class="o">,</span> <span class="n">ioe</span><span class="o">);</span>
                        <span class="n">onIOError</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;SubjectListFragment&quot;</span><span class="o">,</span> <span class="s">&quot;An exception when fetching the subject list&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
                        <span class="n">showCroutonCrossThread</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
                    <span class="o">}</span>

                    <span class="k">return</span> <span class="n">targetHash</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="nd">@Override</span>
                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">DetailedSubject</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kd">super</span><span class="o">.</span><span class="na">onPostExecute</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
                    <span class="n">getActivity</span><span class="o">().</span><span class="na">setProgressBarIndeterminateVisibility</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                    <span class="n">onSubjectHashFound</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}.</span><span class="na">execute</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">};</span>

    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">DetailedSubject</span><span class="o">&gt;</span> <span class="n">subjects</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">DetailedSubject</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">subjectsWithCount</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">SubjectListAdapter</span> <span class="n">mAdapter</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">refreshContentTries</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">refreshContent</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">is_live</span><span class="o">){</span>
            <span class="k">try</span><span class="o">{</span>
                <span class="k">new</span> <span class="nf">Handler</span><span class="o">().</span><span class="na">postDelayed</span><span class="o">(</span><span class="n">refreshContentAction</span><span class="o">,</span> <span class="mi">100</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NullPointerException</span> <span class="n">npe</span><span class="o">){</span>
                <span class="k">if</span><span class="o">(++</span><span class="n">refreshContentTries</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">){</span>
                    <span class="n">refreshContent</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(++</span><span class="n">refreshContentTries</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="o">){</span>
                <span class="n">refreshContent</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onSubjectHashFound</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">DetailedSubject</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">hash</span><span class="o">){</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;SubjectListFragment&quot;</span><span class="o">,</span> <span class="s">&quot;Found &quot;</span> <span class="o">+</span> <span class="n">hash</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; subjects for this area.&quot;</span><span class="o">);</span>
        <span class="n">subjects</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">subjects</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">hash</span><span class="o">.</span><span class="na">keySet</span><span class="o">());</span>
        <span class="n">subjectsWithCount</span> <span class="o">=</span> <span class="n">hash</span><span class="o">;</span>
        <span class="n">mAdapter</span><span class="o">.</span><span class="na">notifyDataSetChanged</span><span class="o">();</span>
        <span class="n">mAdapter</span><span class="o">.</span><span class="na">getCount</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onItemClick</span><span class="o">(</span><span class="n">AdapterView</span><span class="o">&lt;?&gt;</span> <span class="n">parent</span><span class="o">,</span> <span class="n">View</span> <span class="n">view</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">((</span><span class="n">AreaActivity</span><span class="o">)</span> <span class="n">getActivity</span><span class="o">()).</span><span class="na">showSubjectView</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="n">subjects</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">).</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">View</span> <span class="nf">onCreateView</span><span class="o">(</span><span class="n">LayoutInflater</span> <span class="n">inflater</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">container</span><span class="o">,</span> <span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">View</span> <span class="n">view</span> <span class="o">=</span> <span class="n">inflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">fragment_subject_list</span><span class="o">,</span> <span class="n">container</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>

        <span class="n">subjects</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">DetailedSubject</span><span class="o">&gt;();</span>
        <span class="n">subjectsWithCount</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">DetailedSubject</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;();</span>
        <span class="n">mAdapter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SubjectListAdapter</span><span class="o">();</span>

        <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">view</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_header</span><span class="o">)).</span><span class="na">setText</span><span class="o">(</span><span class="s">&quot;AVAILABLE SUBJECTS&quot;</span><span class="o">);</span>
        <span class="n">ListView</span> <span class="n">theList</span> <span class="o">=</span> <span class="o">(</span><span class="n">ListView</span><span class="o">)</span> <span class="n">view</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_list_view</span><span class="o">);</span>
        <span class="n">theList</span><span class="o">.</span><span class="na">setAdapter</span><span class="o">(</span><span class="n">mAdapter</span><span class="o">);</span>
        <span class="n">theList</span><span class="o">.</span><span class="na">setOnItemClickListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">view</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">SubjectViewFragment <small>lamparski.areabase.fragments</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">fragments</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Handler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.LayoutInflater</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.ViewGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.ExpandableListView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.ExpandableListView.OnChildClickListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.ProgressBar</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Locale</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lamparski.areabase.AreaActivity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.R</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.services.AreaDataService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.widgets.SubjectExpandableListAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DataSetFamily</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Dataset</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * A way to display datasets for a particular subject for a particular area.</span>
<span class="cm"> * It shows all datasets (using {@link Dataset} objects) in a {@link nde2.pull.types.Subject} as a</span>
<span class="cm"> * two-level list (an {@link android.widget.ExpandableListView}), where level 1 is the title of the</span>
<span class="cm"> * dataset, and level 2 is the content.</span>
<span class="cm"> *</span>
<span class="cm"> * @author filip</span>
<span class="cm"> * @see lamparski.areabase.fragments.SubjectListFragment</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SubjectViewFragment</span> <span class="kd">extends</span> <span class="n">DetailViewFragment</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">EMPTY</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;();</span>

    <span class="kd">private</span> <span class="n">SubjectExpandableListAdapter</span> <span class="n">mAdapter</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">ProgressBar</span> <span class="n">mPlaceholderProgressBar</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">AreaDataService</span><span class="o">.</span><span class="na">SubjectDumpIface</span> <span class="n">mSubjectDumpCallbacks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AreaDataService</span><span class="o">.</span><span class="na">SubjectDumpIface</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">subjectDumpReady</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                <span class="n">getActivity</span><span class="o">().</span><span class="na">setProgressBarIndeterminateVisibility</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">mAdapter</span><span class="o">.</span><span class="na">setItems</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
            <span class="n">mAdapter</span><span class="o">.</span><span class="na">notifyDataSetChanged</span><span class="o">();</span>
            <span class="n">refreshContentTries</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onProgress</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                <span class="n">getActivity</span><span class="o">().</span><span class="na">runOnUiThread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                        <span class="n">mPlaceholderProgressBar</span><span class="o">.</span><span class="na">setMax</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>
                        <span class="n">mPlaceholderProgressBar</span><span class="o">.</span><span class="na">setProgress</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">});</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">tr</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                <span class="n">getActivity</span><span class="o">().</span><span class="na">runOnUiThread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                        <span class="n">getActivity</span><span class="o">().</span><span class="na">setProgressBarIndeterminateVisibility</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">});</span>
            <span class="o">}</span>
            <span class="n">showCroutonCrossThread</span><span class="o">(</span><span class="n">tr</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;SubjectViewFragment&quot;</span><span class="o">,</span> <span class="s">&quot;SubjectDumpCallbacks onError()&quot;</span><span class="o">,</span> <span class="n">tr</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">};</span>

    <span class="kd">private</span> <span class="n">OnChildClickListener</span> <span class="n">mChildItemClickListener</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OnChildClickListener</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onChildClick</span><span class="o">(</span><span class="n">ExpandableListView</span> <span class="n">parent</span><span class="o">,</span> <span class="n">View</span> <span class="n">v</span><span class="o">,</span> <span class="kt">int</span> <span class="n">groupPosition</span><span class="o">,</span> <span class="kt">int</span> <span class="n">childPosition</span><span class="o">,</span> <span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Check if the click is on a chartlink</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;SubjectViewFragment&quot;</span><span class="o">,</span>
                    <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Click event on group %d, item %d&quot;</span><span class="o">,</span> <span class="n">groupPosition</span><span class="o">,</span> <span class="n">childPosition</span><span class="o">));</span>
            <span class="k">if</span><span class="o">(</span><span class="n">mAdapter</span><span class="o">.</span><span class="na">isGraphable</span><span class="o">(</span><span class="n">groupPosition</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">childPosition</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
                <span class="n">DataSetFamily</span> <span class="n">theFamily</span> <span class="o">=</span> <span class="o">(</span><span class="n">DataSetFamily</span><span class="o">)</span> <span class="n">mAdapter</span><span class="o">.</span><span class="na">getGroup</span><span class="o">(</span><span class="n">groupPosition</span><span class="o">);</span>
                <span class="k">if</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                    <span class="o">((</span><span class="n">AreaActivity</span><span class="o">)</span> <span class="n">getActivity</span><span class="o">()).</span><span class="na">startGraphActivity</span><span class="o">(</span><span class="n">theFamily</span><span class="o">,</span> <span class="n">area</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">};</span>

    <span class="kd">private</span> <span class="n">Runnable</span> <span class="n">refreshContentAction</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span><span class="o">(</span><span class="n">area</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
                    <span class="n">area</span> <span class="o">=</span> <span class="o">((</span><span class="n">AreaActivity</span><span class="o">)</span> <span class="n">getActivity</span><span class="o">()).</span><span class="na">getArea</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">getView</span><span class="o">().</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_header</span><span class="o">)).</span><span class="na">setText</span><span class="o">(</span><span class="n">subjectName</span><span class="o">.</span><span class="na">toUpperCase</span><span class="o">(</span><span class="n">Locale</span><span class="o">.</span><span class="na">UK</span><span class="o">));</span>
                <span class="n">getActivity</span><span class="o">().</span><span class="na">setProgressBarIndeterminateVisibility</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                <span class="n">mPlaceholderProgressBar</span><span class="o">.</span><span class="na">setProgress</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
                <span class="n">mService</span><span class="o">.</span><span class="na">subjectDump</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="n">subjectName</span><span class="o">,</span> <span class="n">mSubjectDumpCallbacks</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NullPointerException</span> <span class="n">npe</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">refreshContent</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">};</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">refreshContentTries</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">refreshContent</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">is_live</span><span class="o">){</span>
            <span class="k">if</span><span class="o">(++</span><span class="n">refreshContentTries</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">){</span>
                <span class="k">new</span> <span class="nf">Handler</span><span class="o">().</span><span class="na">postDelayed</span><span class="o">(</span><span class="n">refreshContentAction</span><span class="o">,</span> <span class="mi">100</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;Subject View&quot;</span><span class="o">,</span> <span class="s">&quot;Exceeded the maximum number of tries for refreshContent() when service is connected.&quot;</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(++</span><span class="n">refreshContentTries</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="o">){</span>
                <span class="n">refreshContent</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">View</span> <span class="nf">onCreateView</span><span class="o">(</span><span class="n">LayoutInflater</span> <span class="n">inflater</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">container</span><span class="o">,</span> <span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">View</span> <span class="n">theView</span> <span class="o">=</span> <span class="n">inflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">fragment_subject_view</span><span class="o">,</span> <span class="n">container</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>

        <span class="k">if</span><span class="o">(</span><span class="n">getArguments</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">if</span><span class="o">(</span><span class="n">getArguments</span><span class="o">().</span><span class="na">containsKey</span><span class="o">(</span><span class="s">&quot;argument-area&quot;</span><span class="o">)){</span>
                <span class="n">area</span> <span class="o">=</span> <span class="o">(</span><span class="n">Area</span><span class="o">)</span> <span class="n">getArguments</span><span class="o">().</span><span class="na">getSerializable</span><span class="o">(</span><span class="s">&quot;argument-area&quot;</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="k">if</span><span class="o">(</span><span class="n">getArguments</span><span class="o">().</span><span class="na">containsKey</span><span class="o">(</span><span class="s">&quot;argument-subject-name&quot;</span><span class="o">)){</span>
                <span class="n">subjectName</span> <span class="o">=</span> <span class="n">getArguments</span><span class="o">().</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;argument-subject-name&quot;</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">mPlaceholderProgressBar</span> <span class="o">=</span> <span class="o">(</span><span class="n">ProgressBar</span><span class="o">)</span> <span class="n">theView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_progress_bar</span><span class="o">);</span>

        <span class="n">mAdapter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SubjectExpandableListAdapter</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="n">EMPTY</span><span class="o">);</span>
        <span class="n">ExpandableListView</span> <span class="n">datasetView</span> <span class="o">=</span> <span class="o">(</span><span class="n">ExpandableListView</span><span class="o">)</span> <span class="n">theView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_expandable_list</span><span class="o">);</span>
        <span class="n">datasetView</span><span class="o">.</span><span class="na">setEmptyView</span><span class="o">(</span><span class="n">mPlaceholderProgressBar</span><span class="o">);</span>
        <span class="n">datasetView</span><span class="o">.</span><span class="na">setAdapter</span><span class="o">(</span><span class="n">mAdapter</span><span class="o">);</span>
        <span class="n">datasetView</span><span class="o">.</span><span class="na">setOnChildClickListener</span><span class="o">(</span><span class="n">mChildItemClickListener</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">theView</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">SummaryFragment <small>lamparski.areabase.fragments</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">fragments</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.app.AlertDialog</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.app.Fragment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.ComponentName</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Intent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.ServiceConnection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.location.Location</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.AsyncTask</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Handler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.IBinder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.LayoutInflater</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.View.OnClickListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.ViewGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.Toast</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.fima.cardsui.objects.Card</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.fima.cardsui.objects.CardFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.fima.cardsui.objects.CardModel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.fima.cardsui.views.CardUI</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">de.keyboardsurfer.android.widget.crouton.Crouton</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">de.keyboardsurfer.android.widget.crouton.Style</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.AreaActivity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.R</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.cards.AreaRankCard</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.cards.ErrorCard</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.cards.EventfulArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.cards.EventfulArrayList.OnItemAddedListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.map_support.OrdnanceSurveyMapView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.services.AreaDataService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.services.AreaDataService.AreaDataBinder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.services.AreaDataService.AreaLookupCallbacks</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.services.AreaDataService.BasicAreaInfoIface</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.widgets.CommonDialogHandlers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.errors.NDE2Exception</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.methodcalls.discovery.GetAreaDetail</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DetailedArea</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">widgets</span><span class="o">.</span><span class="na">CommonDialogs</span><span class="o">.</span><span class="na">serviceDisconnectAlert</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * The lovely Summary Fragment.</span>
<span class="cm"> *</span>
<span class="cm"> * Displays the map of the area, and cards with information relating to the area. It uses</span>
<span class="cm"> * state-of-the-art adaptive Mad Libs generation technology to deliver human-readable descriptions</span>
<span class="cm"> * for even the most confusing statistical data... or, you know, might just crash horribly.</span>
<span class="cm"> *</span>
<span class="cm"> * In this case, one should report bugs.</span>
<span class="cm"> *</span>
<span class="cm"> * no but really this is what the user sees first so it should be good.</span>
<span class="cm"> *</span>
<span class="cm"> * @author filip</span>
<span class="cm"> * @see lamparski.areabase.fragments.IAreabaseFragment</span>
<span class="cm"> * @see lamparski.areabase.AreaActivity</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SummaryFragment</span> <span class="kd">extends</span> <span class="n">Fragment</span> <span class="kd">implements</span> <span class="n">IAreabaseFragment</span><span class="o">,</span> <span class="n">BasicAreaInfoIface</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="n">OrdnanceSurveyMapView</span> <span class="n">mOpenSpaceView</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">CardUI</span> <span class="n">mCardUI</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * This saves cards that are supposed to be preserved across orientation</span>
<span class="cm">	 * changes, etc.</span>
<span class="cm">	 */</span>
	<span class="kd">private</span> <span class="n">EventfulArrayList</span><span class="o">&lt;</span><span class="n">CardModel</span><span class="o">&gt;</span> <span class="n">cardModels</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Location</span> <span class="n">mLocation</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Area</span> <span class="n">area</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">boolean</span> <span class="n">is_tablet</span><span class="o">,</span> <span class="n">is_landscape</span><span class="o">,</span> <span class="n">is_live</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">double</span><span class="o">[][]</span> <span class="n">polygon</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

	<span class="kd">private</span> <span class="n">AreaDataService</span> <span class="n">mService</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isServiceBound</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">ServiceConnection</span> <span class="n">mServiceConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServiceConnection</span><span class="o">()</span> <span class="o">{</span>

		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceDisconnected</span><span class="o">(</span><span class="n">ComponentName</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">is_live</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span>
						<span class="s">&quot;The AreaDataService disconnected unexpectedly.&quot;</span><span class="o">);</span>
				<span class="n">isServiceBound</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
				<span class="n">serviceDisconnectAlert</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">getActivity</span><span class="o">());</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceConnected</span><span class="o">(</span><span class="n">ComponentName</span> <span class="n">name</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span> <span class="s">&quot;AreaDataService connected&quot;</span><span class="o">);</span>
			<span class="n">AreaDataBinder</span> <span class="n">binder</span> <span class="o">=</span> <span class="o">(</span><span class="n">AreaDataBinder</span><span class="o">)</span> <span class="n">service</span><span class="o">;</span>
			<span class="n">mService</span> <span class="o">=</span> <span class="n">binder</span><span class="o">.</span><span class="na">getService</span><span class="o">();</span>
			<span class="n">isServiceBound</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="n">is_live</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">};</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="kd">final</span> <span class="n">Throwable</span> <span class="n">tr</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">getActivity</span><span class="o">().</span><span class="na">runOnUiThread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>

                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span> <span class="s">&quot;Error processing NDE data&quot;</span><span class="o">,</span> <span class="n">tr</span><span class="o">);</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">NDE2Exception</span> <span class="n">nde2Exception</span> <span class="o">=</span> <span class="o">(</span><span class="n">NDE2Exception</span><span class="o">)</span> <span class="n">tr</span><span class="o">;</span>
                        <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span>
                                <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
                                        <span class="s">&quot;NDE2 error response %d: Title: %s; detail: %s&quot;</span><span class="o">,</span>
                                        <span class="n">nde2Exception</span><span class="o">.</span><span class="na">getNessCode</span><span class="o">(),</span>
                                        <span class="n">nde2Exception</span><span class="o">.</span><span class="na">getNessMessage</span><span class="o">(),</span>
                                        <span class="n">nde2Exception</span><span class="o">.</span><span class="na">getNessDetail</span><span class="o">()));</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span> <span class="s">&quot;Not a NDE2Exception, got: &quot;</span>
                                <span class="o">+</span> <span class="n">tr</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">());</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">tr</span> <span class="k">instanceof</span> <span class="n">IOException</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">Crouton</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span>
                                <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">io_exception_generic_message</span><span class="o">,</span>
                                <span class="n">Style</span><span class="o">.</span><span class="na">ALERT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
                        <span class="n">CardModel</span> <span class="n">errmdl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CardModel</span><span class="o">(</span><span class="n">ErrorCard</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                        <span class="n">errmdl</span><span class="o">.</span><span class="na">setTitlePlay</span><span class="o">(</span><span class="n">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">io_exception_generic_message</span><span class="o">));</span>
                        <span class="n">errmdl</span><span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="n">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">summaryactivity_cardmaker_ioerror_body</span><span class="o">));</span>
                        <span class="n">errmdl</span><span class="o">.</span><span class="na">setImageRes</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">ic_network_error</span><span class="o">);</span>
                        <span class="n">cardModels</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">errmdl</span><span class="o">);</span> <span class="c1">// Errors are now</span>
                        <span class="c1">// cards.</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">Crouton</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span>
                                <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">summaryactivity_cardmaker_onserror</span><span class="o">,</span>
                                <span class="n">Style</span><span class="o">.</span><span class="na">ALERT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">tr</span> <span class="k">instanceof</span> <span class="n">NDE2Exception</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;NDE error: %s -- %s&quot;</span><span class="o">,</span>
                                    <span class="o">((</span><span class="n">NDE2Exception</span><span class="o">)</span> <span class="n">tr</span><span class="o">).</span><span class="na">getNessMessage</span><span class="o">(),</span>
                                    <span class="o">((</span><span class="n">NDE2Exception</span><span class="o">)</span> <span class="n">tr</span><span class="o">).</span><span class="na">getNessDetail</span><span class="o">());</span>
                            <span class="n">Crouton</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="n">msg</span><span class="o">,</span> <span class="n">Style</span><span class="o">.</span><span class="na">INFO</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
                            <span class="n">CardModel</span> <span class="n">errmdl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CardModel</span><span class="o">(</span><span class="n">ErrorCard</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                            <span class="n">errmdl</span><span class="o">.</span><span class="na">setTitlePlay</span><span class="o">(</span><span class="n">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error_cannot_resolve_postcode</span><span class="o">));</span>
                            <span class="n">errmdl</span><span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="n">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error_cannot_resolve_postcode_body</span><span class="o">));</span>
                            <span class="n">errmdl</span><span class="o">.</span><span class="na">setImageRes</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">ic_map_error</span><span class="o">);</span>
                            <span class="n">cardModels</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">errmdl</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">cardReady</span><span class="o">(</span><span class="n">CardModel</span> <span class="n">cm</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">cardModels</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">cm</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">allDone</span><span class="o">(</span><span class="n">Float</span> <span class="n">areaRank</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">getActivity</span><span class="o">().</span><span class="na">setProgressBarIndeterminateVisibility</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span><span class="n">areaRank</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                <span class="n">CardModel</span> <span class="n">scoreCard</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CardModel</span><span class="o">(</span><span class="n">AreaRankCard</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="n">scoreCard</span><span class="o">.</span><span class="na">setTitlePlay</span><span class="o">(</span><span class="n">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">card_arearank_text</span><span class="o">,</span> <span class="n">area</span><span class="o">.</span><span class="na">getName</span><span class="o">()));</span>
                <span class="n">scoreCard</span><span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%.1f&quot;</span><span class="o">,</span> <span class="n">areaRank</span><span class="o">));</span>
                <span class="k">if</span><span class="o">(</span><span class="n">areaRank</span> <span class="o">&gt;=</span> <span class="mf">75.0f</span><span class="o">){</span>
                    <span class="n">scoreCard</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;#%08X&quot;</span><span class="o">,</span>
                            <span class="n">getResources</span><span class="o">().</span><span class="na">getColor</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">color</span><span class="o">.</span><span class="na">arearank80</span><span class="o">)));</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">areaRank</span> <span class="o">&gt;=</span> <span class="mf">50.0f</span><span class="o">){</span>
                    <span class="n">scoreCard</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;#%08X&quot;</span><span class="o">,</span>
                            <span class="n">getResources</span><span class="o">().</span><span class="na">getColor</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">color</span><span class="o">.</span><span class="na">arearank60</span><span class="o">)));</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">areaRank</span> <span class="o">&gt;=</span> <span class="mf">25.0f</span><span class="o">){</span>
                    <span class="n">scoreCard</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;#%08X&quot;</span><span class="o">,</span>
                            <span class="n">getResources</span><span class="o">().</span><span class="na">getColor</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">color</span><span class="o">.</span><span class="na">arearank40</span><span class="o">)));</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">scoreCard</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;#%08X&quot;</span><span class="o">,</span>
                            <span class="n">getResources</span><span class="o">().</span><span class="na">getColor</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">color</span><span class="o">.</span><span class="na">arearank20</span><span class="o">)));</span>
                <span class="o">}</span>
                <span class="n">cardModels</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">scoreCard</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAreaNameFound</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">getActivity</span><span class="o">().</span><span class="na">runOnUiThread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="o">((</span><span class="n">AreaActivity</span><span class="o">)</span> <span class="n">getActivity</span><span class="o">()).</span><span class="na">setTitle</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAreaBoundaryFound</span><span class="o">(</span><span class="kd">final</span> <span class="kt">double</span><span class="o">[][]</span> <span class="n">poly</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">getActivity</span><span class="o">().</span><span class="na">runOnUiThread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>

                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">polygon</span> <span class="o">=</span> <span class="n">poly</span><span class="o">;</span>
                    <span class="n">mOpenSpaceView</span><span class="o">.</span><span class="na">highlightBoundary</span><span class="o">(</span><span class="n">poly</span><span class="o">);</span>

                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}</span>

	<span class="kd">public</span> <span class="nf">SummaryFragment</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">();</span>
		<span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span> <span class="s">&quot;Fragment created&quot;</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unchecked&quot;</span><span class="o">)</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onActivityCreated</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onActivityCreated</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
		<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span> <span class="s">&quot;onActivityCreated() enter&quot;</span><span class="o">);</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">savedInstanceState</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span>
					<span class="s">&quot;savedInstanceState != null; reading state...&quot;</span><span class="o">);</span>
			<span class="n">mLocation</span> <span class="o">=</span> <span class="o">(</span><span class="n">Location</span><span class="o">)</span> <span class="n">savedInstanceState</span>
					<span class="o">.</span><span class="na">getParcelable</span><span class="o">(</span><span class="n">AreaActivity</span><span class="o">.</span><span class="na">CURRENT_COORDS</span><span class="o">);</span>

			<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span> <span class="s">&quot;    read current-coords -&gt; mLocation; &quot;</span>
					<span class="o">+</span> <span class="n">mLocation</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>

			<span class="n">Object</span> <span class="n">depickledCards</span> <span class="o">=</span> <span class="n">savedInstanceState</span>
					<span class="o">.</span><span class="na">getSerializable</span><span class="o">(</span><span class="s">&quot;card-models&quot;</span><span class="o">);</span>

			<span class="k">if</span> <span class="o">(</span><span class="n">depickledCards</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span>
						<span class="s">&quot;    read card-models -&gt; depickledCards; &quot;</span>
								<span class="o">+</span> <span class="n">depickledCards</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>

				<span class="n">cardModels</span> <span class="o">=</span> <span class="o">(</span><span class="n">EventfulArrayList</span><span class="o">&lt;</span><span class="n">CardModel</span><span class="o">&gt;)</span> <span class="n">depickledCards</span><span class="o">;</span>
                <span class="n">cardModels</span><span class="o">.</span><span class="na">setOnItemAddedListener</span><span class="o">(</span><span class="n">sOnCardModelAdded</span><span class="o">);</span> <span class="c1">// context leak fix?</span>
				<span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span>
						<span class="s">&quot;Found saved instance state cards&quot;</span><span class="o">,</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">)</span>
						<span class="o">.</span><span class="na">show</span><span class="o">();</span>

				<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span>
						<span class="s">&quot;    cast depickledCards -&gt; cardModels; &quot;</span>
								<span class="o">+</span> <span class="n">cardModels</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>

				<span class="n">populateCards</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
				<span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span>
						<span class="s">&quot;depickledCards turns out to be null, what.&quot;</span><span class="o">);</span>
				<span class="c1">// refreshContent();</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">View</span> <span class="nf">onCreateView</span><span class="o">(</span><span class="n">LayoutInflater</span> <span class="n">inflater</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">container</span><span class="o">,</span>
			<span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span> <span class="s">&quot;onCreateView() enter&quot;</span><span class="o">);</span>

        <span class="n">cardModels</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EventfulArrayList</span><span class="o">&lt;</span><span class="n">CardModel</span><span class="o">&gt;();</span>
        <span class="n">cardModels</span><span class="o">.</span><span class="na">setOnItemAddedListener</span><span class="o">(</span><span class="n">sOnCardModelAdded</span><span class="o">);</span>

		<span class="n">View</span> <span class="n">theView</span> <span class="o">=</span> <span class="n">inflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">fragment_summary</span><span class="o">,</span> <span class="n">container</span><span class="o">,</span>
				<span class="kc">false</span><span class="o">);</span>

        <span class="k">assert</span> <span class="n">theView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">if</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">is_tablet</span> <span class="o">=</span> <span class="o">((</span><span class="n">AreaActivity</span><span class="o">)</span> <span class="n">getActivity</span><span class="o">()).</span><span class="na">isTablet</span><span class="o">();</span>
		    <span class="n">is_landscape</span> <span class="o">=</span> <span class="o">((</span><span class="n">AreaActivity</span><span class="o">)</span> <span class="n">getActivity</span><span class="o">()).</span><span class="na">isLandscape</span><span class="o">();</span>
        <span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">is_tablet</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">is_landscape</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">mOpenSpaceView</span> <span class="o">=</span> <span class="o">(</span><span class="n">OrdnanceSurveyMapView</span><span class="o">)</span> <span class="n">theView</span>
						<span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">fragment_summary_OSMapView_TABLET_LANDSCAPE</span><span class="o">);</span>
				<span class="n">mCardUI</span> <span class="o">=</span> <span class="o">(</span><span class="n">CardUI</span><span class="o">)</span> <span class="n">theView</span>
						<span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">fragment_summary_CardsUI_TABLET_LANDSCAPE</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
				<span class="n">mOpenSpaceView</span> <span class="o">=</span> <span class="o">(</span><span class="n">OrdnanceSurveyMapView</span><span class="o">)</span> <span class="n">theView</span>
						<span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">fragment_summary_OSMapView_TABLET</span><span class="o">);</span>
				<span class="n">mCardUI</span> <span class="o">=</span> <span class="o">(</span><span class="n">CardUI</span><span class="o">)</span> <span class="n">theView</span>
						<span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">fragment_summary_CardsUI_TABLET</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">is_landscape</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">mOpenSpaceView</span> <span class="o">=</span> <span class="o">(</span><span class="n">OrdnanceSurveyMapView</span><span class="o">)</span> <span class="n">theView</span>
						<span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">fragment_summary_OSMapView_DEFAULT_LANDSCAPE</span><span class="o">);</span>
				<span class="n">mCardUI</span> <span class="o">=</span> <span class="o">(</span><span class="n">CardUI</span><span class="o">)</span> <span class="n">theView</span>
						<span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">fragment_summary_CardsUI_DEFAULT_LAND</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
				<span class="n">mOpenSpaceView</span> <span class="o">=</span> <span class="o">(</span><span class="n">OrdnanceSurveyMapView</span><span class="o">)</span> <span class="n">theView</span>
						<span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">fragment_summary_OSMapView_DEFAULT</span><span class="o">);</span>
				<span class="n">mCardUI</span> <span class="o">=</span> <span class="o">(</span><span class="n">CardUI</span><span class="o">)</span> <span class="n">theView</span>
						<span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">fragment_summary_CardsUI_DEFAULT</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="n">mCardUI</span><span class="o">.</span><span class="na">setSwipeable</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">getArguments</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">getArguments</span><span class="o">().</span><span class="na">containsKey</span><span class="o">(</span><span class="n">AreaActivity</span><span class="o">.</span><span class="na">CURRENT_COORDS</span><span class="o">)){</span>
			    <span class="n">mLocation</span> <span class="o">=</span> <span class="o">(</span><span class="n">Location</span><span class="o">)</span> <span class="n">getArguments</span><span class="o">().</span><span class="na">getParcelable</span><span class="o">(</span><span class="n">AreaActivity</span><span class="o">.</span><span class="na">CURRENT_COORDS</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span><span class="o">(</span><span class="n">getArguments</span><span class="o">().</span><span class="na">containsKey</span><span class="o">(</span><span class="s">&quot;argument-area&quot;</span><span class="o">)){</span>
                <span class="n">area</span> <span class="o">=</span> <span class="o">(</span><span class="n">Area</span><span class="o">)</span> <span class="n">getArguments</span><span class="o">().</span><span class="na">getSerializable</span><span class="o">(</span><span class="s">&quot;argument-area&quot;</span><span class="o">);</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span> <span class="s">&quot;Called with no arguments!&quot;</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="n">theView</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see android.support.v4.app.Fragment#onStart()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStart</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onStart</span><span class="o">();</span>
        <span class="n">is_live</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="n">AreaDataService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="n">getActivity</span><span class="o">().</span><span class="na">getApplicationContext</span><span class="o">().</span><span class="na">bindService</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span>
                    <span class="n">mServiceConnection</span><span class="o">,</span> <span class="n">Context</span><span class="o">.</span><span class="na">BIND_AUTO_CREATE</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NullPointerException</span> <span class="n">npe</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span> <span class="s">&quot;Cannot bind AreaDataService: NullPointerException&quot;</span> <span class="o">+</span>
                    <span class="s">&quot;on either getActivity() or getApplicationContext()&quot;</span><span class="o">,</span> <span class="n">npe</span><span class="o">);</span>
        <span class="o">}</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see android.support.v4.app.Fragment#onStop()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStop</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onStop</span><span class="o">();</span>
		<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span> <span class="s">&quot;Stopping AreaDataService.&quot;</span><span class="o">);</span>
		<span class="n">is_live</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see</span>
<span class="cm">	 * android.support.v4.app.Fragment#onSaveInstanceState(android.os.Bundle)</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSaveInstanceState</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">outState</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onSaveInstanceState</span><span class="o">(</span><span class="n">outState</span><span class="o">);</span>
		<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span> <span class="s">&quot;Saving instance state&quot;</span><span class="o">);</span>

		<span class="n">outState</span><span class="o">.</span><span class="na">putParcelable</span><span class="o">(</span><span class="n">AreaActivity</span><span class="o">.</span><span class="na">CURRENT_COORDS</span><span class="o">,</span> <span class="n">mLocation</span><span class="o">);</span>
		<span class="n">outState</span><span class="o">.</span><span class="na">putSerializable</span><span class="o">(</span><span class="s">&quot;card-models&quot;</span><span class="o">,</span> <span class="n">cardModels</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">populateCards</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">CardModel</span> <span class="n">mdl</span> <span class="o">:</span> <span class="n">cardModels</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="n">Card</span> <span class="n">crd</span> <span class="o">=</span> <span class="o">(</span><span class="n">Card</span><span class="o">)</span> <span class="n">CardFactory</span><span class="o">.</span><span class="na">createCard</span><span class="o">(</span><span class="n">mdl</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">mdl</span><span class="o">.</span><span class="na">getTitlePlay</span><span class="o">()</span>
						<span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">getResources</span><span class="o">().</span><span class="na">getString</span><span class="o">(</span>
								<span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">card_error_values_not_available_title</span><span class="o">)))</span> <span class="o">{</span>
					<span class="n">crd</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="n">sExplainMissingData</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="n">mCardUI</span><span class="o">.</span><span class="na">addCardToLastStack</span><span class="o">(</span><span class="n">crd</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">InstantiationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span> <span class="s">&quot;Cannot instantiate a Card.&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span> <span class="s">&quot;Cannot instantiate a Card.&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="n">mCardUI</span><span class="o">.</span><span class="na">invalidate</span><span class="o">();</span>
		<span class="n">mCardUI</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>
		<span class="n">mCardUI</span><span class="o">.</span><span class="na">forceLayout</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">refreshContent</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">is_live</span> <span class="o">&amp;&amp;</span> <span class="n">isServiceBound</span><span class="o">){</span>
            <span class="k">try</span><span class="o">{</span>
                <span class="k">new</span> <span class="nf">Handler</span><span class="o">().</span><span class="na">postDelayed</span><span class="o">(</span><span class="n">refreshContentAction</span><span class="o">,</span> <span class="mi">100</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NullPointerException</span> <span class="n">npe</span><span class="o">){</span>
                <span class="k">if</span><span class="o">(++</span><span class="n">refreshContentTries</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">){</span>
                    <span class="n">refreshContent</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(++</span><span class="n">refreshContentTries</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="o">){</span>
                <span class="n">refreshContent</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
	<span class="o">}</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">refreshContentTries</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Runnable</span> <span class="n">refreshContentAction</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">assert</span> <span class="nf">getActivity</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">if</span><span class="o">(</span><span class="n">area</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
                <span class="n">area</span> <span class="o">=</span> <span class="o">((</span><span class="n">AreaActivity</span><span class="o">)</span> <span class="n">getActivity</span><span class="o">()).</span><span class="na">getArea</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">cardModels</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>

            <span class="n">mCardUI</span><span class="o">.</span><span class="na">clearCards</span><span class="o">();</span>
            <span class="n">mCardUI</span><span class="o">.</span><span class="na">invalidate</span><span class="o">();</span>
            <span class="n">mCardUI</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>
            <span class="n">mCardUI</span><span class="o">.</span><span class="na">forceLayout</span><span class="o">();</span>

            <span class="n">getActivity</span><span class="o">().</span><span class="na">setProgressBarIndeterminateVisibility</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">isServiceBound</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mService</span><span class="o">.</span><span class="na">generateCardsForArea</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="n">SummaryFragment</span><span class="o">.</span><span class="na">this</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">getActivity</span><span class="o">().</span><span class="na">setProgressBarIndeterminateVisibility</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">wtf</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span>
                        <span class="s">&quot;refreshContent(): AreaService is unbound :(&quot;</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">setMapCentre</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
            <span class="n">refreshContentTries</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">};</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setMapCentre</span><span class="o">(</span><span class="kd">final</span> <span class="n">Area</span> <span class="n">area</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">new</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;&gt;(){</span>
            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">Void</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">List</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">coords</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">DetailedArea</span> <span class="n">detailedArea</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GetAreaDetail</span><span class="o">(</span><span class="n">area</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>
                    <span class="kt">double</span> <span class="n">minX</span><span class="o">,</span> <span class="n">minY</span><span class="o">,</span> <span class="n">maxX</span><span class="o">,</span> <span class="n">maxY</span><span class="o">,</span> <span class="n">midX</span><span class="o">,</span> <span class="n">midY</span><span class="o">;</span>
                    <span class="n">String</span><span class="o">[]</span> <span class="n">rawcoords</span> <span class="o">=</span> <span class="n">detailedArea</span><span class="o">.</span><span class="na">getEnvelope</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;:&quot;</span><span class="o">);</span>
                    <span class="n">minX</span> <span class="o">=</span> <span class="n">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">(</span><span class="n">rawcoords</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
                    <span class="n">minY</span> <span class="o">=</span> <span class="n">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">(</span><span class="n">rawcoords</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
                    <span class="n">maxX</span> <span class="o">=</span> <span class="n">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">(</span><span class="n">rawcoords</span><span class="o">[</span><span class="mi">2</span><span class="o">]);</span>
                    <span class="n">maxY</span> <span class="o">=</span> <span class="n">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">(</span><span class="n">rawcoords</span><span class="o">[</span><span class="mi">3</span><span class="o">]);</span>
                    <span class="n">midX</span> <span class="o">=</span> <span class="o">(</span><span class="n">minX</span> <span class="o">+</span> <span class="n">maxX</span><span class="o">)</span> <span class="o">/</span> <span class="mi">2</span><span class="o">;</span>
                    <span class="n">midY</span> <span class="o">=</span> <span class="o">(</span><span class="n">minY</span> <span class="o">+</span> <span class="n">maxY</span><span class="o">)</span> <span class="o">/</span> <span class="mi">2</span><span class="o">;</span>
                    <span class="n">coords</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">midX</span><span class="o">);</span>
                    <span class="n">coords</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">midY</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">onError</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">coords</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">coords</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span><span class="o">(!</span><span class="n">coords</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()){</span>
                    <span class="n">mOpenSpaceView</span><span class="o">.</span><span class="na">setCentre_byEastingNorthing</span><span class="o">(</span><span class="n">coords</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">coords</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
                    <span class="n">mOpenSpaceView</span><span class="o">.</span><span class="na">setZoom</span><span class="o">(</span><span class="mi">9</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}.</span><span class="na">execute</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">searchByText</span><span class="o">(</span><span class="n">String</span> <span class="n">query</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span> <span class="s">&quot;search called with query: &quot;</span> <span class="o">+</span> <span class="n">query</span><span class="o">);</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">isServiceBound</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">mService</span><span class="o">.</span><span class="na">areaForName</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="k">new</span> <span class="n">AreaLookupCallbacks</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">areaReady</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">SummaryFragment</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">area</span> <span class="o">=</span> <span class="n">area</span><span class="o">;</span>
                    <span class="n">refreshContent</span><span class="o">();</span>
                <span class="o">}</span>

                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">tr</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="o">((</span><span class="n">AreaActivity</span><span class="o">)</span> <span class="n">getActivity</span><span class="o">()).</span><span class="na">onError</span><span class="o">(</span><span class="n">tr</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">});</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="n">Log</span><span class="o">.</span><span class="na">wtf</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span>
					<span class="s">&quot;refreshContent(): AreaService is unbound :(&quot;</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="n">mOpenSpaceView</span><span class="o">.</span><span class="na">setZoom</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="n">OnClickListener</span> <span class="n">sExplainMissingData</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OnClickListener</span><span class="o">()</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">View</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span> <span class="s">&quot;Missing data (ValueNotAvailable) error, can&#39;t display &quot;</span> <span class="o">+</span>
                        <span class="s">&quot;as there is no Activity or Context to bind to&quot;</span><span class="o">);</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
			<span class="k">new</span> <span class="n">AlertDialog</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">getActivity</span><span class="o">())</span>
					<span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">card_error_values_not_available_title</span><span class="o">)</span>
					<span class="o">.</span><span class="na">setMessage</span><span class="o">(</span>
							<span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">summaryactivity_cardmaker_values_not_available</span><span class="o">)</span>
					<span class="o">.</span><span class="na">setNeutralButton</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">ok</span><span class="o">,</span>
							<span class="n">CommonDialogHandlers</span><span class="o">.</span><span class="na">JUST_DISMISS</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">};</span>

    <span class="kd">private</span> <span class="n">OnItemAddedListener</span> <span class="n">sOnCardModelAdded</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OnItemAddedListener</span><span class="o">()</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onItemAdded</span><span class="o">(</span><span class="n">Object</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span> <span class="s">&quot;A card model has been added, creating a card...&quot;</span><span class="o">);</span>
                <span class="n">mCardUI</span><span class="o">.</span><span class="na">addCardToLastStack</span><span class="o">((</span><span class="n">Card</span><span class="o">)</span> <span class="n">CardFactory</span>
                        <span class="o">.</span><span class="na">createCard</span><span class="o">((</span><span class="n">CardModel</span><span class="o">)</span> <span class="n">item</span><span class="o">));</span>
                <span class="n">mCardUI</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">&quot;SummaryFragment&quot;</span><span class="o">,</span> <span class="s">&quot;Cannot create card.&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">};</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">HoloCSSColourValues <small>lamparski.areabase.map_support</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">map_support</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kd">public</span> <span class="kd">enum</span> <span class="n">HoloCSSColourValues</span> <span class="o">{</span>
	<span class="n">CYAN</span><span class="o">(</span><span class="s">&quot;#33B5E5&quot;</span><span class="o">),</span> <span class="n">VIOLET</span><span class="o">(</span><span class="s">&quot;#AA66CC&quot;</span><span class="o">),</span> <span class="n">LIME</span><span class="o">(</span><span class="s">&quot;#99CC00&quot;</span><span class="o">),</span> <span class="n">YELLOW</span><span class="o">(</span><span class="s">&quot;#FFBB33&quot;</span><span class="o">),</span> <span class="n">PINK</span><span class="o">(</span>
			<span class="s">&quot;#FF4444&quot;</span><span class="o">),</span> <span class="n">AQUAMARINE</span><span class="o">(</span><span class="s">&quot;#0099CC&quot;</span><span class="o">),</span> <span class="n">PURPLE</span><span class="o">(</span><span class="s">&quot;#9933CC&quot;</span><span class="o">),</span> <span class="n">GREEN</span><span class="o">(</span>
			<span class="s">&quot;#669900&quot;</span><span class="o">),</span> <span class="n">ORANGE</span><span class="o">(</span><span class="s">&quot;#FF8800&quot;</span><span class="o">),</span> <span class="n">RED</span><span class="o">(</span><span class="s">&quot;#CC0000&quot;</span><span class="o">);</span>

	<span class="kd">private</span> <span class="n">String</span> <span class="n">cssColorValue</span><span class="o">;</span>

	<span class="kd">private</span> <span class="nf">HoloCSSColourValues</span><span class="o">(</span><span class="n">String</span> <span class="n">cssValue</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">cssColorValue</span> <span class="o">=</span> <span class="n">cssValue</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getCssValue</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">cssColorValue</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">OrdnanceSurveyMapView <small>lamparski.areabase.map_support</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">map_support</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.annotation.SuppressLint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.app.AlertDialog</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.DialogInterface</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Intent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.location.Location</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.net.Uri</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.AttributeSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.webkit.WebView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.google.gson.Gson</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.gson.GsonBuilder</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * A custom {@link WebView} that loads a local copy of the Ordnance Survey map,</span>
<span class="cm"> * and then provides an interface so that the map can be interacted with from</span>
<span class="cm"> * Areabase.</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * OS has a lot of data about the UK, so it&#39;d be silly not to use it.</span>
<span class="cm"> * Nevertheless, it takes extra effort to get it running.</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="nd">@SuppressLint</span><span class="o">(</span><span class="s">&quot;SetJavaScriptEnabled&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrdnanceSurveyMapView</span> <span class="kd">extends</span> <span class="n">WebView</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="n">OSMapWebViewClient</span> <span class="n">my_client</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">OSNativeInterface</span> <span class="n">mNativeInterface</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">OrdnanceSurveyMapView</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">isInEditMode</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">initOSView</span><span class="o">();</span>
        <span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">OrdnanceSurveyMapView</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">AttributeSet</span> <span class="n">attrs</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">attrs</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">isInEditMode</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">initOSView</span><span class="o">();</span>
        <span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">OrdnanceSurveyMapView</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">AttributeSet</span> <span class="n">attrs</span><span class="o">,</span>
			<span class="kt">int</span> <span class="n">defStyle</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">attrs</span><span class="o">,</span> <span class="n">defStyle</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">isInEditMode</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">initOSView</span><span class="o">();</span>
        <span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">initOSView</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">my_client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OSMapWebViewClient</span><span class="o">();</span>
		<span class="n">my_client</span>
				<span class="o">.</span><span class="na">setOnIllegalURLListener</span><span class="o">(</span><span class="k">new</span> <span class="n">OSMapWebViewClient</span><span class="o">.</span><span class="na">OnNonApplicationURLListener</span><span class="o">()</span> <span class="o">{</span>
					<span class="kd">private</span> <span class="n">Context</span> <span class="n">context</span> <span class="o">=</span> <span class="n">getContext</span><span class="o">();</span>

					<span class="cm">/*</span>
<span class="cm">					 * So here&#39;s how it works: Theoretically, a malicious</span>
<span class="cm">					 * program may want to inject some code that would cause the</span>
<span class="cm">					 * WebView to navigate away from the slippymap and to a site</span>
<span class="cm">					 * pretending to be the app&#39;s UI element, requiring payment.</span>
<span class="cm">					 * In order to mitigate that, URLs that are not local</span>
<span class="cm">					 * (file:///) or OS API&#39;s are gutted and a dialogue warning</span>
<span class="cm">					 * the user is presented instead. Now, the user still has</span>
<span class="cm">					 * the option to visit the page, but in the system browser.</span>
<span class="cm">					 */</span>
					<span class="nd">@Override</span>
					<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onIllegalUrl</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
						<span class="n">AlertDialog</span><span class="o">.</span><span class="na">Builder</span> <span class="n">alert_bldr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AlertDialog</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span>
								<span class="n">context</span><span class="o">);</span>
						<span class="n">alert_bldr</span>
								<span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="mi">0</span> <span class="cm">/* R.string.error_illegal_url_title */</span><span class="o">)</span>
								<span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">getResources</span><span class="o">().</span><span class="na">getString</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span>
								<span class="c1">// R.string.error_illegal_url_formatstring,</span>
										<span class="n">url</span><span class="o">))</span>
								<span class="o">.</span><span class="na">setIcon</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">ic_dialog_alert</span><span class="o">)</span>
								<span class="o">.</span><span class="na">setPositiveButton</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span>
								<span class="c1">// R.string.error_illegal_url_response_dontgo,</span>
										<span class="k">new</span> <span class="n">DialogInterface</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span>

											<span class="nd">@Override</span>
											<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span>
													<span class="n">DialogInterface</span> <span class="n">dialog</span><span class="o">,</span>
													<span class="kt">int</span> <span class="n">which</span><span class="o">)</span> <span class="o">{</span>
												<span class="n">dialog</span><span class="o">.</span><span class="na">dismiss</span><span class="o">();</span>
											<span class="o">}</span>
										<span class="o">}).</span><span class="na">setNegativeButton</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span>
								<span class="c1">// R.string.error_illegal_url_response_open,</span>
										<span class="k">new</span> <span class="n">DialogInterface</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span>

											<span class="nd">@Override</span>
											<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span>
													<span class="n">DialogInterface</span> <span class="n">dialog</span><span class="o">,</span>
													<span class="kt">int</span> <span class="n">which</span><span class="o">)</span> <span class="o">{</span>
												<span class="n">Uri</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
												<span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span>
														<span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_VIEW</span><span class="o">,</span> <span class="n">uri</span><span class="o">);</span>
												<span class="n">context</span><span class="o">.</span><span class="na">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
											<span class="o">}</span>
										<span class="o">});</span>
						<span class="n">alert_bldr</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
					<span class="o">}</span>

					<span class="nd">@Override</span>
					<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onOpenExternalSafeUrl</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
						<span class="n">Uri</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
						<span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_VIEW</span><span class="o">,</span> <span class="n">uri</span><span class="o">);</span>
						<span class="n">context</span><span class="o">.</span><span class="na">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">});</span>
		<span class="n">setWebViewClient</span><span class="o">(</span><span class="n">my_client</span><span class="o">);</span>

		<span class="c1">// Required, as Ordnance Survey is built on top of OpenLayers.</span>
		<span class="n">getSettings</span><span class="o">().</span><span class="na">setJavaScriptEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
		<span class="n">loadUrl</span><span class="o">(</span><span class="s">&quot;file:///android_asset/os_openspace/slippymap.html&quot;</span><span class="o">);</span>

		<span class="n">mNativeInterface</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OSNativeInterface</span><span class="o">(</span><span class="n">getContext</span><span class="o">());</span>
		<span class="n">addJavascriptInterface</span><span class="o">(</span><span class="n">mNativeInterface</span><span class="o">,</span> <span class="s">&quot;AreabaseNative&quot;</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setOnMapLoadedListener</span><span class="o">(</span>
			<span class="n">OSNativeInterface</span><span class="o">.</span><span class="na">OnMapLoadedListener</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">mNativeInterface</span><span class="o">.</span><span class="na">_setOnMapLoadedListener</span><span class="o">(</span><span class="n">listener</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">highlightArea</span><span class="o">(</span><span class="n">String</span> <span class="n">areaId</span><span class="o">,</span> <span class="n">String</span> <span class="n">adminUnit</span><span class="o">,</span>
			<span class="n">HoloCSSColourValues</span> <span class="n">lineColour</span><span class="o">,</span> <span class="n">HoloCSSColourValues</span> <span class="n">fillColour</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">loadUrl</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
				<span class="s">&quot;javascript:wrapper__highlightArea(%s, %s, %s, %s)&quot;</span><span class="o">,</span> <span class="n">areaId</span><span class="o">,</span>
				<span class="n">adminUnit</span><span class="o">,</span> <span class="n">lineColour</span><span class="o">.</span><span class="na">getCssValue</span><span class="o">(),</span> <span class="n">fillColour</span><span class="o">.</span><span class="na">getCssValue</span><span class="o">()));</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">highlightArea</span><span class="o">(</span><span class="n">String</span> <span class="n">areaId</span><span class="o">,</span> <span class="n">String</span> <span class="n">adminUnit</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">highlightArea</span><span class="o">(</span><span class="n">areaId</span><span class="o">,</span> <span class="n">adminUnit</span><span class="o">,</span> <span class="n">HoloCSSColourValues</span><span class="o">.</span><span class="na">AQUAMARINE</span><span class="o">,</span>
				<span class="n">HoloCSSColourValues</span><span class="o">.</span><span class="na">CYAN</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Centre the map on a specific point given by its easting and northing, at</span>
<span class="cm">	 * the same zoom level.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param easting the &quot;easting&quot; coordinate</span>
<span class="cm">	 * @param northing the &quot;northing&quot; coordinate</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCentre_byEastingNorthing</span><span class="o">(</span><span class="n">Double</span> <span class="n">easting</span><span class="o">,</span> <span class="n">Double</span> <span class="n">northing</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">loadUrl</span><span class="o">(</span><span class="n">String</span>
				<span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;javascript:wrapper__setCentre_keepZoom_eastingNorthing(%f, %f)&quot;</span><span class="o">,</span>
						<span class="n">easting</span><span class="o">,</span> <span class="n">northing</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Centre the map on a specific point given by its longitude and latitude,</span>
<span class="cm">	 * at the same zoom level.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param lon</span>
<span class="cm">	 *            Longitude to centre on</span>
<span class="cm">	 * @param lat</span>
<span class="cm">	 *            Latitude to centre on</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCentre</span><span class="o">(</span><span class="n">Double</span> <span class="n">lon</span><span class="o">,</span> <span class="n">Double</span> <span class="n">lat</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">loadUrl</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
				<span class="s">&quot;javascript:wrapper__setCentre_keepZoom_WGS84lonlat(%f, %f)&quot;</span><span class="o">,</span>
				<span class="n">lon</span><span class="o">,</span> <span class="n">lat</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Centre the map on a specific {@link Location} at the same zoom level.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param location</span>
<span class="cm">	 *            Location to centre on.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCentre</span><span class="o">(</span><span class="n">Location</span> <span class="n">location</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">setCentre</span><span class="o">(</span><span class="n">location</span><span class="o">.</span><span class="na">getLongitude</span><span class="o">(),</span> <span class="n">location</span><span class="o">.</span><span class="na">getLatitude</span><span class="o">());</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setZoom</span><span class="o">(</span><span class="kt">int</span> <span class="n">zoomLevel</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">loadUrl</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;javascript:wrapper__setZoom(%d)&quot;</span><span class="o">,</span> <span class="n">zoomLevel</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">highlightBoundary</span><span class="o">(</span><span class="kt">double</span><span class="o">[][]</span> <span class="n">poly</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Gson</span> <span class="n">gson</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GsonBuilder</span><span class="o">().</span><span class="na">create</span><span class="o">();</span> <span class="n">String</span> <span class="n">jsonPoly</span> <span class="o">=</span>
		<span class="n">gson</span><span class="o">.</span><span class="na">toJson</span><span class="o">(</span><span class="n">poly</span><span class="o">);</span>
		<span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">&quot;highlightBoundary&quot;</span><span class="o">,</span> <span class="n">jsonPoly</span><span class="o">);</span>
		<span class="n">loadUrl</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;javascript:wrapper__drawPoly(\&quot;%s\&quot;)&quot;</span><span class="o">,</span> <span class="n">jsonPoly</span><span class="o">));</span>
		
		<span class="k">return</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">OSAdminUnits <small>lamparski.areabase.map_support</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">map_support</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="nd">@Deprecated</span>
<span class="kd">public</span> <span class="kd">enum</span> <span class="n">OSAdminUnits</span> <span class="o">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * @formatter:off</span>
<span class="cm">	 */</span>
	<span class="n">COUNTY</span><span class="o">(</span><span class="s">&quot;County&quot;</span><span class="o">,</span> <span class="s">&quot;CTY&quot;</span><span class="o">),</span>
	<span class="n">COUNTY_ELECTORAL_DIVISION</span><span class="o">(</span><span class="s">&quot;County Electoral Division&quot;</span><span class="o">,</span> <span class="s">&quot;CED&quot;</span><span class="o">),</span>
	<span class="n">DISTRICT</span><span class="o">(</span><span class="s">&quot;District&quot;</span><span class="o">,</span> <span class="s">&quot;DIS&quot;</span><span class="o">),</span>
	<span class="n">DISTRICT_WARD</span><span class="o">(</span><span class="s">&quot;District Ward&quot;</span><span class="o">,</span> <span class="s">&quot;DIW&quot;</span><span class="o">),</span>
	<span class="n">EUROREGION</span><span class="o">(</span><span class="s">&quot;European Region&quot;</span><span class="o">,</span> <span class="s">&quot;EUR&quot;</span><span class="o">),</span>
	<span class="n">GREATER_LONDON_AUTHORITY</span><span class="o">(</span><span class="s">&quot;Greater London Authority&quot;</span><span class="o">,</span> <span class="s">&quot;GLA&quot;</span><span class="o">),</span>
	<span class="n">GLA_ASSEMBLY_CONSTITUENCY</span><span class="o">(</span><span class="s">&quot;Greater London Authority Assembly Constituency&quot;</span><span class="o">,</span> <span class="s">&quot;LAC&quot;</span><span class="o">),</span>
	<span class="n">LONDON_BOROUGH</span><span class="o">(</span><span class="s">&quot;London Borough&quot;</span><span class="o">,</span> <span class="s">&quot;LBO&quot;</span><span class="o">),</span>
	<span class="n">LONDON_BOROUGH_WARD</span><span class="o">(</span><span class="s">&quot;London Borough Ward&quot;</span><span class="o">,</span> <span class="s">&quot;LBW&quot;</span><span class="o">),</span>
	<span class="n">METROPOLITAN_DISTRICT</span><span class="o">(</span><span class="s">&quot;Metropolitan District&quot;</span><span class="o">,</span> <span class="s">&quot;MTD&quot;</span><span class="o">),</span>
	<span class="n">METROPOLITAN_WARD</span><span class="o">(</span><span class="s">&quot;Metropolitan Ward&quot;</span><span class="o">,</span> <span class="s">&quot;MTW&quot;</span><span class="o">),</span>
	<span class="n">SCOTTISH_PARLIAMENT_ELECTORAL_REGION</span><span class="o">(</span><span class="s">&quot;Scottish Parliament Electoral Region&quot;</span><span class="o">,</span> <span class="s">&quot;SPE&quot;</span><span class="o">),</span>
	<span class="n">SCOTTISH_PARLIAMENT_CONSTITUENCY</span><span class="o">(</span><span class="s">&quot;Scottish Parliament Constituency&quot;</span><span class="o">,</span> <span class="s">&quot;SPC&quot;</span><span class="o">),</span>
	<span class="n">UNITARY_AUTHORITY</span><span class="o">(</span><span class="s">&quot;Unitary Authority&quot;</span><span class="o">,</span> <span class="s">&quot;UTA&quot;</span><span class="o">),</span>
	<span class="n">UA_ELECTORAL_DIVISION</span><span class="o">(</span><span class="s">&quot;Unitary Authority Electoral Division&quot;</span><span class="o">,</span> <span class="s">&quot;UTE&quot;</span><span class="o">),</span>
	<span class="n">UA_WARD</span><span class="o">(</span><span class="s">&quot;Unitary Authority Ward&quot;</span><span class="o">,</span> <span class="s">&quot;UTW&quot;</span><span class="o">),</span>
	<span class="n">WELSH_ASSEMBLY_ELECTORAL_REGION</span><span class="o">(</span><span class="s">&quot;Welsh Assembly Electoral Region&quot;</span><span class="o">,</span> <span class="s">&quot;WAE&quot;</span><span class="o">),</span>
	<span class="n">WELSH_ASSEMBLY_CONSTITUENCY</span><span class="o">(</span><span class="s">&quot;Welsh Assembly Constituency&quot;</span><span class="o">,</span> <span class="s">&quot;WAC&quot;</span><span class="o">),</span>
	<span class="n">WESTMINSTER_CONSTITUENCY</span><span class="o">(</span><span class="s">&quot;Westminster Constituency&quot;</span><span class="o">,</span> <span class="s">&quot;WMC&quot;</span><span class="o">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * @formatter:on</span>
<span class="cm">	 */</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">id</span><span class="o">;</span>

	<span class="n">OSAdminUnits</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the name</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">name</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the id</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">id</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">OSMapWebViewClient <small>lamparski.areabase.map_support</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">map_support</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.webkit.WebView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.webkit.WebViewClient</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * A custom {@link WebViewClient} that is used by {@link OrdnanceSurveyMapView}</span>
<span class="cm"> * to restrict the URLs that the latter can load to those belonging to Ordnance</span>
<span class="cm"> * Survey&#39;s OpenSpace map system only (though file:/// URLs have to be permitted</span>
<span class="cm"> * as well). This is to prevent rogue JavaScript being injected into the widget,</span>
<span class="cm"> * which could for instance ask for login details to a Google account.</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * Of course, if the attacker spoofs DNS as well, they could probably pull it</span>
<span class="cm"> * off, but there&#39;s a limit to what I can do to stop that.</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OSMapWebViewClient</span> <span class="kd">extends</span> <span class="n">WebViewClient</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OnNonApplicationURLListener</span> <span class="o">{</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onIllegalUrl</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">);</span>

		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onOpenExternalSafeUrl</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="n">OnNonApplicationURLListener</span> <span class="n">mCallback</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">OSMapWebViewClient</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setOnIllegalURLListener</span><span class="o">(</span><span class="n">OnNonApplicationURLListener</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">mCallback</span> <span class="o">=</span> <span class="n">listener</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">shouldOverrideUrlLoading</span><span class="o">(</span><span class="n">WebView</span> <span class="n">view</span><span class="o">,</span> <span class="n">String</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">url</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;http://openspace.ordnancesurvey.co.uk/&quot;</span><span class="o">)</span> <span class="o">|</span> <span class="n">url</span>
				<span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;file:///&quot;</span><span class="o">)))</span> <span class="o">{</span>
			<span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">&quot;OSMapView client&quot;</span><span class="o">,</span> <span class="s">&quot;Caught non-application url: &quot;</span> <span class="o">+</span> <span class="n">url</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">mCallback</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;http://www.ordnancesurvey.co.uk/&quot;</span><span class="o">))</span> <span class="o">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * http://www.ordnancesurvey.co.uk/oswebsite/web-services/os-</span>
<span class="cm">					 * openspace/developer-agreement.html is safe and should</span>
<span class="cm">					 * just open a browser window</span>
<span class="cm">					 */</span>
					<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;OSMapView client&quot;</span><span class="o">,</span>
							<span class="s">&quot; &gt; Safe URL, firing onOpenExternalSafeUrl.&quot;</span><span class="o">);</span>
					<span class="n">mCallback</span><span class="o">.</span><span class="na">onOpenExternalSafeUrl</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
				<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
					<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;OSMapView client&quot;</span><span class="o">,</span>
							<span class="s">&quot; &gt; Unsafe URL, firing onIllegalUrl&quot;</span><span class="o">);</span>
					<span class="n">mCallback</span><span class="o">.</span><span class="na">onIllegalUrl</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">OSNativeInterface <small>lamparski.areabase.map_support</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">map_support</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.content.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.webkit.JavascriptInterface</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * This is an interface that allows the Ordnance Survey slippy map to call</span>
<span class="cm"> * native methods.</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OSNativeInterface</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OnMapLoadedListener</span> <span class="o">{</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMapLoaded</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="n">Context</span> <span class="n">context</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">OnMapLoadedListener</span> <span class="n">loadedCallback</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">OSNativeInterface</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * &lt;b&gt;Call from Java code&lt;/b&gt;: Sets a callback to be executed when the maps</span>
<span class="cm">	 * finish loading.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param listener</span>
<span class="cm">	 *            the callback</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">_setOnMapLoadedListener</span><span class="o">(</span><span class="n">OnMapLoadedListener</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">loadedCallback</span> <span class="o">=</span> <span class="n">listener</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * &lt;b&gt;Call from JavaScript code&lt;/b&gt;: Notifies the program that the map has</span>
<span class="cm">	 * finished loading.</span>
<span class="cm">	 */</span>
	<span class="nd">@JavascriptInterface</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMapLoaded</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;OSNativeInterface&quot;</span><span class="o">,</span> <span class="s">&quot;onMapLoaded() -&gt; calling the listener&quot;</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">loadedCallback</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">loadedCallback</span><span class="o">.</span><span class="na">onMapLoaded</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">&quot;OSNativeInterface&quot;</span><span class="o">,</span>
                    <span class="s">&quot;onMapLoaded() -&gt; no registered listener&quot;</span><span class="o">);</span>
        <span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@JavascriptInterface</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">consoleLog</span><span class="o">(</span><span class="n">String</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;slippymap.html [JS]&quot;</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@JavascriptInterface</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">consoleInfo</span><span class="o">(</span><span class="n">String</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">&quot;slippymap.html [JS]&quot;</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@JavascriptInterface</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">consoleWarn</span><span class="o">(</span><span class="n">String</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">&quot;slippymap.html [JS]&quot;</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@JavascriptInterface</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">consoleErr</span><span class="o">(</span><span class="n">String</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;slippymap.html [JS]&quot;</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">AreaDataService <small>lamparski.areabase.services</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">services</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.app.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Intent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.location.Location</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.AsyncTask</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Binder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.IBinder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.fima.cardsui.objects.CardModel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.uk_postcodes.api.Postcode</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.FileNotFoundException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Comparator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lamparski.areabase.cardproviders.CrimeCardProvider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.cardproviders.DemographicsCardProvider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.cardproviders.EconomyCardProvider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.cardproviders.EnvironmentCardProvider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.utils.OnError</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.helpers.CensusHelpers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.helpers.Statistics</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.methodcalls.delivery.GetTables</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.methodcalls.discovery.FindAreas</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.methodcalls.discovery.GetDatasetFamilies</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DataSetFamily</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DateRange</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Subject</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * A service for working with ONS data, asynchronously and all.</span>
<span class="cm"> *</span>
<span class="cm"> * Also defines a bunch of callback interfaces.</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AreaDataService</span> <span class="kd">extends</span> <span class="n">Service</span> <span class="o">{</span>



    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BasicAreaInfoIface</span> <span class="kd">extends</span> <span class="n">OnError</span> <span class="o">{</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">allDone</span><span class="o">(</span><span class="n">Float</span> <span class="n">areaRank</span><span class="o">);</span>

		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">cardReady</span><span class="o">(</span><span class="n">CardModel</span> <span class="n">cm</span><span class="o">);</span>

		<span class="cm">/*public void onValueNotAvailable();*/</span>

		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAreaNameFound</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">);</span>

		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAreaBoundaryFound</span><span class="o">(</span><span class="kt">double</span><span class="o">[][]</span> <span class="n">poly</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AreaLookupCallbacks</span> <span class="kd">extends</span> <span class="n">OnError</span> <span class="o">{</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">areaReady</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">);</span>
	<span class="o">}</span>

    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AreaListCallbacks</span> <span class="kd">extends</span> <span class="n">OnError</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">areasReady</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;</span> <span class="n">areas</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SubjectDumpIface</span> <span class="kd">extends</span> <span class="n">OnError</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">subjectDumpReady</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">);</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onProgress</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DatasetDumpCallbacks</span> <span class="kd">extends</span> <span class="n">OnError</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">datasetsDownloaded</span><span class="o">(</span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">DateRange</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">datasets</span><span class="o">);</span>
    <span class="o">}</span>

	<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AreaDataBinder</span> <span class="kd">extends</span> <span class="n">Binder</span> <span class="o">{</span>
		<span class="kd">public</span> <span class="n">AreaDataService</span> <span class="nf">getService</span><span class="o">()</span> <span class="o">{</span>
			<span class="k">return</span> <span class="n">AreaDataService</span><span class="o">.</span><span class="na">this</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kd">final</span> <span class="n">IBinder</span> <span class="n">mBinder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AreaDataBinder</span><span class="o">();</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">IBinder</span> <span class="nf">onBind</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;AreaDataService&quot;</span><span class="o">,</span>
				<span class="s">&quot;Binding! Received intent: &quot;</span> <span class="o">+</span> <span class="n">intent</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">mBinder</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Used by the Summary Fragment to generate the cards for the area</span>
<span class="cm">     * @param area area to get a summary for</span>
<span class="cm">     * @param callbacks callback interface for asynchronous return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">generateCardsForArea</span><span class="o">(</span><span class="kd">final</span> <span class="n">Area</span> <span class="n">area</span><span class="o">,</span> <span class="kd">final</span> <span class="n">BasicAreaInfoIface</span> <span class="n">callbacks</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">new</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">,</span> <span class="n">CardModel</span><span class="o">,</span> <span class="n">Float</span><span class="o">&gt;(){</span>
            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onProgressUpdate</span><span class="o">(</span><span class="n">CardModel</span><span class="o">...</span> <span class="n">values</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">super</span><span class="o">.</span><span class="na">onProgressUpdate</span><span class="o">(</span><span class="n">values</span><span class="o">);</span>
                <span class="n">callbacks</span><span class="o">.</span><span class="na">cardReady</span><span class="o">(</span><span class="n">values</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="n">Float</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">Area</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Area</span> <span class="n">theArea</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
                <span class="n">callbacks</span><span class="o">.</span><span class="na">onAreaNameFound</span><span class="o">(</span><span class="n">theArea</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>

                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">CardModel</span> <span class="n">demoCm</span> <span class="o">=</span> <span class="n">DemographicsCardProvider</span>
                            <span class="o">.</span><span class="na">demographicsCardForArea</span><span class="o">(</span><span class="n">theArea</span><span class="o">,</span>
                                    <span class="n">getResources</span><span class="o">());</span>
                    <span class="n">publishProgress</span><span class="o">(</span><span class="n">demoCm</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;AreaDataService&quot;</span><span class="o">,</span>
                            <span class="s">&quot;Error processing card for Demographics: &quot;</span>
                                    <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
                    <span class="n">callbacks</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="c1">// 2: Crime</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">CardModel</span> <span class="n">crimeCm</span> <span class="o">=</span> <span class="n">CrimeCardProvider</span><span class="o">.</span><span class="na">crimeCardForArea</span><span class="o">(</span>
                            <span class="n">theArea</span><span class="o">,</span> <span class="n">getResources</span><span class="o">());</span>
                    <span class="kt">double</span><span class="o">[][]</span> <span class="n">polygon</span> <span class="o">=</span> <span class="o">(</span><span class="kt">double</span><span class="o">[][])</span> <span class="n">crimeCm</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">polygon</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">callbacks</span><span class="o">.</span><span class="na">onAreaBoundaryFound</span><span class="o">(</span><span class="n">polygon</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">publishProgress</span><span class="o">(</span><span class="n">crimeCm</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;AreaDataService&quot;</span><span class="o">,</span>
                            <span class="s">&quot;Error processing card for Crime: &quot;</span>
                                    <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
                    <span class="n">callbacks</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="c1">// 3: Economy</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">CardModel</span> <span class="n">econCm</span> <span class="o">=</span> <span class="n">EconomyCardProvider</span>
                            <span class="o">.</span><span class="na">economyCardForArea</span><span class="o">(</span><span class="n">theArea</span><span class="o">,</span> <span class="n">getResources</span><span class="o">());</span>
                    <span class="n">publishProgress</span><span class="o">(</span><span class="n">econCm</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;AreaDataService&quot;</span><span class="o">,</span>
                            <span class="s">&quot;Error processing card for Economy: &quot;</span>
                                    <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
                    <span class="n">callbacks</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="c1">// 4: Environment</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">CardModel</span> <span class="n">envCm</span> <span class="o">=</span> <span class="n">EnvironmentCardProvider</span>
                            <span class="o">.</span><span class="na">environmentCardForArea</span><span class="o">(</span><span class="n">theArea</span><span class="o">,</span> <span class="n">getResources</span><span class="o">());</span>
                    <span class="n">publishProgress</span><span class="o">(</span><span class="n">envCm</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;AreaDataService&quot;</span><span class="o">,</span>
                            <span class="s">&quot;Error processing card for Environment: &quot;</span>
                                    <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
                    <span class="n">callbacks</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">AreaRank</span><span class="o">.</span><span class="na">forArea</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">callbacks</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="n">Float</span> <span class="n">areaRank</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">super</span><span class="o">.</span><span class="na">onPostExecute</span><span class="o">(</span><span class="n">areaRank</span><span class="o">);</span>
                <span class="n">callbacks</span><span class="o">.</span><span class="na">allDone</span><span class="o">(</span><span class="n">areaRank</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}.</span><span class="na">execute</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
    <span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Fetches a MSOA area which encloses the supplied location</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param location</span>
<span class="cm">	 *            the user&#39;s location</span>
<span class="cm">	 * @param commlink</span>
<span class="cm">	 *            the callback interface</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">areaForLocation</span><span class="o">(</span><span class="n">Location</span> <span class="n">location</span><span class="o">,</span>
			<span class="kd">final</span> <span class="n">AreaLookupCallbacks</span> <span class="n">commlink</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">new</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">Location</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">Area</span><span class="o">&gt;()</span> <span class="o">{</span>
			<span class="nd">@Override</span>
			<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPreExecute</span><span class="o">()</span> <span class="o">{</span>
				<span class="kd">super</span><span class="o">.</span><span class="na">onPreExecute</span><span class="o">();</span>

			<span class="o">}</span>

			<span class="nd">@Override</span>
			<span class="kd">protected</span> <span class="n">Area</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">Location</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">Location</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>

				<span class="n">Area</span> <span class="n">theArea</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
				<span class="k">try</span> <span class="o">{</span>
                    <span class="n">String</span> <span class="n">postcode</span> <span class="o">=</span> <span class="n">Postcode</span><span class="o">.</span><span class="na">forLocation</span><span class="o">(</span><span class="n">loc</span><span class="o">);</span>
                    <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">&quot;AreaDataService&quot;</span><span class="o">,</span> <span class="s">&quot;Got postcode: &quot;</span> <span class="o">+</span> <span class="n">postcode</span><span class="o">);</span>
					<span class="n">Set</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;</span> <span class="n">areaSet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FindAreas</span><span class="o">()</span>
							<span class="o">.</span><span class="na">ofLevelType</span><span class="o">(</span><span class="n">Area</span><span class="o">.</span><span class="na">LEVELTYPE_LOCAL_AUTHORITY</span><span class="o">)</span>
							<span class="o">.</span><span class="na">inHierarchy</span><span class="o">(</span>
									<span class="n">Area</span><span class="o">.</span><span class="na">HIERARCHY_2011_STATISTICAL_GEOGRAPHY</span><span class="o">)</span>
							<span class="o">.</span><span class="na">forPostcode</span><span class="o">(</span><span class="n">postcode</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>

					<span class="k">for</span> <span class="o">(</span><span class="n">Area</span> <span class="n">a</span> <span class="o">:</span> <span class="n">areaSet</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">getLevelTypeId</span><span class="o">()</span> <span class="o">==</span> <span class="n">Area</span><span class="o">.</span><span class="na">LEVELTYPE_LOCAL_AUTHORITY</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">theArea</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
                        <span class="o">}</span>
					<span class="o">}</span>

				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">tr</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">commlink</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">tr</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">return</span> <span class="n">theArea</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="nd">@Override</span>
			<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="n">Area</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
				<span class="kd">super</span><span class="o">.</span><span class="na">onPostExecute</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>

				<span class="n">commlink</span><span class="o">.</span><span class="na">areaReady</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}.</span><span class="na">execute</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Finds the area for the given postcode</span>
<span class="cm">     * @param postcode postcode for the area</span>
<span class="cm">     * @param callbacks callbacks for async call</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">areaForPostcode</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">postcode</span><span class="o">,</span> <span class="kd">final</span> <span class="n">AreaLookupCallbacks</span> <span class="n">callbacks</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">new</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">Area</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPreExecute</span><span class="o">()</span> <span class="o">{</span>
                <span class="kd">super</span><span class="o">.</span><span class="na">onPreExecute</span><span class="o">();</span>

            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="n">Area</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">Void</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Area</span> <span class="n">theArea</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">Set</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;</span> <span class="n">areaSet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FindAreas</span><span class="o">()</span>
                            <span class="o">.</span><span class="na">ofLevelType</span><span class="o">(</span><span class="n">Area</span><span class="o">.</span><span class="na">LEVELTYPE_LOCAL_AUTHORITY</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">inHierarchy</span><span class="o">(</span>
                                    <span class="n">Area</span><span class="o">.</span><span class="na">HIERARCHY_2011_STATISTICAL_GEOGRAPHY</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">forPostcode</span><span class="o">(</span><span class="n">postcode</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>

                    <span class="k">for</span> <span class="o">(</span><span class="n">Area</span> <span class="n">a</span> <span class="o">:</span> <span class="n">areaSet</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">getLevelTypeId</span><span class="o">()</span> <span class="o">==</span> <span class="n">Area</span><span class="o">.</span><span class="na">LEVELTYPE_LOCAL_AUTHORITY</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">theArea</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>

                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">tr</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">callbacks</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">tr</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">theArea</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="n">Area</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">super</span><span class="o">.</span><span class="na">onPostExecute</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>

                <span class="n">callbacks</span><span class="o">.</span><span class="na">areaReady</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}.</span><span class="na">execute</span><span class="o">();</span>
    <span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Fetches an area whose name most closely matches the supplied string</span>
<span class="cm">	 * (partials accepted)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param areaName the name (partials accepted) for the area to find</span>
<span class="cm">	 * @param commlink</span>
<span class="cm">	 *            the callback interface</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">areaForName</span><span class="o">(</span><span class="n">String</span> <span class="n">areaName</span><span class="o">,</span>
			<span class="kd">final</span> <span class="n">AreaLookupCallbacks</span> <span class="n">commlink</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">new</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">Area</span><span class="o">&gt;()</span> <span class="o">{</span>

			<span class="nd">@Override</span>
			<span class="kd">protected</span> <span class="n">Area</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="n">Set</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;</span> <span class="n">areaSet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FindAreas</span><span class="o">()</span>
							<span class="o">.</span><span class="na">inHierarchy</span><span class="o">(</span>
									<span class="n">Area</span><span class="o">.</span><span class="na">HIERARCHY_2011_STATISTICAL_GEOGRAPHY</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">ofLevelType</span><span class="o">(</span><span class="n">Area</span><span class="o">.</span><span class="na">HIERARCHY_2011_STATISTICAL_GEOGRAPHY</span><span class="o">)</span>
							<span class="o">.</span><span class="na">whoseNameContains</span><span class="o">(</span><span class="n">params</span><span class="o">[</span><span class="mi">0</span><span class="o">]).</span><span class="na">execute</span><span class="o">();</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">areaSet</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
                        <span class="n">commlink</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="k">new</span> <span class="n">FileNotFoundException</span><span class="o">(</span><span class="s">&quot;No areas returned for &quot;</span> <span class="o">+</span>
                                <span class="s">&quot;query string \&quot;&quot;</span> <span class="o">+</span> <span class="n">params</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">+</span> <span class="s">&quot;\&quot;&quot;</span><span class="o">));</span>
                    <span class="o">}</span>
					<span class="n">Area</span> <span class="n">theArea</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
					<span class="kt">int</span> <span class="n">topStringMatchScore</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
					<span class="k">for</span> <span class="o">(</span><span class="n">Area</span> <span class="n">a</span> <span class="o">:</span> <span class="n">areaSet</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">assert</span> <span class="n">a</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
						<span class="kt">int</span> <span class="n">nameScore</span> <span class="o">=</span> <span class="n">Statistics</span><span class="o">.</span><span class="na">computeLevenshteinDistance</span><span class="o">(</span>
								<span class="n">theArea</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">theArea</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="o">,</span> <span class="n">params</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">nameScore</span> <span class="o">&gt;</span> <span class="n">topStringMatchScore</span><span class="o">)</span> <span class="o">{</span>
							<span class="n">theArea</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
							<span class="n">topStringMatchScore</span> <span class="o">=</span> <span class="n">nameScore</span><span class="o">;</span>
						<span class="o">}</span>
					<span class="o">}</span>
					<span class="k">return</span> <span class="n">theArea</span><span class="o">;</span>
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">tr</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">commlink</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">tr</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="n">Area</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">commlink</span><span class="o">.</span><span class="na">areaReady</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
			<span class="o">}</span>

		<span class="o">}.</span><span class="na">execute</span><span class="o">(</span><span class="n">areaName</span><span class="o">);</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Gets a list of areas whose name contains the string areaName, ordered by the similarity</span>
<span class="cm">     * to that string.</span>
<span class="cm">     * @param areaName the name (partials accepted) for the area to find</span>
<span class="cm">     * @param commlink callbacks for returning the value or reporting errors.</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">areasForName</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">areaName</span><span class="o">,</span>
                            <span class="kd">final</span> <span class="n">AreaListCallbacks</span> <span class="n">commlink</span><span class="o">)</span> <span class="o">{</span>
        <span class="cm">/**</span>
<span class="cm">         * Compares the &quot;distances&quot; of given areas&#39; names from the original query. This makes it</span>
<span class="cm">         * possible to sort the area list without having to worry about sorting algorithms.</span>
<span class="cm">         */</span>
        <span class="kd">final</span> <span class="n">Comparator</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;</span> <span class="n">areaComparator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Comparator</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">int</span> <span class="nf">compare</span><span class="o">(</span><span class="n">Area</span> <span class="n">lhs</span><span class="o">,</span> <span class="n">Area</span> <span class="n">rhs</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">distanceLhs</span> <span class="o">=</span> <span class="n">Statistics</span><span class="o">.</span><span class="na">computeLevenshteinDistance</span><span class="o">(</span><span class="n">lhs</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">areaName</span><span class="o">);</span>
                <span class="kt">int</span> <span class="n">distanceRhs</span> <span class="o">=</span> <span class="n">Statistics</span><span class="o">.</span><span class="na">computeLevenshteinDistance</span><span class="o">(</span><span class="n">rhs</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">areaName</span><span class="o">);</span>
                <span class="k">if</span><span class="o">(</span><span class="n">distanceLhs</span> <span class="o">==</span> <span class="n">distanceRhs</span><span class="o">){</span>
                    <span class="k">return</span> <span class="mi">0</span><span class="o">;</span> <span class="c1">// both areas&#39; names are the same distance from the query</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">distanceLhs</span> <span class="o">&lt;</span> <span class="n">distanceRhs</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="c1">// lhs area&#39;s name is closer to the query</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="mi">1</span><span class="o">;</span> <span class="c1">// rhs area&#39;s name is closer to the query</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">};</span>

        <span class="k">new</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">Set</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;</span> <span class="n">areaSet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FindAreas</span><span class="o">()</span>
                            <span class="o">.</span><span class="na">inHierarchy</span><span class="o">(</span>
                                    <span class="n">Area</span><span class="o">.</span><span class="na">HIERARCHY_2011_STATISTICAL_GEOGRAPHY</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">ofLevelType</span><span class="o">(</span><span class="n">Area</span><span class="o">.</span><span class="na">LEVELTYPE_LOCAL_AUTHORITY</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">whoseNameContains</span><span class="o">(</span><span class="n">params</span><span class="o">[</span><span class="mi">0</span><span class="o">]).</span><span class="na">execute</span><span class="o">();</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">areaSet</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
                        <span class="n">commlink</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="k">new</span> <span class="n">FileNotFoundException</span><span class="o">(</span><span class="s">&quot;No areas returned for &quot;</span> <span class="o">+</span>
                                <span class="s">&quot;query string \&quot;&quot;</span> <span class="o">+</span> <span class="n">params</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">+</span> <span class="s">&quot;\&quot;&quot;</span><span class="o">));</span>
                    <span class="o">}</span>
                    <span class="n">List</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;</span> <span class="n">areas</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;(</span><span class="n">areaSet</span><span class="o">);</span>
                    <span class="n">Collections</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">areas</span><span class="o">,</span> <span class="n">areaComparator</span><span class="o">);</span>
                    <span class="k">return</span> <span class="n">areas</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">tr</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">commlink</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">tr</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;</span> <span class="n">areas</span><span class="o">){</span>
                <span class="n">commlink</span><span class="o">.</span><span class="na">areasReady</span><span class="o">(</span><span class="n">areas</span><span class="o">);</span>
            <span class="o">}</span>

        <span class="o">}.</span><span class="na">execute</span><span class="o">(</span><span class="n">areaName</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Fetches all the datasets in the given subject. May be slow the first time.</span>
<span class="cm">     * @param area The area to fetch information for</span>
<span class="cm">     * @param subjectName The subject name</span>
<span class="cm">     * @param commlink A callback interface</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">subjectDump</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">,</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">subjectName</span><span class="o">,</span> <span class="kd">final</span> <span class="n">SubjectDumpIface</span> <span class="n">commlink</span><span class="o">){</span>
        <span class="k">new</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;&gt;(){</span>

            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">doInBackground</span><span class="o">(</span><span class="n">Area</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Area</span> <span class="n">area</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
                <span class="k">assert</span> <span class="n">area</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="n">Map</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;();</span>
                <span class="k">try</span><span class="o">{</span>
                    <span class="n">Subject</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">CensusHelpers</span><span class="o">.</span><span class="na">findSubject</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="n">subjectName</span><span class="o">);</span>
                    <span class="n">List</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">&gt;</span> <span class="n">families</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GetDatasetFamilies</span><span class="o">(</span><span class="n">subject</span><span class="o">).</span><span class="na">forArea</span><span class="o">(</span><span class="n">area</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>
                    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">families</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++){</span>
                        <span class="n">commlink</span><span class="o">.</span><span class="na">onProgress</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">families</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
                        <span class="n">DataSetFamily</span> <span class="n">family</span> <span class="o">=</span> <span class="n">families</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                        <span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">datasets</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GetTables</span><span class="o">().</span><span class="na">forArea</span><span class="o">(</span><span class="n">area</span><span class="o">).</span><span class="na">inFamily</span><span class="o">(</span><span class="n">family</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">datasets</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="o">){</span>
                            <span class="n">Log</span><span class="o">.</span><span class="na">wtf</span><span class="o">(</span><span class="s">&quot;AreaDataService&quot;</span><span class="o">,</span> <span class="s">&quot;Asked for 1 dataset, got &quot;</span>
                                    <span class="o">+</span> <span class="n">datasets</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; instead.&quot;</span><span class="o">);</span>
                            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="n">Dataset</span> <span class="n">dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">();</span>
                        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">family</span><span class="o">,</span> <span class="n">dataset</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">tr</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">commlink</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">tr</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">super</span><span class="o">.</span><span class="na">onPostExecute</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
                <span class="n">commlink</span><span class="o">.</span><span class="na">subjectDumpReady</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}.</span><span class="na">execute</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Fetches all data for the dataset family given, referenced by the date ranges they cover.</span>
<span class="cm">     * @param area The area to fetch information for</span>
<span class="cm">     * @param family The dataset family to download</span>
<span class="cm">     * @param callbacks A callback interface</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">datasetDump</span><span class="o">(</span><span class="kd">final</span> <span class="n">Area</span> <span class="n">area</span><span class="o">,</span> <span class="kd">final</span> <span class="n">DataSetFamily</span> <span class="n">family</span><span class="o">,</span> <span class="kd">final</span> <span class="n">DatasetDumpCallbacks</span> <span class="n">callbacks</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">new</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">DateRange</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;&gt;(){</span>
            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">DateRange</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">doInBackground</span><span class="o">(</span><span class="n">Void</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">DateRange</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">dateRangeDatasetHashMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">DateRange</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;();</span>

                <span class="n">DateRange</span><span class="o">[]</span> <span class="n">ranges</span> <span class="o">=</span> <span class="n">family</span><span class="o">.</span><span class="na">getDateRanges</span><span class="o">();</span>
                <span class="k">for</span><span class="o">(</span><span class="n">DateRange</span> <span class="n">range</span> <span class="o">:</span> <span class="n">ranges</span><span class="o">){</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">current</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GetTables</span><span class="o">()</span>
                                <span class="o">.</span><span class="na">forArea</span><span class="o">(</span><span class="n">area</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">inFamily</span><span class="o">(</span><span class="n">family</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">inDateRange</span><span class="o">(</span><span class="n">range</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">execute</span><span class="o">();</span>
                        <span class="n">Dataset</span> <span class="n">currentDataset</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">();</span>
                        <span class="n">dateRangeDatasetHashMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">range</span><span class="o">,</span> <span class="n">currentDataset</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">callbacks</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>

                <span class="k">return</span> <span class="n">dateRangeDatasetHashMap</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">DateRange</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">dateRangeDatasetHashMap</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">callbacks</span><span class="o">.</span><span class="na">datasetsDownloaded</span><span class="o">(</span><span class="n">dateRangeDatasetHashMap</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}.</span><span class="na">execute</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">AreaRank <small>lamparski.areabase.services</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">services</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.content.ContentResolver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.ContentValues</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.database.Cursor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParserException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.FileNotFoundException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lamparski.areabase.AreaActivity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.CacheContentProvider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.CacheDbOpenHelper.AreaRankTable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.cardproviders.CrimeCardProvider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.cardproviders.EconomyCardProvider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.cardproviders.EnvironmentCardProvider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.cardproviders.TrendDescription</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.errors.NDE2Exception</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.methodcalls.delivery.GetTables</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DataSetFamily</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Subject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Topic</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">nde2</span><span class="o">.</span><span class="na">helpers</span><span class="o">.</span><span class="na">CensusHelpers</span><span class="o">.</span><span class="na">findRequiredFamilies</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">nde2</span><span class="o">.</span><span class="na">helpers</span><span class="o">.</span><span class="na">CensusHelpers</span><span class="o">.</span><span class="na">findSubject</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Generates AreaRank for the area based on certain parameters. This score takes into account</span>
<span class="cm"> * key socio-economic variables.</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> *     The formula for calculating an AreaRank is as follows:</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;ol&gt;</span>
<span class="cm"> *     &lt;li&gt;Start with a mid-value of 38.&lt;/li&gt;</span>
<span class="cm"> *     &lt;li&gt;For the crime trend, change the value by -10, -5, 0, +5 or +10&lt;/li&gt;</span>
<span class="cm"> *     &lt;li&gt;For the energy trend, change the value by -4, -2, 0, +2 or +4&lt;/li&gt;</span>
<span class="cm"> *     &lt;li&gt;For the unemployment rate, change the value by -6, -3, 0, +3 or +6&lt;/li&gt;</span>
<span class="cm"> *     &lt;li&gt;For the unemployment trend, change the value by -8, -4, 0, +4 or +8&lt;/li&gt;</span>
<span class="cm"> *     &lt;li&gt;For the rate of free school meal pupils, change the value by -5, -2.5, 0, +2.5 or 5&lt;/li&gt;</span>
<span class="cm"> *     &lt;li&gt;For the rate of A*-C GCSE pupils, change the value by -5, -2.5, 0, +2.5 or 5&lt;/li&gt;</span>
<span class="cm"> *     &lt;li&gt;Take the value (as v) and return (v/76)*100&lt;/li&gt;</span>
<span class="cm"> * &lt;/ol&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> *     The changes are triggered by various thresholds that should be adjusted to national average</span>
<span class="cm"> *     values or other magics, however at the moment they are quite arbitrary.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @author filip</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AreaRank</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">KS4_ASTAR_TO_C_ALL_PUPILS</span> <span class="o">=</span> <span class="mi">7700</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ALL_PUPILS</span> <span class="o">=</span> <span class="mi">7705</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">FREE_SCHOOL_MEAL_PUPILS</span> <span class="o">=</span> <span class="mi">7706</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">float</span> <span class="n">MID_SCORE</span> <span class="o">=</span> <span class="mf">38.0f</span><span class="o">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Returns a score for the given area. Since computing an AreaRank score usually takes a while,</span>
<span class="cm">     * the scores are cached.</span>
<span class="cm">     * @param area The area to grade</span>
<span class="cm">     * @return AreaRank for the area</span>
<span class="cm">     * @throws Exception</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">float</span> <span class="nf">forArea</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="k">return</span> <span class="nf">cachedScore</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">FileNotFoundException</span> <span class="n">fnfe</span><span class="o">){</span>
            <span class="kt">float</span> <span class="n">score</span> <span class="o">=</span> <span class="n">newScore</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
            <span class="n">saveScore</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="n">score</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">score</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Tries to retrieve a cached score. If one is not available, returns NaN.</span>
<span class="cm">     * @param area The area to grade</span>
<span class="cm">     * @return Cached AreaRank or NaN.</span>
<span class="cm">     * @throws FileNotFoundException</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">float</span> <span class="nf">cachedScore</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">FileNotFoundException</span> <span class="o">{</span>
        <span class="n">ContentResolver</span> <span class="n">resolver</span> <span class="o">=</span> <span class="n">AreaActivity</span><span class="o">.</span><span class="na">getAreabaseApplicationContext</span><span class="o">().</span><span class="na">getContentResolver</span><span class="o">();</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">selectionArgs</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">area</span><span class="o">.</span><span class="na">getAreaId</span><span class="o">()),</span>
                <span class="n">Long</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="n">l</span><span class="o">)</span> <span class="o">};</span>
        <span class="n">Cursor</span> <span class="n">c</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">CacheContentProvider</span><span class="o">.</span><span class="na">AREARANK_CACHE_URI</span><span class="o">,</span>
                <span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span> <span class="s">&quot;*&quot;</span> <span class="o">},</span>
                <span class="s">&quot;areaId = ? AND computedOn &gt; ?&quot;</span><span class="o">,</span>
                <span class="n">selectionArgs</span><span class="o">,</span> <span class="s">&quot;computedOn DESC&quot;</span><span class="o">);</span>

        <span class="k">if</span><span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">FileNotFoundException</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kt">float</span> <span class="n">score</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="na">NaN</span><span class="o">;</span>
        <span class="k">if</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">moveToFirst</span><span class="o">()){</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getFloat</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">getColumnIndex</span><span class="o">(</span><span class="n">AreaRankTable</span><span class="o">.</span><span class="na">FIELD_AREA_RANK</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">c</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">Float</span><span class="o">.</span><span class="na">isNaN</span><span class="o">(</span><span class="n">score</span><span class="o">)){</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">FileNotFoundException</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;AreaRank&quot;</span><span class="o">,</span>
                <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Returning a cached score for %s: %.1f&quot;</span><span class="o">,</span> <span class="n">area</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">score</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">score</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Generate a new score.</span>
<span class="cm">     * @param area The area to grade</span>
<span class="cm">     * @return AreaRank</span>
<span class="cm">     * @throws Exception</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">float</span> <span class="nf">newScore</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="kt">float</span> <span class="n">score</span> <span class="o">=</span> <span class="n">MID_SCORE</span><span class="o">;</span>

        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;AreaRank&quot;</span><span class="o">,</span>
                <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Computing a new score for %s...&quot;</span><span class="o">,</span> <span class="n">area</span><span class="o">.</span><span class="na">getName</span><span class="o">()));</span>
        <span class="n">Subject</span> <span class="n">economySubject</span> <span class="o">=</span> <span class="n">findSubject</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="s">&quot;Economic Deprivation&quot;</span><span class="o">);</span>
        <span class="n">score</span> <span class="o">+=</span> <span class="n">crimeTrend</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">&quot;AreaRank&quot;</span><span class="o">,</span>
                <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Computing a new score for %s... [Crime component done]&quot;</span><span class="o">,</span> <span class="n">area</span><span class="o">.</span><span class="na">getName</span><span class="o">()));</span>
        <span class="n">score</span> <span class="o">+=</span> <span class="n">energyTrend</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">&quot;AreaRank&quot;</span><span class="o">,</span>
                <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Computing a new score for %s... [Energy component done]&quot;</span><span class="o">,</span> <span class="n">area</span><span class="o">.</span><span class="na">getName</span><span class="o">()));</span>
        <span class="n">score</span> <span class="o">+=</span> <span class="n">unemployment</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">&quot;AreaRank&quot;</span><span class="o">,</span>
                <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Computing a new score for %s... [Unemployment component done]&quot;</span><span class="o">,</span> <span class="n">area</span><span class="o">.</span><span class="na">getName</span><span class="o">()));</span>
        <span class="n">score</span> <span class="o">+=</span> <span class="n">education</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">&quot;AreaRank&quot;</span><span class="o">,</span>
                <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Computing a new score for %s... [Education component done]&quot;</span><span class="o">,</span> <span class="n">area</span><span class="o">.</span><span class="na">getName</span><span class="o">()));</span>

        <span class="k">return</span> <span class="o">(</span><span class="n">score</span><span class="o">/(</span><span class="n">MID_SCORE</span><span class="o">*</span><span class="mi">2</span><span class="o">))*</span><span class="mi">100</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Save the given AreaRank to database.</span>
<span class="cm">     * @param area The graded area</span>
<span class="cm">     * @param score The score to save</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">saveScore</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">,</span> <span class="kt">float</span> <span class="n">score</span><span class="o">){</span>
        <span class="n">ContentResolver</span> <span class="n">resolver</span> <span class="o">=</span> <span class="n">AreaActivity</span><span class="o">.</span><span class="na">getAreabaseApplicationContext</span><span class="o">().</span><span class="na">getContentResolver</span><span class="o">();</span>
        <span class="n">ContentValues</span> <span class="n">values</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContentValues</span><span class="o">();</span>
        <span class="n">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">AreaRankTable</span><span class="o">.</span><span class="na">FIELD_AREA_ID</span><span class="o">,</span> <span class="n">area</span><span class="o">.</span><span class="na">getAreaId</span><span class="o">());</span>
        <span class="n">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">AreaRankTable</span><span class="o">.</span><span class="na">FIELD_AREA_RANK</span><span class="o">,</span> <span class="n">score</span><span class="o">);</span>
        <span class="n">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">AreaRankTable</span><span class="o">.</span><span class="na">FIELD_RETRIEVED_ON</span><span class="o">,</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
        <span class="n">resolver</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">CacheContentProvider</span><span class="o">.</span><span class="na">AREARANK_CACHE_URI</span><span class="o">,</span> <span class="n">values</span><span class="o">);</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;AreaRank&quot;</span><span class="o">,</span>
                <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Saving score for %s: %.1f&quot;</span><span class="o">,</span> <span class="n">area</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">score</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Analyses the unemployment rate and trend</span>
<span class="cm">     * @param area The area to grade</span>
<span class="cm">     * @return a modifier for the AreaRank</span>
<span class="cm">     * @throws XmlPullParserException</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     * @throws NDE2Exception</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">float</span> <span class="nf">unemployment</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">NDE2Exception</span> <span class="o">{</span>
        <span class="n">TrendDescription</span> <span class="n">trenddesc</span> <span class="o">=</span> <span class="n">EconomyCardProvider</span><span class="o">.</span><span class="na">getUnemploymentRate</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>

        <span class="kt">float</span> <span class="n">scoreComponent</span> <span class="o">=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>

        <span class="kt">float</span> <span class="n">unemplRatio</span> <span class="o">=</span> <span class="n">trenddesc</span><span class="o">.</span><span class="na">currentValue</span><span class="o">;</span>
        <span class="k">if</span><span class="o">(</span><span class="n">unemplRatio</span> <span class="o">&lt;=</span> <span class="mf">0.02f</span><span class="o">){</span>
            <span class="n">scoreComponent</span> <span class="o">+=</span> <span class="mi">6</span><span class="n">f</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">unemplRatio</span> <span class="o">&lt;=</span> <span class="mf">0.04f</span><span class="o">){</span>
            <span class="n">scoreComponent</span> <span class="o">+=</span> <span class="mi">3</span><span class="n">f</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">unemplRatio</span> <span class="o">&lt;=</span> <span class="mf">0.08f</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">scoreComponent</span> <span class="o">+=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">unemplRatio</span> <span class="o">&lt;=</span> <span class="mf">0.1f</span><span class="o">){</span>
            <span class="n">scoreComponent</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">3</span><span class="n">f</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">scoreComponent</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">6</span><span class="n">f</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">switch</span> <span class="o">(</span><span class="n">trenddesc</span><span class="o">.</span><span class="na">which</span><span class="o">){</span>
            <span class="k">case</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">FALLING_RAPIDLY</span><span class="o">:</span>
                <span class="n">scoreComponent</span> <span class="o">+=</span> <span class="mi">8</span><span class="n">f</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">FALLING</span><span class="o">:</span>
                <span class="n">scoreComponent</span> <span class="o">+=</span> <span class="mi">4</span><span class="n">f</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">STABLE</span><span class="o">:</span>
                <span class="n">scoreComponent</span> <span class="o">+=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">RISING</span><span class="o">:</span>
                <span class="n">scoreComponent</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">4</span><span class="n">f</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">RISING_RAPIDLY</span><span class="o">:</span>
                <span class="n">scoreComponent</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">8</span><span class="n">f</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">scoreComponent</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Analyses the rate of Free School Meals pupils and the A*-C GCSE rate.</span>
<span class="cm">     * @param area The area to grade</span>
<span class="cm">     * @return a modifier for the AreaRank</span>
<span class="cm">     * @throws XmlPullParserException</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     * @throws NDE2Exception</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">float</span> <span class="nf">education</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">NDE2Exception</span> <span class="o">{</span>
        <span class="kt">float</span> <span class="n">scoreComponent</span> <span class="o">=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>

        <span class="kt">float</span> <span class="n">allKS4Pupils</span> <span class="o">=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>
        <span class="kt">float</span> <span class="n">freeMealsKS4Pupils</span> <span class="o">=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>
        <span class="kt">float</span> <span class="n">aStarToCKS4Pupils</span> <span class="o">=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>

        <span class="n">Subject</span> <span class="n">eduSubject</span> <span class="o">=</span> <span class="n">findSubject</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="s">&quot;Education, Skills and Training&quot;</span><span class="o">);</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">kw</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span> <span class="s">&quot;GCSE and Equivalent Results for Young People by Free School Meal Eligibility, Referenced by Location of Pupil Residence&quot;</span> <span class="o">};</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">&gt;</span> <span class="n">dataSetFamilies</span> <span class="o">=</span> <span class="n">findRequiredFamilies</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="n">eduSubject</span><span class="o">,</span> <span class="n">kw</span><span class="o">);</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">datasets</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GetTables</span><span class="o">().</span><span class="na">inFamilies</span><span class="o">(</span><span class="n">dataSetFamilies</span><span class="o">).</span><span class="na">forArea</span><span class="o">(</span><span class="n">area</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>

        <span class="n">Dataset</span> <span class="n">dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Topic</span> <span class="n">t</span> <span class="o">:</span> <span class="n">dataset</span><span class="o">.</span><span class="na">getTopics</span><span class="o">().</span><span class="na">values</span><span class="o">()){</span>
            <span class="k">if</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTopicId</span><span class="o">()</span> <span class="o">==</span> <span class="n">KS4_ASTAR_TO_C_ALL_PUPILS</span><span class="o">){</span>
                <span class="n">aStarToCKS4Pupils</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">().</span><span class="na">getValue</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTopicId</span><span class="o">()</span> <span class="o">==</span> <span class="n">ALL_PUPILS</span><span class="o">){</span>
                <span class="n">allKS4Pupils</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">().</span><span class="na">getValue</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getTopicId</span><span class="o">()</span> <span class="o">==</span> <span class="n">FREE_SCHOOL_MEAL_PUPILS</span><span class="o">){</span>
                <span class="n">freeMealsKS4Pupils</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="na">getItems</span><span class="o">(</span><span class="n">t</span><span class="o">).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">().</span><span class="na">getValue</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kt">float</span> <span class="n">freeSchoolMealRatio</span> <span class="o">=</span> <span class="n">freeMealsKS4Pupils</span> <span class="o">/</span> <span class="n">allKS4Pupils</span><span class="o">;</span>

        <span class="k">if</span><span class="o">(</span><span class="n">freeSchoolMealRatio</span> <span class="o">&gt;=</span> <span class="mf">0.3</span><span class="o">){</span>
            <span class="n">scoreComponent</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">5</span><span class="n">f</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">freeSchoolMealRatio</span> <span class="o">&gt;=</span> <span class="mf">0.2</span><span class="o">){</span>
            <span class="n">scoreComponent</span> <span class="o">+=</span> <span class="o">-</span><span class="mf">2.5f</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">freeSchoolMealRatio</span> <span class="o">&gt;=</span> <span class="mf">0.15</span><span class="o">){</span>
            <span class="n">scoreComponent</span> <span class="o">+=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">freeSchoolMealRatio</span> <span class="o">&gt;=</span> <span class="mf">0.1</span><span class="o">){</span>
            <span class="n">scoreComponent</span> <span class="o">+=</span> <span class="mf">2.5f</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">scoreComponent</span> <span class="o">+=</span> <span class="mi">5</span><span class="n">f</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span><span class="o">(</span><span class="n">aStarToCKS4Pupils</span> <span class="o">&gt;=</span> <span class="mi">95</span><span class="n">f</span><span class="o">){</span>
            <span class="n">scoreComponent</span> <span class="o">+=</span> <span class="mi">5</span><span class="n">f</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">aStarToCKS4Pupils</span> <span class="o">&gt;=</span> <span class="mi">90</span><span class="n">f</span><span class="o">){</span>
            <span class="n">scoreComponent</span> <span class="o">+=</span> <span class="mf">2.5f</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">aStarToCKS4Pupils</span> <span class="o">&gt;=</span> <span class="mi">85</span><span class="n">f</span><span class="o">){</span>
            <span class="n">scoreComponent</span> <span class="o">+=</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">aStarToCKS4Pupils</span> <span class="o">&gt;=</span> <span class="mi">80</span><span class="n">f</span><span class="o">){</span>
            <span class="n">scoreComponent</span> <span class="o">+=</span> <span class="o">-</span><span class="mf">2.5f</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">scoreComponent</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">5</span><span class="n">f</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">scoreComponent</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Analyses energy usage trend.</span>
<span class="cm">     * @param area The area to grade</span>
<span class="cm">     * @return a modifier for the AreaRank</span>
<span class="cm">     * @throws XmlPullParserException</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     * @throws NDE2Exception</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">float</span> <span class="nf">energyTrend</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">NDE2Exception</span> <span class="o">{</span>
        <span class="n">TrendDescription</span> <span class="n">trendDescription</span> <span class="o">=</span> <span class="n">EnvironmentCardProvider</span><span class="o">.</span><span class="na">getEnergyTrend</span><span class="o">(</span><span class="n">area</span><span class="o">,</span>
                <span class="n">findRequiredFamilies</span><span class="o">(</span><span class="n">area</span><span class="o">,</span>
                        <span class="n">findSubject</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="n">EnvironmentCardProvider</span><span class="o">.</span><span class="na">ENVIRONMENT_SUBJECT</span><span class="o">),</span>
                        <span class="n">EnvironmentCardProvider</span><span class="o">.</span><span class="na">REQUIRED_FAMILIES</span><span class="o">));</span>
        <span class="k">switch</span><span class="o">(</span><span class="n">trendDescription</span><span class="o">.</span><span class="na">which</span><span class="o">){</span>
            <span class="k">case</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">FALLING_RAPIDLY</span><span class="o">:</span>
                <span class="k">return</span> <span class="mi">4</span><span class="n">f</span><span class="o">;</span>
            <span class="k">case</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">FALLING</span><span class="o">:</span>
                <span class="k">return</span> <span class="mi">2</span><span class="n">f</span><span class="o">;</span>
            <span class="k">case</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">STABLE</span><span class="o">:</span>
                <span class="k">return</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>
            <span class="k">case</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">RISING</span><span class="o">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="n">f</span><span class="o">;</span>
            <span class="k">case</span> <span class="n">TrendDescription</span><span class="o">.</span><span class="na">RISING_RAPIDLY</span><span class="o">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">4</span><span class="n">f</span><span class="o">;</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Analyses crime trend.</span>
<span class="cm">     * @param area The area to grade</span>
<span class="cm">     * @return a modifier for the AreaRank</span>
<span class="cm">     * @throws Exception</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">float</span> <span class="nf">crimeTrend</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="kt">double</span> <span class="n">gradient</span> <span class="o">=</span> <span class="n">CrimeCardProvider</span><span class="o">.</span><span class="na">getCrimeTrend</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">gradient</span> <span class="o">&gt;</span> <span class="n">CrimeCardProvider</span><span class="o">.</span><span class="na">TREND_RAPID_LOWER_THRESHOLD</span>
                <span class="o">&amp;&amp;</span> <span class="n">gradient</span> <span class="o">&lt;=</span> <span class="n">CrimeCardProvider</span><span class="o">.</span><span class="na">TREND_STABLE_LOWER_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="mi">5</span><span class="n">f</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">gradient</span> <span class="o">&gt;</span> <span class="n">CrimeCardProvider</span><span class="o">.</span><span class="na">TREND_STABLE_LOWER_THRESHOLD</span>
                <span class="o">&amp;&amp;</span> <span class="n">gradient</span> <span class="o">&lt;=</span> <span class="n">CrimeCardProvider</span><span class="o">.</span><span class="na">TREND_STABLE_UPPER_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="mi">0</span><span class="n">f</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">gradient</span> <span class="o">&gt;</span> <span class="n">CrimeCardProvider</span><span class="o">.</span><span class="na">TREND_STABLE_UPPER_THRESHOLD</span>
                <span class="o">&amp;&amp;</span> <span class="n">gradient</span> <span class="o">&lt;=</span> <span class="n">CrimeCardProvider</span><span class="o">.</span><span class="na">TREND_RAPID_UPPER_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">5</span><span class="n">f</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">gradient</span> <span class="o">&gt;</span> <span class="n">CrimeCardProvider</span><span class="o">.</span><span class="na">TREND_RAPID_UPPER_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">10</span><span class="n">f</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="mi">10</span><span class="n">f</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">OnError <small>lamparski.areabase.utils</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">utils</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="cm">/**</span>
<span class="cm"> * An OnError subroutine declaration.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OnError</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">tr</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">Pickle <small>lamparski.areabase.utils</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">utils</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">java.io.ByteArrayInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ByteArrayOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectInput</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectOutput</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.StreamCorruptedException</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Objects to byte arrays and vice versa</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="nd">@Deprecated</span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unused&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pickle</span> <span class="o">{</span>
	<span class="cm">/**</span>
<span class="cm">	 * Creates an object from the byte array &lt;i&gt;pickle&lt;/i&gt;.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param pickle</span>
<span class="cm">	 *            The byte array to unpack</span>
<span class="cm">	 * @return The object that was stored in the array</span>
<span class="cm">	 * @throws StreamCorruptedException</span>
<span class="cm">	 *             When the array provided is garbage</span>
<span class="cm">	 * @throws IOException</span>
<span class="cm">	 *             ObjectInput throws it, but since it&#39;s all memory it should</span>
<span class="cm">	 *             not really happen</span>
<span class="cm">	 * @throws ClassNotFoundException</span>
<span class="cm">	 *             When trying to unpack an object that&#39;s not defined in client</span>
<span class="cm">	 *             code</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">load</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">pickle</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">StreamCorruptedException</span><span class="o">,</span>
			<span class="n">IOException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
		<span class="n">ByteArrayInputStream</span> <span class="n">instream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayInputStream</span><span class="o">(</span><span class="n">pickle</span><span class="o">);</span>
		<span class="n">ObjectInput</span> <span class="n">oin</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="n">instream</span><span class="o">);</span>
		<span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">oin</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
		<span class="n">oin</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		<span class="n">instream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		<span class="k">return</span> <span class="n">o</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Packs the object &lt;i&gt;s&lt;/i&gt; into a byte array.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param s</span>
<span class="cm">	 *            The object to pack</span>
<span class="cm">	 * @return A byte array ready to be, say, stored in a database as a blob</span>
<span class="cm">	 * @throws IOException</span>
<span class="cm">	 *             Streams throw it</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">dump</span><span class="o">(</span><span class="n">Serializable</span> <span class="n">s</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
		<span class="n">ByteArrayOutputStream</span> <span class="n">outstream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
		<span class="n">ObjectOutput</span> <span class="n">oout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">outstream</span><span class="o">);</span>
		<span class="n">oout</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
		<span class="kt">byte</span><span class="o">[]</span> <span class="n">pickle</span> <span class="o">=</span> <span class="n">outstream</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
		<span class="n">oout</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		<span class="n">outstream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		<span class="k">return</span> <span class="n">pickle</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">CommonDialogHandlers <small>lamparski.areabase.widgets</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">widgets</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.content.DialogInterface</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Contains very simple, common dialogue box handlers (such as hiding the dialogue).</span>
<span class="cm"> * @author Minkovsky</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CommonDialogHandlers</span> <span class="o">{</span>
	<span class="cm">/**</span>
<span class="cm">	 * A shortcut to the dialog.dismiss() callback.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">DialogInterface</span><span class="o">.</span><span class="na">OnClickListener</span> <span class="n">JUST_DISMISS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DialogInterface</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span>
		
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">DialogInterface</span> <span class="n">dialog</span><span class="o">,</span> <span class="kt">int</span> <span class="n">which</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">dialog</span><span class="o">.</span><span class="na">dismiss</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">};</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">CommonDialogs <small>lamparski.areabase.widgets</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">widgets</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.app.AlertDialog</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.ComponentName</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Context</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lamparski.areabase.R</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CommonDialogs</span> <span class="o">{</span>
	<span class="cm">/**</span>
<span class="cm">	 * Notifies the user about service disconnect errors.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param name</span>
<span class="cm">	 *            The name of the incompetent service.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">serviceDisconnectAlert</span><span class="o">(</span><span class="n">ComponentName</span> <span class="n">name</span><span class="o">,</span> <span class="n">Context</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">new</span> <span class="n">AlertDialog</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">ctx</span><span class="o">)</span>
				<span class="o">.</span><span class="na">setTitle</span><span class="o">(</span>
						<span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">summaryactivity_cardmaker_servicedisconnect_title</span><span class="o">)</span>
				<span class="o">.</span><span class="na">setMessage</span><span class="o">(</span>
						<span class="n">ctx</span><span class="o">.</span><span class="na">getResources</span><span class="o">()</span>
								<span class="o">.</span><span class="na">getString</span><span class="o">(</span>
										<span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">summaryactivity_cardmaker_servicedisconnect_message</span><span class="o">,</span>
										<span class="n">name</span><span class="o">))</span>
				<span class="o">.</span><span class="na">setNeutralButton</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">ok</span><span class="o">,</span>
						<span class="n">CommonDialogHandlers</span><span class="o">.</span><span class="na">JUST_DISMISS</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
	<span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">areaDataServiceError</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">err</span><span class="o">,</span> <span class="n">Context</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">new</span> <span class="n">AlertDialog</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">ctx</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setTitle</span><span class="o">(</span>
                        <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error_cannot_fetch_area_data</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setMessage</span><span class="o">(</span>
                        <span class="n">ctx</span><span class="o">.</span><span class="na">getResources</span><span class="o">()</span>
                                <span class="o">.</span><span class="na">getString</span><span class="o">(</span>
                                        <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error_cannot_fetch_area_data_body</span><span class="o">,</span> <span class="n">err</span><span class="o">.</span><span class="na">toString</span><span class="o">()))</span>
                <span class="o">.</span><span class="na">setNeutralButton</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">ok</span><span class="o">,</span>
                        <span class="n">CommonDialogHandlers</span><span class="o">.</span><span class="na">JUST_DISMISS</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">RobotoLightTextView <small>lamparski.areabase.widgets</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">widgets</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.content.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.graphics.Typeface</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Build</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.AttributeSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * A special flavour of TextView which can load up a custom typeface.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RobotoLightTextView</span> <span class="kd">extends</span> <span class="n">TextView</span> <span class="o">{</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unused&quot;</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nf">RobotoLightTextView</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">AttributeSet</span> <span class="n">attrs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">defStyle</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">attrs</span><span class="o">,</span> <span class="n">defStyle</span><span class="o">);</span>
		<span class="n">setupFont</span><span class="o">();</span>
	<span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unused&quot;</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nf">RobotoLightTextView</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">AttributeSet</span> <span class="n">attrs</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">attrs</span><span class="o">);</span>
		<span class="n">setupFont</span><span class="o">();</span>
	<span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unused&quot;</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nf">RobotoLightTextView</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
		<span class="n">setupFont</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">setupFont</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(!</span><span class="n">isInEditMode</span><span class="o">())</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&gt;=</span> <span class="n">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">JELLY_BEAN</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">setTypeface</span><span class="o">(</span><span class="n">Typeface</span>
						<span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">&quot;sans-serif-light&quot;</span><span class="o">,</span> <span class="n">Typeface</span><span class="o">.</span><span class="na">NORMAL</span><span class="o">));</span>
			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
				<span class="k">this</span><span class="o">.</span><span class="na">setTypeface</span><span class="o">(</span><span class="n">Typeface</span><span class="o">.</span><span class="na">createFromAsset</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getContext</span><span class="o">()</span>
						<span class="o">.</span><span class="na">getAssets</span><span class="o">(),</span> <span class="s">&quot;fonts/Roboto-Thin.ttf&quot;</span><span class="o">));</span>
			<span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="n">setTypeface</span><span class="o">(</span><span class="n">Typeface</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">&quot;sans-serif-light&quot;</span><span class="o">,</span> <span class="n">Typeface</span><span class="o">.</span><span class="na">NORMAL</span><span class="o">));</span>
		<span class="o">}</span>
		<span class="n">setTypeface</span><span class="o">(</span><span class="n">getTypeface</span><span class="o">(),</span> <span class="n">Typeface</span><span class="o">.</span><span class="na">NORMAL</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">SubjectExpandableListAdapter <small>lamparski.areabase.widgets</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">lamparski</span><span class="o">.</span><span class="na">areabase</span><span class="o">.</span><span class="na">widgets</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.content.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.LayoutInflater</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.ViewGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.BaseExpandableListAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.ImageView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Nonnull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.annotation.Nullable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lamparski.areabase.R</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.helpers.CensusHelpers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DataSetFamily</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DataSetItem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Dataset</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * A {@link android.widget.BaseExpandableListAdapter} implementation that deals with the census</span>
<span class="cm"> * data -- it&#39;s the Controller bit of {@link lamparski.areabase.fragments.SubjectViewFragment}&#39;s</span>
<span class="cm"> * MVC flow.</span>
<span class="cm"> *</span>
<span class="cm"> * @author filip</span>
<span class="cm"> * @see android.widget.BaseExpandableListAdapter</span>
<span class="cm"> * @see lamparski.areabase.fragments.SubjectViewFragment</span>
<span class="cm"> * @see nde2.pull.types.Dataset</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SubjectExpandableListAdapter</span> <span class="kd">extends</span> <span class="n">BaseExpandableListAdapter</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Context</span> <span class="n">mContext</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">&gt;</span> <span class="n">toplevelItems</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;&gt;</span> <span class="n">childItems</span><span class="o">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Create a new Adapter for the context given.</span>
<span class="cm">     * @param context the Context to use with this Adapter</span>
<span class="cm">     * @param items Optionally pre-set the items</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="nf">SubjectExpandableListAdapter</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">items</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">items</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">setItems</span><span class="o">(</span><span class="n">items</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">mContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Sets the new dataset. Please then call {@link #notifyDataSetChanged()}.</span>
<span class="cm">     * @param items the new dataset.</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setItems</span><span class="o">(</span><span class="nd">@Nonnull</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">,</span> <span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">items</span><span class="o">){</span>
        <span class="n">toplevelItems</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">&gt;(</span><span class="n">items</span><span class="o">.</span><span class="na">keySet</span><span class="o">());</span>
        <span class="n">childItems</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">DataSetFamily</span> <span class="n">k</span> <span class="o">:</span> <span class="n">toplevelItems</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Collection</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;</span> <span class="n">dsitems</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">k</span><span class="o">).</span><span class="na">getItems</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">dsitems</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">childItems</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;(</span><span class="n">dsitems</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * @return the currently loaded dataset</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;&gt;</span> <span class="n">getChildItems</span> <span class="o">(){</span>
        <span class="k">return</span> <span class="n">childItems</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getGroupCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">toplevelItems</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getChildrenCount</span><span class="o">(</span><span class="kt">int</span> <span class="n">groupPosition</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">realSize</span> <span class="o">=</span> <span class="n">childItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">toplevelItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">groupPosition</span><span class="o">)).</span><span class="na">size</span><span class="o">();</span>
        <span class="c1">// We need to accommodate for the chartlink for those datasets that can be graphed.</span>
        <span class="k">return</span> <span class="nf">isGraphable</span><span class="o">(</span><span class="n">groupPosition</span><span class="o">)</span> <span class="o">?</span> <span class="n">realSize</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">realSize</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getGroup</span><span class="o">(</span><span class="kt">int</span> <span class="n">groupPosition</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">toplevelItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">groupPosition</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getChild</span><span class="o">(</span><span class="kt">int</span> <span class="n">groupPosition</span><span class="o">,</span> <span class="kt">int</span> <span class="n">childPosition</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">childItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">toplevelItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">groupPosition</span><span class="o">)).</span><span class="na">get</span><span class="o">(</span><span class="n">childPosition</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getGroupId</span><span class="o">(</span><span class="kt">int</span> <span class="n">groupPosition</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">groupPosition</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getChildId</span><span class="o">(</span><span class="kt">int</span> <span class="n">groupPosition</span><span class="o">,</span> <span class="kt">int</span> <span class="n">childPosition</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">childPosition</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasStableIds</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Generates a top-level view of the list -- a dataset title bar.</span>
<span class="cm">     * @param groupPosition The index of the dataset in the array</span>
<span class="cm">     * @param isExpanded Whether the sub-list (ie the dataset) has been expanded</span>
<span class="cm">     * @param convertView Optionally a recyclable view, however it may not be the one we want</span>
<span class="cm">     * @param parent The list view</span>
<span class="cm">     * @return A complete view</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">View</span> <span class="nf">getGroupView</span><span class="o">(</span><span class="kt">int</span> <span class="n">groupPosition</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isExpanded</span><span class="o">,</span> <span class="n">View</span> <span class="n">convertView</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">convertView</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_groupitem_title</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">LayoutInflater</span> <span class="n">inflater</span> <span class="o">=</span> <span class="n">LayoutInflater</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">mContext</span><span class="o">);</span>
            <span class="n">convertView</span> <span class="o">=</span> <span class="n">inflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">subject_view_groupitem</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">DataSetFamily</span> <span class="n">fam</span> <span class="o">=</span> <span class="n">toplevelItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">groupPosition</span><span class="o">);</span>
        <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_groupitem_title</span><span class="o">)).</span><span class="na">setText</span><span class="o">(</span><span class="n">fam</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_groupitem_count</span><span class="o">)).</span><span class="na">setText</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">childItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">fam</span><span class="o">).</span><span class="na">size</span><span class="o">()));</span>
        <span class="n">ImageView</span> <span class="n">indicator</span> <span class="o">=</span> <span class="o">(</span><span class="n">ImageView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_groupitem_graphability_indicator</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">isGraphable</span><span class="o">(</span><span class="n">groupPosition</span><span class="o">)){</span>
            <span class="n">indicator</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">VISIBLE</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">indicator</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">INVISIBLE</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">convertView</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Generates a view for a dataset item</span>
<span class="cm">     * @param groupPosition the ID of the dataset</span>
<span class="cm">     * @param childPosition the ID of the item</span>
<span class="cm">     * @param isLastChild (framework) is it the last child in the list</span>
<span class="cm">     * @param convertView a view that can be recycled (however sometimes this might not be possible)</span>
<span class="cm">     * @param parent (framework) parent viewgroup</span>
<span class="cm">     * @return the item view</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">View</span> <span class="nf">getRegularChildView</span><span class="o">(</span><span class="kt">int</span> <span class="n">groupPosition</span><span class="o">,</span> <span class="kt">int</span> <span class="n">childPosition</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isLastChild</span><span class="o">,</span> <span class="n">View</span> <span class="n">convertView</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">parent</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">convertView</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_listitem_title</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">LayoutInflater</span> <span class="n">inflater</span> <span class="o">=</span> <span class="n">LayoutInflater</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">mContext</span><span class="o">);</span>
            <span class="n">convertView</span> <span class="o">=</span> <span class="n">inflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">subject_view_listitem</span><span class="o">,</span> <span class="n">parent</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">DataSetItem</span> <span class="n">item</span> <span class="o">=</span> <span class="o">(</span><span class="n">DataSetItem</span><span class="o">)</span> <span class="n">getChild</span><span class="o">(</span><span class="n">groupPosition</span><span class="o">,</span> <span class="n">childPosition</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">item</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">&quot;getRegularChildView&quot;</span><span class="o">,</span>
                    <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;item #%d for group #%d (%s) not found&quot;</span><span class="o">,</span>
                            <span class="n">childPosition</span><span class="o">,</span>
                            <span class="n">groupPosition</span><span class="o">,</span>
                            <span class="n">toplevelItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">groupPosition</span><span class="o">).</span><span class="na">getName</span><span class="o">()));</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_listitem_title</span><span class="o">)).</span><span class="na">setText</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getTopic</span><span class="o">().</span><span class="na">getTitle</span><span class="o">());</span>
        <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_listitem_subtitle</span><span class="o">)).</span><span class="na">setText</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getTopic</span><span class="o">().</span><span class="na">getDescription</span><span class="o">());</span>
        <span class="n">String</span> <span class="n">valueString</span> <span class="o">=</span> <span class="n">CensusHelpers</span><span class="o">.</span><span class="na">getValueString</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getValue</span><span class="o">(),</span> <span class="n">item</span><span class="o">.</span><span class="na">getTopic</span><span class="o">().</span><span class="na">getCoinageUnit</span><span class="o">());</span>
        <span class="o">((</span><span class="n">TextView</span><span class="o">)</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_listitem_count</span><span class="o">)).</span><span class="na">setText</span><span class="o">(</span><span class="n">valueString</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">convertView</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     *</span>
<span class="cm">     * @param groupPosition Which dataset</span>
<span class="cm">     * @param convertView Optionally a recyclable view, however it may not be the one we want</span>
<span class="cm">     * @param parent The list view</span>
<span class="cm">     * @return A list item that will launch a {@link lamparski.areabase.GraphActivity} for the</span>
<span class="cm">     * current dataset when clicked.</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">View</span> <span class="nf">getChartLinkChildView</span><span class="o">(</span><span class="kt">int</span> <span class="n">groupPosition</span><span class="o">,</span> <span class="n">View</span> <span class="n">convertView</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">parent</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">convertView</span> <span class="o">==</span> <span class="kc">null</span>
                <span class="o">||</span> <span class="n">convertView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">subject_view_listitem_chartlink_icon</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">LayoutInflater</span> <span class="n">inflater</span> <span class="o">=</span> <span class="n">LayoutInflater</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">mContext</span><span class="o">);</span>
            <span class="n">convertView</span> <span class="o">=</span> <span class="n">inflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">subject_view_listitem_chartlink</span><span class="o">,</span> <span class="n">parent</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">convertView</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Examines the current dataset and decides which type of list item to display</span>
<span class="cm">     * @param groupPosition The index of the dataset in the array</span>
<span class="cm">     * @param childPosition The index of the data item in the dataset</span>
<span class="cm">     * @param isLastChild Whether the current item is the last child (not really useful here)</span>
<span class="cm">     * @param convertView Optionally a recyclable view, however it may not be the one we want;</span>
<span class="cm">     *                    it just gets passed down to the functions that actually generate views</span>
<span class="cm">     * @param parent The list view</span>
<span class="cm">     * @return Depending on whether the dataset is graphable and the child position, either a</span>
<span class="cm">     * dataset item or a chartlink.</span>
<span class="cm">     *</span>
<span class="cm">     * @see lamparski.areabase.widgets.SubjectExpandableListAdapter#getRegularChildView(int, int, boolean, android.view.View, android.view.ViewGroup)</span>
<span class="cm">     * @see SubjectExpandableListAdapter#getChartLinkChildView(int, android.view.View, android.view.ViewGroup)</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">View</span> <span class="nf">getChildView</span><span class="o">(</span><span class="kt">int</span> <span class="n">groupPosition</span><span class="o">,</span> <span class="kt">int</span> <span class="n">childPosition</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isLastChild</span><span class="o">,</span> <span class="n">View</span> <span class="n">convertView</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">isGraphable</span><span class="o">(</span><span class="n">groupPosition</span><span class="o">)){</span>
            <span class="k">if</span><span class="o">(</span><span class="n">childPosition</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
                <span class="k">return</span> <span class="nf">getChartLinkChildView</span><span class="o">(</span><span class="n">groupPosition</span><span class="o">,</span> <span class="n">convertView</span><span class="o">,</span> <span class="n">parent</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">return</span> <span class="nf">getRegularChildView</span><span class="o">(</span><span class="n">groupPosition</span><span class="o">,</span> <span class="n">childPosition</span> <span class="o">-</span> <span class="mi">1</span><span class="o">,</span> <span class="n">isLastChild</span><span class="o">,</span> <span class="n">convertView</span><span class="o">,</span> <span class="n">parent</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">getRegularChildView</span><span class="o">(</span><span class="n">groupPosition</span><span class="o">,</span> <span class="n">childPosition</span><span class="o">,</span> <span class="n">isLastChild</span><span class="o">,</span> <span class="n">convertView</span><span class="o">,</span> <span class="n">parent</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isChildSelectable</span><span class="o">(</span><span class="kt">int</span> <span class="n">groupPosition</span><span class="o">,</span> <span class="kt">int</span> <span class="n">childPosition</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">isGraphable</span><span class="o">(</span><span class="n">groupPosition</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">childPosition</span> <span class="o">==</span> <span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Determines if the dataset is possible to represent as a graph. Currently, it just looks at</span>
<span class="cm">     * whether it has more than 1 item, however it can later use an exclusion list or other rules</span>
<span class="cm">     * to determine graphability</span>
<span class="cm">     * @param groupPosition The index of the dataset in the array</span>
<span class="cm">     * @return &lt;code&gt;true&lt;/code&gt; if the dataset can be represented on a graph</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isGraphable</span><span class="o">(</span><span class="kt">int</span> <span class="n">groupPosition</span><span class="o">){</span>
        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">childItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">toplevelItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">groupPosition</span><span class="o">)).</span><span class="na">size</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">InvalidParameterException <small>nde2.errors</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">errors</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">InvalidParameterException</span> <span class="kd">extends</span> <span class="n">RuntimeException</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

	<span class="kd">private</span> <span class="n">String</span> <span class="n">parameterName</span><span class="o">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">InvalidParameterException</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">();</span>
		<span class="n">parameterName</span> <span class="o">=</span> <span class="s">&quot;(unspecified)&quot;</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param message explanation for the exception</span>
<span class="cm">	 * @param cause another throwable that caused this exception</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">InvalidParameterException</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
		<span class="n">parameterName</span> <span class="o">=</span> <span class="s">&quot;(unspecified)&quot;</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param message explanation for the exception</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">InvalidParameterException</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
		<span class="n">parameterName</span> <span class="o">=</span> <span class="s">&quot;(unspecified)&quot;</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param cause another throwable that caused this exception</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">InvalidParameterException</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
		<span class="n">parameterName</span> <span class="o">=</span> <span class="s">&quot;(unspecified)&quot;</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     *</span>
<span class="cm">     * @param parameterName the parameter that was set to something invalid</span>
<span class="cm">     * @param message explanation for the exception</span>
<span class="cm">     */</span>
	<span class="kd">public</span> <span class="nf">InvalidParameterException</span><span class="o">(</span><span class="n">String</span> <span class="n">parameterName</span><span class="o">,</span> <span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">parameterName</span> <span class="o">=</span> <span class="n">parameterName</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     *</span>
<span class="cm">     * @param parameterName the parameter that was set to something invalid</span>
<span class="cm">     * @param message explanation for the exception</span>
<span class="cm">     * @param cause another throwable that caused this exception</span>
<span class="cm">     */</span>
	<span class="kd">public</span> <span class="nf">InvalidParameterException</span><span class="o">(</span><span class="n">String</span> <span class="n">parameterName</span><span class="o">,</span> <span class="n">String</span> <span class="n">message</span><span class="o">,</span>
			<span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">parameterName</span> <span class="o">=</span> <span class="n">parameterName</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the invalid parameter&#39;s name</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getParameterName</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">parameterName</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">NDE2Exception <small>nde2.errors</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">errors</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="cm">/**</span>
<span class="cm"> * A subtype of Exception that is used by the NDE2 API. It is thrown when</span>
<span class="cm"> * internal errors happen, or when the server itself returns a problem. If it is</span>
<span class="cm"> * a server error, use the ness* properties to determine what it is.</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NDE2Exception</span> <span class="kd">extends</span> <span class="n">Exception</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2521548020242335676L</span><span class="o">;</span>

	<span class="kd">private</span> <span class="n">String</span> <span class="n">nessMessage</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">nessDetail</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">nessCode</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">NDE2Exception</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">NDE2Exception</span><span class="o">(</span><span class="n">String</span> <span class="n">detailMessage</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">detailMessage</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">NDE2Exception</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">throwable</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">NDE2Exception</span><span class="o">(</span><span class="n">String</span> <span class="n">detailMessage</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">detailMessage</span><span class="o">,</span> <span class="n">throwable</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">NDE2Exception</span><span class="o">(</span><span class="n">String</span> <span class="n">nessMessage</span><span class="o">,</span> <span class="n">String</span> <span class="n">nessDetail</span><span class="o">,</span> <span class="kt">int</span> <span class="n">nessCode</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">nessMessage</span> <span class="o">=</span> <span class="n">nessMessage</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">nessDetail</span> <span class="o">=</span> <span class="n">nessDetail</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">nessCode</span> <span class="o">=</span> <span class="n">nessCode</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">NDE2Exception</span><span class="o">(</span><span class="n">String</span> <span class="n">nessMessage</span><span class="o">,</span> <span class="n">String</span> <span class="n">nessDetail</span><span class="o">,</span> <span class="kt">int</span> <span class="n">nessCode</span><span class="o">,</span>
			<span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">nessMessage</span> <span class="o">=</span> <span class="n">nessMessage</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">nessDetail</span> <span class="o">=</span> <span class="n">nessDetail</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">nessCode</span> <span class="o">=</span> <span class="n">nessCode</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">NDE2Exception</span><span class="o">(</span><span class="n">String</span> <span class="n">nessMessage</span><span class="o">,</span> <span class="n">String</span> <span class="n">nessDetail</span><span class="o">,</span> <span class="kt">int</span> <span class="n">nessCode</span><span class="o">,</span>
			<span class="n">String</span> <span class="n">detailMessage</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">detailMessage</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">nessMessage</span> <span class="o">=</span> <span class="n">nessMessage</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">nessDetail</span> <span class="o">=</span> <span class="n">nessDetail</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">nessCode</span> <span class="o">=</span> <span class="n">nessCode</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getNessMessage</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">nessMessage</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getNessDetail</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">nessDetail</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">getNessCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">nessCode</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param nessMessage</span>
<span class="cm">	 *            the nessMessage to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setNessMessage</span><span class="o">(</span><span class="n">String</span> <span class="n">nessMessage</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">nessMessage</span> <span class="o">=</span> <span class="n">nessMessage</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param nessDetail</span>
<span class="cm">	 *            the nessDetail to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setNessDetail</span><span class="o">(</span><span class="n">String</span> <span class="n">nessDetail</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">nessDetail</span> <span class="o">=</span> <span class="n">nessDetail</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param nessCode</span>
<span class="cm">	 *            the nessCode to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setNessCode</span><span class="o">(</span><span class="kt">int</span> <span class="n">nessCode</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">nessCode</span> <span class="o">=</span> <span class="n">nessCode</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">ValueNotAvailable <small>nde2.errors</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">errors</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DataSetItem</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * This is not an exception. ValueNotAvailable is thrown whenever a value is</span>
<span class="cm"> * literally not available, as it was not returned by the server. In reality, it</span>
<span class="cm"> * is thrown when a {@link DataSetItem#getValue()} value is equal to</span>
<span class="cm"> * {@link Integer#MIN_VALUE}, which seems like a sensible choice for 32-bit or</span>
<span class="cm"> * higher systems.</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * &lt;b&gt;Handling:&lt;/b&gt; Display a &quot;N/A&quot; inside the offending value&#39;s cell, or skip</span>
<span class="cm"> * this value when comparing things.</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ValueNotAvailable</span> <span class="kd">extends</span> <span class="n">RuntimeException</span> <span class="o">{</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">57513490567813L</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">ValueNotAvailable</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">ValueNotAvailable</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
		<span class="c1">// TODO Auto-generated constructor stub</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">ValueNotAvailable</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
		<span class="c1">// TODO Auto-generated constructor stub</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">ValueNotAvailable</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
		<span class="c1">// TODO Auto-generated constructor stub</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">ArrayHelpers <small>nde2.helpers</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">helpers</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.google.common.collect.BiMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.common.collect.HashBiMap</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map.Entry</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">nde2.pull.types.DateRange</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * A collection of functions that have to do with arrays and collections.</span>
<span class="cm"> *</span>
<span class="cm"> * @author filip</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ArrayHelpers</span> <span class="o">{</span>

	<span class="cm">/**</span>
<span class="cm">	 * Reduces the size of an array of 2-arrays of doubles so that only every</span>
<span class="cm">	 * nth pair remains. In practice, this can be used to remove vertices of a</span>
<span class="cm">	 * geo-coded polygon to reduce GET request string length (used with the</span>
<span class="cm">	 * Police Data API).</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param original</span>
<span class="cm">	 *            The array to be simplified</span>
<span class="cm">	 * @param n</span>
<span class="cm">	 *            number of elements to skip (hence &quot;every nth pair&quot;)</span>
<span class="cm">	 * @return A simplified array of 2-arrays of doubles.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">double</span><span class="o">[][]</span> <span class="nf">every_nth_pair</span><span class="o">(</span><span class="kt">double</span><span class="o">[][]</span> <span class="n">original</span><span class="o">,</span> <span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
		<span class="kt">double</span><span class="o">[][]</span> <span class="n">destination</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">double</span><span class="o">[</span><span class="n">original</span><span class="o">.</span><span class="na">length</span> <span class="o">/</span> <span class="n">n</span><span class="o">][</span><span class="mi">2</span><span class="o">];</span>

		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">original</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="n">destination</span><span class="o">[</span><span class="n">i</span> <span class="o">/</span> <span class="n">n</span><span class="o">]</span> <span class="o">=</span> <span class="n">original</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ArrayIndexOutOfBoundsException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">continue</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="n">destination</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Get the most common element in the given list</span>
<span class="cm">     * @param list The list to search</span>
<span class="cm">     * @param &lt;T&gt; Type of elements in the list</span>
<span class="cm">     * @return The most common element in the list</span>
<span class="cm">     */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="n">mostCommon</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">){</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;();</span>
		
		<span class="k">for</span><span class="o">(</span><span class="n">T</span> <span class="n">e</span> <span class="o">:</span> <span class="n">list</span><span class="o">){</span>
			<span class="n">Integer</span> <span class="n">c</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
			<span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">c</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
		<span class="o">}</span>
		
		<span class="n">Entry</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">max</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		
		<span class="k">for</span><span class="o">(</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">:</span> <span class="n">map</span><span class="o">.</span><span class="na">entrySet</span><span class="o">()){</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">&quot;mostCommon&quot;</span><span class="o">,</span> <span class="s">&quot;Entry [&quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">().</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; =&gt; &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">max</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">max</span><span class="o">.</span><span class="na">getValue</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">&quot;mostCommon&quot;</span><span class="o">,</span> <span class="s">&quot;...is the new most common&quot;</span><span class="o">);</span>
                <span class="n">max</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span>
		
		<span class="k">return</span> <span class="n">max</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Needed for GraphActivity -- unpacks the dateRanges array and maps the date ranges</span>
<span class="cm">     * to their textual representation.</span>
<span class="cm">     * @param dateRanges the date ranges to unpack</span>
<span class="cm">     * @return date ranges mapped to their text representations</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">BiMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">DateRange</span><span class="o">&gt;</span> <span class="n">remapDateRanges</span><span class="o">(</span><span class="n">DateRange</span><span class="o">...</span> <span class="n">dateRanges</span><span class="o">){</span>
        <span class="n">BiMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">DateRange</span><span class="o">&gt;</span> <span class="n">newMap</span> <span class="o">=</span> <span class="n">HashBiMap</span><span class="o">.</span><span class="na">create</span><span class="o">();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">DateRange</span> <span class="n">dr</span> <span class="o">:</span> <span class="n">dateRanges</span><span class="o">){</span>
            <span class="n">String</span> <span class="n">s</span><span class="o">;</span>
            <span class="k">if</span><span class="o">(</span><span class="n">dr</span><span class="o">.</span><span class="na">getStartDate</span><span class="o">().</span><span class="na">compareTo</span><span class="o">(</span><span class="n">dr</span><span class="o">.</span><span class="na">getEndDate</span><span class="o">())</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%TF&quot;</span><span class="o">,</span> <span class="n">dr</span><span class="o">.</span><span class="na">getEndDate</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%TF - %TF&quot;</span><span class="o">,</span> <span class="n">dr</span><span class="o">.</span><span class="na">getStartDate</span><span class="o">(),</span> <span class="n">dr</span><span class="o">.</span><span class="na">getEndDate</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="n">newMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">dr</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">newMap</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">CensusHelpers <small>nde2.helpers</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">helpers</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParserException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">nde2.errors.NDE2Exception</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.methodcalls.discovery.GetDatasetFamilies</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DataSetFamily</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Subject</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CensusHelpers</span> <span class="o">{</span>

	<span class="cm">/**</span>
<span class="cm">	 * Finds {@link DataSetFamily DataSetFamilies} for an {@link Area} that</span>
<span class="cm">	 * contain any of the keywords.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param area</span>
<span class="cm">	 *            Area to find datasets for</span>
<span class="cm">	 * @param subject</span>
<span class="cm">	 *            The subject to find these datasets in</span>
<span class="cm">	 * @param keywords</span>
<span class="cm">	 *            Strings that the required datasets should start with</span>
<span class="cm">	 * @return A List of {@link DataSetFamily} objects representing the</span>
<span class="cm">	 *         requested datasets.</span>
<span class="cm">	 * @throws XmlPullParserException</span>
<span class="cm">	 * @throws IOException</span>
<span class="cm">	 * @throws NDE2Exception</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">&gt;</span> <span class="nf">findRequiredFamilies</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">,</span>
			<span class="n">Subject</span> <span class="n">subject</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">keywords</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span>
			<span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">NDE2Exception</span> <span class="o">{</span>
		<span class="n">List</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">&gt;</span> <span class="n">censusDatasetFamilies</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GetDatasetFamilies</span><span class="o">(</span>
				<span class="n">subject</span><span class="o">).</span><span class="na">forArea</span><span class="o">(</span><span class="n">area</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>

		<span class="n">List</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">&gt;</span> <span class="n">requiredFamilies</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">&gt;();</span>

		<span class="k">for</span> <span class="o">(</span><span class="n">DataSetFamily</span> <span class="n">family</span> <span class="o">:</span> <span class="n">censusDatasetFamilies</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">kw</span> <span class="o">:</span> <span class="n">keywords</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">family</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="n">kw</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">requiredFamilies</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">family</span><span class="o">);</span>
                <span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="n">requiredFamilies</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Finds a {@link Subject} for an {@link Area} by its name</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param area</span>
<span class="cm">	 *            Area to query</span>
<span class="cm">	 * @param subjectName</span>
<span class="cm">	 *            subject name to find</span>
<span class="cm">	 * @return A {@link Subject}</span>
<span class="cm">	 * @throws NDE2Exception</span>
<span class="cm">	 * @throws XmlPullParserException</span>
<span class="cm">	 * @throws IOException</span>
<span class="cm">	 * </span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="n">Subject</span> <span class="nf">findSubject</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">,</span> <span class="n">String</span> <span class="n">subjectName</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">NDE2Exception</span> <span class="o">{</span>
		<span class="n">Subject</span> <span class="n">subject</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">Subject</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">areaSubjects</span> <span class="o">=</span> <span class="n">area</span><span class="o">.</span><span class="na">getCompatibleSubjects</span><span class="o">();</span>
		<span class="cm">/*</span>
<span class="cm">		 * Loop exit condition: valid subject id is found; or there are no more</span>
<span class="cm">		 * subjects left.</span>
<span class="cm">		 */</span>
		<span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Subject</span><span class="o">&gt;</span> <span class="n">subjectIter</span> <span class="o">=</span> <span class="n">areaSubjects</span><span class="o">.</span><span class="na">keySet</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
		<span class="k">while</span> <span class="o">(</span><span class="n">subjectIter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">subject</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">Subject</span> <span class="n">s</span> <span class="o">=</span> <span class="n">subjectIter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">subjectName</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">subject</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="n">subject</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Generates a value string from a value and its unit</span>
<span class="cm">     * @param value the value</span>
<span class="cm">     * @param coinageUnit the unit to use</span>
<span class="cm">     * @return a string that best fits the coinage unit and represents the value well</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getValueString</span><span class="o">(</span><span class="kt">float</span> <span class="n">value</span><span class="o">,</span> <span class="n">String</span> <span class="n">coinageUnit</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">valueString</span><span class="o">;</span>
        <span class="k">if</span><span class="o">(</span><span class="n">coinageUnit</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Count&quot;</span><span class="o">))</span> <span class="o">{</span>
            <span class="cm">/* This clause will display all sorts of counts or integer measures */</span>
            <span class="n">valueString</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%.0f&quot;</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">coinageUnit</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Percentage&quot;</span><span class="o">))</span> <span class="o">{</span>
            <span class="cm">/* This clause will display percentages */</span>
            <span class="n">valueString</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%.1f%%&quot;</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">coinageUnit</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Square metres (m2)(thousands)&quot;</span><span class="o">))</span> <span class="o">{</span>
            <span class="cm">/* Special case for area measurement */</span>
            <span class="n">value</span> <span class="o">*=</span> <span class="mi">1000</span><span class="o">;</span>
            <span class="n">valueString</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%.2f m²&quot;</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">coinageUnit</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Pounds Sterling (thousands)&quot;</span><span class="o">))</span> <span class="o">{</span>
            <span class="cm">/* A measure for GBP000s values */</span>
            <span class="n">valueString</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;£%.3fk&quot;</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">coinageUnit</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Pounds Sterling&quot;</span><span class="o">))</span> <span class="o">{</span>
            <span class="cm">/* A measure for plain GBP values */</span>
            <span class="n">valueString</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;£%.2f&quot;</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">coinageUnit</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Score&quot;</span><span class="o">)</span>
                    <span class="o">||</span> <span class="n">coinageUnit</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Rate&quot;</span><span class="o">))</span> <span class="o">{</span>
            <span class="cm">/* Scores */</span>
            <span class="n">valueString</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%.1f&quot;</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="cm">/* Any other value: just print it and then its coinage unit */</span>
            <span class="n">valueString</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%.1f %s&quot;</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="n">coinageUnit</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">valueString</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">DateFormat <small>nde2.helpers</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">helpers</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">java.util.Calendar</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.GregorianCalendar</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.TimeZone</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DateFormat</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Calendar</span> <span class="n">CACHED_CALENDAR</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GregorianCalendar</span><span class="o">();</span>

	<span class="kd">static</span> <span class="o">{</span>
		<span class="n">CACHED_CALENDAR</span><span class="o">.</span><span class="na">setTimeZone</span><span class="o">(</span><span class="n">TimeZone</span><span class="o">.</span><span class="na">getTimeZone</span><span class="o">(</span><span class="s">&quot;GMT&quot;</span><span class="o">));</span>
		<span class="n">CACHED_CALENDAR</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param dateString</span>
<span class="cm">	 *            Expected format: yyyy-MM-dd</span>
<span class="cm">	 * @return a date object from an NDE date string</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="n">Date</span> <span class="nf">fromNDEDateOnly</span><span class="o">(</span><span class="n">String</span> <span class="n">dateString</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">dateString</span> <span class="o">=</span> <span class="n">dateString</span><span class="o">.</span><span class="na">trim</span><span class="o">();</span> <span class="c1">// If anything gets messed up.</span>
		<span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">dateString</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">4</span><span class="o">));</span>
		<span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">dateString</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="mi">7</span><span class="o">));</span>
		<span class="o">--</span><span class="n">m</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">dateString</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">8</span><span class="o">,</span> <span class="mi">10</span><span class="o">));</span>

		<span class="n">CACHED_CALENDAR</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">y</span><span class="o">,</span> <span class="n">m</span><span class="o">,</span> <span class="n">d</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">CACHED_CALENDAR</span><span class="o">.</span><span class="na">getTime</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param datetimeString</span>
<span class="cm">	 *            Expected format: yyyy-MM-ddT~~~~~~</span>
<span class="cm">	 * @return a date object from an NDE date/time string</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="n">Date</span> <span class="nf">fromNDEDateTime</span><span class="o">(</span><span class="n">String</span> <span class="n">datetimeString</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">fromNDEDateOnly</span><span class="o">(</span><span class="n">datetimeString</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;T&quot;</span><span class="o">)[</span><span class="mi">0</span><span class="o">]);</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * A faster? variant of new SimpleDateFormat(&quot;yyyy-MM-dd&quot;).format(date).</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param date</span>
<span class="cm">	 *            The date to be formatted</span>
<span class="cm">	 * @return A string formatted using the year-month-day format.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">toNDEDate</span><span class="o">(</span><span class="n">Date</span> <span class="n">date</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">CACHED_CALENDAR</span><span class="o">.</span><span class="na">setTime</span><span class="o">(</span><span class="n">date</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%1$tF&quot;</span><span class="o">,</span> <span class="n">CACHED_CALENDAR</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param date the date to get the year out of</span>
<span class="cm">	 * @return The year of given date</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">getYear</span><span class="o">(</span><span class="n">Date</span> <span class="n">date</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">CACHED_CALENDAR</span><span class="o">.</span><span class="na">setTime</span><span class="o">(</span><span class="n">date</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">CACHED_CALENDAR</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">GregorianCalendar</span><span class="o">.</span><span class="na">YEAR</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">Statistics <small>nde2.helpers</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">helpers</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map.Entry</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * A collection of functions that perform statistical things with data</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Statistics</span> <span class="o">{</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return An average of the series</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">double</span> <span class="nf">average</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Number</span><span class="o">&gt;</span> <span class="n">series</span><span class="o">)</span> <span class="o">{</span>
		<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
		<span class="kt">double</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">Number</span> <span class="n">e</span> <span class="o">:</span> <span class="n">series</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">sum</span> <span class="o">+=</span> <span class="n">e</span><span class="o">.</span><span class="na">doubleValue</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">sum</span> <span class="o">/</span> <span class="n">n</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Calculates the linear regression gradient for the data given</span>
<span class="cm">	 * </span>
<span class="cm">	 * @return the ordinary least squares gradient</span>
<span class="cm">	 * @param data</span>
<span class="cm">	 *            the dataset to calculate the ols for</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">double</span> <span class="nf">linearRegressionGradient</span><span class="o">(</span>
			<span class="n">Map</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Number</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="n">Number</span><span class="o">&gt;</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * OLS linear regression: (y - ybar) = (Sxy / Sxx) * (x - xbar) we need</span>
<span class="cm">		 * to find Sxy / Sxx Sum(x*y) Sxy = ---------- - (xbar*ybar) n</span>
<span class="cm">		 * </span>
<span class="cm">		 * Sum(x^2) Sxx = ---------- - (xbar^2) n</span>
<span class="cm">		 * </span>
<span class="cm">		 * where x is the date Long (key) and y is the Integer value.</span>
<span class="cm">		 */</span>

		<span class="kt">double</span> <span class="n">Sxy</span> <span class="o">=</span> <span class="mi">0</span><span class="n">d</span><span class="o">;</span>
		<span class="kt">double</span> <span class="n">Sxx</span> <span class="o">=</span> <span class="mi">0</span><span class="n">d</span><span class="o">;</span>
		<span class="kt">double</span> <span class="n">sumXY</span> <span class="o">=</span> <span class="mi">0</span><span class="n">d</span><span class="o">;</span>
		<span class="kt">double</span> <span class="n">sumXX</span> <span class="o">=</span> <span class="mi">0</span><span class="n">d</span><span class="o">;</span>
		<span class="kt">double</span> <span class="n">sumX</span> <span class="o">=</span> <span class="mi">0</span><span class="n">d</span><span class="o">;</span>
		<span class="kt">double</span> <span class="n">sumY</span> <span class="o">=</span> <span class="mi">0</span><span class="n">d</span><span class="o">;</span>
		<span class="kt">double</span> <span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>

		<span class="k">for</span> <span class="o">(</span><span class="n">Entry</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Number</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="n">Number</span><span class="o">&gt;</span> <span class="n">point</span> <span class="o">:</span> <span class="n">data</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">x</span> <span class="o">=</span> <span class="o">(</span><span class="kt">double</span><span class="o">)</span> <span class="n">point</span><span class="o">.</span><span class="na">getKey</span><span class="o">().</span><span class="na">doubleValue</span><span class="o">();</span>
			<span class="n">y</span> <span class="o">=</span> <span class="o">(</span><span class="kt">double</span><span class="o">)</span> <span class="n">point</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">doubleValue</span><span class="o">();</span>
			<span class="n">sumX</span> <span class="o">+=</span> <span class="n">x</span><span class="o">;</span>
			<span class="n">sumY</span> <span class="o">+=</span> <span class="n">y</span><span class="o">;</span>
			<span class="n">sumXY</span> <span class="o">+=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="o">;</span>
			<span class="n">sumXX</span> <span class="o">+=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="kt">double</span> <span class="n">xbar</span> <span class="o">=</span> <span class="n">sumX</span> <span class="o">/</span> <span class="n">n</span><span class="o">;</span>
		<span class="kt">double</span> <span class="n">ybar</span> <span class="o">=</span> <span class="n">sumY</span> <span class="o">/</span> <span class="n">n</span><span class="o">;</span>

		<span class="n">Sxy</span> <span class="o">=</span> <span class="n">sumXY</span> <span class="o">/</span> <span class="n">n</span> <span class="o">-</span> <span class="n">xbar</span> <span class="o">*</span> <span class="n">ybar</span><span class="o">;</span>
		<span class="n">Sxx</span> <span class="o">=</span> <span class="n">sumXX</span> <span class="o">/</span> <span class="n">n</span> <span class="o">-</span> <span class="n">xbar</span> <span class="o">*</span> <span class="n">xbar</span><span class="o">;</span>

		<span class="k">return</span> <span class="n">Sxy</span> <span class="o">/</span> <span class="n">Sxx</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">minimum</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">),</span> <span class="n">c</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Calculates the &quot;distance&quot; (a measure of similarity) between two strings.</span>
<span class="cm">	 * </span>
<span class="cm">	 * Sourced from</span>
<span class="cm">	 * https://en.wikibooks.org/wiki/Algorithm_Implementation/Strings</span>
<span class="cm">	 * /Levenshtein_distance#Java</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param str1 one of the strings</span>
<span class="cm">	 * @param str2 other string</span>
<span class="cm">	 * @return The similarity score between two strings</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">computeLevenshteinDistance</span><span class="o">(</span><span class="n">String</span> <span class="n">str1</span><span class="o">,</span> <span class="n">String</span> <span class="n">str2</span><span class="o">)</span> <span class="o">{</span>
		<span class="kt">int</span><span class="o">[][]</span> <span class="n">distance</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">str1</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">][</span><span class="n">str2</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">];</span>

		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">str1</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">distance</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">str2</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">distance</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">j</span><span class="o">;</span>
        <span class="o">}</span>

		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">str1</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">str2</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">distance</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">minimum</span><span class="o">(</span>
                        <span class="n">distance</span><span class="o">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="o">][</span><span class="n">j</span><span class="o">]</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span>
                        <span class="n">distance</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span>
                        <span class="n">distance</span><span class="o">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="o">][</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span>
                                <span class="o">+</span> <span class="o">((</span><span class="n">str1</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">==</span> <span class="n">str2</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span> <span class="o">?</span> <span class="mi">0</span>
                                <span class="o">:</span> <span class="mi">1</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>

		<span class="k">return</span> <span class="n">distance</span><span class="o">[</span><span class="n">str1</span><span class="o">.</span><span class="na">length</span><span class="o">()][</span><span class="n">str2</span><span class="o">.</span><span class="na">length</span><span class="o">()];</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">BaseMethodCall <small>nde2.pull.methodcalls</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">methodcalls</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.content.ContentResolver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.ContentValues</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.database.Cursor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.commons.io.IOUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParserException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParserFactory</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.StringReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.HttpURLConnection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.URL</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map.Entry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lamparski.areabase.AreaActivity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.CacheContentProvider</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Contains the most basic methods to fetch XML response documents from ONS and wrap them inside</span>
<span class="cm"> * of a parser object. Also handles caching.</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> *     Note that I said XML. It is actually a SOAP response document, but the way I&#39;m using it</span>
<span class="cm"> *     later in the data flow, it may as well be regular XML. SOAP doesn&#39;t make much sense.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @author filip</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BaseMethodCall</span> <span class="o">{</span>
    <span class="cm">/**</span>
<span class="cm">     * URL-encodes the parameters</span>
<span class="cm">     * @param endpoint the endpoint to call</span>
<span class="cm">     * @param method the method to call</span>
<span class="cm">     * @param params a dictionary of parameter names and their values</span>
<span class="cm">     * @return an URL string to call the given method on the given endpoint with the given parameters.</span>
<span class="cm">     */</span>
	<span class="kd">protected</span> <span class="n">String</span> <span class="nf">buildURLString</span><span class="o">(</span><span class="n">String</span> <span class="n">endpoint</span><span class="o">,</span> <span class="n">String</span> <span class="n">method</span><span class="o">,</span>
			<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
		<span class="cm">/* Build a URL which for the method call */</span>
		<span class="n">StringBuilder</span> <span class="n">methodCallStrBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="n">endpoint</span><span class="o">);</span>
		<span class="n">methodCallStrBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">method</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;?&quot;</span><span class="o">);</span>
		<span class="n">Set</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">paramEntries</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="na">entrySet</span><span class="o">();</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">param</span> <span class="o">:</span> <span class="n">paramEntries</span><span class="o">)</span> <span class="o">{</span>

			<span class="n">methodCallStrBuilder</span>
                    <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">getKey</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;=&quot;</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">getValue</span><span class="o">())</span>
					<span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;&amp;&quot;</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Gets rid of the trailing &amp; from the URLs</span>
<span class="cm">		 */</span>
		<span class="n">String</span> <span class="n">callUrlStr</span> <span class="o">=</span> <span class="n">methodCallStrBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
		<span class="n">callUrlStr</span> <span class="o">=</span> <span class="n">callUrlStr</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">callUrlStr</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">callUrlStr</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Performs a GET request on the given url and downloads the response into a String.</span>
<span class="cm">     * @param callUrlStr the call url</span>
<span class="cm">     * @return a String containing the response document.</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     */</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="nf">sendRequest</span><span class="o">(</span><span class="n">String</span> <span class="n">callUrlStr</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
		<span class="n">URL</span> <span class="n">callUrl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="n">callUrlStr</span><span class="o">);</span>
		<span class="n">HttpURLConnection</span> <span class="n">callConnection</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpURLConnection</span><span class="o">)</span> <span class="n">callUrl</span>
				<span class="o">.</span><span class="na">openConnection</span><span class="o">();</span>
		<span class="c1">// The ten-second rule:</span>
		<span class="c1">// If there&#39;s no data in 10s, assume the worst.</span>
		<span class="n">callConnection</span><span class="o">.</span><span class="na">setReadTimeout</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
		<span class="n">InputStream</span> <span class="n">is</span> <span class="o">=</span> <span class="n">callConnection</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
		<span class="k">return</span> <span class="n">IOUtils</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">is</span><span class="o">);</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Creates an {@link org.xmlpull.v1.XmlPullParser} for the instr.</span>
<span class="cm">     * @param instr A String containing the XML document to parse.</span>
<span class="cm">     * @return A streaming parser that works with the XML document.</span>
<span class="cm">     * @throws XmlPullParserException</span>
<span class="cm">     */</span>
	<span class="kd">private</span> <span class="n">XmlPullParser</span> <span class="nf">makeParser</span><span class="o">(</span><span class="n">String</span> <span class="n">instr</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">XmlPullParserException</span> <span class="o">{</span>
		<span class="n">XmlPullParserFactory</span> <span class="n">xfac</span> <span class="o">=</span> <span class="n">XmlPullParserFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
		<span class="n">xfac</span><span class="o">.</span><span class="na">setNamespaceAware</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span> <span class="c1">// Because SOAP loves namespaces.</span>
		<span class="n">XmlPullParser</span> <span class="n">xpp</span> <span class="o">=</span> <span class="n">xfac</span><span class="o">.</span><span class="na">newPullParser</span><span class="o">();</span>
		<span class="n">xpp</span><span class="o">.</span><span class="na">setInput</span><span class="o">(</span><span class="k">new</span> <span class="n">StringReader</span><span class="o">(</span><span class="n">instr</span><span class="o">));</span>
		<span class="k">return</span> <span class="n">xpp</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * This method:</span>
<span class="cm">     *</span>
<span class="cm">     * &lt;p&gt;1. Takes the call url and sees if there is a cache entry for it&lt;/p&gt;</span>
<span class="cm">     *</span>
<span class="cm">     * &lt;p&gt;2.1. If there is, load it&lt;/p&gt;</span>
<span class="cm">     *</span>
<span class="cm">     * &lt;p&gt;2.2. If there isn&#39;t, fetch the data from ONS and save to cache&lt;/p&gt;</span>
<span class="cm">     *</span>
<span class="cm">     * &lt;p&gt;3. Creates an {@link org.xmlpull.v1.XmlPullParser} for the result&lt;/p&gt;</span>
<span class="cm">     *</span>
<span class="cm">     * @param callUrl the URL to get data from</span>
<span class="cm">     * @return an {@link org.xmlpull.v1.XmlPullParser} for the data</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     * @throws XmlPullParserException</span>
<span class="cm">     */</span>
	<span class="kd">private</span> <span class="n">XmlPullParser</span> <span class="nf">doCall</span><span class="o">(</span><span class="n">String</span> <span class="n">callUrl</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span>
			<span class="n">XmlPullParserException</span> <span class="o">{</span>
		<span class="c1">// HACK</span>
		<span class="n">ContentResolver</span> <span class="n">resolver</span> <span class="o">=</span> <span class="n">AreaActivity</span><span class="o">.</span><span class="na">getAreabaseApplicationContext</span><span class="o">()</span>
				<span class="o">.</span><span class="na">getContentResolver</span><span class="o">();</span>
		<span class="n">String</span><span class="o">[]</span> <span class="n">selectionArgs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span>
				<span class="n">callUrl</span><span class="o">,</span>
				<span class="n">Long</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>
						<span class="o">*</span> <span class="mi">1000</span><span class="n">l</span><span class="o">)</span> <span class="o">};</span>
		<span class="n">Cursor</span> <span class="n">c</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">CacheContentProvider</span><span class="o">.</span><span class="na">ONS_CACHE_URI</span><span class="o">,</span>
				<span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span> <span class="s">&quot;*&quot;</span> <span class="o">},</span> <span class="s">&quot;url = ? AND retrievedOn &gt; ?&quot;</span><span class="o">,</span>
				<span class="n">selectionArgs</span><span class="o">,</span> <span class="s">&quot;retrievedOn DESC&quot;</span><span class="o">);</span>
		<span class="cm">/*</span>
<span class="cm">		 Equivalent to the following SQL:</span>
<span class="cm">		 SELECT * FROM onsCache</span>
<span class="cm">		 WHERE url = @url AND retrievedOn &gt; @30_days_ago</span>
<span class="cm">		 ORDER BY retrievedOn DESC</span>
<span class="cm">		 */</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">wtf</span><span class="o">(</span><span class="s">&quot;BaseMethodCall&quot;</span><span class="o">,</span> <span class="s">&quot;Cannot get a database cursor!&quot;</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">moveToFirst</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;BaseMethodCall&quot;</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
                    <span class="s">&quot;A cached instance of %s is available, returning.\n&quot;</span><span class="o">,</span>
                    <span class="n">callUrl</span><span class="o">));</span>
			<span class="n">String</span> <span class="n">response</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">getColumnIndex</span><span class="o">(</span><span class="s">&quot;cachedObject&quot;</span><span class="o">));</span>
			<span class="n">c</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
			<span class="k">return</span> <span class="nf">makeParser</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;BaseMethodCall&quot;</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Calling: %s\n&quot;</span><span class="o">,</span> <span class="n">callUrl</span><span class="o">));</span>
			<span class="n">String</span> <span class="n">response</span> <span class="o">=</span> <span class="n">sendRequest</span><span class="o">(</span><span class="n">callUrl</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;&lt;Error&gt;&quot;</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">c</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
				<span class="k">return</span> <span class="nf">makeParser</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
				<span class="n">c</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
				<span class="n">updateCacheDb</span><span class="o">(</span><span class="n">resolver</span><span class="o">,</span> <span class="n">callUrl</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
				<span class="k">return</span> <span class="nf">makeParser</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Saves the data to the database</span>
<span class="cm">     * @param resolver the content resolver to use</span>
<span class="cm">     * @param url request url to save</span>
<span class="cm">     * @param response the response at the time</span>
<span class="cm">     */</span>
	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">updateCacheDb</span><span class="o">(</span><span class="n">ContentResolver</span> <span class="n">resolver</span><span class="o">,</span> <span class="n">String</span> <span class="n">url</span><span class="o">,</span>
			<span class="n">String</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">ContentValues</span> <span class="n">values</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContentValues</span><span class="o">();</span>
		<span class="n">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;retrievedOn&quot;</span><span class="o">,</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
		<span class="n">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;cachedObject&quot;</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Tries to update existing rows, and if none exist, create a new</span>
<span class="cm">		 * record. That way pruning old records may not even be required.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">resolver</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">CacheContentProvider</span><span class="o">.</span><span class="na">ONS_CACHE_URI</span><span class="o">,</span> <span class="n">values</span><span class="o">,</span> <span class="s">&quot;url = ?&quot;</span><span class="o">,</span>
				<span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span> <span class="n">url</span> <span class="o">})</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;url&quot;</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span>
			<span class="n">resolver</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">CacheContentProvider</span><span class="o">.</span><span class="na">ONS_CACHE_URI</span><span class="o">,</span> <span class="n">values</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">protected</span> <span class="n">XmlPullParser</span> <span class="nf">doCall</span><span class="o">(</span><span class="n">String</span> <span class="n">endpoint</span><span class="o">,</span> <span class="n">String</span> <span class="n">method</span><span class="o">,</span>
			<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span>
			<span class="n">XmlPullParserException</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">doCall</span><span class="o">(</span><span class="n">buildURLString</span><span class="o">(</span><span class="n">endpoint</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">params</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="kd">abstract</span> <span class="kd">protected</span> <span class="n">XmlPullParser</span> <span class="nf">doCall</span><span class="o">(</span><span class="n">String</span> <span class="n">method</span><span class="o">,</span>
			<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span>
			<span class="n">XmlPullParserException</span><span class="o">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * Defines the execution plan of a call. Usually, this means plugging in a</span>
<span class="cm">	 * remote method name and the params into the other doCall(), however it can</span>
<span class="cm">	 * be used for anything, such as checking some parameters and then deciding</span>
<span class="cm">	 * to use a different call altogether, because the other one is utterly</span>
<span class="cm">	 * broken for given inputs. (Looking at you, FindAreas)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param params a dictionary of parameter names and their values</span>
<span class="cm">	 * @return An {@link XmlPullParser} primed with the response document.</span>
<span class="cm">	 * @throws IOException</span>
<span class="cm">	 * @throws XmlPullParserException</span>
<span class="cm">	 */</span>
	<span class="kd">abstract</span> <span class="kd">protected</span> <span class="n">XmlPullParser</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span><span class="o">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Children objects will use this method to collect their parameters</span>
<span class="cm">     * for the call.</span>
<span class="cm">     * @return A map of the parameters.</span>
<span class="cm">     */</span>
	<span class="kd">abstract</span> <span class="kd">protected</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">collectParams</span><span class="o">();</span>

	<span class="kd">abstract</span> <span class="kd">public</span> <span class="n">String</span> <span class="nf">toURLString</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">DeliveryMethodCall <small>nde2.pull.methodcalls.delivery</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">methodcalls</span><span class="o">.</span><span class="na">delivery</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParserException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">nde2.pull.methodcalls.BaseMethodCall</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * A base class from which all Delivery method calls inherit.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">DeliveryMethodCall</span> <span class="kd">extends</span> <span class="n">BaseMethodCall</span> <span class="o">{</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">DELIVERY_ENDPOINT</span> <span class="o">=</span> <span class="s">&quot;http://neighbourhood.statistics.gov.uk/NDE2/Deli/&quot;</span><span class="o">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Fills in the Endpoint of {@link nde2.pull.methodcalls.BaseMethodCall#doCall(String, String, java.util.Map)}.</span>
<span class="cm">     * @param method which method to call</span>
<span class="cm">     * @param params the parameters</span>
<span class="cm">     * @return an {@link org.xmlpull.v1.XmlPullParser}.</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     * @throws XmlPullParserException</span>
<span class="cm">     */</span>
	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="n">XmlPullParser</span> <span class="nf">doCall</span><span class="o">(</span><span class="n">String</span> <span class="n">method</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">doCall</span><span class="o">(</span><span class="n">DELIVERY_ENDPOINT</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">params</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">GetChildAreaTables <small>nde2.pull.methodcalls.delivery</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">methodcalls</span><span class="o">.</span><span class="na">delivery</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParserException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">nde2.errors.InvalidParameterException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.errors.NDE2Exception</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Dataset</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Gets the child area tables.</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> *     In the current form, it doesn&#39;t work as intended, and other forms</span>
<span class="cm"> *     of supplying parameters may have to be used.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @author filip</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GetChildAreaTables</span> <span class="kd">extends</span> <span class="n">GetTables</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">METHOD_NAME</span> <span class="o">=</span> <span class="s">&quot;getChildAreaTables&quot;</span><span class="o">;</span>

	<span class="kd">private</span> <span class="kt">int</span> <span class="n">levelTypeId</span><span class="o">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Specify a parent area</span>
<span class="cm">     * @param area the area to get child area tables for</span>
<span class="cm">     * @return modified object for currying</span>
<span class="cm">     */</span>
	<span class="kd">public</span> <span class="n">GetChildAreaTables</span> <span class="nf">forParentArea</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">areas</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Find children of this level type</span>
<span class="cm">     * @param levelTypeId level type id</span>
<span class="cm">     * @return modified object for currying</span>
<span class="cm">     */</span>
	<span class="kd">public</span> <span class="n">GetChildAreaTables</span> <span class="nf">forChildrenOfLevelType</span><span class="o">(</span><span class="kt">int</span> <span class="n">levelTypeId</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">levelTypeId</span> <span class="o">=</span> <span class="n">levelTypeId</span><span class="o">;</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">collectParams</span><span class="o">()</span>
			<span class="kd">throws</span> <span class="n">InvalidParameterException</span> <span class="o">{</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
		<span class="n">collectParentAreaToParams</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>
		<span class="n">collectDatasetFamiliesToParams</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>
		<span class="n">collectDateRangeToParams</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>
		<span class="n">collectLevelTypeIdToParams</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">params</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">collectLevelTypeIdToParams</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">areas</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">().</span><span class="na">getLevelTypeId</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">levelTypeId</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidParameterException</span><span class="o">(</span><span class="s">&quot;LevelTypeId&quot;</span><span class="o">,</span>
					<span class="s">&quot;The level type id of child areas must be lower than that of the parent.&quot;</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;LevelTypeId&quot;</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">levelTypeId</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">collectParentAreaToParams</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">areas</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidParameterException</span><span class="o">(</span><span class="s">&quot;ParentArea&quot;</span><span class="o">,</span>
					<span class="s">&quot;You must specify exactly one area to query for.&quot;</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;ParentAreaId&quot;</span><span class="o">,</span>
				<span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">areas</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">().</span><span class="na">getAreaId</span><span class="o">()));</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="n">XmlPullParser</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">doCall</span><span class="o">(</span><span class="n">METHOD_NAME</span><span class="o">,</span> <span class="n">params</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="nf">execute</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InvalidParameterException</span><span class="o">,</span>
			<span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">NDE2Exception</span> <span class="o">{</span>
		<span class="n">XmlPullParser</span> <span class="n">xpp</span> <span class="o">=</span> <span class="n">execute</span><span class="o">(</span><span class="n">collectParams</span><span class="o">());</span>

		<span class="k">return</span> <span class="nf">processDataCubeResponseElement</span><span class="o">(</span><span class="n">xpp</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">toURLString</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">buildURLString</span><span class="o">(</span><span class="n">DELIVERY_ENDPOINT</span><span class="o">,</span> <span class="n">METHOD_NAME</span><span class="o">,</span> <span class="n">collectParams</span><span class="o">());</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">GetTables <small>nde2.pull.methodcalls.delivery</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">methodcalls</span><span class="o">.</span><span class="na">delivery</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParserException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">nde2.errors.InvalidParameterException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.errors.NDE2Exception</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.helpers.DateFormat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Boundary</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DataSetFamily</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DataSetItem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DateRange</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Period</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Topic</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Fetches the dataset tables from ONS.</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> *     Generally, you&#39;ll need to set dataset families and areas</span>
<span class="cm"> *     to get the data for, and optionally a date range.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @author filip</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GetTables</span> <span class="kd">extends</span> <span class="n">DeliveryMethodCall</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">METHOD_NAME</span> <span class="o">=</span> <span class="s">&quot;getTables&quot;</span><span class="o">;</span>

	<span class="kd">protected</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;</span> <span class="n">areas</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">&gt;</span> <span class="n">datasetFamilies</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="n">DateRange</span> <span class="n">dateRange</span><span class="o">;</span>

	<span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Topic</span><span class="o">&gt;</span> <span class="n">dstopics</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Boundary</span><span class="o">&gt;</span> <span class="n">dsboundaries</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Period</span><span class="o">&gt;</span> <span class="n">dsperiods</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">GetTables</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">areas</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;();</span>
		<span class="n">datasetFamilies</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">&gt;();</span>
		<span class="n">dateRange</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Accepts a single area. This really is just sugar, as forAreas(Area...)</span>
<span class="cm">	 * can do the same thing.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param area</span>
<span class="cm">	 *            The area to find data for.</span>
<span class="cm">	 * @return The modified GetTables object for chaining instructions.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">GetTables</span> <span class="nf">forArea</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">areas</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Accepts either an array, or a variable-length list of arguments.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param areas</span>
<span class="cm">	 *            The areas to find data for.</span>
<span class="cm">	 * @return The modified GetTables object for chaining instructions.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">GetTables</span> <span class="nf">forAreas</span><span class="o">(</span><span class="n">Area</span><span class="o">...</span> <span class="n">areas</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">List</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;</span> <span class="n">args</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">areas</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">areas</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Accepts a collection, such as a set (hint hint).</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param areas</span>
<span class="cm">	 *            The areas to find data for.</span>
<span class="cm">	 * @return The modified GetTables object for chaining instructions.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">GetTables</span> <span class="nf">forAreas</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;</span> <span class="n">areas</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">areas</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">areas</span><span class="o">);</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Single dataset, sugar really.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param family</span>
<span class="cm">	 *            The dataset family to search in.</span>
<span class="cm">	 * @return Modified GetTables for chaining instructions.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">GetTables</span> <span class="nf">inFamily</span><span class="o">(</span><span class="n">DataSetFamily</span> <span class="n">family</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">datasetFamilies</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">family</span><span class="o">);</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Accepts an array of families, or a variable argument list.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param families</span>
<span class="cm">	 *            The dataset families to search in.</span>
<span class="cm">	 * @return Modified GetTables for chaining instructions.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">GetTables</span> <span class="nf">inFamilies</span><span class="o">(</span><span class="n">DataSetFamily</span><span class="o">...</span> <span class="n">families</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">List</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">&gt;</span> <span class="n">args</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">families</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">datasetFamilies</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Accepts a collection of families</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param families</span>
<span class="cm">	 *            The dataset families to search in.</span>
<span class="cm">	 * @return Modified GetTables for chaining instructions.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">GetTables</span> <span class="nf">inFamilies</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">&gt;</span> <span class="n">families</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">datasetFamilies</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">families</span><span class="o">);</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param range</span>
<span class="cm">	 *            Date range to limit the results by.</span>
<span class="cm">	 * @return Modified GetTables for chaining instructions.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">GetTables</span> <span class="nf">inDateRange</span><span class="o">(</span><span class="n">DateRange</span> <span class="n">range</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">dateRange</span> <span class="o">=</span> <span class="n">range</span><span class="o">;</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Execute the method call, supplying the method name</span>
<span class="cm">     * @param params a dictionary of parameter names and their values</span>
<span class="cm">     * @return an {@link org.xmlpull.v1.XmlPullParser}.</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     * @throws XmlPullParserException</span>
<span class="cm">     */</span>
	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="n">XmlPullParser</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">doCall</span><span class="o">(</span><span class="n">METHOD_NAME</span><span class="o">,</span> <span class="n">params</span><span class="o">);</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Takes the parameters for the method call and puts them into a dictionary</span>
<span class="cm">     * @return a dictionary of parameter names and their values</span>
<span class="cm">     * @throws InvalidParameterException</span>
<span class="cm">     */</span>
	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">collectParams</span><span class="o">()</span>
			<span class="kd">throws</span> <span class="n">InvalidParameterException</span> <span class="o">{</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
		<span class="n">collectAreasToParams</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>
		<span class="n">collectDatasetFamiliesToParams</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>
		<span class="n">collectDateRangeToParams</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">params</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Collects areas into the parameter dictionary</span>
<span class="cm">     * @param params a dictionary of parameter names and their values</span>
<span class="cm">     */</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">collectAreasToParams</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">areas</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">StringBuilder</span> <span class="n">commaSeparatedAreas</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
			<span class="k">for</span> <span class="o">(</span><span class="n">Area</span> <span class="n">a</span> <span class="o">:</span> <span class="n">areas</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">commaSeparatedAreas</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">getAreaId</span><span class="o">()).</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="c1">// Delete the trailing comma.</span>
			<span class="n">commaSeparatedAreas</span><span class="o">.</span><span class="na">deleteCharAt</span><span class="o">(</span><span class="n">commaSeparatedAreas</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
			<span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;Areas&quot;</span><span class="o">,</span> <span class="n">commaSeparatedAreas</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidParameterException</span><span class="o">(</span><span class="s">&quot;Areas&quot;</span><span class="o">,</span>
					<span class="s">&quot;Please specify at least one Area.&quot;</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Collects the date range into the parameter dictionary</span>
<span class="cm">     * @param params a dictionary of parameter names and their values</span>
<span class="cm">     */</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">collectDateRangeToParams</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">dateRange</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">StringBuilder</span> <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
			<span class="n">p</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">DateFormat</span><span class="o">.</span><span class="na">toNDEDate</span><span class="o">(</span><span class="n">dateRange</span><span class="o">.</span><span class="na">getStartDate</span><span class="o">()))</span>
					<span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;:&quot;</span><span class="o">)</span>
					<span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">DateFormat</span><span class="o">.</span><span class="na">toNDEDate</span><span class="o">(</span><span class="n">dateRange</span><span class="o">.</span><span class="na">getEndDate</span><span class="o">()));</span>
			<span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;TimePeriod&quot;</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
		<span class="o">}</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Collects the dataset families into the parameter dictionary</span>
<span class="cm">     * @param params a dictionary of parameter names and their values</span>
<span class="cm">     */</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">collectDatasetFamiliesToParams</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">datasetFamilies</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">StringBuilder</span> <span class="n">commaSeparatedDatasets</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
			<span class="k">for</span> <span class="o">(</span><span class="n">DataSetFamily</span> <span class="n">d</span> <span class="o">:</span> <span class="n">datasetFamilies</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">commaSeparatedDatasets</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">d</span><span class="o">.</span><span class="na">getFamilyId</span><span class="o">()).</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="c1">// Delete trailing comma</span>
			<span class="n">commaSeparatedDatasets</span>
					<span class="o">.</span><span class="na">deleteCharAt</span><span class="o">(</span><span class="n">commaSeparatedDatasets</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
			<span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;Datasets&quot;</span><span class="o">,</span> <span class="n">commaSeparatedDatasets</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidParameterException</span><span class="o">(</span><span class="s">&quot;Datasets&quot;</span><span class="o">,</span>
					<span class="s">&quot;Please specify at least one Dataset Family&quot;</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Pulls the datasets</span>
<span class="cm">     * @return A set of datasets for the specified request.</span>
<span class="cm">     * @throws InvalidParameterException</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     * @throws XmlPullParserException</span>
<span class="cm">     * @throws NDE2Exception</span>
<span class="cm">     */</span>
	<span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="nf">execute</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InvalidParameterException</span><span class="o">,</span>
			<span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">NDE2Exception</span> <span class="o">{</span>
		<span class="n">XmlPullParser</span> <span class="n">xpp</span> <span class="o">=</span> <span class="n">execute</span><span class="o">(</span><span class="n">collectParams</span><span class="o">());</span>

		<span class="k">return</span> <span class="nf">processDataCubeResponseElement</span><span class="o">(</span><span class="n">xpp</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Extracted to a separate method because {@link GetChildAreaTables} remote</span>
<span class="cm">	 * operation returns the same response element.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param xpp the parser object responsible for the datacube element</span>
<span class="cm">	 * @return a processed set of datasets in the datacube element</span>
<span class="cm">	 * @throws XmlPullParserException</span>
<span class="cm">	 * @throws IOException</span>
<span class="cm">	 * @throws NDE2Exception</span>
<span class="cm">	 */</span>
	<span class="kd">protected</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="nf">processDataCubeResponseElement</span><span class="o">(</span><span class="n">XmlPullParser</span> <span class="n">xpp</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">NDE2Exception</span> <span class="o">{</span>
		<span class="n">Set</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">datasets</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Dataset</span><span class="o">&gt;();</span>
		<span class="n">String</span> <span class="n">parent_key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">previous_key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">NDE2Exception</span> <span class="n">error</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">Dataset</span> <span class="n">ds</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

		<span class="n">Set</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;</span> <span class="n">dsitems</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">event</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getEventType</span><span class="o">();</span>
		<span class="k">while</span> <span class="o">(</span><span class="n">event</span> <span class="o">!=</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">END_DOCUMENT</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">switch</span> <span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">START_TAG</span><span class="o">:</span>
				<span class="n">previous_key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">xpp</span><span class="o">.</span><span class="na">getDepth</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">depth</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">parent_key</span> <span class="o">=</span> <span class="n">previous_key</span><span class="o">;</span>
					<span class="n">depth</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getDepth</span><span class="o">();</span>
				<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">xpp</span><span class="o">.</span><span class="na">getDepth</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">depth</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">depth</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getDepth</span><span class="o">();</span>
				<span class="o">}</span>
				<span class="n">key</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Dataset&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Dataset</span><span class="o">();</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Topics&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">dstopics</span> <span class="o">=</span> <span class="n">processTopics</span><span class="o">(</span><span class="n">xpp</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Boundaries&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">dsboundaries</span> <span class="o">=</span> <span class="n">processBoundaries</span><span class="o">(</span><span class="n">xpp</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Periods&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">dsperiods</span> <span class="o">=</span> <span class="n">processPeriods</span><span class="o">(</span><span class="n">xpp</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;DatasetItems&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">dsitems</span> <span class="o">=</span> <span class="n">processItems</span><span class="o">(</span><span class="n">xpp</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Error&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NDE2Exception</span><span class="o">();</span>
                <span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">TEXT</span><span class="o">:</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getText</span><span class="o">();</span>
				<span class="kt">boolean</span> <span class="n">in_dataset_metadata</span> <span class="o">=</span> <span class="n">parent_key</span>
						<span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;DatasetMetadata&quot;</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;DatasetCode&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">ds</span><span class="o">.</span><span class="na">setFamilyId</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">in_dataset_metadata</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Creator&quot;</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">ds</span><span class="o">.</span><span class="na">setCreator</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                    <span class="o">}</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Description&quot;</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">ds</span><span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                    <span class="o">}</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Subject.Category&quot;</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">ds</span><span class="o">.</span><span class="na">setSubjectCategory</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                    <span class="o">}</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Title&quot;</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">ds</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                    <span class="o">}</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;message&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">error</span><span class="o">.</span><span class="na">setNessMessage</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;detail&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">error</span><span class="o">.</span><span class="na">setNessDetail</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">END_TAG</span><span class="o">:</span>
				<span class="n">String</span> <span class="n">n</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">n</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Dataset&quot;</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">ds</span><span class="o">.</span><span class="na">setTopics</span><span class="o">(</span><span class="n">dstopics</span><span class="o">);</span>
					<span class="n">ds</span><span class="o">.</span><span class="na">setBoundaries</span><span class="o">(</span><span class="n">dsboundaries</span><span class="o">);</span>
					<span class="n">ds</span><span class="o">.</span><span class="na">setPeriods</span><span class="o">(</span><span class="n">dsperiods</span><span class="o">);</span>
					<span class="n">ds</span><span class="o">.</span><span class="na">setItems</span><span class="o">(</span><span class="n">dsitems</span><span class="o">);</span>
					<span class="n">datasets</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ds</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="n">event</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">error</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">error</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="n">datasets</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Processes dataset items based on the current call state</span>
<span class="cm">     * @param xpp the parser object responsible for the datacube element</span>
<span class="cm">     * @return A set of dataset items to attach to the dataset</span>
<span class="cm">     * @throws XmlPullParserException</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     */</span>
	<span class="kd">protected</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;</span> <span class="nf">processItems</span><span class="o">(</span><span class="n">XmlPullParser</span> <span class="n">xpp</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
		<span class="n">Set</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;</span> <span class="n">items</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;();</span>
		<span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">DataSetItem</span> <span class="n">i</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">event</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getEventType</span><span class="o">();</span>
		<span class="kt">boolean</span> <span class="n">in_items</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
		<span class="k">while</span> <span class="o">(</span><span class="n">in_items</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">switch</span> <span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">START_TAG</span><span class="o">:</span>
				<span class="n">key</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;DatasetItem&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataSetItem</span><span class="o">();</span>
                <span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">TEXT</span><span class="o">:</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getText</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;TopicId&quot;</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">Topic</span> <span class="n">t</span> <span class="o">=</span> <span class="n">dstopics</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
					<span class="n">i</span><span class="o">.</span><span class="na">setTopic</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;BoundaryId&quot;</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">Boundary</span> <span class="n">b</span> <span class="o">=</span> <span class="n">dsboundaries</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
					<span class="n">i</span><span class="o">.</span><span class="na">setBoundary</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;PeriodId&quot;</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">Period</span> <span class="n">p</span> <span class="o">=</span> <span class="n">dsperiods</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
					<span class="n">i</span><span class="o">.</span><span class="na">setPeriod</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Value&quot;</span><span class="o">))</span> <span class="o">{</span>
					<span class="kt">float</span> <span class="n">v</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="na">parseFloat</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
					<span class="n">i</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">v</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">END_TAG</span><span class="o">:</span>
				<span class="c1">// Done with ONE item</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">xpp</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;DatasetItem&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">items</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="c1">// Done with ALL of the items</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">xpp</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;DatasetItems&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">in_items</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">in_items</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">event</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">items</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Processes the periods</span>
<span class="cm">     * @param xpp the parser object responsible for the datacube element</span>
<span class="cm">     * @return periods, referenced by their pointer value.</span>
<span class="cm">     * @throws XmlPullParserException</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     */</span>
	<span class="kd">protected</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Period</span><span class="o">&gt;</span> <span class="n">processPeriods</span><span class="o">(</span><span class="n">XmlPullParser</span> <span class="n">xpp</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Period</span><span class="o">&gt;</span> <span class="n">periods</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Period</span><span class="o">&gt;();</span>
		<span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">Period</span> <span class="n">p</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">__p</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">event</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getEventType</span><span class="o">();</span>
		<span class="kt">boolean</span> <span class="n">in_periods</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
		<span class="k">while</span> <span class="o">(</span><span class="n">in_periods</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">switch</span> <span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">START_TAG</span><span class="o">:</span>
				<span class="n">key</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Period&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Period</span><span class="o">();</span>
                <span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">TEXT</span><span class="o">:</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getText</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;PeriodId&quot;</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">__p</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
					<span class="n">p</span><span class="o">.</span><span class="na">set__pointer</span><span class="o">(</span><span class="n">__p</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Date&quot;</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">p</span><span class="o">.</span><span class="na">setPeriodType</span><span class="o">(</span><span class="n">Period</span><span class="o">.</span><span class="na">SINGLE_DATE</span><span class="o">);</span>
					<span class="n">Date</span> <span class="n">d</span> <span class="o">=</span> <span class="n">DateFormat</span><span class="o">.</span><span class="na">fromNDEDateOnly</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
					<span class="n">p</span><span class="o">.</span><span class="na">setStartDate</span><span class="o">(</span><span class="n">d</span><span class="o">);</span>
					<span class="n">p</span><span class="o">.</span><span class="na">setEndDate</span><span class="o">(</span><span class="n">d</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Start&quot;</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">p</span><span class="o">.</span><span class="na">setPeriodType</span><span class="o">(</span><span class="n">Period</span><span class="o">.</span><span class="na">DATE_RANGE</span><span class="o">);</span>
					<span class="n">p</span><span class="o">.</span><span class="na">setStartDate</span><span class="o">(</span><span class="n">DateFormat</span><span class="o">.</span><span class="na">fromNDEDateOnly</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;End&quot;</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">p</span><span class="o">.</span><span class="na">setEndDate</span><span class="o">(</span><span class="n">DateFormat</span><span class="o">.</span><span class="na">fromNDEDateOnly</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
				<span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">END_TAG</span><span class="o">:</span>
				<span class="c1">// Done with ONE period</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">xpp</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Period&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">periods</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">__p</span><span class="o">,</span> <span class="n">p</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="c1">// Done with ALL of the periods</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">xpp</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Periods&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">in_periods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">in_periods</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">event</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">periods</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Processes the boundaries</span>
<span class="cm">     * @param xpp the parser object responsible for the datacube element</span>
<span class="cm">     * @return boundaries, referenced by their pointer value</span>
<span class="cm">     * @throws XmlPullParserException</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     */</span>
	<span class="kd">protected</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Boundary</span><span class="o">&gt;</span> <span class="n">processBoundaries</span><span class="o">(</span><span class="n">XmlPullParser</span> <span class="n">xpp</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Boundary</span><span class="o">&gt;</span> <span class="n">boundaries</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Boundary</span><span class="o">&gt;();</span>
		<span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">Boundary</span> <span class="n">b</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">__p</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">event</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getEventType</span><span class="o">();</span>
		<span class="kt">boolean</span> <span class="n">in_boundaries</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
		<span class="k">while</span> <span class="o">(</span><span class="n">in_boundaries</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">switch</span> <span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">START_TAG</span><span class="o">:</span>
				<span class="n">key</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Boundary&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Boundary</span><span class="o">();</span>
                <span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">TEXT</span><span class="o">:</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getText</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;BoundaryId&quot;</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">__p</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
					<span class="n">b</span><span class="o">.</span><span class="na">set__pointer</span><span class="o">(</span><span class="n">__p</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;BoundaryCode&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">b</span><span class="o">.</span><span class="na">setBoundaryCode</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Coverage.Spatial.Location&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">b</span><span class="o">.</span><span class="na">setEnvelope</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Identifier&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">b</span><span class="o">.</span><span class="na">setIdentifier</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Title&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">b</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">END_TAG</span><span class="o">:</span>
				<span class="c1">// Done with ONE boundary</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">xpp</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Boundary&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">boundaries</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">__p</span><span class="o">,</span> <span class="n">b</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="c1">// Done with ALL of the boundaries</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">xpp</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Boundaries&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">in_boundaries</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">in_boundaries</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">event</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">boundaries</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Processes the topics</span>
<span class="cm">     * @param xpp the parser object responsible for the datacube element</span>
<span class="cm">     * @return topics, referenced by their pointer value</span>
<span class="cm">     * @throws XmlPullParserException</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     */</span>
	<span class="kd">protected</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Topic</span><span class="o">&gt;</span> <span class="n">processTopics</span><span class="o">(</span><span class="n">XmlPullParser</span> <span class="n">xpp</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Topic</span><span class="o">&gt;</span> <span class="n">topics</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Topic</span><span class="o">&gt;();</span>
		<span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">Topic</span> <span class="n">t</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">__p</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">event</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getEventType</span><span class="o">();</span>
		<span class="kt">boolean</span> <span class="n">in_topics</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
		<span class="k">while</span> <span class="o">(</span><span class="n">in_topics</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">switch</span> <span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">START_TAG</span><span class="o">:</span>
				<span class="n">key</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Topic&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Topic</span><span class="o">();</span>
                <span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">TEXT</span><span class="o">:</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getText</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;TopicId&quot;</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">__p</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
					<span class="n">t</span><span class="o">.</span><span class="na">set__pointer</span><span class="o">(</span><span class="n">__p</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;TopicCode&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">t</span><span class="o">.</span><span class="na">setTopicId</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Creator&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">t</span><span class="o">.</span><span class="na">setCreator</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Description&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">t</span><span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Identifier&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">t</span><span class="o">.</span><span class="na">setDatasetFamilyId</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Title&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">t</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Coinage.Unit&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">t</span><span class="o">.</span><span class="na">setCoinageUnit</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">END_TAG</span><span class="o">:</span>
				<span class="c1">// Done with ONE topic, add to list</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">xpp</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Topic&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">topics</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">__p</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="c1">// Done with ALL the topics, return</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">xpp</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Topics&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">in_topics</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * Only advance the parser if the end of the list of topics is not</span>
<span class="cm">			 * reached.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">in_topics</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">event</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">topics</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">toURLString</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">buildURLString</span><span class="o">(</span><span class="n">DELIVERY_ENDPOINT</span><span class="o">,</span> <span class="n">METHOD_NAME</span><span class="o">,</span> <span class="n">collectParams</span><span class="o">());</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">DiscoveryMethodCall <small>nde2.pull.methodcalls.discovery</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">methodcalls</span><span class="o">.</span><span class="na">discovery</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParserException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">nde2.errors.NDE2Exception</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.methodcalls.BaseMethodCall</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">DiscoveryMethodCall</span> <span class="kd">extends</span> <span class="n">BaseMethodCall</span> <span class="o">{</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">DISCOVERY_ENDPOINT</span> <span class="o">=</span> <span class="s">&quot;http://neighbourhood.statistics.gov.uk/NDE2/Disco/&quot;</span><span class="o">;</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="n">XmlPullParser</span> <span class="nf">doCall</span><span class="o">(</span><span class="n">String</span> <span class="n">method</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">doCall</span><span class="o">(</span><span class="n">DISCOVERY_ENDPOINT</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">params</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * So many methods return lists of areas.</span>
<span class="cm">	 * </span>
<span class="cm">	 * &lt;p&gt;</span>
<span class="cm">	 * This method returns a {@link Set} of areas. That is because the remote</span>
<span class="cm">	 * call for {@link FindAreas} returns a slightly more complex structure than</span>
<span class="cm">	 * a simple list (as it also attempts some hierarchy in certain cases), and</span>
<span class="cm">	 * if a simple {@link List} was employed, areas would repeat. {@link Set}</span>
<span class="cm">	 * makes it impossible for equal objects to repeat, which is ideal in this</span>
<span class="cm">	 * scenario.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param xpp</span>
<span class="cm">	 *            The {@link XmlPullParser} pointed at a method call that</span>
<span class="cm">	 *            returns a list of Area elements.</span>
<span class="cm">	 * @return A {@link Set} of {@link Area Areas}.</span>
<span class="cm">	 * @throws XmlPullParserException</span>
<span class="cm">	 * @throws IOException</span>
<span class="cm">	 * @throws NDE2Exception</span>
<span class="cm">	 */</span>
	<span class="kd">protected</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;</span> <span class="nf">processAreaSet</span><span class="o">(</span><span class="n">XmlPullParser</span> <span class="n">xpp</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">NDE2Exception</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">Set</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;</span> <span class="n">areaSet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;();</span>
		<span class="n">Area</span> <span class="n">area</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">NDE2Exception</span> <span class="n">error</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">event</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getEventType</span><span class="o">();</span>
		<span class="k">while</span> <span class="o">(</span><span class="n">event</span> <span class="o">!=</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">END_DOCUMENT</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">switch</span> <span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">START_TAG</span><span class="o">:</span>
				<span class="n">key</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Error&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NDE2Exception</span><span class="o">();</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Area&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">area</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Area</span><span class="o">();</span>
                <span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">TEXT</span><span class="o">:</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getText</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;AreaId&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">area</span><span class="o">.</span><span class="na">setAreaId</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Name&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">area</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;HierarchyId&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">area</span><span class="o">.</span><span class="na">setHierarchyId</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;LevelTypeId&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">area</span><span class="o">.</span><span class="na">setLevelTypeId</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;message&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">error</span><span class="o">.</span><span class="na">setNessMessage</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;detail&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">error</span><span class="o">.</span><span class="na">setNessDetail</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">END_TAG</span><span class="o">:</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">xpp</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Area&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">areaSet</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="n">event</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">error</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">error</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="n">areaSet</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">FindAreas <small>nde2.pull.methodcalls.discovery</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">methodcalls</span><span class="o">.</span><span class="na">discovery</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParserException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">nde2.errors.NDE2Exception</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;i&gt;Encapsulates the FindAreas() call to the NDE2 web service.&lt;/i&gt;</span>
<span class="cm"> * </span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * Build FindAreas requests declaratively by currying, for instance:</span>
<span class="cm"> * </span>
<span class="cm"> * &lt;pre&gt;</span>
<span class="cm"> * new FindAreas().forPostcode(POSTCODE).ofLevelType(LEVELTYPE)</span>
<span class="cm"> * 		.inHierarchy(HIERARCHY);</span>
<span class="cm"> * &lt;/pre&gt;</span>
<span class="cm"> * </span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * The remote method only gets called when you &lt;code&gt;execute()&lt;/code&gt; it.</span>
<span class="cm"> * </span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This will return a set of areas that contain POSTCODE, are of the LEVELTYPE</span>
<span class="cm"> * level in hierarchy HIERARCHY. &lt;b&gt;Note:&lt;/b&gt; The remote procedure for this is</span>
<span class="cm"> * wonky. It may return objects that were not asked for (i.e. an Area of</span>
<span class="cm"> * hierarchy 2 if asked for areas of hierarchy 26).</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This operation is a composite search operation which combines all the</span>
<span class="cm"> * existing area searches. The postcode, area string and SNAC code are separate</span>
<span class="cm"> * parameters to avoid parsing complexities. A setting of HierarchyId= 0 tells</span>
<span class="cm"> * the service to use “Stats by Area” rules to pick hierarchy for level type.</span>
<span class="cm"> * One of postcode, area name part and (SNAC) Code must be supplied. All other</span>
<span class="cm"> * parameters optional.</span>
<span class="cm"> * </span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * Current area search operations:</span>
<span class="cm"> * &lt;ul&gt;</span>
<span class="cm"> * &lt;li&gt;SearchAreaByCode(code[, hierarchyId, leveltypeid])</span>
<span class="cm"> * &lt;li&gt;SearchAreaByNameHierarchy(name[, hierarchyid])</span>
<span class="cm"> * &lt;li&gt;SearchAreaByNameLevelType(name, leveltypeid)</span>
<span class="cm"> * &lt;li&gt;SearchAreaByPostcodeHierarchy(postcode[, hierarchyid])</span>
<span class="cm"> * &lt;li&gt;SearchAreaByPostcodeLevelType(postcode, leveltypeid)</span>
<span class="cm"> * &lt;li&gt;SearchSByAByName(name, leveltypeid)</span>
<span class="cm"> * &lt;li&gt;SearchSByAByPostcode(postcode, leveltypeid)</span>
<span class="cm"> * &lt;/ul&gt;</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FindAreas</span> <span class="kd">extends</span> <span class="n">DiscoveryMethodCall</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">METHOD_NAME</span> <span class="o">=</span> <span class="s">&quot;FindAreas&quot;</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">METHOD_NAME_S_BY_A_BY_POSTCODE</span> <span class="o">=</span> <span class="s">&quot;SearchSByAByPostcode&quot;</span><span class="o">;</span>

	<span class="kd">private</span> <span class="n">String</span> <span class="n">postcode</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">areaNamePart</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">code</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">levelTypeId</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">hierarchyId</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param postcode</span>
<span class="cm">	 *            Postcode of the area to find</span>
<span class="cm">	 * @return Modified {@link FindAreas} for currying</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">FindAreas</span> <span class="nf">forPostcode</span><span class="o">(</span><span class="n">String</span> <span class="n">postcode</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">postcode</span> <span class="o">=</span> <span class="n">postcode</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">&quot; &quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">);</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param areaNamePart</span>
<span class="cm">	 *            Part of the required area&#39;s name</span>
<span class="cm">	 * @return Modified {@link FindAreas} for currying</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">FindAreas</span> <span class="nf">whoseNameContains</span><span class="o">(</span><span class="n">String</span> <span class="n">areaNamePart</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">areaNamePart</span> <span class="o">=</span> <span class="n">areaNamePart</span><span class="o">;</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param code</span>
<span class="cm">	 *            SNAC code of the area to find</span>
<span class="cm">	 * @return Modified {@link FindAreas} for currying</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">FindAreas</span> <span class="nf">forSNACCode</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">;</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param levelTypeId</span>
<span class="cm">	 *            Level Type ID to filter results with -- see {@link Area} for</span>
<span class="cm">	 *            allowed values.</span>
<span class="cm">	 * @return Modified {@link FindAreas} for currying</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">FindAreas</span> <span class="nf">ofLevelType</span><span class="o">(</span><span class="kt">int</span> <span class="n">levelTypeId</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">levelTypeId</span> <span class="o">=</span> <span class="n">levelTypeId</span><span class="o">;</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param hierarchyId</span>
<span class="cm">	 *            Hierarchy ID to filter results with -- see {@link Area} for</span>
<span class="cm">	 *            allowed values.</span>
<span class="cm">	 * @return Modified {@link FindAreas} for currying</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">FindAreas</span> <span class="nf">inHierarchy</span><span class="o">(</span><span class="kt">int</span> <span class="n">hierarchyId</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">hierarchyId</span> <span class="o">=</span> <span class="n">hierarchyId</span><span class="o">;</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">useAlternateMethod</span><span class="o">()</span> <span class="o">{</span>
		<span class="kt">boolean</span> <span class="n">no_name</span> <span class="o">=</span> <span class="o">(</span><span class="n">areaNamePart</span> <span class="o">==</span> <span class="kc">null</span><span class="o">);</span>
		<span class="kt">boolean</span> <span class="n">has_postcode</span> <span class="o">=</span> <span class="o">(</span><span class="n">postcode</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
		<span class="kt">boolean</span> <span class="n">has_leveltype</span> <span class="o">=</span> <span class="o">(</span><span class="n">levelTypeId</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span>
		<span class="kt">boolean</span> <span class="n">has_hierarchy</span> <span class="o">=</span> <span class="o">(</span><span class="n">hierarchyId</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span>
		<span class="k">return</span> <span class="o">(</span><span class="n">no_name</span> <span class="o">&amp;&amp;</span> <span class="n">has_postcode</span> <span class="o">&amp;&amp;</span> <span class="n">has_hierarchy</span> <span class="o">&amp;&amp;</span> <span class="n">has_leveltype</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="n">XmlPullParser</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span> <span class="o">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Special case: There is a bug in the ONS service, wherein upon making</span>
<span class="cm">		 * a call to FindAreas(), inquiring about an area containing a postcode,</span>
<span class="cm">		 * of a specified level in a specified hierarchy, one receives that</span>
<span class="cm">		 * area, as well as another area from a hierarchy that is altogether</span>
<span class="cm">		 * different. Hence, in order to avoid such issues, this will check if</span>
<span class="cm">		 * the user wants to make that particular query, and switches to a more</span>
<span class="cm">		 * predictable call, SearchSByAByPostcode(). Good thing the latter</span>
<span class="cm">		 * returns the same datatypes. And also only the hierarchies etc that</span>
<span class="cm">		 * are requested.</span>
<span class="cm">		 * </span>
<span class="cm">		 * See: http://goo.gl/ezODf8</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">useAlternateMethod</span><span class="o">())</span> <span class="o">{</span>
			<span class="c1">// FindAreas is broken under this configuration, so let&#39;s use</span>
			<span class="c1">// something that isn&#39;t.</span>
			<span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">doCall</span><span class="o">(</span><span class="n">METHOD_NAME_S_BY_A_BY_POSTCODE</span><span class="o">,</span> <span class="n">params</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">doCall</span><span class="o">(</span><span class="n">METHOD_NAME</span><span class="o">,</span> <span class="n">params</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">collectParams</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">postcode</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;Postcode&quot;</span><span class="o">,</span> <span class="n">postcode</span><span class="o">);</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">code</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;Code&quot;</span><span class="o">,</span> <span class="n">code</span><span class="o">);</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">areaNamePart</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;AreaNamePart&quot;</span><span class="o">,</span> <span class="n">areaNamePart</span><span class="o">);</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">hierarchyId</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;HierarchyId&quot;</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">hierarchyId</span><span class="o">));</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">levelTypeId</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;LevelTypeId&quot;</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">levelTypeId</span><span class="o">));</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="n">params</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * This method will take data supplied to this {@link FindAreas} and call</span>
<span class="cm">	 * the web service. It will then parse the result, or thrown an Exception if</span>
<span class="cm">	 * there is a problem.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @return A set of areas returned by the service.</span>
<span class="cm">	 * @throws IOException</span>
<span class="cm">	 *             Usually occurs when a connection could not be established, or</span>
<span class="cm">	 *             the URL called is wrong for some reason.</span>
<span class="cm">	 * @throws XmlPullParserException</span>
<span class="cm">	 *             May occur if the server returns some WTF-worthy XML.</span>
<span class="cm">	 * @throws NDE2Exception</span>
<span class="cm">	 *             Encapsulates an error response returned by the service</span>
<span class="cm">	 *             itself.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;</span> <span class="nf">execute</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span><span class="o">,</span>
			<span class="n">NDE2Exception</span> <span class="o">{</span>
		<span class="n">XmlPullParser</span> <span class="n">xpp</span> <span class="o">=</span> <span class="n">execute</span><span class="o">(</span><span class="n">collectParams</span><span class="o">());</span>

		<span class="n">Set</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;</span> <span class="n">areaSet</span> <span class="o">=</span> <span class="n">processAreaSet</span><span class="o">(</span><span class="n">xpp</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">areaSet</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">toURLString</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">useAlternateMethod</span><span class="o">())</span> <span class="o">{</span>
			<span class="k">return</span> <span class="nf">buildURLString</span><span class="o">(</span><span class="n">DISCOVERY_ENDPOINT</span><span class="o">,</span>
					<span class="n">METHOD_NAME_S_BY_A_BY_POSTCODE</span><span class="o">,</span> <span class="n">collectParams</span><span class="o">());</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="nf">buildURLString</span><span class="o">(</span><span class="n">DISCOVERY_ENDPOINT</span><span class="o">,</span> <span class="n">METHOD_NAME</span><span class="o">,</span> <span class="n">collectParams</span><span class="o">());</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">GetAreaChildren <small>nde2.pull.methodcalls.discovery</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">methodcalls</span><span class="o">.</span><span class="na">discovery</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">nde2.errors.NDE2Exception</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParserException</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;i&gt;Encapsulates the GetAreaChildren() call to the NDE2 web service. Creation</span>
<span class="cm"> * follows the Builder pattern.&lt;/i&gt;</span>
<span class="cm"> * </span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This operation allows you to get the lower level areas for a supplied area,</span>
<span class="cm"> * regardless of level type. Only those areas immediately below the supplied</span>
<span class="cm"> * area are returned. For example, the child areas of a region would be the</span>
<span class="cm"> * counties and unitary authorities within that region. Repeatedly calling this</span>
<span class="cm"> * operation allows you drill down through area hierarchies.</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GetAreaChildren</span> <span class="kd">extends</span> <span class="n">DiscoveryMethodCall</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">METHOD_NAME</span> <span class="o">=</span> <span class="s">&quot;GetAreaChildren&quot;</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Area</span> <span class="n">parentArea</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">GetAreaChildren</span><span class="o">(</span><span class="n">Area</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">parentArea</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="n">XmlPullParser</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">doCall</span><span class="o">(</span><span class="n">METHOD_NAME</span><span class="o">,</span> <span class="n">params</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">collectParams</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
		<span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;AreaId&quot;</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">parentArea</span><span class="o">.</span><span class="na">getAreaId</span><span class="o">()));</span>
		<span class="k">return</span> <span class="n">params</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @return A list of children {@link Area}s for the parent {@link Area}</span>
<span class="cm">	 *         supplied.</span>
<span class="cm">	 * @throws IOException</span>
<span class="cm">	 * @throws XmlPullParserException</span>
<span class="cm">	 * @throws NDE2Exception</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;</span> <span class="nf">execute</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span><span class="o">,</span>
			<span class="n">NDE2Exception</span> <span class="o">{</span>
		<span class="n">XmlPullParser</span> <span class="n">xpp</span> <span class="o">=</span> <span class="n">execute</span><span class="o">(</span><span class="n">collectParams</span><span class="o">());</span>
		<span class="n">Set</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;</span> <span class="n">childSet</span> <span class="o">=</span> <span class="n">processAreaSet</span><span class="o">(</span><span class="n">xpp</span><span class="o">);</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">Area</span> <span class="n">child</span> <span class="o">:</span> <span class="n">childSet</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">child</span><span class="o">.</span><span class="na">setParent</span><span class="o">(</span><span class="n">parentArea</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">childSet</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">toURLString</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">buildURLString</span><span class="o">(</span><span class="n">DISCOVERY_ENDPOINT</span><span class="o">,</span> <span class="n">METHOD_NAME</span><span class="o">,</span> <span class="n">collectParams</span><span class="o">());</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">GetAreaDetail <small>nde2.pull.methodcalls.discovery</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">methodcalls</span><span class="o">.</span><span class="na">discovery</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParserException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">nde2.errors.NDE2Exception</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DetailedArea</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;i&gt;Encapsulates the GetAreaDetail() call to the NDE2 web service. Creation</span>
<span class="cm"> * follows the Builder pattern.&lt;/i&gt;</span>
<span class="cm"> * </span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This is a simple operation which gives you extra information about an area,</span>
<span class="cm"> * by supplying its AreaId. This AreaId is internal to the NeSS datastore and</span>
<span class="cm"> * must have been previously obtained via other discovery calls.</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * In the returned information, the Envelope can be used in a GIS system – it is</span>
<span class="cm"> * the four corners of the map of the area MinX:MinY:MaxX:MaxY - these numbers</span>
<span class="cm"> * being Ordnance Survey Eastings and Northings. The ExtCode is the standard</span>
<span class="cm"> * SNAC code for the area. There may be metadata for the area or nil elements.</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GetAreaDetail</span> <span class="kd">extends</span> <span class="n">DiscoveryMethodCall</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">METHOD_NAME</span> <span class="o">=</span> <span class="s">&quot;GetAreaDetail&quot;</span><span class="o">;</span>

	<span class="kd">private</span> <span class="n">Area</span> <span class="n">basicArea</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">GetAreaDetail</span><span class="o">(</span><span class="n">Area</span> <span class="n">basicArea</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">basicArea</span> <span class="o">=</span> <span class="n">basicArea</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="n">XmlPullParser</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">doCall</span><span class="o">(</span><span class="n">METHOD_NAME</span><span class="o">,</span> <span class="n">params</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">collectParams</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
		<span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;AreaId&quot;</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">basicArea</span><span class="o">.</span><span class="na">getAreaId</span><span class="o">()));</span>
		<span class="k">return</span> <span class="n">params</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * A {@link DetailedArea} corresponding to the supplied Area.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @return the detailed area</span>
<span class="cm">	 * @throws IOException</span>
<span class="cm">	 * @throws XmlPullParserException</span>
<span class="cm">	 * @throws NDE2Exception</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">DetailedArea</span> <span class="nf">execute</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span><span class="o">,</span>
			<span class="n">NDE2Exception</span> <span class="o">{</span>
		<span class="n">XmlPullParser</span> <span class="n">xpp</span> <span class="o">=</span> <span class="n">execute</span><span class="o">(</span><span class="n">collectParams</span><span class="o">());</span>
		<span class="n">DetailedArea</span> <span class="n">detailedArea</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

		<span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">NDE2Exception</span> <span class="n">error</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">event</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getEventType</span><span class="o">();</span>
		<span class="k">while</span> <span class="o">(</span><span class="n">event</span> <span class="o">!=</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">END_DOCUMENT</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">switch</span> <span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">START_TAG</span><span class="o">:</span>
				<span class="n">key</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Error&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NDE2Exception</span><span class="o">();</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;AreaDetail&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">detailedArea</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DetailedArea</span><span class="o">(</span><span class="n">basicArea</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
                            <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">TEXT</span><span class="o">:</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getText</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;ExtCode&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">detailedArea</span><span class="o">.</span><span class="na">setExtCode</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;OptionalMetaData&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">detailedArea</span><span class="o">.</span><span class="na">setOptionalMetadata</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;MandatoryMetaData&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">detailedArea</span><span class="o">.</span><span class="na">setMandatoryMetadata</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Envelope&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">detailedArea</span><span class="o">.</span><span class="na">setEnvelope</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;message&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">error</span><span class="o">.</span><span class="na">setNessMessage</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;detail&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">error</span><span class="o">.</span><span class="na">setNessDetail</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="n">event</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">error</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">error</span><span class="o">;</span>
        <span class="o">}</span>

		<span class="k">return</span> <span class="n">detailedArea</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">toURLString</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">buildURLString</span><span class="o">(</span><span class="n">DISCOVERY_ENDPOINT</span><span class="o">,</span> <span class="n">METHOD_NAME</span><span class="o">,</span> <span class="n">collectParams</span><span class="o">());</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">GetAreaParent <small>nde2.pull.methodcalls.discovery</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">methodcalls</span><span class="o">.</span><span class="na">discovery</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">nde2.errors.NDE2Exception</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParserException</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;i&gt;Encapsulates the GetAreaComparators() method call and returns the closest</span>
<span class="cm"> * comparator.&lt;/i&gt;</span>
<span class="cm"> * </span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This operation gives you the higher level areas which contain your chosen</span>
<span class="cm"> * area, which are considered useful for comparison purposes. For example, the</span>
<span class="cm"> * comparator areas of an Output Area might be the local authority, the region</span>
<span class="cm"> * (if within England) and the country.</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GetAreaParent</span> <span class="kd">extends</span> <span class="n">DiscoveryMethodCall</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">METHOD_NAME</span> <span class="o">=</span> <span class="s">&quot;GetAreaComparators&quot;</span><span class="o">;</span>

	<span class="kd">private</span> <span class="n">Area</span> <span class="n">childArea</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">GetAreaParent</span><span class="o">(</span><span class="n">Area</span> <span class="n">childArea</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">childArea</span> <span class="o">=</span> <span class="n">childArea</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="n">XmlPullParser</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">doCall</span><span class="o">(</span><span class="n">METHOD_NAME</span><span class="o">,</span> <span class="n">params</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">collectParams</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
		<span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;AreaId&quot;</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">childArea</span><span class="o">.</span><span class="na">getAreaId</span><span class="o">()));</span>
		<span class="k">return</span> <span class="n">params</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @return A parent (comparator) area of the supplied {@link Area}. Note</span>
<span class="cm">	 *         that due to how NDE works, it may not be the actual</span>
<span class="cm">	 *         administrative parent.</span>
<span class="cm">	 * @throws IOException</span>
<span class="cm">	 * @throws XmlPullParserException</span>
<span class="cm">	 * @throws NDE2Exception</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Area</span> <span class="nf">execute</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span><span class="o">,</span>
			<span class="n">NDE2Exception</span> <span class="o">{</span>
		<span class="n">XmlPullParser</span> <span class="n">xpp</span> <span class="o">=</span> <span class="n">execute</span><span class="o">(</span><span class="n">collectParams</span><span class="o">());</span>
		<span class="n">Set</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;</span> <span class="n">comparators</span> <span class="o">=</span> <span class="n">processAreaSet</span><span class="o">(</span><span class="n">xpp</span><span class="o">);</span>
		<span class="n">Area</span> <span class="n">parentCandidate</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

		<span class="k">for</span> <span class="o">(</span><span class="n">Area</span> <span class="n">comparator</span> <span class="o">:</span> <span class="n">comparators</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">parentCandidate</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">comparator</span><span class="o">.</span><span class="na">getLevelTypeId</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">parentCandidate</span>
						<span class="o">.</span><span class="na">getLevelTypeId</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">parentCandidate</span> <span class="o">=</span> <span class="n">comparator</span><span class="o">;</span>
				<span class="o">}</span>
			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
				<span class="n">parentCandidate</span> <span class="o">=</span> <span class="n">comparator</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="n">parentCandidate</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">toURLString</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">buildURLString</span><span class="o">(</span><span class="n">DISCOVERY_ENDPOINT</span><span class="o">,</span> <span class="n">METHOD_NAME</span><span class="o">,</span> <span class="n">collectParams</span><span class="o">());</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">GetCompatibleSubjects <small>nde2.pull.methodcalls.discovery</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">methodcalls</span><span class="o">.</span><span class="na">discovery</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParserException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">nde2.errors.NDE2Exception</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Subject</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;i&gt;Encapsulates the GetCompatibleSubjects() call to the NDE2 web service.&lt;/i&gt;</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This operation retrieves the available subjects, without dataset families.</span>
<span class="cm"> * With each subject, however, a count is returned of dataset families that are</span>
<span class="cm"> * compatible with the supplied area.</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GetCompatibleSubjects</span> <span class="kd">extends</span> <span class="n">DiscoveryMethodCall</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">METHOD_NAME</span> <span class="o">=</span> <span class="s">&quot;GetCompatibleSubjects&quot;</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Area</span> <span class="n">area</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">GetCompatibleSubjects</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">area</span> <span class="o">=</span> <span class="n">area</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="n">XmlPullParser</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">doCall</span><span class="o">(</span><span class="n">METHOD_NAME</span><span class="o">,</span> <span class="n">params</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">collectParams</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
		<span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;AreaId&quot;</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">area</span><span class="o">.</span><span class="na">getAreaId</span><span class="o">()));</span>
		<span class="k">return</span> <span class="n">params</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Subject</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">execute</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span>
			<span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">NDE2Exception</span> <span class="o">{</span>
		<span class="n">XmlPullParser</span> <span class="n">xpp</span> <span class="o">=</span> <span class="n">execute</span><span class="o">(</span><span class="n">collectParams</span><span class="o">());</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">Subject</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">subjects</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Subject</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;();</span>

		<span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">Subject</span> <span class="n">subject</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="n">NDE2Exception</span> <span class="n">error</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">event</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getEventType</span><span class="o">();</span>

		<span class="k">while</span> <span class="o">(</span><span class="n">event</span> <span class="o">!=</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">END_DOCUMENT</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">switch</span> <span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">START_TAG</span><span class="o">:</span>
				<span class="n">key</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Error&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NDE2Exception</span><span class="o">();</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Subject&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Subject</span><span class="o">();</span>
                <span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">TEXT</span><span class="o">:</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getText</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;SubjectId&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">subject</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Name&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">subject</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Count&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;message&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">error</span><span class="o">.</span><span class="na">setNessMessage</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;detail&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">error</span><span class="o">.</span><span class="na">setNessDetail</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">END_TAG</span><span class="o">:</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">xpp</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;SubjectWithCount&quot;</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">subjects</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">subject</span><span class="o">,</span> <span class="n">count</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="n">event</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">error</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">error</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="n">subjects</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">toURLString</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">buildURLString</span><span class="o">(</span><span class="n">DISCOVERY_ENDPOINT</span><span class="o">,</span> <span class="n">METHOD_NAME</span><span class="o">,</span> <span class="n">collectParams</span><span class="o">());</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">GetDatasetFamilies <small>nde2.pull.methodcalls.discovery</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">methodcalls</span><span class="o">.</span><span class="na">discovery</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParserException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">nde2.errors.NDE2Exception</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.helpers.DateFormat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Area</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DataSetFamily</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DateRange</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Subject</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GetDatasetFamilies</span> <span class="kd">extends</span> <span class="n">DiscoveryMethodCall</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">METHOD_NAME</span> <span class="o">=</span> <span class="s">&quot;GetDatasets&quot;</span><span class="o">;</span>

	<span class="kd">private</span> <span class="n">Area</span> <span class="n">area</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Subject</span> <span class="n">subject</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">GetDatasetFamilies</span><span class="o">(</span><span class="n">Subject</span> <span class="n">subject</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">subject</span> <span class="o">=</span> <span class="n">subject</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">area</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">GetDatasetFamilies</span> <span class="nf">forArea</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">area</span> <span class="o">=</span> <span class="n">area</span><span class="o">;</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="n">XmlPullParser</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">doCall</span><span class="o">(</span><span class="n">METHOD_NAME</span><span class="o">,</span> <span class="n">params</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">collectParams</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
		<span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;SubjectId&quot;</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">subject</span><span class="o">.</span><span class="na">getId</span><span class="o">()));</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">area</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;AreaId&quot;</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">area</span><span class="o">.</span><span class="na">getAreaId</span><span class="o">()));</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">params</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">&gt;</span> <span class="nf">execute</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span>
			<span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">NDE2Exception</span> <span class="o">{</span>
		<span class="n">XmlPullParser</span> <span class="n">xpp</span> <span class="o">=</span> <span class="n">execute</span><span class="o">(</span><span class="n">collectParams</span><span class="o">());</span>
		<span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">event</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getEventType</span><span class="o">();</span>
		<span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">&gt;</span> <span class="n">dataSetFamilies</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">DataSetFamily</span><span class="o">&gt;();</span>
		<span class="n">NDE2Exception</span> <span class="n">error</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">DataSetFamily</span> <span class="n">dataSetFamily</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">DateRange</span> <span class="n">dateRange</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">List</span><span class="o">&lt;</span><span class="n">DateRange</span><span class="o">&gt;</span> <span class="n">dateRanges</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">while</span> <span class="o">(</span><span class="n">event</span> <span class="o">!=</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">END_DOCUMENT</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">switch</span> <span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">START_TAG</span><span class="o">:</span>
				<span class="n">key</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;DSFamily&quot;</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">dataSetFamily</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataSetFamily</span><span class="o">();</span>
					<span class="n">dateRanges</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">DateRange</span><span class="o">&gt;(</span><span class="mi">5</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;DateRange&quot;</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">dateRange</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DateRange</span><span class="o">();</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Error&quot;</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">error</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NDE2Exception</span><span class="o">();</span>
				<span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">TEXT</span><span class="o">:</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getText</span><span class="o">();</span>
				<span class="c1">// DateRange</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;StartDate&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">dateRange</span><span class="o">.</span><span class="na">setStartDate</span><span class="o">(</span><span class="n">DateFormat</span><span class="o">.</span><span class="na">fromNDEDateTime</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;EndDate&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">dateRange</span><span class="o">.</span><span class="na">setEndDate</span><span class="o">(</span><span class="n">DateFormat</span><span class="o">.</span><span class="na">fromNDEDateTime</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
                <span class="o">}</span>
				<span class="c1">// DSFamily</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;DSFamilyId&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">dataSetFamily</span><span class="o">.</span><span class="na">setFamilyId</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Name&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">dataSetFamily</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="c1">// Error</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;message&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">error</span><span class="o">.</span><span class="na">setNessMessage</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;detail&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">error</span><span class="o">.</span><span class="na">setNessDetail</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">END_TAG</span><span class="o">:</span>
				<span class="n">String</span> <span class="n">t</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;DateRange&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">dateRanges</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">dateRange</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;DSFamily&quot;</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">dataSetFamily</span><span class="o">.</span><span class="na">setDateRanges</span><span class="o">(</span><span class="n">dateRanges</span>
							<span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="n">DateRange</span><span class="o">[</span><span class="n">dateRanges</span><span class="o">.</span><span class="na">size</span><span class="o">()]));</span>
					<span class="n">dataSetFamilies</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">dataSetFamily</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="n">event</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">error</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">error</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Let&#39;s not waste memory. On the other hand, when this is trimmed, it</span>
<span class="cm">		 * could cause a performance hit depending on the GC (looking at you,</span>
<span class="cm">		 * Android).</span>
<span class="cm">		 */</span>
		<span class="n">dataSetFamilies</span><span class="o">.</span><span class="na">trimToSize</span><span class="o">();</span>
		<span class="k">return</span> <span class="n">dataSetFamilies</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">toURLString</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">buildURLString</span><span class="o">(</span><span class="n">DISCOVERY_ENDPOINT</span><span class="o">,</span> <span class="n">METHOD_NAME</span><span class="o">,</span> <span class="n">collectParams</span><span class="o">());</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">GetSubjectDetail <small>nde2.pull.methodcalls.discovery</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">methodcalls</span><span class="o">.</span><span class="na">discovery</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParserException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">nde2.errors.NDE2Exception</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.DetailedSubject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.types.Subject</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;i&gt;Encapsulates the GetSubjectDetail() call to the NDE2 web service.&lt;/i&gt;</span>
<span class="cm"> * </span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This operation allows you to obtain the metadata associated with your</span>
<span class="cm"> * requested subject. Dataset families are not returned.</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GetSubjectDetail</span> <span class="kd">extends</span> <span class="n">DiscoveryMethodCall</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">METHOD_NAME</span> <span class="o">=</span> <span class="s">&quot;GetSubjectDetail&quot;</span><span class="o">;</span>

	<span class="kd">private</span> <span class="n">Subject</span> <span class="n">subject</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">GetSubjectDetail</span><span class="o">(</span><span class="n">Subject</span> <span class="n">subject</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">subject</span> <span class="o">=</span> <span class="n">subject</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="n">XmlPullParser</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">doCall</span><span class="o">(</span><span class="n">METHOD_NAME</span><span class="o">,</span> <span class="n">params</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">collectParams</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
		<span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;SubjectId&quot;</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">subject</span><span class="o">.</span><span class="na">getId</span><span class="o">()));</span>
		<span class="k">return</span> <span class="n">params</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @return A detailed representation of the supplied {@link Subject}</span>
<span class="cm">	 * @throws IOException</span>
<span class="cm">	 * @throws XmlPullParserException</span>
<span class="cm">	 * @throws NDE2Exception</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">DetailedSubject</span> <span class="nf">execute</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span>
			<span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">NDE2Exception</span> <span class="o">{</span>
		<span class="n">XmlPullParser</span> <span class="n">xpp</span> <span class="o">=</span> <span class="n">execute</span><span class="o">(</span><span class="n">collectParams</span><span class="o">());</span>
		<span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">event</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getEventType</span><span class="o">();</span>
		<span class="n">NDE2Exception</span> <span class="n">error</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">DetailedSubject</span> <span class="n">dsubject</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">while</span> <span class="o">(</span><span class="n">event</span> <span class="o">!=</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">END_DOCUMENT</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">switch</span> <span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">START_TAG</span><span class="o">:</span>
				<span class="n">key</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;SubjectDetail&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">dsubject</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DetailedSubject</span><span class="o">(</span><span class="n">subject</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Error&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NDE2Exception</span><span class="o">();</span>
                <span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="k">case</span> <span class="n">XmlPullParser</span><span class="o">.</span><span class="na">TEXT</span><span class="o">:</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">getText</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Description&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">dsubject</span><span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;OptionalMetaData&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">dsubject</span><span class="o">.</span><span class="na">setMoreDescription</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;message&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">error</span><span class="o">.</span><span class="na">setNessMessage</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;detail&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">error</span><span class="o">.</span><span class="na">setNessDetail</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="n">event</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">error</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">error</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="n">dsubject</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">toURLString</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">buildURLString</span><span class="o">(</span><span class="n">DISCOVERY_ENDPOINT</span><span class="o">,</span> <span class="n">METHOD_NAME</span><span class="o">,</span> <span class="n">collectParams</span><span class="o">());</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">Area <small>nde2.pull.types</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">types</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParserException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">nde2.errors.NDE2Exception</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.methodcalls.discovery.GetAreaChildren</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.methodcalls.discovery.GetAreaParent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.methodcalls.discovery.GetCompatibleSubjects</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * This class of objects represents geographic of administrative areas returned</span>
<span class="cm"> * by the NDE2 Discovery web service.</span>
<span class="cm"> * </span>
<span class="cm"> * @see {@link DetailedArea} -- a version of the area that has slightly more</span>
<span class="cm"> *      data; you want this for the Ordnance Survey envelope.</span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Area</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_2011_STATISTICAL_GEOGRAPHY</span> <span class="o">=</span> <span class="mi">26</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_2001_STATISTICAL_GEOGRAPHY</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_1998_ADMINISTRATIVE</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_2003_ADMINISTRATIVE</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_2003_ELECTORAL</span> <span class="o">=</span> <span class="mi">7</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_2003_HEALTH</span> <span class="o">=</span> <span class="mi">8</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_2003_PARISH</span> <span class="o">=</span> <span class="mi">9</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_2003_EDUCATION</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_2004_ADMINISTRATIVE</span> <span class="o">=</span> <span class="mi">11</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_NEW_DEAL_FOR_COMMUNITIES_BEST_FIT</span> <span class="o">=</span> <span class="mi">12</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_PROVISIONAL_PARLIAMENTARY_CONSTITUENCIES_2007</span> <span class="o">=</span> <span class="mi">14</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_2006_HEALTH</span> <span class="o">=</span> <span class="mi">15</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_2006_ADMINISTRATIVE</span> <span class="o">=</span> <span class="mi">17</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_2005_ADMINISTRATIVE</span> <span class="o">=</span> <span class="mi">16</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_2007_ADMINISTRATIVE</span> <span class="o">=</span> <span class="mi">18</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_2010_WESTMINSTER_PARLIAMENTARY_CONSTITUENCIES</span> <span class="o">=</span> <span class="mi">23</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_2008_ADMINISTRATIVE</span> <span class="o">=</span> <span class="mi">22</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_2010_ADMINISTRATIVE</span> <span class="o">=</span> <span class="mi">25</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_2009_ADMINISTRATIVE</span> <span class="o">=</span> <span class="mi">24</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_2011_ADMINISTRATIVE</span> <span class="o">=</span> <span class="mi">27</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_2011_PARISH</span> <span class="o">=</span> <span class="mi">29</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_2011_WESTMINSTER_PARLIAMENTARY_CONSTITUENCIES</span> <span class="o">=</span> <span class="mi">28</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Denotes an invalid/&quot;null&quot; hierarchy</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HIERARCHY_NULL</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * Community</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_COMMUNITY</span> <span class="o">=</span> <span class="mi">164</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Country</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_COUNTRY</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * County</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_COUNTY</span> <span class="o">=</span> <span class="mi">12</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Education Area</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_EDUCATION_AREA</span> <span class="o">=</span> <span class="mi">180</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * England and Wales</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_ENGLAND_WALES</span> <span class="o">=</span> <span class="mi">9</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Former county</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_FORMER_COUNTY</span> <span class="o">=</span> <span class="mi">96</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * ???</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_FLA</span> <span class="o">=</span> <span class="mi">251</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Gazetteer</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_GAZ</span> <span class="o">=</span> <span class="mi">21</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Gazetteer 2</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_GAZ2</span> <span class="o">=</span> <span class="mi">259</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Great Britain</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_GREAT_BRITAIN</span> <span class="o">=</span> <span class="mi">8</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Government Office Region</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_GOV_OFFICE_REGION</span> <span class="o">=</span> <span class="mi">11</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Health Authority</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_HEALTH_AUTHORITY</span> <span class="o">=</span> <span class="mi">19</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Local Authority</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_LOCAL_AUTHORITY</span> <span class="o">=</span> <span class="mi">13</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Lower layer super output area</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_LSOA</span> <span class="o">=</span> <span class="mi">141</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Middle layer super output area</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_MSOA</span> <span class="o">=</span> <span class="mi">140</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * New Deal for Community</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_NEW_DEAL_FOR_COMMUNITY</span> <span class="o">=</span> <span class="mi">201</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * National Park</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_NATIONAL_PARK</span> <span class="o">=</span> <span class="mi">17</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Output area</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_OA</span> <span class="o">=</span> <span class="mi">15</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Parish</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_PARISH</span> <span class="o">=</span> <span class="mi">16</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Postcode area</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_POSTCODE_AREA</span> <span class="o">=</span> <span class="mi">25</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Postcode</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_POSTCODE</span> <span class="o">=</span> <span class="mi">22</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Postcode 2</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_POSTCODE2</span> <span class="o">=</span> <span class="mi">257</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Primary Care Organisation</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_PRIMARY_CARE_ORG</span> <span class="o">=</span> <span class="mi">20</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Postcode district</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_POSTCODE_DISTRICT</span> <span class="o">=</span> <span class="mi">24</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Postcode sector</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_POSTCODE_SECTOR</span> <span class="o">=</span> <span class="mi">23</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Regional office</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_REGIONAL_OFFICE</span> <span class="o">=</span> <span class="mi">97</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Strategic Health Authority</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_STRATEGIC_HEALTH_AUTHORITY</span> <span class="o">=</span> <span class="mi">81</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Statistical neighbourhood</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_STAT_NEIGHBOURHOOD</span> <span class="o">=</span> <span class="mi">143</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Scottish Parliamentary region</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_SCOTTISH_PARL_REGION</span> <span class="o">=</span> <span class="mi">144</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Urban area</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_URBAN_AREA</span> <span class="o">=</span> <span class="mi">28</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * United Kingdom -- England, Scotland, Wales, N Ireland</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_UK</span> <span class="o">=</span> <span class="mi">7</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Urban subdivision</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_URBAN_SUBDIV</span> <span class="o">=</span> <span class="mi">29</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Upper layer super output area</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_USOA</span> <span class="o">=</span> <span class="mi">153</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Ward</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_WARD</span> <span class="o">=</span> <span class="mi">14</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Westminster Parliamentary constituency</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_WESTMINSTER_PARL_CONSTITUENCY</span> <span class="o">=</span> <span class="mi">27</span><span class="o">;</span>
	<span class="cm">/**</span>
<span class="cm">	 * Denotes an invalid/&quot;null&quot; leveltype</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEVELTYPE_NULL</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>

	<span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">areaId</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">levelTypeId</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">hierarchyId</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Area</span> <span class="n">parent</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;</span> <span class="n">children</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Subject</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">compatibleSubjects</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">Area</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">areaId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">levelTypeId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hierarchyId</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">areaId</span> <span class="o">=</span> <span class="n">areaId</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">levelTypeId</span> <span class="o">=</span> <span class="n">levelTypeId</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">hierarchyId</span> <span class="o">=</span> <span class="n">hierarchyId</span><span class="o">;</span>
		<span class="n">children</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="n">compatibleSubjects</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">protected</span> <span class="nf">Area</span><span class="o">(</span><span class="n">Area</span> <span class="n">copy</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="na">name</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">areaId</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="na">areaId</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">levelTypeId</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="na">levelTypeId</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">hierarchyId</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="na">hierarchyId</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="na">parent</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">children</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="na">children</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">Area</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @return The area&#39;s proper name</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">name</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @return The area&#39;s internal ID</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAreaId</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">areaId</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Comparable to Area.LEVELTYPE_ constants.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @return This area&#39;s administrative level type.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">getLevelTypeId</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">levelTypeId</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Comparable to Area.HIERARCHY_ constants.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @return This area&#39;s administrative hierarchy ID</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">getHierarchyId</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">hierarchyId</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param name</span>
<span class="cm">	 *            the name to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param areaId</span>
<span class="cm">	 *            the areaId to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAreaId</span><span class="o">(</span><span class="kt">int</span> <span class="n">areaId</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">areaId</span> <span class="o">=</span> <span class="n">areaId</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param levelTypeId</span>
<span class="cm">	 *            the levelTypeId to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLevelTypeId</span><span class="o">(</span><span class="kt">int</span> <span class="n">levelTypeId</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">levelTypeId</span> <span class="o">=</span> <span class="n">levelTypeId</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param hierarchyId</span>
<span class="cm">	 *            the hierarchyId to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setHierarchyId</span><span class="o">(</span><span class="kt">int</span> <span class="n">hierarchyId</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">hierarchyId</span> <span class="o">=</span> <span class="n">hierarchyId</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Set this area&#39;s parent (containing area).</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param parent</span>
<span class="cm">	 *            This area&#39;s parent/containing area.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setParent</span><span class="o">(</span><span class="n">Area</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @return A Set of child areas, fetching the information from NeSS if</span>
<span class="cm">	 *         necessary.</span>
<span class="cm">	 * @throws IOException</span>
<span class="cm">	 * @throws XmlPullParserException</span>
<span class="cm">	 * @throws NDE2Exception</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Area</span><span class="o">&gt;</span> <span class="nf">getChildren</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span><span class="o">,</span>
			<span class="n">NDE2Exception</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">children</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">children</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GetAreaChildren</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">children</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @return The parent area of this area.</span>
<span class="cm">	 * @throws NDE2Exception</span>
<span class="cm">	 * @throws XmlPullParserException</span>
<span class="cm">	 * @throws IOException</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Area</span> <span class="nf">getParent</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XmlPullParserException</span><span class="o">,</span>
			<span class="n">NDE2Exception</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">parent</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">parent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GetAreaParent</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">parent</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return {@link Subject Subjects} that are compatible with this area.</span>
<span class="cm">	 * @throws XmlPullParserException</span>
<span class="cm">	 * @throws IOException</span>
<span class="cm">	 * @throws NDE2Exception</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Subject</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">getCompatibleSubjects</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span>
			<span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">NDE2Exception</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">compatibleSubjects</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">{</span>
                <span class="n">compatibleSubjects</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GetCompatibleSubjects</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="n">compatibleSubjects</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param compatibleSubjects</span>
<span class="cm">	 *            {@link Subject Subjects} to set as compatible with this area.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCompatibleSubjects</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Subject</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">compatibleSubjects</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">compatibleSubjects</span> <span class="o">=</span> <span class="n">compatibleSubjects</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#hashCode()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">prime</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">areaId</span> <span class="o">^</span> <span class="o">(</span><span class="n">areaId</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">32</span><span class="o">));</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="n">hierarchyId</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="n">levelTypeId</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">name</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">name</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#equals(java.lang.Object)</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">Area</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="n">Area</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">Area</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">areaId</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="na">areaId</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">hierarchyId</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="na">hierarchyId</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">levelTypeId</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="na">levelTypeId</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">name</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">name</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">Boundary <small>nde2.pull.types</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">types</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Boundary</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

	<span class="kd">private</span> <span class="n">String</span> <span class="n">boundaryCode</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">envelope</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">identifier</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">__delivery_getTables_boundaryPointer</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">title</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">Boundary</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the boundaryCode</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getBoundaryCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">boundaryCode</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param boundaryCode</span>
<span class="cm">	 *            the boundaryCode to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setBoundaryCode</span><span class="o">(</span><span class="n">String</span> <span class="n">boundaryCode</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">boundaryCode</span> <span class="o">=</span> <span class="n">boundaryCode</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the envelope</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getEnvelope</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">envelope</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param envelope</span>
<span class="cm">	 *            the envelope to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEnvelope</span><span class="o">(</span><span class="n">String</span> <span class="n">envelope</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">envelope</span> <span class="o">=</span> <span class="n">envelope</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the identifier</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">getIdentifier</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">identifier</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param identifier</span>
<span class="cm">	 *            the identifier to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setIdentifier</span><span class="o">(</span><span class="kt">int</span> <span class="n">identifier</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">identifier</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">get__pointer</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">__delivery_getTables_boundaryPointer</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">set__pointer</span><span class="o">(</span><span class="kt">int</span> <span class="n">__delivery_getTables_boundaryPointer</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">__delivery_getTables_boundaryPointer</span> <span class="o">=</span> <span class="n">__delivery_getTables_boundaryPointer</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the title</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getTitle</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">title</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param title</span>
<span class="cm">	 *            the title to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTitle</span><span class="o">(</span><span class="n">String</span> <span class="n">title</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="n">title</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#hashCode()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">prime</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">boundaryCode</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">boundaryCode</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">envelope</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">envelope</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="n">identifier</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">title</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">title</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#equals(java.lang.Object)</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">Boundary</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="n">Boundary</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">Boundary</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">boundaryCode</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">boundaryCode</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">boundaryCode</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">boundaryCode</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">envelope</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">envelope</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">envelope</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">envelope</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">identifier</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="na">identifier</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">title</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">title</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">title</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">title</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">Dataset <small>nde2.pull.types</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">types</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Dataset</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

	<span class="kd">private</span> <span class="kt">int</span> <span class="n">familyId</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">creator</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">description</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">subjectCategory</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">title</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Topic</span><span class="o">&gt;</span> <span class="n">topics</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Period</span><span class="o">&gt;</span> <span class="n">periods</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Boundary</span><span class="o">&gt;</span> <span class="n">boundaries</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;</span> <span class="n">items</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">Dataset</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the familyId</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">getFamilyId</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">familyId</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param familyId</span>
<span class="cm">	 *            the familyId to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFamilyId</span><span class="o">(</span><span class="kt">int</span> <span class="n">familyId</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">familyId</span> <span class="o">=</span> <span class="n">familyId</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the creator</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getCreator</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">creator</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param creator</span>
<span class="cm">	 *            the creator to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCreator</span><span class="o">(</span><span class="n">String</span> <span class="n">creator</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">creator</span> <span class="o">=</span> <span class="n">creator</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the description</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getDescription</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">description</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param description</span>
<span class="cm">	 *            the description to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDescription</span><span class="o">(</span><span class="n">String</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the subjectCategory</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getSubjectCategory</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">subjectCategory</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param subjectCategory</span>
<span class="cm">	 *            the subjectCategory to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSubjectCategory</span><span class="o">(</span><span class="n">String</span> <span class="n">subjectCategory</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">subjectCategory</span> <span class="o">=</span> <span class="n">subjectCategory</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the title</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getTitle</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">title</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param title</span>
<span class="cm">	 *            the title to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTitle</span><span class="o">(</span><span class="n">String</span> <span class="n">title</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="n">title</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the topics</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Topic</span><span class="o">&gt;</span> <span class="n">getTopics</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">topics</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param dstopics</span>
<span class="cm">	 *            the topics to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTopics</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Topic</span><span class="o">&gt;</span> <span class="n">dstopics</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">topics</span> <span class="o">=</span> <span class="n">dstopics</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the period</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Period</span><span class="o">&gt;</span> <span class="n">getPeriods</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">periods</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param dsperiods</span>
<span class="cm">	 *            the period to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPeriods</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Period</span><span class="o">&gt;</span> <span class="n">dsperiods</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">periods</span> <span class="o">=</span> <span class="n">dsperiods</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the boundaries</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Boundary</span><span class="o">&gt;</span> <span class="n">getBoundaries</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">boundaries</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param dsboundaries</span>
<span class="cm">	 *            the boundaries to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setBoundaries</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Boundary</span><span class="o">&gt;</span> <span class="n">dsboundaries</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">boundaries</span> <span class="o">=</span> <span class="n">dsboundaries</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the items as a list</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;</span> <span class="nf">getItems</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">items</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param t topic to filter the dataset by</span>
<span class="cm">	 * @return the items with topic t</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;</span> <span class="nf">getItems</span><span class="o">(</span><span class="n">Topic</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Set</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;</span> <span class="n">filtered</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;();</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">DataSetItem</span> <span class="n">e</span> <span class="o">:</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getTopic</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">t</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">filtered</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">filtered</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param p period to filter the dataset by</span>
<span class="cm">	 * @return the items with period p</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;</span> <span class="nf">getItems</span><span class="o">(</span><span class="n">Period</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Set</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;</span> <span class="n">filtered</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;();</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">DataSetItem</span> <span class="n">e</span> <span class="o">:</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getTopic</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">p</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">filtered</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">filtered</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param b boundary to filter the dataset by</span>
<span class="cm">	 * @return the items with boundary b</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;</span> <span class="nf">getItems</span><span class="o">(</span><span class="n">Boundary</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Set</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;</span> <span class="n">filtered</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;();</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">DataSetItem</span> <span class="n">e</span> <span class="o">:</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getTopic</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">b</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">filtered</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">filtered</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param items</span>
<span class="cm">	 *            the items to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setItems</span><span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">DataSetItem</span><span class="o">&gt;</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">items</span> <span class="o">=</span> <span class="n">items</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#hashCode()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">prime</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">boundaries</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">boundaries</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">creator</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">creator</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">description</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">description</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="n">familyId</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">items</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">items</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">periods</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">periods</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">subjectCategory</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">subjectCategory</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">title</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">title</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">topics</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">topics</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#equals(java.lang.Object)</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">Dataset</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="n">Dataset</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">Dataset</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">boundaries</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">boundaries</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">boundaries</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">boundaries</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">creator</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">creator</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">creator</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">creator</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">description</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">description</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">description</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">description</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">familyId</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="na">familyId</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">items</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">items</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">items</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">items</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">periods</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">periods</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">periods</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">periods</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">subjectCategory</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">subjectCategory</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">subjectCategory</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">subjectCategory</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">title</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">title</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">title</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">title</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">topics</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">topics</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">topics</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">topics</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">DataSetFamily <small>nde2.pull.types</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">types</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Represents a dataset family, as returned by the NDE2 web service.</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataSetFamily</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

	<span class="kd">private</span> <span class="n">DateRange</span><span class="o">[]</span> <span class="n">dateRanges</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">familyId</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">DataSetFamily</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the date ranges of this dataset family</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">DateRange</span><span class="o">[]</span> <span class="nf">getDateRanges</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">dateRanges</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param dateRanges</span>
<span class="cm">	 *            the dateRanges to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDateRanges</span><span class="o">(</span><span class="n">DateRange</span><span class="o">[]</span> <span class="n">dateRanges</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">dateRanges</span> <span class="o">=</span> <span class="n">dateRanges</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the id of this dataset family</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">getFamilyId</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">familyId</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param familyId</span>
<span class="cm">	 *            the familyId to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFamilyId</span><span class="o">(</span><span class="kt">int</span> <span class="n">familyId</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">familyId</span> <span class="o">=</span> <span class="n">familyId</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the name</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">name</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param name</span>
<span class="cm">	 *            the name to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#hashCode()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">prime</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">hashCode</span><span class="o">(</span><span class="n">dateRanges</span><span class="o">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="n">familyId</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">name</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">name</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#equals(java.lang.Object)</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">DataSetFamily</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="n">DataSetFamily</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">DataSetFamily</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(!</span><span class="n">Arrays</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">dateRanges</span><span class="o">,</span> <span class="n">other</span><span class="o">.</span><span class="na">dateRanges</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">familyId</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="na">familyId</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">name</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">name</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">DataSetItem <small>nde2.pull.types</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">types</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataSetItem</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

	<span class="kd">private</span> <span class="n">Topic</span> <span class="n">topic</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Boundary</span> <span class="n">boundary</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Period</span> <span class="n">period</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">float</span> <span class="n">value</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">DataSetItem</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the topic</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Topic</span> <span class="nf">getTopic</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">topic</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param topic</span>
<span class="cm">	 *            the topic to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTopic</span><span class="o">(</span><span class="n">Topic</span> <span class="n">topic</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">topic</span> <span class="o">=</span> <span class="n">topic</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the boundary</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Boundary</span> <span class="nf">getBoundary</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">boundary</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param boundary</span>
<span class="cm">	 *            the boundary to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setBoundary</span><span class="o">(</span><span class="n">Boundary</span> <span class="n">boundary</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">boundary</span> <span class="o">=</span> <span class="n">boundary</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the period</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Period</span> <span class="nf">getPeriod</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">period</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param period</span>
<span class="cm">	 *            the period to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPeriod</span><span class="o">(</span><span class="n">Period</span> <span class="n">period</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">period</span> <span class="o">=</span> <span class="n">period</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the value</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">float</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">value</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param value</span>
<span class="cm">	 *            the value to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setValue</span><span class="o">(</span><span class="kt">float</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#hashCode()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">prime</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">boundary</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">boundary</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">period</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">period</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">topic</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">topic</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="n">Float</span><span class="o">.</span><span class="na">floatToIntBits</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#equals(java.lang.Object)</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">DataSetItem</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="n">DataSetItem</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">DataSetItem</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">boundary</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">boundary</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">boundary</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">boundary</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">period</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">period</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">period</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">period</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">topic</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">topic</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">topic</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">topic</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">Float</span><span class="o">.</span><span class="na">floatToIntBits</span><span class="o">(</span><span class="n">value</span><span class="o">)</span> <span class="o">!=</span> <span class="n">Float</span><span class="o">.</span><span class="na">floatToIntBits</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">value</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">DateRange <small>nde2.pull.types</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">types</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">nde2.helpers.DateFormat</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Represents a date range</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DateRange</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

	<span class="kd">private</span> <span class="n">Date</span> <span class="n">startDate</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Date</span> <span class="n">endDate</span><span class="o">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param startDate</span>
<span class="cm">	 *            Starting date of this date range</span>
<span class="cm">	 * @param endDate</span>
<span class="cm">	 *            ending date of this date range</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">DateRange</span><span class="o">(</span><span class="n">Date</span> <span class="n">startDate</span><span class="o">,</span> <span class="n">Date</span> <span class="n">endDate</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">startDate</span> <span class="o">=</span> <span class="n">startDate</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">endDate</span> <span class="o">=</span> <span class="n">endDate</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">DateRange</span><span class="o">(</span><span class="n">String</span> <span class="n">startDateString</span><span class="o">,</span> <span class="n">String</span> <span class="n">endDateString</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">startDate</span> <span class="o">=</span> <span class="n">DateFormat</span><span class="o">.</span><span class="na">fromNDEDateTime</span><span class="o">(</span><span class="n">startDateString</span><span class="o">);</span>
		<span class="n">endDate</span> <span class="o">=</span> <span class="n">DateFormat</span><span class="o">.</span><span class="na">fromNDEDateTime</span><span class="o">(</span><span class="n">endDateString</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">DateRange</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the Starting date of this date range</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Date</span> <span class="nf">getStartDate</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">startDate</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setStartDate</span><span class="o">(</span><span class="n">Date</span> <span class="n">startDate</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">startDate</span> <span class="o">=</span> <span class="n">startDate</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the ending date of this date range</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Date</span> <span class="nf">getEndDate</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">endDate</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEndDate</span><span class="o">(</span><span class="n">Date</span> <span class="n">endDate</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">endDate</span> <span class="o">=</span> <span class="n">endDate</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return The duration of this time range</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Date</span> <span class="nf">getDuration</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">Date</span><span class="o">(</span><span class="n">endDate</span><span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">startDate</span><span class="o">.</span><span class="na">getTime</span><span class="o">());</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @see java.lang.Object#hashCode()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">prime</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">endDate</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">endDate</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">startDate</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">startDate</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @see java.lang.Object#equals(java.lang.Object)</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">DateRange</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="n">DateRange</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">DateRange</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">endDate</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">endDate</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">endDate</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">endDate</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">startDate</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">startDate</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">startDate</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">startDate</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Find the most recent date range in the array</span>
<span class="cm">     * @param dateRanges the array to search</span>
<span class="cm">     * @return the date range whose end date is closest to now</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">DateRange</span> <span class="nf">mostRecent</span><span class="o">(</span><span class="n">DateRange</span><span class="o">[]</span> <span class="n">dateRanges</span><span class="o">){</span>
        <span class="n">DateRange</span> <span class="n">ret</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="kt">long</span> <span class="n">smallestDifference</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span>
        <span class="k">for</span><span class="o">(</span><span class="n">DateRange</span> <span class="n">r</span> <span class="o">:</span> <span class="n">dateRanges</span><span class="o">){</span>
            <span class="kt">long</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">r</span><span class="o">.</span><span class="na">endDate</span><span class="o">.</span><span class="na">getTime</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="n">smallestDifference</span><span class="o">){</span>
                <span class="n">smallestDifference</span> <span class="o">=</span> <span class="n">diff</span><span class="o">;</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">ret</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">DetailedArea <small>nde2.pull.types</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">types</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>

<span class="cm">/**</span>
<span class="cm"> * This class of objects represents UK&#39;s administrative and geographical areas</span>
<span class="cm"> * in more detail. You want this in order to get the OS-grid encoded envelope</span>
<span class="cm"> * for this area if you want to use maps.</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * @see {@link Area}</span>
<span class="cm"> */</span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;SameParameterValue&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DetailedArea</span> <span class="kd">extends</span> <span class="n">Area</span> <span class="o">{</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

	<span class="kd">private</span> <span class="n">String</span> <span class="n">extCode</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">envelope</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">mandatoryMetadata</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">optionalMetadata</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">DetailedArea</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">areaId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">levelTypeId</span><span class="o">,</span>
			<span class="kt">int</span> <span class="n">hierarchyId</span><span class="o">,</span> <span class="n">String</span> <span class="n">extCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">envelope</span><span class="o">,</span>
			<span class="n">String</span> <span class="n">mandatoryMetadata</span><span class="o">,</span> <span class="n">String</span> <span class="n">optionalMetadata</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">areaId</span><span class="o">,</span> <span class="n">levelTypeId</span><span class="o">,</span> <span class="n">hierarchyId</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">envelope</span> <span class="o">=</span> <span class="n">envelope</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">extCode</span> <span class="o">=</span> <span class="n">extCode</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">mandatoryMetadata</span> <span class="o">=</span> <span class="n">mandatoryMetadata</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">optionalMetadata</span> <span class="o">=</span> <span class="n">optionalMetadata</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">DetailedArea</span><span class="o">(</span><span class="n">Area</span> <span class="n">area</span><span class="o">,</span> <span class="n">String</span> <span class="n">extCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">envelope</span><span class="o">,</span>
			<span class="n">String</span> <span class="n">mandatoryMetadata</span><span class="o">,</span> <span class="n">String</span> <span class="n">optionalMetadata</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">envelope</span> <span class="o">=</span> <span class="n">envelope</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">extCode</span> <span class="o">=</span> <span class="n">extCode</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">mandatoryMetadata</span> <span class="o">=</span> <span class="n">mandatoryMetadata</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">optionalMetadata</span> <span class="o">=</span> <span class="n">optionalMetadata</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">DetailedArea</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return The SNAC code for this area. Useful for Mapit.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getExtCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">extCode</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param extCode</span>
<span class="cm">	 *            the SNAC code to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setExtCode</span><span class="o">(</span><span class="n">String</span> <span class="n">extCode</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">extCode</span> <span class="o">=</span> <span class="n">extCode</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * This is not a polygon wrapping the area by its borders; there&#39;s an</span>
<span class="cm">	 * OpenSpace API for that. This is just a rectangle that is just big enough</span>
<span class="cm">	 * to contain this area.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @return Ordnance Survey easting/northing envelope of this area.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getEnvelope</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">envelope</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param envelope</span>
<span class="cm">	 *            the envelope to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEnvelope</span><span class="o">(</span><span class="n">String</span> <span class="n">envelope</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">envelope</span> <span class="o">=</span> <span class="n">envelope</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @return The &quot;mandatory&quot; metadata for this area.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getMandatoryMetadata</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">mandatoryMetadata</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param mandatoryMetadata</span>
<span class="cm">	 *            the mandatoryMetadata to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMandatoryMetadata</span><span class="o">(</span><span class="n">String</span> <span class="n">mandatoryMetadata</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">mandatoryMetadata</span> <span class="o">=</span> <span class="n">mandatoryMetadata</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the &quot;optional&quot; metadata</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getOptionalMetadata</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">optionalMetadata</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param optionalMetadata</span>
<span class="cm">	 *            the optionalMetadata to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setOptionalMetadata</span><span class="o">(</span><span class="n">String</span> <span class="n">optionalMetadata</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">optionalMetadata</span> <span class="o">=</span> <span class="n">optionalMetadata</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#hashCode()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">prime</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">envelope</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">envelope</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">extCode</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">extCode</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span>
				<span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">mandatoryMetadata</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">mandatoryMetadata</span>
						<span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span>
				<span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">optionalMetadata</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">optionalMetadata</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#equals(java.lang.Object)</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(!</span><span class="kd">super</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">obj</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">DetailedArea</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="n">DetailedArea</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">DetailedArea</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">envelope</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">envelope</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">envelope</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">envelope</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">extCode</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">extCode</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">extCode</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">extCode</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">mandatoryMetadata</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">mandatoryMetadata</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">mandatoryMetadata</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">mandatoryMetadata</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">optionalMetadata</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">optionalMetadata</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">optionalMetadata</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">optionalMetadata</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">DetailedSubject <small>nde2.pull.types</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">types</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParserException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">nde2.errors.NDE2Exception</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * A more detailed representation of a subject. Has *two* descriptions!</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * @see {@link Subject}</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DetailedSubject</span> <span class="kd">extends</span> <span class="n">Subject</span> <span class="o">{</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">description</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">moreDescription</span><span class="o">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param name subject name</span>
<span class="cm">	 * @param id subject id</span>
<span class="cm">	 * @param description the description to set</span>
<span class="cm">	 * @param moreDescription additional information</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">DetailedSubject</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="n">String</span> <span class="n">description</span><span class="o">,</span>
			<span class="n">String</span> <span class="n">moreDescription</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">moreDescription</span> <span class="o">=</span> <span class="n">moreDescription</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">DetailedSubject</span><span class="o">(</span><span class="n">Subject</span> <span class="n">basic</span><span class="o">,</span> <span class="n">String</span> <span class="n">description</span><span class="o">,</span>
			<span class="n">String</span> <span class="n">moreDescription</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">basic</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">moreDescription</span> <span class="o">=</span> <span class="n">moreDescription</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">DetailedSubject</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the description</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getDescription</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">description</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param description</span>
<span class="cm">	 *            the description to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDescription</span><span class="o">(</span><span class="n">String</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the moreDescription</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getMoreDescription</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">moreDescription</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param moreDescription</span>
<span class="cm">	 *            the moreDescription to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMoreDescription</span><span class="o">(</span><span class="n">String</span> <span class="n">moreDescription</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">moreDescription</span> <span class="o">=</span> <span class="n">moreDescription</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return Itself. It&#39;s already a DetailedSubject after all.</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">DetailedSubject</span> <span class="nf">getDetailed</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span>
			<span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">NDE2Exception</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#hashCode()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">prime</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">description</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">description</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">moreDescription</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">moreDescription</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#equals(java.lang.Object)</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(!</span><span class="kd">super</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">obj</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">DetailedSubject</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="n">DetailedSubject</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">DetailedSubject</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">description</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">description</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">description</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">description</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">moreDescription</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">moreDescription</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">moreDescription</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">moreDescription</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">Period <small>nde2.pull.types</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">types</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Period</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">char</span> <span class="n">SINGLE_DATE</span> <span class="o">=</span> <span class="sc">&#39;s&#39;</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">char</span> <span class="n">DATE_RANGE</span> <span class="o">=</span> <span class="sc">&#39;r&#39;</span><span class="o">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

	<span class="kd">private</span> <span class="n">Date</span> <span class="n">startDate</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Date</span> <span class="n">endDate</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">char</span> <span class="n">periodType</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">__delivery_getTables_periodPointer</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">Period</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the starting date</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Date</span> <span class="nf">getStartDate</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">startDate</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the ending date</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Date</span> <span class="nf">getEndDate</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">endDate</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">get__pointer</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">__delivery_getTables_periodPointer</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">char</span> <span class="nf">getPeriodType</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">periodType</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param startDate</span>
<span class="cm">	 *            the startDate to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setStartDate</span><span class="o">(</span><span class="n">Date</span> <span class="n">startDate</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">startDate</span> <span class="o">=</span> <span class="n">startDate</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param endDate</span>
<span class="cm">	 *            the endDate to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEndDate</span><span class="o">(</span><span class="n">Date</span> <span class="n">endDate</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">endDate</span> <span class="o">=</span> <span class="n">endDate</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param __delivery_getTables_periodPointer</span>
<span class="cm">	 *            the __delivery_getTables_periodPointer to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">set__pointer</span><span class="o">(</span><span class="kt">int</span> <span class="n">__delivery_getTables_periodPointer</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">__delivery_getTables_periodPointer</span> <span class="o">=</span> <span class="n">__delivery_getTables_periodPointer</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPeriodType</span><span class="o">(</span><span class="kt">char</span> <span class="n">periodType</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">periodType</span> <span class="o">=</span> <span class="n">periodType</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#hashCode()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">prime</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">endDate</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">endDate</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="n">periodType</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">startDate</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">startDate</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#equals(java.lang.Object)</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">Period</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="n">Period</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">Period</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">endDate</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">endDate</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">endDate</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">endDate</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">periodType</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="na">periodType</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">startDate</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">startDate</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">startDate</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">startDate</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">Subject <small>nde2.pull.types</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">types</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">org.xmlpull.v1.XmlPullParserException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">nde2.errors.NDE2Exception</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.methodcalls.discovery.GetSubjectDetail</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Represents a subject in the NDE database.</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * @see {@link DetailedSubject}</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Subject</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

	<span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">Subject</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">protected</span> <span class="nf">Subject</span><span class="o">(</span><span class="n">Subject</span> <span class="n">copy</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="na">name</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="na">id</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">Subject</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @return The subject&#39;s proper name</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">name</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @return The subject&#39;s ID, used for NDE querying.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">id</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param name</span>
<span class="cm">	 *            the name to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param id</span>
<span class="cm">	 *            the id to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 * @return A detailed representation of this Subject, containing description</span>
<span class="cm">	 *         and explanation of the subject.</span>
<span class="cm">	 * @throws IOException</span>
<span class="cm">	 * @throws XmlPullParserException</span>
<span class="cm">	 * @throws NDE2Exception</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">DetailedSubject</span> <span class="nf">getDetailed</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span>
			<span class="n">XmlPullParserException</span><span class="o">,</span> <span class="n">NDE2Exception</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">GetSubjectDetail</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#hashCode()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">prime</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">name</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">name</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#equals(java.lang.Object)</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">Subject</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="n">Subject</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">Subject</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">id</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="na">id</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">name</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">name</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">Topic <small>nde2.pull.types</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">types</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * A column in a {@link Dataset}. To get values that belong to this column from</span>
<span class="cm"> * a data set, use {@link Dataset#getItems(Topic)}</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Topic</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

	<span class="kd">private</span> <span class="kt">int</span> <span class="n">__delivery_getTables_topicPointer</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">topicId</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">datasetFamilyId</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">creator</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">description</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">title</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">coinageUnit</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">Topic</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * &lt;b&gt;Do not use&lt;/b&gt;: If you need a primary-key ID of this Topic, use</span>
<span class="cm">	 * {@link Topic#getTopicCode()} instead. This is only useful when ordering</span>
<span class="cm">	 * topics during the creation of a {@link Dataset}.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @return the ID element of the Topic that is used in the response</span>
<span class="cm">	 *         document. Actually an internal pointer that links topics and</span>
<span class="cm">	 *         items together when SOAP serialized.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">get__pointer</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">__delivery_getTables_topicPointer</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the ID of this topic</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">getTopicId</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">topicId</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the identifier -- which is also the id of the</span>
<span class="cm">	 *         {@link DataSetFamily} this Topic is in.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">getDatasetFamilyId</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">datasetFamilyId</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the creator</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getCreator</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">creator</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the description</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getDescription</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">description</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the title</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getTitle</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">title</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the the unit in which this value is presented. Count, Percentage,</span>
<span class="cm">	 *         etc.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getCoinageUnit</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">coinageUnit</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param the</span>
<span class="cm">	 *            __pointer to set. explanation in get__pointer().</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">set__pointer</span><span class="o">(</span><span class="kt">int</span> <span class="n">__delivery_getTables_topicPointer</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">__delivery_getTables_topicPointer</span> <span class="o">=</span> <span class="n">__delivery_getTables_topicPointer</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param topicId</span>
<span class="cm">	 *            the topicCode to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTopicId</span><span class="o">(</span><span class="kt">int</span> <span class="n">topicId</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">topicId</span> <span class="o">=</span> <span class="n">topicId</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param identifier</span>
<span class="cm">	 *            the identifier to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDatasetFamilyId</span><span class="o">(</span><span class="kt">int</span> <span class="n">identifier</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">datasetFamilyId</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param creator</span>
<span class="cm">	 *            the creator to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCreator</span><span class="o">(</span><span class="n">String</span> <span class="n">creator</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">creator</span> <span class="o">=</span> <span class="n">creator</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param description</span>
<span class="cm">	 *            the description to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDescription</span><span class="o">(</span><span class="n">String</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param title</span>
<span class="cm">	 *            the title to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTitle</span><span class="o">(</span><span class="n">String</span> <span class="n">title</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="n">title</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param coinageUnit</span>
<span class="cm">	 *            the coinageUnit to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCoinageUnit</span><span class="o">(</span><span class="n">String</span> <span class="n">coinageUnit</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">coinageUnit</span> <span class="o">=</span> <span class="n">coinageUnit</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#hashCode()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">prime</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">coinageUnit</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">coinageUnit</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">creator</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">creator</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">description</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">description</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="n">datasetFamilyId</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">title</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">title</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="n">topicId</span><span class="o">;</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#equals(java.lang.Object)</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">Topic</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="n">Topic</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">Topic</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">coinageUnit</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">coinageUnit</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">coinageUnit</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">coinageUnit</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">creator</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">creator</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">creator</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">creator</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">description</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">description</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">description</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">description</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">datasetFamilyId</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="na">datasetFamilyId</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">title</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">title</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">title</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">title</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">topicId</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="na">topicId</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">Mapper <small>org.mysociety.mapit</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">mysociety</span><span class="o">.</span><span class="na">mapit</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.content.ContentResolver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.ContentValues</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.database.Cursor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.google.gson.JsonArray</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.gson.JsonElement</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.gson.JsonObject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.gson.JsonParser</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.commons.io.IOUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xml.sax.SAXException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.HttpURLConnection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.URL</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Nullable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.parsers.ParserConfigurationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.xpath.XPathExpressionException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lamparski.areabase.AreaActivity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.CacheContentProvider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.CacheDbOpenHelper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.errors.NDE2Exception</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nde2.pull.methodcalls.discovery.GetAreaDetail</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * MapIt is a service that maps UK postcodes and geographical points to administrative areas.</span>
<span class="cm"> * It’s useful for anyone who has a postcode or co-ordinates of a point in the UK,</span>
<span class="cm"> * and needs to find out what region, constituency, or council it lies within. It’s also great for</span>
<span class="cm"> * looking up the shapes of all those boundaries.</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;Areabase uses Mapit to get the boundary polygons (shapes) of the areas examined.&lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;&lt;a href=&quot;http://mapit.mysociety.org/&quot;&gt;See original docs&lt;/a&gt;&lt;/p&gt;</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Mapper</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">CALL</span> <span class="o">=</span> <span class="s">&quot;http://mapit.mysociety.org/area/%s.geojson&quot;</span><span class="o">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Tries to get the geometry from database, and returns null if it can&#39;t.</span>
<span class="cm">     * @param url The query url</span>
<span class="cm">     * @return a JsonElement that holds the geometry, or null if there&#39;s no cache entry for it</span>
<span class="cm">     * @throws Exception</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nd">@Nullable</span> <span class="n">JsonElement</span> <span class="n">getJsonFromDatabase</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ContentResolver</span> <span class="n">contentResolver</span> <span class="o">=</span> <span class="n">AreaActivity</span>
                <span class="o">.</span><span class="na">getAreabaseApplicationContext</span><span class="o">().</span><span class="na">getContentResolver</span><span class="o">();</span>

        <span class="n">String</span><span class="o">[]</span> <span class="n">selectionArgs</span> <span class="o">=</span> <span class="o">{</span> <span class="n">url</span><span class="o">,</span>
                <span class="n">Long</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="n">l</span><span class="o">)</span> <span class="o">};</span>
        <span class="n">Cursor</span> <span class="n">c</span> <span class="o">=</span> <span class="n">contentResolver</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">CacheContentProvider</span><span class="o">.</span><span class="na">MAPIT_CACHE_URI</span><span class="o">,</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]{</span> <span class="s">&quot;*&quot;</span> <span class="o">},</span> <span class="s">&quot;url = ? AND retrievedOn &gt; ?&quot;</span><span class="o">,</span>
                <span class="n">selectionArgs</span><span class="o">,</span> <span class="s">&quot;retrievedOn DESC&quot;</span><span class="o">);</span>

        <span class="k">if</span><span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="o">}</span>

        <span class="n">String</span> <span class="n">response</span><span class="o">;</span>
        <span class="k">if</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">moveToFirst</span><span class="o">()){</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;BaseMethodCall&quot;</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
                    <span class="s">&quot;A cached instance of %s is available, returning.\n&quot;</span><span class="o">,</span>
                    <span class="n">url</span><span class="o">));</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">getColumnIndex</span><span class="o">(</span><span class="s">&quot;cachedObject&quot;</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">response</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">c</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;Mapper&quot;</span><span class="o">,</span> <span class="s">&quot;A cached instance of &quot;</span> <span class="o">+</span> <span class="n">url</span> <span class="o">+</span> <span class="s">&quot; is available, returning.&quot;</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">response</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="k">new</span> <span class="n">JsonParser</span><span class="o">().</span><span class="na">parse</span><span class="o">(</span><span class="n">response</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Actually get this from Mapit</span>
<span class="cm">     * @param url the url to get</span>
<span class="cm">     * @return a JsonElement that holds the geometry</span>
<span class="cm">     * @throws Exception</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">JsonElement</span> <span class="nf">getJsonFromMapit</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// Uncomment for testing:</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;Mapper&quot;</span><span class="o">,</span> <span class="s">&quot;Calling &quot;</span> <span class="o">+</span> <span class="n">url</span><span class="o">);</span>

        <span class="n">URL</span> <span class="n">callUrl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
        <span class="n">HttpURLConnection</span> <span class="n">callConnection</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpURLConnection</span><span class="o">)</span> <span class="n">callUrl</span>
                <span class="o">.</span><span class="na">openConnection</span><span class="o">();</span>
        <span class="c1">// The ten-second rule:</span>
        <span class="c1">// If there&#39;s no data in 10s (or TIMEOUT), assume the worst.</span>
        <span class="n">callConnection</span><span class="o">.</span><span class="na">setReadTimeout</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
        <span class="c1">// Set the request method to GET.</span>
        <span class="n">callConnection</span><span class="o">.</span><span class="na">setRequestMethod</span><span class="o">(</span><span class="s">&quot;GET&quot;</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">code</span> <span class="o">=</span> <span class="n">callConnection</span><span class="o">.</span><span class="na">getResponseCode</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">code</span> <span class="o">!=</span> <span class="n">HttpURLConnection</span><span class="o">.</span><span class="na">HTTP_OK</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="o">(</span><span class="s">&quot;A non-200 code was returned: &quot;</span> <span class="o">+</span> <span class="n">code</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">String</span> <span class="n">responseStr</span><span class="o">;</span>
        <span class="n">responseStr</span> <span class="o">=</span> <span class="n">IOUtils</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">callConnection</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
        <span class="n">callConnection</span><span class="o">.</span><span class="na">disconnect</span><span class="o">();</span>

        <span class="n">ContentResolver</span> <span class="n">contentResolver</span> <span class="o">=</span> <span class="n">AreaActivity</span>
                <span class="o">.</span><span class="na">getAreabaseApplicationContext</span><span class="o">().</span><span class="na">getContentResolver</span><span class="o">();</span>
        <span class="n">ContentValues</span> <span class="n">cacheValues</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContentValues</span><span class="o">();</span>
        <span class="n">cacheValues</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">CacheDbOpenHelper</span><span class="o">.</span><span class="na">BaseCacheTable</span><span class="o">.</span><span class="na">FIELD_URL</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span>
        <span class="n">cacheValues</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">CacheDbOpenHelper</span><span class="o">.</span><span class="na">BaseCacheTable</span><span class="o">.</span><span class="na">FIELD_RETRIEVED_ON</span><span class="o">,</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
        <span class="n">cacheValues</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">CacheDbOpenHelper</span><span class="o">.</span><span class="na">BaseCacheTable</span><span class="o">.</span><span class="na">FIELD_CACHED_OBJECT</span><span class="o">,</span> <span class="n">responseStr</span><span class="o">);</span>
        <span class="n">contentResolver</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">CacheContentProvider</span><span class="o">.</span><span class="na">MAPIT_CACHE_URI</span><span class="o">,</span> <span class="n">cacheValues</span><span class="o">);</span>

        <span class="n">JsonParser</span> <span class="n">jp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JsonParser</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">jp</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">responseStr</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Try to return the json element from cache, then from the web service if that fails.</span>
<span class="cm">     * @param arg ONS area code (NOT {@link nde2.pull.types.Area#getAreaId()})</span>
<span class="cm">     * @return a JsonElement that holds the geometry</span>
<span class="cm">     * @throws Exception</span>
<span class="cm">     */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="n">JsonElement</span> <span class="nf">getJson</span><span class="o">(</span><span class="n">String</span> <span class="n">arg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">full_url</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">CALL</span><span class="o">,</span> <span class="n">arg</span><span class="o">);</span>

        <span class="n">JsonElement</span> <span class="n">jsonElement</span> <span class="o">=</span> <span class="n">getJsonFromDatabase</span><span class="o">(</span><span class="n">full_url</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">jsonElement</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">jsonElement</span> <span class="o">=</span> <span class="n">getJsonFromMapit</span><span class="o">(</span><span class="n">full_url</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">jsonElement</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Gets the geometry for the specified area.</span>
<span class="cm">     * @param area The area to find the boundary of.</span>
<span class="cm">     * @return Array of coordinates ((lon, lat), ...) that make up the shape of the boundary.</span>
<span class="cm">     * @throws Exception</span>
<span class="cm">     */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">double</span><span class="o">[][]</span> <span class="nf">getGeometryForArea</span><span class="o">(</span><span class="n">nde2</span><span class="o">.</span><span class="na">pull</span><span class="o">.</span><span class="na">types</span><span class="o">.</span><span class="na">Area</span> <span class="n">area</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">XPathExpressionException</span><span class="o">,</span> <span class="n">ParserConfigurationException</span><span class="o">,</span>
			<span class="n">SAXException</span><span class="o">,</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">NDE2Exception</span><span class="o">,</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">JsonElement</span> <span class="n">_root</span> <span class="o">=</span> <span class="n">getJson</span><span class="o">(</span><span class="k">new</span> <span class="n">GetAreaDetail</span><span class="o">(</span><span class="n">area</span><span class="o">).</span><span class="na">execute</span><span class="o">()</span>
				<span class="o">.</span><span class="na">getExtCode</span><span class="o">());</span>
		<span class="n">JsonObject</span> <span class="n">geojson</span> <span class="o">=</span> <span class="n">_root</span><span class="o">.</span><span class="na">getAsJsonObject</span><span class="o">();</span>
		<span class="n">JsonArray</span> <span class="n">coord_ja</span> <span class="o">=</span> <span class="n">geojson</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;coordinates&quot;</span><span class="o">).</span><span class="na">getAsJsonArray</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
				<span class="o">.</span><span class="na">getAsJsonArray</span><span class="o">();</span>
		<span class="kt">double</span><span class="o">[][]</span> <span class="n">coords</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">double</span><span class="o">[</span><span class="n">coord_ja</span><span class="o">.</span><span class="na">size</span><span class="o">()][</span><span class="mi">2</span><span class="o">];</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">coord_ja</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">JsonArray</span> <span class="n">jsonCoordPair</span> <span class="o">=</span> <span class="n">coord_ja</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">getAsJsonArray</span><span class="o">();</span>
			<span class="n">coords</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">jsonCoordPair</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getAsDouble</span><span class="o">();</span>
			<span class="n">coords</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">jsonCoordPair</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">getAsDouble</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">coords</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">package-info <small>ense-block</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*//**</span>
<span class="cm"> * &lt;p&gt;A client for the UK Police Data API.&lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;&lt;a href=&quot;http://data.police.uk/docs/&quot;&gt;See the API documentation&lt;/a&gt;&lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;The Police Data API allows its users to access crime data. It is a RESTful service,</span>
<span class="cm"> * and uses JSON to return data. Therefore, this code uses either the {@link com.google.gson.JsonParser} low-level</span>
<span class="cm"> * classes, or the {@link com.google.gson.Gson} reflection-based parser depending on where it makes sense.&lt;/p&gt;</span>
<span class="cm"> */</span>
<span class="kn">package</span> <span class="n">police</span><span class="o">;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">APIException <small>police.errors</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">police</span><span class="o">.</span><span class="na">errors</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="cm">/**</span>
<span class="cm"> * An exception that can be thrown in case of a REST-ful service error</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">APIException</span> <span class="kd">extends</span> <span class="n">Exception</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kt">int</span> <span class="n">httpCode</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">705215153574849785L</span><span class="o">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * </span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">APIException</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">();</span>
		<span class="c1">// TODO Auto-generated constructor stub</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param message the message attached to this exception</span>
<span class="cm">	 * @param cause a throwable cause (usually another exception)</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">APIException</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
		<span class="c1">// TODO Auto-generated constructor stub</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param message the message attached to this exception</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">APIException</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
		<span class="c1">// TODO Auto-generated constructor stub</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">APIException</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">,</span> <span class="kt">int</span> <span class="n">httpCode</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">httpCode</span> <span class="o">=</span> <span class="n">httpCode</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param cause a throwable cause (usually another exception)</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">APIException</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
		<span class="c1">// TODO Auto-generated constructor stub</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the http code returned by the service</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">getHttpCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">httpCode</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param httpCode</span>
<span class="cm">	 *            the http code returned by the service</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setHttpCode</span><span class="o">(</span><span class="kt">int</span> <span class="n">httpCode</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">httpCode</span> <span class="o">=</span> <span class="n">httpCode</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">BaseMethodCall <small>police.methodcalls</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">police</span><span class="o">.</span><span class="na">methodcalls</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.content.ContentResolver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.ContentValues</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.database.Cursor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.commons.io.IOUtils</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.net.HttpURLConnection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.URL</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map.Entry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Nullable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lamparski.areabase.AreaActivity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.CacheContentProvider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lamparski.areabase.CacheDbOpenHelper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">police.errors.APIException</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Base class from which all MethodCalls inherit. Contains</span>
<span class="cm"> * {@link BaseMethodCall#doCall(String, Map)}, which encodes the request into an</span>
<span class="cm"> * URL and fetches the JSON response from the Police API.</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BaseMethodCall</span> <span class="o">{</span>
	<span class="kd">protected</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">ENDPOINT</span> <span class="o">=</span> <span class="s">&quot;http://data.police.uk/api/&quot;</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">TIMEOUT</span> <span class="o">=</span> <span class="mi">10000</span><span class="o">;</span>

    <span class="cm">/**</span>
<span class="cm">     * This method will actually pull new data from the web service</span>
<span class="cm">     * @param url the url to fetch data from</span>
<span class="cm">     * @return response returned by the server -- a JSON document</span>
<span class="cm">     * @throws Exception</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="nf">doCallToAPI</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="n">URL</span> <span class="n">callUrl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
        <span class="n">HttpURLConnection</span> <span class="n">callConnection</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpURLConnection</span><span class="o">)</span> <span class="n">callUrl</span>
                <span class="o">.</span><span class="na">openConnection</span><span class="o">();</span>
        <span class="c1">// The ten-second rule:</span>
        <span class="c1">// If there&#39;s no data in 5s (or TIMEOUT), assume the worst.</span>
        <span class="n">callConnection</span><span class="o">.</span><span class="na">setReadTimeout</span><span class="o">(</span><span class="n">TIMEOUT</span><span class="o">);</span>
        <span class="c1">// Set the request method to GET.</span>
        <span class="n">callConnection</span><span class="o">.</span><span class="na">setRequestMethod</span><span class="o">(</span><span class="s">&quot;GET&quot;</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">code</span> <span class="o">=</span> <span class="n">callConnection</span><span class="o">.</span><span class="na">getResponseCode</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">code</span> <span class="o">!=</span> <span class="n">HttpURLConnection</span><span class="o">.</span><span class="na">HTTP_OK</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">APIException</span><span class="o">(</span><span class="s">&quot;A non-200 code was returned&quot;</span><span class="o">,</span> <span class="n">code</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">String</span> <span class="n">responseStr</span><span class="o">;</span>
        <span class="n">responseStr</span> <span class="o">=</span> <span class="n">IOUtils</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">callConnection</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
        <span class="n">callConnection</span><span class="o">.</span><span class="na">disconnect</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">responseStr</span><span class="o">;</span>
    <span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Gets the response from the API or the database.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param method</span>
<span class="cm">	 *            The method to call (URL after /api/)</span>
<span class="cm">	 * @param params</span>
<span class="cm">	 *            A map containing the GET parameters (query for the API)</span>
<span class="cm">	 * @return A String, which contains the JSON response.</span>
<span class="cm">	 */</span>
	<span class="kd">protected</span> <span class="n">String</span> <span class="nf">doCall</span><span class="o">(</span><span class="n">String</span> <span class="n">method</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">StringBuilder</span> <span class="n">paramsBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="n">ENDPOINT</span><span class="o">)</span>
				<span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">method</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">params</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">paramsBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;?&quot;</span><span class="o">);</span>
			<span class="n">Set</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">paramsSet</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="na">entrySet</span><span class="o">();</span>
			<span class="k">for</span> <span class="o">(</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">param</span> <span class="o">:</span> <span class="n">paramsSet</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">paramsBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">getKey</span><span class="o">()).</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;=&quot;</span><span class="o">)</span>
						<span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">getValue</span><span class="o">()).</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;&amp;&quot;</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Remove the trailing &amp;</span>
<span class="cm">		 */</span>
		<span class="n">String</span> <span class="n">paramString</span> <span class="o">=</span> <span class="n">paramsBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">paramString</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&quot;&amp;&quot;</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">paramString</span> <span class="o">=</span> <span class="n">paramString</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">paramString</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
		<span class="o">}</span>

        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;BaseMethodCall&quot;</span><span class="o">,</span> <span class="s">&quot;Calling &quot;</span> <span class="o">+</span> <span class="n">paramString</span><span class="o">);</span>

		<span class="n">String</span> <span class="n">responseStr</span> <span class="o">=</span> <span class="n">doCallToDB</span><span class="o">(</span><span class="n">paramString</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">responseStr</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">responseStr</span> <span class="o">=</span> <span class="n">doCallToAPI</span><span class="o">(</span><span class="n">paramString</span><span class="o">);</span>

            <span class="n">ContentResolver</span> <span class="n">contentResolver</span> <span class="o">=</span> <span class="n">AreaActivity</span>
                    <span class="o">.</span><span class="na">getAreabaseApplicationContext</span><span class="o">().</span><span class="na">getContentResolver</span><span class="o">();</span>
            <span class="n">ContentValues</span> <span class="n">cacheValues</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContentValues</span><span class="o">();</span>

            <span class="n">cacheValues</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">CacheDbOpenHelper</span><span class="o">.</span><span class="na">BaseCacheTable</span><span class="o">.</span><span class="na">FIELD_RETRIEVED_ON</span><span class="o">,</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
            <span class="n">cacheValues</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">CacheDbOpenHelper</span><span class="o">.</span><span class="na">BaseCacheTable</span><span class="o">.</span><span class="na">FIELD_CACHED_OBJECT</span><span class="o">,</span> <span class="n">responseStr</span><span class="o">);</span>
            <span class="c1">// Update existing entry...</span>
            <span class="kt">int</span> <span class="n">rowsUpdated</span> <span class="o">=</span> <span class="n">contentResolver</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">CacheContentProvider</span><span class="o">.</span><span class="na">POLICE_CACHE_URI</span><span class="o">,</span> <span class="n">cacheValues</span><span class="o">,</span> <span class="s">&quot;url = ?&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span><span class="n">paramString</span><span class="o">});</span>
            <span class="c1">// ...or create one.</span>
            <span class="k">if</span><span class="o">(</span><span class="n">rowsUpdated</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
                <span class="n">cacheValues</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">CacheDbOpenHelper</span><span class="o">.</span><span class="na">BaseCacheTable</span><span class="o">.</span><span class="na">FIELD_URL</span><span class="o">,</span> <span class="n">paramString</span><span class="o">);</span>
                <span class="n">contentResolver</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">CacheContentProvider</span><span class="o">.</span><span class="na">POLICE_CACHE_URI</span><span class="o">,</span> <span class="n">cacheValues</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

		<span class="k">return</span> <span class="n">responseStr</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Tries to fetch a cached instance of the crime dataset</span>
<span class="cm">     * @param url call url to check data for</span>
<span class="cm">     * @return a cached JSON document, or null if there isn&#39;t any in the database</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">doCallToDB</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ContentResolver</span> <span class="n">contentResolver</span> <span class="o">=</span> <span class="n">AreaActivity</span>
                <span class="o">.</span><span class="na">getAreabaseApplicationContext</span><span class="o">().</span><span class="na">getContentResolver</span><span class="o">();</span>

        <span class="n">String</span><span class="o">[]</span> <span class="n">selectionArgs</span> <span class="o">=</span> <span class="o">{</span> <span class="n">url</span><span class="o">,</span>
                <span class="n">Long</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="n">l</span><span class="o">)</span> <span class="o">};</span>
        <span class="cm">/*</span>
<span class="cm">        The query will be equivalent to the following SQL:</span>
<span class="cm">        SELECT * FROM policeCache</span>
<span class="cm">        WHERE url = @url AND retrievedOn &gt; @30_days_ago</span>
<span class="cm">        ORDER BY retrievedOn DESC</span>
<span class="cm">         */</span>
        <span class="n">Cursor</span> <span class="n">c</span> <span class="o">=</span> <span class="n">contentResolver</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">CacheContentProvider</span><span class="o">.</span><span class="na">POLICE_CACHE_URI</span><span class="o">,</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]{</span> <span class="s">&quot;*&quot;</span> <span class="o">},</span> <span class="s">&quot;url = ? AND retrievedOn &gt; ?&quot;</span><span class="o">,</span>
                <span class="n">selectionArgs</span><span class="o">,</span> <span class="s">&quot;retrievedOn DESC&quot;</span><span class="o">);</span>

        <span class="k">if</span><span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="o">}</span>

        <span class="n">String</span> <span class="n">response</span><span class="o">;</span>
        <span class="k">if</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">moveToFirst</span><span class="o">()){</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;BaseMethodCall&quot;</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
                    <span class="s">&quot;A cached instance of %s is available, returning.\n&quot;</span><span class="o">,</span>
                    <span class="n">url</span><span class="o">));</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">getColumnIndex</span><span class="o">(</span><span class="s">&quot;cachedObject&quot;</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">response</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">c</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">CaseHistoryMethodCall <small>police.methodcalls</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">police</span><span class="o">.</span><span class="na">methodcalls</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">com.google.gson.Gson</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">police.types.CaseHistory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">police.types.Crime</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Returns the outcomes (case history) for the specified crime. Crime ID is 64-character identifier, as returned by other API methods.</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;&lt;strong&gt;Note: Outcomes are not available for the Police Service of Northern Ireland.&lt;/strong&gt;&lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;&lt;a href=&quot;http://data.police.uk/docs/method/outcomes-for-crime/&quot;&gt;See original docs&lt;/a&gt;&lt;/p&gt;</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CaseHistoryMethodCall</span> <span class="kd">extends</span> <span class="n">BaseMethodCall</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">METHOD</span> <span class="o">=</span> <span class="s">&quot;outcomes-for-crime&quot;</span><span class="o">;</span>

	<span class="kd">private</span> <span class="n">String</span> <span class="n">persistent_id</span><span class="o">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Get case history for a crime</span>
<span class="cm">     * @param persistent_crime_id crime UUID</span>
<span class="cm">     * @return case history</span>
<span class="cm">     * @throws Exception</span>
<span class="cm">     */</span>
	<span class="kd">public</span> <span class="n">CaseHistory</span> <span class="nf">getOutcomes</span><span class="o">(</span><span class="n">String</span> <span class="n">persistent_crime_id</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">persistent_id</span> <span class="o">=</span> <span class="n">persistent_crime_id</span><span class="o">;</span>
		<span class="k">return</span> <span class="nf">getOutcomes</span><span class="o">();</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Get case history for a crime</span>
<span class="cm">     * @param crime crime object</span>
<span class="cm">     * @return case history</span>
<span class="cm">     * @throws Exception</span>
<span class="cm">     */</span>
	<span class="kd">public</span> <span class="n">CaseHistory</span> <span class="nf">getOutcomes</span><span class="o">(</span><span class="n">Crime</span> <span class="n">crime</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">persistent_id</span> <span class="o">=</span> <span class="n">crime</span><span class="o">.</span><span class="na">getPersistent_id</span><span class="o">();</span>
		<span class="k">return</span> <span class="nf">getOutcomes</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">protected</span> <span class="n">CaseHistory</span> <span class="nf">getOutcomes</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">raw_json</span> <span class="o">=</span> <span class="n">doCall</span><span class="o">(</span><span class="n">METHOD</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">persistent_id</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
		<span class="n">Gson</span> <span class="n">gson</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Gson</span><span class="o">();</span>
		<span class="k">return</span> <span class="n">gson</span><span class="o">.</span><span class="na">fromJson</span><span class="o">(</span><span class="n">raw_json</span><span class="o">,</span> <span class="n">CaseHistory</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">CrimeAvailabilityMethodCall <small>police.methodcalls</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">police</span><span class="o">.</span><span class="na">methodcalls</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">com.google.gson.JsonArray</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.gson.JsonElement</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.gson.JsonObject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.gson.JsonParser</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.text.SimpleDateFormat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Encapsulates the following Police API methods:</span>
<span class="cm"> * &lt;ul&gt;</span>
<span class="cm"> * &lt;li&gt;&lt;b&gt;crimes-street-dates&lt;/b&gt;: Lists dates for which data is available.</span>
<span class="cm"> * &lt;li&gt;&lt;b&gt;crime-last-updated&lt;/b&gt;: Retrieves the last date on which the crime</span>
<span class="cm"> * information was updated.</span>
<span class="cm"> * &lt;/ul&gt;</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * @see &lt;a</span>
<span class="cm"> *      href=&quot;http://data.police.uk/docs/method/crimes-street-dates/&quot;&gt;crimes-street-dates&lt;/a&gt;</span>
<span class="cm"> *      , &lt;a</span>
<span class="cm"> *      href=&quot;http://data.police.uk/docs/method/crime-last-updated/&quot;&gt;crime-last</span>
<span class="cm"> *      -updated&lt;/a&gt;</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CrimeAvailabilityMethodCall</span> <span class="kd">extends</span> <span class="n">BaseMethodCall</span> <span class="o">{</span>

    <span class="cm">/**</span>
<span class="cm">     * @return A list of dates for which crime data is available</span>
<span class="cm">     * @throws Exception</span>
<span class="cm">     */</span>
	<span class="kd">public</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Date</span><span class="o">&gt;</span> <span class="nf">getAvailableDates</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">raw_json</span> <span class="o">=</span> <span class="n">doCall</span><span class="o">(</span><span class="s">&quot;crimes-street-dates&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
		<span class="n">JsonArray</span> <span class="n">idates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JsonParser</span><span class="o">().</span><span class="na">parse</span><span class="o">(</span><span class="n">raw_json</span><span class="o">).</span><span class="na">getAsJsonArray</span><span class="o">();</span>

		<span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Date</span><span class="o">&gt;</span> <span class="n">dates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Date</span><span class="o">&gt;();</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">JsonElement</span> <span class="n">idate</span> <span class="o">:</span> <span class="n">idates</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">dates</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s">&quot;yyyy-MM&quot;</span><span class="o">).</span><span class="na">parse</span><span class="o">(</span><span class="n">idate</span>
					<span class="o">.</span><span class="na">getAsJsonObject</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;date&quot;</span><span class="o">).</span><span class="na">getAsString</span><span class="o">()));</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="n">dates</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * @return The latest date for which crime data is available</span>
<span class="cm">     * @throws Exception</span>
<span class="cm">     */</span>
	<span class="kd">public</span> <span class="n">Date</span> <span class="nf">getLastUpdated</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">raw_json</span> <span class="o">=</span> <span class="n">doCall</span><span class="o">(</span><span class="s">&quot;crime-last-updated&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

		<span class="n">JsonObject</span> <span class="n">dateObj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JsonParser</span><span class="o">().</span><span class="na">parse</span><span class="o">(</span><span class="n">raw_json</span><span class="o">).</span><span class="na">getAsJsonObject</span><span class="o">();</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">SimpleDateFormat</span><span class="o">(</span><span class="s">&quot;yyyy-MM-dd&quot;</span><span class="o">).</span><span class="na">parse</span><span class="o">(</span><span class="n">dateObj</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;date&quot;</span><span class="o">)</span>
				<span class="o">.</span><span class="na">getAsString</span><span class="o">());</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">CrimeCategoriesMethodCall <small>police.methodcalls</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">police</span><span class="o">.</span><span class="na">methodcalls</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">com.google.gson.JsonArray</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.gson.JsonElement</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.gson.JsonObject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.gson.JsonParser</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Hashtable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Get a map of crime category slugs to their human-readable names.</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;a href=&quot;http://data.police.uk/docs/method/crime-categories/&quot;&gt;See original docs&lt;/a&gt;</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CrimeCategoriesMethodCall</span> <span class="kd">extends</span> <span class="n">BaseMethodCall</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">METHOD</span> <span class="o">=</span> <span class="s">&quot;crime-categories&quot;</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Date</span> <span class="n">date</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">inMemoryCache</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">getFromStorage</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">raw_json</span> <span class="o">=</span> <span class="n">doCall</span><span class="o">(</span><span class="n">METHOD</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

        <span class="n">Hashtable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">categories</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
        <span class="n">JsonArray</span> <span class="n">raw_array</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JsonParser</span><span class="o">().</span><span class="na">parse</span><span class="o">(</span><span class="n">raw_json</span><span class="o">).</span><span class="na">getAsJsonArray</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">JsonElement</span> <span class="n">el</span> <span class="o">:</span> <span class="n">raw_array</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">JsonObject</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="na">getAsJsonObject</span><span class="o">();</span>
            <span class="n">categories</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">obj</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;url&quot;</span><span class="o">).</span><span class="na">getAsString</span><span class="o">(),</span> <span class="n">obj</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">getAsString</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">categories</span><span class="o">;</span>
    <span class="o">}</span>

	<span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">getCrimeCategories</span><span class="o">()</span>
            <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="k">if</span><span class="o">(</span><span class="n">inMemoryCache</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">inMemoryCache</span> <span class="o">=</span> <span class="n">getFromStorage</span><span class="o">();</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="n">inMemoryCache</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">ForcesMethodCall <small>police.methodcalls</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">police</span><span class="o">.</span><span class="na">methodcalls</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">com.google.gson.Gson</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.gson.JsonArray</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.gson.JsonElement</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.gson.JsonParser</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">police.types.ForceInformation</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Acquire information about police forces</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ForcesMethodCall</span> <span class="kd">extends</span> <span class="n">BaseMethodCall</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">METHOD</span> <span class="o">=</span> <span class="s">&quot;forces&quot;</span><span class="o">;</span>

    <span class="cm">/**</span>
<span class="cm">     * A list of all the police forces available via the API. Unique force identifiers obtained here</span>
<span class="cm">     * are used in requests for force-specific data via other methods.</span>
<span class="cm">     *</span>
<span class="cm">     * &lt;a href=&quot;http://data.police.uk/docs/method/forces/&quot;&gt;See original docs&lt;/a&gt;</span>
<span class="cm">     *</span>
<span class="cm">     * @return a list of forces available</span>
<span class="cm">     * @throws Exception</span>
<span class="cm">     */</span>
	<span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">listForces</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">raw_json</span> <span class="o">=</span> <span class="n">doCall</span><span class="o">(</span><span class="n">METHOD</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
		<span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">forces</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
		<span class="n">JsonArray</span> <span class="n">forces_array</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JsonParser</span><span class="o">().</span><span class="na">parse</span><span class="o">(</span><span class="n">raw_json</span><span class="o">)</span>
				<span class="o">.</span><span class="na">getAsJsonArray</span><span class="o">();</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">JsonElement</span> <span class="n">force_element</span> <span class="o">:</span> <span class="n">forces_array</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">forces</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">force_element</span><span class="o">.</span><span class="na">getAsJsonObject</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">).</span><span class="na">getAsString</span><span class="o">(),</span>
					<span class="n">force_element</span><span class="o">.</span><span class="na">getAsJsonObject</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">).</span><span class="na">getAsString</span><span class="o">());</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">forces</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Detailed information about a specific force.</span>
<span class="cm">     *</span>
<span class="cm">     * &lt;a href=&quot;http://data.police.uk/docs/method/force/&quot;&gt;See original docs&lt;/a&gt;</span>
<span class="cm">     *</span>
<span class="cm">     * @param id the force&#39;s id</span>
<span class="cm">     * @return an info object containing information about the force</span>
<span class="cm">     * @throws Exception</span>
<span class="cm">     */</span>
	<span class="kd">public</span> <span class="n">ForceInformation</span> <span class="nf">getForceDetails</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">raw_json</span> <span class="o">=</span> <span class="n">doCall</span><span class="o">(</span><span class="n">METHOD</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">id</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">Gson</span><span class="o">().</span><span class="na">fromJson</span><span class="o">(</span><span class="n">raw_json</span><span class="o">,</span> <span class="n">ForceInformation</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">NeighbourhoodsMethodCall <small>police.methodcalls</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">police</span><span class="o">.</span><span class="na">methodcalls</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">com.google.gson.JsonArray</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.gson.JsonElement</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.gson.JsonParser</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Gets neighbourhoods for a specific force.</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;a href=&quot;http://data.police.uk/docs/method/neighbourhoods/&quot;&gt;See original docs&lt;/a&gt;</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NeighbourhoodsMethodCall</span> <span class="kd">extends</span> <span class="n">BaseMethodCall</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">METHOD</span> <span class="o">=</span> <span class="s">&quot;neighbourhoods&quot;</span><span class="o">;</span>

	<span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">listNeighbourhoods</span><span class="o">(</span><span class="n">String</span> <span class="n">forceId</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">raw_json</span> <span class="o">=</span> <span class="n">doCall</span><span class="o">(</span><span class="n">forceId</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">METHOD</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

		<span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">neighbourhoods</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
		<span class="n">JsonArray</span> <span class="n">neighbourhoods_array</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JsonParser</span><span class="o">().</span><span class="na">parse</span><span class="o">(</span><span class="n">raw_json</span><span class="o">)</span>
				<span class="o">.</span><span class="na">getAsJsonArray</span><span class="o">();</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">JsonElement</span> <span class="n">neighbourhood_element</span> <span class="o">:</span> <span class="n">neighbourhoods_array</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">neighbourhoods</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">neighbourhood_element</span><span class="o">.</span><span class="na">getAsJsonObject</span><span class="o">()</span>
					<span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">).</span><span class="na">getAsString</span><span class="o">(),</span> <span class="n">neighbourhood_element</span>
					<span class="o">.</span><span class="na">getAsJsonObject</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">).</span><span class="na">getAsString</span><span class="o">());</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">neighbourhoods</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">StreetLevelCrimeMethodCall <small>police.methodcalls</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">police</span><span class="o">.</span><span class="na">methodcalls</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.google.gson.Gson</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.gson.reflect.TypeToken</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Type</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.text.SimpleDateFormat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">police.errors.APIException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">police.types.Crime</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Represents a call to the Police API which returns a list of crimes within a</span>
<span class="cm"> * mile of a given point or within an area specified.</span>
<span class="cm"> * </span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * You cannot specify a point and an area at the same time.</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * @see &lt;a href=&quot;http://data.police.uk/docs/method/crime-street/&quot;&gt;The Police API</span>
<span class="cm"> *      documentation of this method&lt;/a&gt;</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StreetLevelCrimeMethodCall</span> <span class="kd">extends</span> <span class="n">BaseMethodCall</span> <span class="o">{</span>
	<span class="kd">protected</span> <span class="n">Date</span> <span class="n">date</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="n">Double</span> <span class="n">latitude</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="n">Double</span> <span class="n">longitude</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="kd">protected</span> <span class="kt">double</span><span class="o">[][]</span> <span class="n">poly</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

	<span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">METHOD</span> <span class="o">=</span> <span class="s">&quot;crimes-street&quot;</span><span class="o">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * Only show crimes from the given month</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param date</span>
<span class="cm">	 *            A month to show crimes from</span>
<span class="cm">	 * @return this object for further modification</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">StreetLevelCrimeMethodCall</span> <span class="nf">addDate</span><span class="o">(</span><span class="n">Date</span> <span class="n">date</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">date</span> <span class="o">=</span> <span class="n">date</span><span class="o">;</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Specify a point used to look up crimes. The remote method will return</span>
<span class="cm">	 * crimes that happened within a mile of this location.</span>
<span class="cm">	 * &lt;p&gt;</span>
<span class="cm">	 * Awesomely, you can just put GPS coords here :)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param lat</span>
<span class="cm">	 *            The latitude</span>
<span class="cm">	 * @param lon</span>
<span class="cm">	 *            The longitude</span>
<span class="cm">	 * @return this object for further modification</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">StreetLevelCrimeMethodCall</span> <span class="nf">addPoint</span><span class="o">(</span><span class="kt">double</span> <span class="n">lat</span><span class="o">,</span> <span class="kt">double</span> <span class="n">lon</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">latitude</span> <span class="o">=</span> <span class="n">lat</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">longitude</span> <span class="o">=</span> <span class="n">lon</span><span class="o">;</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Specify an area in which to look for crimes. Area cannot be larger than</span>
<span class="cm">	 * 20 sq km.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param poly</span>
<span class="cm">	 *            An array of GPS coordinate pairs [[lon,lat],...] that describe</span>
<span class="cm">	 *            the polygon. No need to close this poly as the server will</span>
<span class="cm">	 *            just draw a straight line for you from the last point to the</span>
<span class="cm">	 *            first one.</span>
<span class="cm">	 * @return this object for further modification</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">StreetLevelCrimeMethodCall</span> <span class="nf">addAreaPolygon</span><span class="o">(</span><span class="kt">double</span><span class="o">[][]</span> <span class="n">poly</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">poly</span> <span class="o">=</span> <span class="n">poly</span><span class="o">;</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Call the API and retrieve a {@link Collection} of {@link Crime Crimes}</span>
<span class="cm">	 * that was returned.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @param category</span>
<span class="cm">	 *            The category to filter the crimes by, can be obtained via</span>
<span class="cm">	 *            CrimeCategoriesMethodCall.</span>
<span class="cm">	 * @return A {@link Collection} of {@link Crime}.</span>
<span class="cm">	 * @throws IOException</span>
<span class="cm">	 *             When a connection could not be created -- see</span>
<span class="cm">	 *             {@link BaseMethodCall#doCall(String, java.util.Map)}</span>
<span class="cm">	 * @throws APIException</span>
<span class="cm">	 *             When the API returned a non-200 code. Typically, there would</span>
<span class="cm">	 *             be too many crimes to return (over 10000), or the request URL</span>
<span class="cm">     *             exceeds 4094 characters (upstream API supports POST parameters,</span>
<span class="cm">     *             but the client code does not).</span>
<span class="cm">	 * @see BaseMethodCall</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Crime</span><span class="o">&gt;</span> <span class="nf">getStreetLevelCrime</span><span class="o">(</span><span class="n">String</span> <span class="n">category</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">APIException</span> <span class="o">{</span>
		<span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">parameters</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
		<span class="k">if</span> <span class="o">((</span><span class="n">latitude</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">longitude</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">poly</span> <span class="o">==</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">(</span><span class="s">&quot;Must specify a polygon or a point&quot;</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">longitude</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">latitude</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">poly</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">UnsupportedOperationException</span><span class="o">(</span>
					<span class="s">&quot;Cannot use both poly and point&quot;</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">longitude</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">latitude</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">parameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;lat&quot;</span><span class="o">,</span> <span class="n">latitude</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
			<span class="n">parameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;lng&quot;</span><span class="o">,</span> <span class="n">longitude</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">poly</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">String</span> <span class="n">polyRep</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
			<span class="k">for</span> <span class="o">(</span><span class="kt">double</span><span class="o">[]</span> <span class="n">point</span> <span class="o">:</span> <span class="n">poly</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">polyRep</span> <span class="o">+=</span> <span class="n">Double</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">point</span><span class="o">[</span><span class="mi">1</span><span class="o">])</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span>
						<span class="o">+</span> <span class="n">Double</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">point</span><span class="o">[</span><span class="mi">0</span><span class="o">])</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="n">polyRep</span> <span class="o">=</span> <span class="n">polyRep</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">polyRep</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span> <span class="c1">// Remove</span>
																	<span class="c1">// trailing</span>
																	<span class="c1">// comma</span>
			<span class="n">parameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;poly&quot;</span><span class="o">,</span> <span class="n">polyRep</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">date</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">parameters</span>
					<span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;date&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s">&quot;yyyy-MM&quot;</span><span class="o">).</span><span class="na">format</span><span class="o">(</span><span class="n">date</span><span class="o">));</span>
		<span class="o">}</span>

		<span class="n">String</span> <span class="n">raw_json</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">raw_json</span> <span class="o">=</span> <span class="n">doCall</span><span class="o">(</span><span class="n">METHOD</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">category</span><span class="o">,</span> <span class="n">parameters</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">APIException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Note that this catch block doesn&#39;t really catch the APIException,</span>
<span class="cm">			 * but it does add additional data to it, based on the response code</span>
<span class="cm">			 * from the server. This can be displayed to user, or used</span>
<span class="cm">			 * internally to gracefully handle weird requests.</span>
<span class="cm">			 */</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">&quot;StreetLevelCrimeMethodCall&quot;</span><span class="o">,</span> <span class="s">&quot;API error: Code &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getHttpCode</span><span class="o">()</span>
                    <span class="o">+</span> <span class="s">&quot;; message: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getHttpCode</span><span class="o">()</span> <span class="o">==</span> <span class="mi">400</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">APIException</span><span class="o">(</span><span class="s">&quot;The area specified is too large&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getHttpCode</span><span class="o">()</span> <span class="o">==</span> <span class="mi">503</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// A very sad exception because it means people shoot each</span>
				<span class="c1">// other so much that even the Police API gives up on counting</span>
				<span class="c1">// them.</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">APIException</span><span class="o">(</span><span class="s">&quot;There are too many crimes to process&quot;</span><span class="o">,</span>
						<span class="n">e</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Crime</span><span class="o">&gt;</span> <span class="n">resultValue</span><span class="o">;</span>

		<span class="n">resultValue</span> <span class="o">=</span> <span class="n">processCrimes</span><span class="o">(</span><span class="n">raw_json</span><span class="o">);</span>

		<span class="k">return</span> <span class="n">resultValue</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Processes the response into a collection of Crime objects</span>
<span class="cm">     * @param raw_json the JSON response</span>
<span class="cm">     * @return a collection of crimes</span>
<span class="cm">     */</span>
	<span class="kd">protected</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Crime</span><span class="o">&gt;</span> <span class="nf">processCrimes</span><span class="o">(</span><span class="n">String</span> <span class="n">raw_json</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Collection</span><span class="o">&lt;</span><span class="n">Crime</span><span class="o">&gt;</span> <span class="n">crimes</span><span class="o">;</span>

		<span class="n">Type</span> <span class="n">collectionT</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TypeToken</span><span class="o">&lt;</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">Crime</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
		<span class="o">}.</span><span class="na">getType</span><span class="o">();</span>
		<span class="n">crimes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Gson</span><span class="o">().</span><span class="na">fromJson</span><span class="o">(</span><span class="n">raw_json</span><span class="o">,</span> <span class="n">collectionT</span><span class="o">);</span>

		<span class="k">return</span> <span class="n">crimes</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Get all the crimes for the specified parameters</span>
<span class="cm">     * @return a collection of crimes</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     *             When a connection could not be created -- see</span>
<span class="cm">     *             {@link BaseMethodCall#doCall(String, java.util.Map)}</span>
<span class="cm">     * @throws APIException</span>
<span class="cm">     *             When the API returned a non-200 code. Typically, there would</span>
<span class="cm">     *             be too many crimes to return (over 10000), or the request URL</span>
<span class="cm">     *             exceeds 4094 characters (upstream API supports POST parameters,</span>
<span class="cm">     *             but the client code does not).</span>
<span class="cm">     * @see #getStreetLevelCrime(String)</span>
<span class="cm">     */</span>
	<span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Crime</span><span class="o">&gt;</span> <span class="nf">getStreetLevelCrime</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span>
			<span class="n">APIException</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">getStreetLevelCrime</span><span class="o">(</span><span class="s">&quot;all-crime&quot;</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">StreetLevelOutcomesMethodCall <small>police.methodcalls</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">police</span><span class="o">.</span><span class="na">methodcalls</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">com.google.gson.Gson</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.gson.reflect.TypeToken</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.Type</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.text.SimpleDateFormat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">police.errors.APIException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">police.types.Outcome</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;p&gt;Outcomes at street-level; either at a specific location, within a 1 mile radius of a single point, or within a custom area.&lt;/p&gt;</span>
<span class="cm"> * &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; Outcomes are not available for the Police Service of Northern Ireland.&lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;&lt;a href=&quot;http://data.police.uk/docs/method/outcomes-at-location/&quot;&gt;See original docs&lt;/a&gt;&lt;/p&gt;</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StreetLevelOutcomesMethodCall</span> <span class="kd">extends</span> <span class="n">StreetLevelCrimeMethodCall</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">METHOD</span> <span class="o">=</span> <span class="s">&quot;outcomes-at-location&quot;</span><span class="o">;</span>

	<span class="kd">private</span> <span class="n">Integer</span> <span class="n">location_id</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

	<span class="kd">public</span> <span class="n">StreetLevelOutcomesMethodCall</span> <span class="nf">addLocationId</span><span class="o">(</span><span class="n">Integer</span> <span class="n">lid</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">location_id</span> <span class="o">=</span> <span class="n">lid</span><span class="o">;</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Outcome</span><span class="o">&gt;</span> <span class="nf">getOutcomesAtLocation</span><span class="o">()</span>
            <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">parameters</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
		<span class="k">if</span> <span class="o">((</span><span class="n">latitude</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">longitude</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">poly</span> <span class="o">==</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">(</span><span class="s">&quot;Must specify a polygon or a point&quot;</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">longitude</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">latitude</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">poly</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">UnsupportedOperationException</span><span class="o">(</span>
					<span class="s">&quot;Cannot use both poly and point&quot;</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">longitude</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">latitude</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">parameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;lat&quot;</span><span class="o">,</span> <span class="n">latitude</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
			<span class="n">parameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;lng&quot;</span><span class="o">,</span> <span class="n">longitude</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">poly</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">String</span> <span class="n">polyRep</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
			<span class="k">for</span> <span class="o">(</span><span class="kt">double</span><span class="o">[]</span> <span class="n">point</span> <span class="o">:</span> <span class="n">poly</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">polyRep</span> <span class="o">+=</span> <span class="n">Double</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">point</span><span class="o">[</span><span class="mi">1</span><span class="o">])</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span>
						<span class="o">+</span> <span class="n">Double</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">point</span><span class="o">[</span><span class="mi">0</span><span class="o">])</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="n">polyRep</span> <span class="o">=</span> <span class="n">polyRep</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">polyRep</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span> <span class="c1">// Remove</span>
																	<span class="c1">// trailing</span>
																	<span class="c1">// comma</span>
			<span class="n">parameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;poly&quot;</span><span class="o">,</span> <span class="n">polyRep</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">date</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">parameters</span>
					<span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;date&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s">&quot;yyyy-MM&quot;</span><span class="o">).</span><span class="na">format</span><span class="o">(</span><span class="n">date</span><span class="o">));</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">location_id</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">parameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;location&quot;</span><span class="o">,</span> <span class="n">location_id</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
		<span class="o">}</span>

		<span class="n">String</span> <span class="n">raw_json</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">raw_json</span> <span class="o">=</span> <span class="n">doCall</span><span class="o">(</span><span class="n">METHOD</span><span class="o">,</span> <span class="n">parameters</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">APIException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Note that this catch block doesn&#39;t really catch the APIException,</span>
<span class="cm">			 * but it does add additional data to it, based on the response code</span>
<span class="cm">			 * from the server. This can be displayed to user, or used</span>
<span class="cm">			 * internally to gracefully handle weird requests.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getHttpCode</span><span class="o">()</span> <span class="o">==</span> <span class="mi">400</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">APIException</span><span class="o">(</span><span class="s">&quot;The area specified is too large&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getHttpCode</span><span class="o">()</span> <span class="o">==</span> <span class="mi">503</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// A very sad exception because it means people shoot each</span>
				<span class="c1">// other so much that even the Police API gives up on counting</span>
				<span class="c1">// them.</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">APIException</span><span class="o">(</span><span class="s">&quot;There are too many crimes to process&quot;</span><span class="o">,</span>
						<span class="n">e</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="n">Collection</span><span class="o">&lt;</span><span class="n">Outcome</span><span class="o">&gt;</span> <span class="n">outcomes</span> <span class="o">=</span> <span class="n">processOutcomes</span><span class="o">(</span><span class="n">raw_json</span><span class="o">);</span>

		<span class="k">return</span> <span class="n">outcomes</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">protected</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Outcome</span><span class="o">&gt;</span> <span class="nf">processOutcomes</span><span class="o">(</span><span class="n">String</span> <span class="n">raw_json</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Gson</span> <span class="n">gson</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Gson</span><span class="o">();</span>
		<span class="n">Type</span> <span class="n">collectionT</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TypeToken</span><span class="o">&lt;</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">Outcome</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
		<span class="o">}.</span><span class="na">getType</span><span class="o">();</span>
		<span class="n">Collection</span><span class="o">&lt;</span><span class="n">Outcome</span><span class="o">&gt;</span> <span class="n">outcomes</span> <span class="o">=</span> <span class="n">gson</span><span class="o">.</span><span class="na">fromJson</span><span class="o">(</span><span class="n">raw_json</span><span class="o">,</span> <span class="n">collectionT</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">outcomes</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">CaseHistory <small>police.types</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">police</span><span class="o">.</span><span class="na">types</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map.Entry</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CaseHistory</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Outcome</span><span class="o">&gt;</span> <span class="n">outcomes</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Crime</span> <span class="n">crime</span><span class="o">;</span>

	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unused&quot;</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nf">CaseHistory</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param outcomes the crime outcomes to set for the crime</span>
<span class="cm">	 * @param crime the crime to set</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">CaseHistory</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">Outcome</span><span class="o">&gt;</span> <span class="n">outcomes</span><span class="o">,</span> <span class="n">Crime</span> <span class="n">crime</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">outcomes</span> <span class="o">=</span> <span class="n">outcomes</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">crime</span> <span class="o">=</span> <span class="n">crime</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the outcomes</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Outcome</span><span class="o">&gt;</span> <span class="nf">getOutcomes</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">outcomes</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the crime</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Crime</span> <span class="nf">getCrime</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">crime</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#hashCode()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">prime</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">crime</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">crime</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">outcomes</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">outcomes</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#equals(java.lang.Object)</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">CaseHistory</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="n">CaseHistory</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">CaseHistory</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">crime</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">crime</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">crime</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">crime</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">outcomes</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">outcomes</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">outcomes</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">outcomes</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#toString()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">outcomes</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">outcomes</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">outcomes</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">outcomes</span> <span class="o">=</span> <span class="s">&quot;(null)&quot;</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="n">String</span> <span class="n">crime</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">crime</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">crime</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">crime</span> <span class="o">=</span> <span class="s">&quot;(null)&quot;</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="s">&quot;CaseHistory [outcomes=&quot;</span> <span class="o">+</span> <span class="n">outcomes</span> <span class="o">+</span> <span class="s">&quot;, crime=&quot;</span> <span class="o">+</span> <span class="n">crime</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">toStringWithExtraInfo</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">swei_crime</span> <span class="o">=</span> <span class="n">crime</span>
				<span class="o">.</span><span class="na">toStringWithExtraInfo</span><span class="o">();</span>
		<span class="kd">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">remarks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>

		<span class="n">String</span> <span class="n">crime</span> <span class="o">=</span> <span class="n">swei_crime</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
		<span class="n">remarks</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">swei_crime</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>

		<span class="n">String</span> <span class="n">outcomes</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">outcomes</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">outcomes</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">outcomes</span> <span class="o">=</span> <span class="s">&quot;(null)&quot;</span><span class="o">;</span>
			<span class="n">remarks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;outcomes are null&quot;</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="kd">final</span> <span class="n">String</span> <span class="n">mStr</span> <span class="o">=</span> <span class="s">&quot;CaseHistory [outcomes=&quot;</span> <span class="o">+</span> <span class="n">outcomes</span> <span class="o">+</span> <span class="s">&quot;, crime=&quot;</span>
				<span class="o">+</span> <span class="n">crime</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="o">;</span>

		<span class="k">return</span> <span class="k">new</span> <span class="n">KeyValuePair</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;(</span><span class="n">mStr</span><span class="o">,</span> <span class="n">remarks</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">Crime <small>police.types</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">police</span><span class="o">.</span><span class="na">types</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Crime</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">category</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">persistent_id</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">location_type</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">location_subtype</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Location</span> <span class="n">location</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">context</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">OutcomeStatus</span> <span class="n">outcome_status</span><span class="o">;</span>

	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unused&quot;</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nf">Crime</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">     * A full constructor for the crime object</span>
<span class="cm">	 * @param category the category of the crime in url slug form</span>
<span class="cm">	 * @param persistent_id the UUID for the crime which can be used for tracking</span>
<span class="cm">	 * @param location_type the type of the location attached to the crime</span>
<span class="cm">	 * @param location_subtype the subtype of the location attached to the crime</span>
<span class="cm">	 * @param id an internal ID (PK?) of the crime, use persistent_id for tracking</span>
<span class="cm">	 * @param location location attached to the crime</span>
<span class="cm">	 * @param context extra information about the crime</span>
<span class="cm">	 * @param outcome_status outcome status</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">Crime</span><span class="o">(</span><span class="n">String</span> <span class="n">category</span><span class="o">,</span> <span class="n">String</span> <span class="n">persistent_id</span><span class="o">,</span> <span class="n">String</span> <span class="n">location_type</span><span class="o">,</span>
			<span class="n">String</span> <span class="n">location_subtype</span><span class="o">,</span> <span class="kt">long</span> <span class="n">id</span><span class="o">,</span> <span class="n">Location</span> <span class="n">location</span><span class="o">,</span>
			<span class="n">String</span> <span class="n">context</span><span class="o">,</span> <span class="n">OutcomeStatus</span> <span class="n">outcome_status</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">category</span> <span class="o">=</span> <span class="n">category</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">persistent_id</span> <span class="o">=</span> <span class="n">persistent_id</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">location_type</span> <span class="o">=</span> <span class="n">location_type</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">location_subtype</span> <span class="o">=</span> <span class="n">location_subtype</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">location</span> <span class="o">=</span> <span class="n">location</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">outcome_status</span> <span class="o">=</span> <span class="n">outcome_status</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the category of the crime in url slug form</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getCategory</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">category</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the UUID for the crime which can be used for tracking</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getPersistent_id</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">persistent_id</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the the type of the location attached to the crime</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getLocation_type</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">location_type</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the the subtype of the location attached to the crime</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getLocation_subtype</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">location_subtype</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return an internal ID (PK?) of the crime, use persistent_id for tracking</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">long</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">id</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the location attached to the crime</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Location</span> <span class="nf">getLocation</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">location</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return extra information about the crime</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getContext</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">context</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the outcome status</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">OutcomeStatus</span> <span class="nf">getOutcomeStatus</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">outcome_status</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#toString()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">locStr</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">locStr</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">locStr</span> <span class="o">=</span> <span class="s">&quot;(null)&quot;</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="n">String</span> <span class="n">outcomeStr</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">outcomeStr</span> <span class="o">=</span> <span class="n">outcome_status</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">outcome_status</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">&quot;Crime&quot;</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Crime %d (%s): %s %s\n&quot;</span><span class="o">,</span> <span class="n">id</span><span class="o">,</span> <span class="n">persistent_id</span><span class="o">,</span>
                        <span class="n">category</span><span class="o">,</span> <span class="n">location</span><span class="o">.</span><span class="na">getStreet</span><span class="o">().</span><span class="na">getName</span><span class="o">()));</span>
            <span class="o">}</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">&quot;Crime&quot;</span><span class="o">,</span> <span class="s">&quot; &gt;&gt; Outcome status for Crime@&quot;</span>
					<span class="o">+</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">hashCode</span><span class="o">())</span> <span class="o">+</span> <span class="s">&quot; is null!&quot;</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">outcomeStr</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">locStr</span> <span class="o">=</span> <span class="s">&quot;(null)&quot;</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="n">String</span> <span class="n">category</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">category</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">persistent_id</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">persistent_id</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">location_type</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">location_type</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">location_subtype</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">location_subtype</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">context</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">context</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">category</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
			<span class="n">category</span> <span class="o">=</span> <span class="s">&quot;(null)&quot;</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">persistent_id</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
			<span class="n">persistent_id</span> <span class="o">=</span> <span class="s">&quot;(null)&quot;</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">location_type</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
			<span class="n">location_type</span> <span class="o">=</span> <span class="s">&quot;(null)&quot;</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">location_subtype</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
			<span class="n">location_type</span> <span class="o">=</span> <span class="s">&quot;(null)&quot;</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">context</span> <span class="o">=</span> <span class="s">&quot;(null)&quot;</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="s">&quot;Crime [category=&quot;</span> <span class="o">+</span> <span class="n">category</span> <span class="o">+</span> <span class="s">&quot;, persistent_id=&quot;</span>
				<span class="o">+</span> <span class="n">persistent_id</span> <span class="o">+</span> <span class="s">&quot;, location_type=&quot;</span> <span class="o">+</span> <span class="n">location_type</span>
				<span class="o">+</span> <span class="s">&quot;, location_subtype=&quot;</span> <span class="o">+</span> <span class="n">location_subtype</span> <span class="o">+</span> <span class="s">&quot;, id=&quot;</span>
				<span class="o">+</span> <span class="n">Long</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot;, location=&quot;</span> <span class="o">+</span> <span class="n">locStr</span> <span class="o">+</span> <span class="s">&quot;, context=&quot;</span>
				<span class="o">+</span> <span class="n">context</span> <span class="o">+</span> <span class="s">&quot;, outcome_status=&quot;</span> <span class="o">+</span> <span class="n">outcomeStr</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * This method is required to convey all the non-exceptional but important</span>
<span class="cm">	 * information about this Crime.</span>
<span class="cm">	 * </span>
<span class="cm">	 * @return An Entry, where the key is the string representation of the</span>
<span class="cm">	 *         object, and the value is a list of remarks about the object&#39;s</span>
<span class="cm">	 *         retrieval. It will be empty if everything is OK.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">KeyValuePair</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">toStringWithExtraInfo</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">remarks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
		<span class="n">String</span> <span class="n">locStr</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">locStr</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e1</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">remarks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;location is null&quot;</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">locStr</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">locStr</span> <span class="o">=</span> <span class="s">&quot;(null)&quot;</span><span class="o">;</span>
			<span class="n">remarks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;location string is null&quot;</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="n">String</span> <span class="n">outcomeStr</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">outcomeStr</span> <span class="o">=</span> <span class="n">outcome_status</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">remarks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;outcome_status is null&quot;</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">outcomeStr</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">locStr</span> <span class="o">=</span> <span class="s">&quot;(null)&quot;</span><span class="o">;</span>
			<span class="n">remarks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;outcome_status string is null&quot;</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="n">String</span> <span class="n">category</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">category</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">persistent_id</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">persistent_id</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">location_type</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">location_type</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">location_subtype</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">location_subtype</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">context</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">context</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">category</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">category</span> <span class="o">=</span> <span class="s">&quot;(null)&quot;</span><span class="o">;</span>
			<span class="n">remarks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;category is null&quot;</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">persistent_id</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">persistent_id</span> <span class="o">=</span> <span class="s">&quot;(null)&quot;</span><span class="o">;</span>
			<span class="n">remarks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;persistent_id is null&quot;</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">location_type</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">location_type</span> <span class="o">=</span> <span class="s">&quot;(null)&quot;</span><span class="o">;</span>
			<span class="n">remarks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;location_type is null&quot;</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">location_subtype</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">location_type</span> <span class="o">=</span> <span class="s">&quot;(null)&quot;</span><span class="o">;</span>
			<span class="n">remarks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;location_subtype is null&quot;</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">context</span> <span class="o">=</span> <span class="s">&quot;(null)&quot;</span><span class="o">;</span>
			<span class="n">remarks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;context is null&quot;</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="kd">final</span> <span class="n">String</span> <span class="n">toString</span> <span class="o">=</span> <span class="s">&quot;Crime [category=&quot;</span> <span class="o">+</span> <span class="n">category</span>
				<span class="o">+</span> <span class="s">&quot;, persistent_id=&quot;</span> <span class="o">+</span> <span class="n">persistent_id</span> <span class="o">+</span> <span class="s">&quot;, location_type=&quot;</span>
				<span class="o">+</span> <span class="n">location_type</span> <span class="o">+</span> <span class="s">&quot;, location_subtype=&quot;</span> <span class="o">+</span> <span class="n">location_subtype</span>
				<span class="o">+</span> <span class="s">&quot;, id=&quot;</span> <span class="o">+</span> <span class="n">Long</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot;, location=&quot;</span> <span class="o">+</span> <span class="n">locStr</span>
				<span class="o">+</span> <span class="s">&quot;, context=&quot;</span> <span class="o">+</span> <span class="n">context</span> <span class="o">+</span> <span class="s">&quot;, outcome_status=&quot;</span> <span class="o">+</span> <span class="n">outcomeStr</span>
				<span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="o">;</span>
		<span class="k">return</span> <span class="k">new</span> <span class="n">KeyValuePair</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;(</span><span class="n">toString</span><span class="o">,</span> <span class="n">remarks</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#hashCode()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">prime</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">category</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">category</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">context</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">context</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">id</span> <span class="o">^</span> <span class="o">(</span><span class="n">id</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">32</span><span class="o">));</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">location</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">location</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span>
				<span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">location_subtype</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">location_subtype</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">location_type</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">location_type</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">outcome_status</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">outcome_status</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">persistent_id</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">persistent_id</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#equals(java.lang.Object)</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">Crime</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="n">Crime</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">Crime</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">category</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">category</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">category</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">category</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">context</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">context</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">context</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">context</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">id</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="na">id</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">location</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">location</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">location</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">location</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">location_subtype</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">location_subtype</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">location_subtype</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">location_subtype</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">location_type</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">location_type</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">location_type</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">location_type</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">outcome_status</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">outcome_status</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">outcome_status</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">outcome_status</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">persistent_id</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">persistent_id</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">persistent_id</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">persistent_id</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">EngagementMethod <small>police.types</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">police</span><span class="o">.</span><span class="na">types</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EngagementMethod</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">url</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">description</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">title</span><span class="o">;</span>

	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unused&quot;</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nf">EngagementMethod</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param url url for this engagement method</span>
<span class="cm">	 * @param description description of the engagement method</span>
<span class="cm">	 * @param title the title</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">EngagementMethod</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">,</span> <span class="n">String</span> <span class="n">description</span><span class="o">,</span> <span class="n">String</span> <span class="n">title</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="n">title</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the url</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getUrl</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">url</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the description</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getDescription</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">description</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the title</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getTitle</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">title</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#hashCode()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">prime</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">description</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">description</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">title</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">title</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">url</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">url</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#equals(java.lang.Object)</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">EngagementMethod</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="n">EngagementMethod</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">EngagementMethod</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">description</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">description</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">description</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">description</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">title</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">title</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">title</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">title</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">url</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">url</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">url</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">url</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#toString()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="s">&quot;EngagementMethod [url=&quot;</span> <span class="o">+</span> <span class="n">url</span> <span class="o">+</span> <span class="s">&quot;, description=&quot;</span> <span class="o">+</span> <span class="n">description</span>
				<span class="o">+</span> <span class="s">&quot;, title=&quot;</span> <span class="o">+</span> <span class="n">title</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">ForceInformation <small>police.types</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">police</span><span class="o">.</span><span class="na">types</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ForceInformation</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">description</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">url</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">telephone</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">id</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">EngagementMethod</span><span class="o">&gt;</span> <span class="n">engagement_methods</span><span class="o">;</span>

	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unused&quot;</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nf">ForceInformation</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param description Force description</span>
<span class="cm">	 * @param url Homepage url</span>
<span class="cm">	 * @param telephone phone number (non-999)</span>
<span class="cm">	 * @param id internal force id</span>
<span class="cm">	 * @param name force name</span>
<span class="cm">	 * @param engagement_methods available methods of interaction</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">ForceInformation</span><span class="o">(</span><span class="n">String</span> <span class="n">description</span><span class="o">,</span> <span class="n">String</span> <span class="n">url</span><span class="o">,</span> <span class="n">String</span> <span class="n">telephone</span><span class="o">,</span>
			<span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span>
			<span class="n">Collection</span><span class="o">&lt;</span><span class="n">EngagementMethod</span><span class="o">&gt;</span> <span class="n">engagement_methods</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">telephone</span> <span class="o">=</span> <span class="n">telephone</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">engagement_methods</span> <span class="o">=</span> <span class="n">engagement_methods</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the description</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getDescription</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">description</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the url</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getUrl</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">url</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the telephone</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getTelephone</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">telephone</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the id</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">id</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the name</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">name</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the engagement_methods</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">EngagementMethod</span><span class="o">&gt;</span> <span class="nf">getEngagement_methods</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">engagement_methods</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#hashCode()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">prime</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">description</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">description</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span>
				<span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">engagement_methods</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">engagement_methods</span>
						<span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">id</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">id</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">name</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">name</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">telephone</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">telephone</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">url</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">url</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#equals(java.lang.Object)</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">ForceInformation</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="n">ForceInformation</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">ForceInformation</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">description</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">description</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">description</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">description</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">engagement_methods</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">engagement_methods</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">engagement_methods</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">engagement_methods</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">id</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">id</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">id</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">id</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">name</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">name</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">telephone</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">telephone</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">telephone</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">telephone</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">url</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">url</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">url</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">url</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#toString()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="s">&quot;ForceInformation [description=&quot;</span> <span class="o">+</span> <span class="n">description</span> <span class="o">+</span> <span class="s">&quot;, url=&quot;</span> <span class="o">+</span> <span class="n">url</span>
				<span class="o">+</span> <span class="s">&quot;, telephone=&quot;</span> <span class="o">+</span> <span class="n">telephone</span> <span class="o">+</span> <span class="s">&quot;, id=&quot;</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span> <span class="s">&quot;, name=&quot;</span> <span class="o">+</span> <span class="n">name</span>
				<span class="o">+</span> <span class="s">&quot;, engagement_methods=&quot;</span> <span class="o">+</span> <span class="n">engagement_methods</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">KeyValuePair <small>police.types</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">police</span><span class="o">.</span><span class="na">types</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map.Entry</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * A simple key-value pair for when a {@link Map} would be a waste of memory.</span>
<span class="cm"> * Used here to allow certain functions to return two values of different types.</span>
<span class="cm"> * </span>
<span class="cm"> * @author filip</span>
<span class="cm"> * </span>
<span class="cm"> * @param &lt;K&gt;</span>
<span class="cm"> *            The type of the key.</span>
<span class="cm"> * @param &lt;V&gt;</span>
<span class="cm"> *            The type of the value.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">KeyValuePair</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="n">K</span> <span class="n">key</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">V</span> <span class="n">value</span><span class="o">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param key the &quot;key&quot; part of this KV pair</span>
<span class="cm">	 * @param value the &quot;value&quot; part of this KV pair</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">KeyValuePair</span><span class="o">(</span><span class="n">K</span> <span class="n">key</span><span class="o">,</span> <span class="n">V</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">K</span> <span class="nf">getKey</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">// TODO Auto-generated method stub</span>
		<span class="k">return</span> <span class="n">key</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">V</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">// TODO Auto-generated method stub</span>
		<span class="k">return</span> <span class="n">value</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">V</span> <span class="nf">setValue</span><span class="o">(</span><span class="n">V</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">V</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
		<span class="k">return</span> <span class="n">oldValue</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">Location <small>police.types</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">police</span><span class="o">.</span><span class="na">types</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="cm">/**</span>
<span class="cm"> * Note that this is not the exact location of the crime, but rather</span>
<span class="cm"> * an arbitrary grid point closest to the actual location</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Location</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">latitude</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">longitude</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Street</span> <span class="n">street</span><span class="o">;</span>

	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unused&quot;</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nf">Location</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param latitude latitude of the normalised crime location</span>
<span class="cm">	 * @param longitude longitude of the normalised crime location</span>
<span class="cm">	 * @param street street name</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">Location</span><span class="o">(</span><span class="n">String</span> <span class="n">latitude</span><span class="o">,</span> <span class="n">String</span> <span class="n">longitude</span><span class="o">,</span> <span class="n">Street</span> <span class="n">street</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">latitude</span> <span class="o">=</span> <span class="n">latitude</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">longitude</span> <span class="o">=</span> <span class="n">longitude</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">street</span> <span class="o">=</span> <span class="n">street</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the latitude</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getLatitude</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">latitude</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the longitude</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getLongitude</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">longitude</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the street</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Street</span> <span class="nf">getStreet</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">street</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#toString()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="s">&quot;Location [latitude=&quot;</span> <span class="o">+</span> <span class="n">latitude</span> <span class="o">+</span> <span class="s">&quot;, longitude=&quot;</span> <span class="o">+</span> <span class="n">longitude</span>
				<span class="o">+</span> <span class="s">&quot;, street=&quot;</span> <span class="o">+</span> <span class="n">street</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#hashCode()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">prime</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">latitude</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">latitude</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">longitude</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">longitude</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">street</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">street</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#equals(java.lang.Object)</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">Location</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="n">Location</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">Location</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">latitude</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">latitude</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">latitude</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">latitude</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">longitude</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">longitude</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">longitude</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">longitude</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">street</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">street</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">street</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">street</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">Outcome <small>police.types</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">police</span><span class="o">.</span><span class="na">types</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map.Entry</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Outcome</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="n">OutcomeCategory</span> <span class="n">category</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">date</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Crime</span> <span class="n">crime</span><span class="o">;</span>

	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unused&quot;</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nf">Outcome</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param category outcome category</span>
<span class="cm">	 * @param date unparsed date at which the crime occurred</span>
<span class="cm">	 * @param crime the crime itself</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">Outcome</span><span class="o">(</span><span class="n">OutcomeCategory</span> <span class="n">category</span><span class="o">,</span> <span class="n">String</span> <span class="n">date</span><span class="o">,</span> <span class="n">Crime</span> <span class="n">crime</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">category</span> <span class="o">=</span> <span class="n">category</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">date</span> <span class="o">=</span> <span class="n">date</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">crime</span> <span class="o">=</span> <span class="n">crime</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the category</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">OutcomeCategory</span> <span class="nf">getCategory</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">category</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the date</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getDate</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">date</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the crime</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Crime</span> <span class="nf">getCrime</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">crime</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#hashCode()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">prime</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">category</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">category</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">crime</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">crime</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">date</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">date</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#equals(java.lang.Object)</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">Outcome</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="n">Outcome</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">Outcome</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">category</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">category</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">category</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">category</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">crime</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">crime</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">crime</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">crime</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">date</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">date</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">date</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">date</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#toString()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="s">&quot;Outcome [category=&quot;</span> <span class="o">+</span> <span class="n">category</span> <span class="o">+</span> <span class="s">&quot;, date=&quot;</span> <span class="o">+</span> <span class="n">date</span> <span class="o">+</span> <span class="s">&quot;, crime=&quot;</span>
				<span class="o">+</span> <span class="n">crime</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">toStringWithExtraInfo</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">swei_crime</span> <span class="o">=</span> <span class="n">crime</span>
				<span class="o">.</span><span class="na">toStringWithExtraInfo</span><span class="o">();</span>
		<span class="kd">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">remarks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>

		<span class="n">String</span> <span class="n">category</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">category</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">category</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">remarks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;category is null&quot;</span><span class="o">);</span>
			<span class="n">category</span> <span class="o">=</span> <span class="s">&quot;(null)&quot;</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="n">String</span> <span class="n">date</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">date</span><span class="o">;</span>

		<span class="n">String</span> <span class="n">crime</span> <span class="o">=</span> <span class="n">swei_crime</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
		<span class="n">remarks</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">swei_crime</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>

		<span class="kd">final</span> <span class="n">String</span> <span class="n">mStr</span> <span class="o">=</span> <span class="s">&quot;Outcome [category=&quot;</span> <span class="o">+</span> <span class="n">category</span> <span class="o">+</span> <span class="s">&quot;, date=&quot;</span> <span class="o">+</span> <span class="n">date</span>
				<span class="o">+</span> <span class="s">&quot;, crime=&quot;</span> <span class="o">+</span> <span class="n">crime</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="o">;</span>

		<span class="k">return</span> <span class="k">new</span> <span class="n">KeyValuePair</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;(</span><span class="n">mStr</span><span class="o">,</span> <span class="n">remarks</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">OutcomeCategory <small>police.types</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">police</span><span class="o">.</span><span class="na">types</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OutcomeCategory</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">code</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unused&quot;</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nf">OutcomeCategory</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param code url slug for the category</span>
<span class="cm">	 * @param name human-readable category name</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">OutcomeCategory</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the code</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">code</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the name</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">name</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#toString()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="s">&quot;OutcomeCategory [code=&quot;</span> <span class="o">+</span> <span class="n">code</span> <span class="o">+</span> <span class="s">&quot;, name=&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#hashCode()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">prime</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">code</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">code</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">name</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">name</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#equals(java.lang.Object)</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">OutcomeCategory</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="n">OutcomeCategory</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">OutcomeCategory</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">code</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">code</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">code</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">code</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">name</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">name</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">OutcomeStatus <small>police.types</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">police</span><span class="o">.</span><span class="na">types</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kn">import</span> <span class="nn">java.text.ParseException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.text.SimpleDateFormat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OutcomeStatus</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">category</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">date</span><span class="o">;</span>

	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unused&quot;</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nf">OutcomeStatus</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param category outcome status category</span>
<span class="cm">	 * @param date date of this outcome status occurring.</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">OutcomeStatus</span><span class="o">(</span><span class="n">String</span> <span class="n">category</span><span class="o">,</span> <span class="n">String</span> <span class="n">date</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">category</span> <span class="o">=</span> <span class="n">category</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">date</span> <span class="o">=</span> <span class="n">date</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the category</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getCategory</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">category</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the date</span>
<span class="cm">	 * @throws ParseException</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">Date</span> <span class="nf">getDate</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">ParseException</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">SimpleDateFormat</span><span class="o">(</span><span class="s">&quot;yyyy-MM&quot;</span><span class="o">).</span><span class="na">parse</span><span class="o">(</span><span class="n">date</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#toString()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="s">&quot;OutcomeStatus [category=&quot;</span> <span class="o">+</span> <span class="n">category</span> <span class="o">+</span> <span class="s">&quot;, date=&quot;</span> <span class="o">+</span> <span class="n">date</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#hashCode()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">prime</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span>
				<span class="o">+</span> <span class="o">((</span><span class="n">category</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">category</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">date</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">date</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#equals(java.lang.Object)</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">OutcomeStatus</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="n">OutcomeStatus</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">OutcomeStatus</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">category</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">category</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">category</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">category</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">date</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">date</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">date</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">date</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">Street <small>police.types</small></h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="kn">package</span> <span class="n">police</span><span class="o">.</span><span class="na">types</span><span class="o">;</span>
<span class="cm">/** !license-block </span>
<span class="cm">    This file is part of Areabase.</span>

<span class="cm">    Areabase is free software: you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    Areabase is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Areabase.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="cm">    Areabase (C) 2013-2014 Filip Wieland &lt;filiplamparski@gmail.com&gt;</span>
<span class="cm">*/</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Street</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unused&quot;</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nf">Street</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @param id url slug or id of the street</span>
<span class="cm">	 * @param name human-readable street name</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="nf">Street</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the id</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">id</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * @return the name</span>
<span class="cm">	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">name</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#hashCode()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">prime</span> <span class="o">=</span> <span class="mi">31</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">((</span><span class="n">name</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">name</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#equals(java.lang.Object)</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">Street</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="n">Street</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">Street</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">id</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="na">id</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">name</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">name</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * (non-Javadoc)</span>
<span class="cm">	 * </span>
<span class="cm">	 * @see java.lang.Object#toString()</span>
<span class="cm">	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="s">&quot;Street [id=&quot;</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span> <span class="s">&quot;, name=&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">AndroidManifest.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;manifest</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">package=</span><span class="s">&quot;lamparski.areabase&quot;</span>
    <span class="na">android:installLocation=</span><span class="s">&quot;auto&quot;</span>
    <span class="na">android:versionCode=</span><span class="s">&quot;3&quot;</span>
    <span class="na">android:versionName=</span><span class="s">&quot;0.2.beta-2&quot;</span> <span class="nt">&gt;</span>

    <span class="nt">&lt;uses-sdk</span>
        <span class="na">android:minSdkVersion=</span><span class="s">&quot;14&quot;</span>
        <span class="na">android:targetSdkVersion=</span><span class="s">&quot;19&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.ACCESS_FINE_LOCATION&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.INTERNET&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;uses-feature</span> <span class="na">android:name=</span><span class="s">&quot;android.hardware.location&quot;</span> <span class="na">android:required=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;uses-feature</span> <span class="na">android:name=</span><span class="s">&quot;android.hardware.location.gps&quot;</span> <span class="na">android:required=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;uses-feature</span> <span class="na">android:name=</span><span class="s">&quot;android.hardware.touchscreen&quot;</span> <span class="na">android:required=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;supports-screens</span>
        <span class="na">android:anyDensity=</span><span class="s">&quot;true&quot;</span>
        <span class="na">android:largeScreens=</span><span class="s">&quot;true&quot;</span>
        <span class="na">android:normalScreens=</span><span class="s">&quot;true&quot;</span>
        <span class="na">android:smallScreens=</span><span class="s">&quot;true&quot;</span>
        <span class="na">android:resizeable=</span><span class="s">&quot;true&quot;</span>   <span class="nt">/&gt;</span>

    <span class="nt">&lt;compatible-screens&gt;</span>

        <span class="c">&lt;!-- small size screens --&gt;</span>
        <span class="nt">&lt;screen</span> <span class="na">android:screenSize=</span><span class="s">&quot;small&quot;</span> <span class="na">android:screenDensity=</span><span class="s">&quot;ldpi&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;screen</span> <span class="na">android:screenSize=</span><span class="s">&quot;small&quot;</span> <span class="na">android:screenDensity=</span><span class="s">&quot;mdpi&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;screen</span> <span class="na">android:screenSize=</span><span class="s">&quot;small&quot;</span> <span class="na">android:screenDensity=</span><span class="s">&quot;hdpi&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;screen</span> <span class="na">android:screenSize=</span><span class="s">&quot;small&quot;</span> <span class="na">android:screenDensity=</span><span class="s">&quot;xhdpi&quot;</span> <span class="nt">/&gt;</span>

        <span class="c">&lt;!--Only hdpi and xhdpi for normal size screens --&gt;</span>
        <span class="nt">&lt;screen</span> <span class="na">android:screenSize=</span><span class="s">&quot;normal&quot;</span> <span class="na">android:screenDensity=</span><span class="s">&quot;ldpi&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;screen</span> <span class="na">android:screenSize=</span><span class="s">&quot;normal&quot;</span> <span class="na">android:screenDensity=</span><span class="s">&quot;mdpi&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;screen</span> <span class="na">android:screenSize=</span><span class="s">&quot;normal&quot;</span> <span class="na">android:screenDensity=</span><span class="s">&quot;hdpi&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;screen</span> <span class="na">android:screenSize=</span><span class="s">&quot;normal&quot;</span> <span class="na">android:screenDensity=</span><span class="s">&quot;xhdpi&quot;</span> <span class="nt">/&gt;</span>

        <span class="c">&lt;!-- all large size screens --&gt;</span>
        <span class="nt">&lt;screen</span> <span class="na">android:screenSize=</span><span class="s">&quot;large&quot;</span> <span class="na">android:screenDensity=</span><span class="s">&quot;ldpi&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;screen</span> <span class="na">android:screenSize=</span><span class="s">&quot;large&quot;</span> <span class="na">android:screenDensity=</span><span class="s">&quot;mdpi&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;screen</span> <span class="na">android:screenSize=</span><span class="s">&quot;large&quot;</span> <span class="na">android:screenDensity=</span><span class="s">&quot;hdpi&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;screen</span> <span class="na">android:screenSize=</span><span class="s">&quot;large&quot;</span> <span class="na">android:screenDensity=</span><span class="s">&quot;xhdpi&quot;</span> <span class="nt">/&gt;</span>

        <span class="c">&lt;!-- all xlarge size screens --&gt;</span>
        <span class="nt">&lt;screen</span> <span class="na">android:screenSize=</span><span class="s">&quot;xlarge&quot;</span> <span class="na">android:screenDensity=</span><span class="s">&quot;ldpi&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;screen</span> <span class="na">android:screenSize=</span><span class="s">&quot;xlarge&quot;</span> <span class="na">android:screenDensity=</span><span class="s">&quot;mdpi&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;screen</span> <span class="na">android:screenSize=</span><span class="s">&quot;xlarge&quot;</span> <span class="na">android:screenDensity=</span><span class="s">&quot;hdpi&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;screen</span> <span class="na">android:screenSize=</span><span class="s">&quot;xlarge&quot;</span> <span class="na">android:screenDensity=</span><span class="s">&quot;xhdpi&quot;</span> <span class="nt">/&gt;</span>

        <span class="c">&lt;!-- Special case for Nexus 7 --&gt;</span>
        <span class="nt">&lt;screen</span> <span class="na">android:screenSize=</span><span class="s">&quot;large&quot;</span> <span class="na">android:screenDensity=</span><span class="s">&quot;213&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;/compatible-screens&gt;</span>



    <span class="nt">&lt;application</span>
        <span class="na">android:allowBackup=</span><span class="s">&quot;true&quot;</span>
        <span class="na">android:icon=</span><span class="s">&quot;@drawable/ic_launcher&quot;</span>
        <span class="na">android:label=</span><span class="s">&quot;@string/app_name&quot;</span>
        <span class="na">android:theme=</span><span class="s">&quot;@style/AppTheme&quot;</span> <span class="nt">&gt;</span>
        <span class="nt">&lt;activity</span>
            <span class="na">android:name=</span><span class="s">&quot;lamparski.areabase.AreaActivity&quot;</span>
            <span class="na">android:label=</span><span class="s">&quot;@string/app_name&quot;</span> <span class="nt">&gt;</span>
            <span class="nt">&lt;intent-filter&gt;</span>
                <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.action.MAIN&quot;</span> <span class="nt">/&gt;</span>

                <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.category.LAUNCHER&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/intent-filter&gt;</span>
        <span class="nt">&lt;/activity&gt;</span>
        <span class="nt">&lt;activity</span>
            <span class="na">android:name=</span><span class="s">&quot;lamparski.areabase.SettingsActivity&quot;</span>
            <span class="na">android:label=</span><span class="s">&quot;@string/title_activity_settings&quot;</span> <span class="nt">&gt;</span>
        <span class="nt">&lt;/activity&gt;</span>

        <span class="nt">&lt;service</span> <span class="na">android:name=</span><span class="s">&quot;lamparski.areabase.services.AreaDataService&quot;</span> <span class="nt">&gt;</span>
        <span class="nt">&lt;/service&gt;</span>

        <span class="nt">&lt;provider</span>
            <span class="na">android:name=</span><span class="s">&quot;lamparski.areabase.CacheContentProvider&quot;</span>
            <span class="na">android:authorities=</span><span class="s">&quot;lamparski.areabase.content&quot;</span>
            <span class="na">android:exported=</span><span class="s">&quot;false&quot;</span> <span class="nt">&gt;</span>
        <span class="nt">&lt;/provider&gt;</span>

        <span class="nt">&lt;meta-data</span>
            <span class="na">android:name=</span><span class="s">&quot;com.google.android.gms.version&quot;</span>
            <span class="na">android:value=</span><span class="s">&quot;@integer/google_play_services_version&quot;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;activity</span>
            <span class="na">android:name=</span><span class="s">&quot;lamparski.areabase.GraphActivity&quot;</span>
            <span class="na">android:label=</span><span class="s">&quot;@string/title_activity_graph&quot;</span>
            <span class="na">android:parentActivityName=</span><span class="s">&quot;lamparski.areabase.AreaActivity&quot;</span> <span class="nt">&gt;</span>
            <span class="nt">&lt;meta-data</span>
                <span class="na">android:name=</span><span class="s">&quot;android.support.PARENT_ACTIVITY&quot;</span>
                <span class="na">android:value=</span><span class="s">&quot;AreaActivity&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/activity&gt;</span>
    <span class="nt">&lt;/application&gt;</span>

<span class="nt">&lt;/manifest&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/drawable/card.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;layer-list</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="nt">&gt;</span>

    <span class="c">&lt;!-- &quot;shadow&quot; --&gt;</span>
    <span class="c">&lt;!--</span>
<span class="c">    &lt;item&gt;</span>
<span class="c">        &lt;bitmap android:src=&quot;@drawable/card_shadow&quot; &gt;</span>
<span class="c">        &lt;/bitmap&gt;</span>
<span class="c">    &lt;/item&gt;</span>
<span class="c">    --&gt;</span>
    <span class="nt">&lt;item&gt;</span>
        <span class="nt">&lt;shape</span>
            <span class="na">android:dither=</span><span class="s">&quot;true&quot;</span>
            <span class="na">android:shape=</span><span class="s">&quot;rectangle&quot;</span> <span class="nt">&gt;</span>
            <span class="nt">&lt;corners</span> <span class="na">android:radius=</span><span class="s">&quot;2dp&quot;</span> <span class="nt">/&gt;</span>

            <span class="nt">&lt;solid</span> <span class="na">android:color=</span><span class="s">&quot;@drawable/mySemiTransparentDrawable&quot;</span> <span class="nt">/&gt;</span>

            <span class="nt">&lt;stroke</span>
                <span class="na">android:width=</span><span class="s">&quot;0px&quot;</span>
                <span class="na">android:color=</span><span class="s">&quot;@android:color/primary_text_light&quot;</span> <span class="nt">/&gt;</span>

            <span class="nt">&lt;padding</span>
                <span class="na">android:bottom=</span><span class="s">&quot;8dp&quot;</span>
                <span class="na">android:left=</span><span class="s">&quot;8dp&quot;</span>
                <span class="na">android:right=</span><span class="s">&quot;8dp&quot;</span>
                <span class="na">android:top=</span><span class="s">&quot;8dp&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/shape&gt;</span>
    <span class="nt">&lt;/item&gt;</span>

<span class="nt">&lt;/layer-list&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/drawable/divider_vertical.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;shape</span> <span class="na">xmlns:a=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">a:shape=</span><span class="s">&quot;line&quot;</span> <span class="nt">&gt;</span>

    <span class="nt">&lt;stroke</span>
        <span class="na">a:width=</span><span class="s">&quot;1dp&quot;</span>
        <span class="na">a:color=</span><span class="s">&quot;@android:color/darker_gray&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/shape&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/drawable/navicon_police.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;shape</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="na">android:shape=</span><span class="s">&quot;rectangle&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;solid</span> <span class="na">android:color=</span><span class="s">&quot;#1b4080&quot;</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;stroke</span> <span class="na">android:width=</span><span class="s">&quot;12dp&quot;</span> <span class="na">android:color=</span><span class="s">&quot;@android:color/transparent&quot;</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;size</span> <span class="na">android:width=</span><span class="s">&quot;48dp&quot;</span> <span class="na">android:height=</span><span class="s">&quot;48dp&quot;</span><span class="nt">/&gt;</span>
	
<span class="nt">&lt;/shape&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/drawable/nav_crime_padded.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>

<span class="nt">&lt;inset</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:drawable=</span><span class="s">&quot;@drawable/navicon_crime&quot;</span>
    <span class="na">android:insetLeft=</span><span class="s">&quot;8dp&quot;</span>
    <span class="na">android:insetRight=</span><span class="s">&quot;8dp&quot;</span>
    <span class="na">android:insetTop=</span><span class="s">&quot;8dp&quot;</span>
    <span class="na">android:insetBottom=</span><span class="s">&quot;8dp&quot;</span>
    <span class="nt">/&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/drawable/nav_economy_padded.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>

<span class="nt">&lt;inset</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:drawable=</span><span class="s">&quot;@drawable/navicon_economy&quot;</span>
    <span class="na">android:insetLeft=</span><span class="s">&quot;8dp&quot;</span>
    <span class="na">android:insetRight=</span><span class="s">&quot;8dp&quot;</span>
    <span class="na">android:insetTop=</span><span class="s">&quot;8dp&quot;</span>
    <span class="na">android:insetBottom=</span><span class="s">&quot;8dp&quot;</span>
    <span class="nt">/&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/drawable/nav_environment_padded.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>

<span class="nt">&lt;inset</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:drawable=</span><span class="s">&quot;@drawable/navicon_environment&quot;</span>
    <span class="na">android:insetLeft=</span><span class="s">&quot;8dp&quot;</span>
    <span class="na">android:insetRight=</span><span class="s">&quot;8dp&quot;</span>
    <span class="na">android:insetTop=</span><span class="s">&quot;8dp&quot;</span>
    <span class="na">android:insetBottom=</span><span class="s">&quot;8dp&quot;</span>
    <span class="nt">/&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/drawable/nav_ons_padded.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>

<span class="nt">&lt;inset</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:drawable=</span><span class="s">&quot;@drawable/ons_logo_small&quot;</span>
    <span class="na">android:insetLeft=</span><span class="s">&quot;8dp&quot;</span>
    <span class="na">android:insetRight=</span><span class="s">&quot;8dp&quot;</span>
    <span class="na">android:insetTop=</span><span class="s">&quot;8dp&quot;</span>
    <span class="na">android:insetBottom=</span><span class="s">&quot;8dp&quot;</span>
    <span class="nt">/&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/drawable/nav_summary_padded.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>

<span class="nt">&lt;inset</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:drawable=</span><span class="s">&quot;@drawable/navicon_summary&quot;</span>
    <span class="na">android:insetLeft=</span><span class="s">&quot;8dp&quot;</span>
    <span class="na">android:insetRight=</span><span class="s">&quot;8dp&quot;</span>
    <span class="na">android:insetTop=</span><span class="s">&quot;8dp&quot;</span>
    <span class="na">android:insetBottom=</span><span class="s">&quot;8dp&quot;</span>
    <span class="nt">/&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/drawable/selectable_background_cardbank.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="c">&lt;!--</span>
<span class="c">     File created by the Android Action Bar Style Generator</span>

<span class="c">     Copyright (C) 2012 readyState Software Ltd</span>

<span class="c">     Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c">     you may not use this file except in compliance with the License.</span>
<span class="c">     You may obtain a copy of the License at</span>
<span class="c">  </span>
<span class="c">          http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">  </span>
<span class="c">     Unless required by applicable law or agreed to in writing, software</span>
<span class="c">     distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c">     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c">     See the License for the specific language governing permissions and</span>
<span class="c">     limitations under the License.</span>
<span class="c">--&gt;</span>

<span class="nt">&lt;selector</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="na">android:exitFadeDuration=</span><span class="s">&quot;@android:integer/config_mediumAnimTime&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;item</span> <span class="na">android:drawable=</span><span class="s">&quot;@android:color/transparent&quot;</span> <span class="na">android:state_focused=</span><span class="s">&quot;true&quot;</span> <span class="na">android:state_pressed=</span><span class="s">&quot;false&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;item</span> <span class="na">android:drawable=</span><span class="s">&quot;@color/holoLightBlueColour&quot;</span> <span class="na">android:state_pressed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;item</span> <span class="na">android:drawable=</span><span class="s">&quot;@android:color/transparent&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/selector&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/drawable/selectable_background_links.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="c">&lt;!--</span>
<span class="c">     File created by the Android Action Bar Style Generator</span>

<span class="c">     Copyright (C) 2012 readyState Software Ltd</span>

<span class="c">     Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c">     you may not use this file except in compliance with the License.</span>
<span class="c">     You may obtain a copy of the License at</span>
<span class="c">  </span>
<span class="c">          http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">  </span>
<span class="c">     Unless required by applicable law or agreed to in writing, software</span>
<span class="c">     distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c">     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c">     See the License for the specific language governing permissions and</span>
<span class="c">     limitations under the License.</span>
<span class="c">--&gt;</span>

<span class="nt">&lt;selector</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="na">android:exitFadeDuration=</span><span class="s">&quot;@android:integer/config_mediumAnimTime&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;item</span> <span class="na">android:drawable=</span><span class="s">&quot;@android:color/darker_gray&quot;</span> <span class="na">android:state_focused=</span><span class="s">&quot;true&quot;</span> <span class="na">android:state_pressed=</span><span class="s">&quot;false&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;item</span> <span class="na">android:drawable=</span><span class="s">&quot;@android:color/holo_blue_light&quot;</span> <span class="na">android:state_pressed=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;item</span> <span class="na">android:drawable=</span><span class="s">&quot;@android:color/transparent&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/selector&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/action_search_edittext.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;EditText</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:id=</span><span class="s">&quot;@+id/action_search_edittext_edittext&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:hint=</span><span class="s">&quot;@string/action_search_hint&quot;</span>
    <span class="na">android:imeOptions=</span><span class="s">&quot;actionSearch&quot;</span>
    <span class="na">android:inputType=</span><span class="s">&quot;text&quot;</span> <span class="nt">&gt;</span>

<span class="nt">&lt;/EditText&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/activity_graph.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="nt">&lt;FrameLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
    <span class="na">android:id=</span><span class="s">&quot;@+id/container&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">tools:context=</span><span class="s">&quot;lamparski.areabase.GraphActivity&quot;</span>
    <span class="na">tools:ignore=</span><span class="s">&quot;MergeRootFrame&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/area_activity.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;android.support.v4.widget.DrawerLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:id=</span><span class="s">&quot;@+id/handset_area_activity_drawerLayout_DEFAULT&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span> <span class="nt">&gt;</span>

    <span class="c">&lt;!-- Content view --&gt;</span>

    <span class="nt">&lt;FrameLayout</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/handset_area_activity_frameLayout_DEFAULT&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;/FrameLayout&gt;</span>
    <span class="c">&lt;!-- Nav drawer --&gt;</span>

    <span class="nt">&lt;include</span> <span class="na">layout=</span><span class="s">&quot;@layout/navdrawer&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/android.support.v4.widget.DrawerLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/card_arearank.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>

<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;horizontal&quot;</span> <span class="na">android:layout_width=</span><span class="s">&quot;fill_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;TextView</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;0dp&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:textAppearance=</span><span class="s">&quot;@android:style/TextAppearance.Holo.Medium&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;AreaRank for Lewisham 010&quot;</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/card_arearank_text&quot;</span>
        <span class="na">android:layout_weight=</span><span class="s">&quot;1&quot;</span>
        <span class="na">android:layout_gravity=</span><span class="s">&quot;center_vertical&quot;</span>
        <span class="na">android:paddingLeft=</span><span class="s">&quot;16dp&quot;</span>
        <span class="na">android:fontFamily=</span><span class="s">&quot;sans-serif-thin&quot;</span>
        <span class="na">android:textSize=</span><span class="s">&quot;24sp&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;TextView</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;64dp&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;100.0&quot;</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/card_arearank_score&quot;</span>
        <span class="na">android:layout_gravity=</span><span class="s">&quot;center_vertical|right&quot;</span>
        <span class="na">android:gravity=</span><span class="s">&quot;center&quot;</span>
        <span class="na">android:textAlignment=</span><span class="s">&quot;gravity&quot;</span>
        <span class="na">android:singleLine=</span><span class="s">&quot;true&quot;</span>
        <span class="na">android:textColor=</span><span class="s">&quot;@android:color/primary_text_dark&quot;</span>
        <span class="na">android:background=</span><span class="s">&quot;@android:color/holo_blue_dark&quot;</span>
        <span class="na">android:padding=</span><span class="s">&quot;4dp&quot;</span>
        <span class="na">android:textAppearance=</span><span class="s">&quot;@android:style/TextAppearance.Holo.Large&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/card_error.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;horizontal&quot;</span>
    <span class="na">android:layout_marginRight=</span><span class="s">&quot;@dimen/activity_horizontal_margin&quot;</span>
    <span class="na">android:layout_marginLeft=</span><span class="s">&quot;@dimen/activity_horizontal_margin&quot;</span>
    <span class="na">android:paddingRight=</span><span class="s">&quot;@dimen/activity_horizontal_margin&quot;</span>
    <span class="na">android:paddingLeft=</span><span class="s">&quot;@dimen/activity_horizontal_margin&quot;</span> <span class="nt">&gt;</span>

    <span class="nt">&lt;ImageView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/cardsui_error_placeholder_icon&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:padding=</span><span class="s">&quot;16dp&quot;</span>
        <span class="na">android:src=</span><span class="s">&quot;@drawable/ic_launcher&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;LinearLayout</span>
    	<span class="na">android:layout_width=</span><span class="s">&quot;0dp&quot;</span>
    	<span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    	<span class="na">android:padding=</span><span class="s">&quot;8dp&quot;</span><span class="nt">&gt;</span>
    	
    	<span class="nt">&lt;TextView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/cardsui_error_placeholder_title&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_gravity=</span><span class="s">&quot;center_horizontal&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;Large Text&quot;</span>
        <span class="na">android:textAppearance=</span><span class="s">&quot;?android:attr/textAppearanceLarge&quot;</span>
        <span class="na">android:textColor=</span><span class="s">&quot;@android:color/holo_orange_dark&quot;</span> <span class="nt">/&gt;</span>

    	<span class="nt">&lt;TextView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/cardsui_error_placeholder_msg&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_gravity=</span><span class="s">&quot;center_horizontal&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;Medium Text&quot;</span>
        <span class="na">android:textAppearance=</span><span class="s">&quot;?android:attr/textAppearanceMedium&quot;</span> <span class="nt">/&gt;</span>	
    <span class="nt">&lt;/LinearLayout&gt;</span>

<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/card_ex.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span>
    <span class="na">android:paddingBottom=</span><span class="s">&quot;16dp&quot;</span> <span class="nt">&gt;</span>

    <span class="nt">&lt;LinearLayout</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:gravity=</span><span class="s">&quot;center_vertical&quot;</span>
        <span class="na">android:paddingLeft=</span><span class="s">&quot;8dp&quot;</span>
        <span class="na">android:paddingRight=</span><span class="s">&quot;8dp&quot;</span> <span class="nt">&gt;</span>

        <span class="nt">&lt;TextView</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/card_basic_title&quot;</span>
            <span class="na">style=</span><span class="s">&quot;@style/CardTitle&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;0dp&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_weight=</span><span class="s">&quot;1&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;title&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/LinearLayout&gt;</span>

    <span class="nt">&lt;View</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;fill_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;1dp&quot;</span>
        <span class="na">android:layout_marginTop=</span><span class="s">&quot;4dp&quot;</span>
        <span class="na">android:background=</span><span class="s">&quot;@color/stroke&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;LinearLayout</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:background=</span><span class="s">&quot;@drawable/selectable_background_cardbank&quot;</span>
        <span class="na">android:gravity=</span><span class="s">&quot;center_vertical&quot;</span>
        <span class="na">android:padding=</span><span class="s">&quot;4dp&quot;</span> <span class="nt">&gt;</span>

        <span class="nt">&lt;TextView</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/card_basic_text&quot;</span>
            <span class="na">style=</span><span class="s">&quot;@style/CardText&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_marginLeft=</span><span class="s">&quot;8dp&quot;</span>
            <span class="na">android:ellipsize=</span><span class="s">&quot;end&quot;</span>
            <span class="na">android:maxLines=</span><span class="s">&quot;4&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec viverra metus et ligula accumsan auctor. Nullam luctus neque quis nibh porttitor sagittis. Nunc dignissim quam nec quam scelerisque faucibus. Maecenas elementum ante eget felis vestibulum quis pharetra dui condimentum. In a ligula lectus, aliquet interdum diam. Fusce luctus bibendum tellus, sed iaculis mi vehicula vitae. Fusce quis ipsum in est ultricies egestas a vel orci.&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/LinearLayout&gt;</span>

<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/card_picture.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span> <span class="nt">&gt;</span>

    <span class="nt">&lt;LinearLayout</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:gravity=</span><span class="s">&quot;center_vertical&quot;</span>
        <span class="na">android:paddingLeft=</span><span class="s">&quot;8dp&quot;</span>
        <span class="na">android:paddingRight=</span><span class="s">&quot;8dp&quot;</span> <span class="nt">&gt;</span>

        <span class="nt">&lt;TextView</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/card_picture_title&quot;</span>
            <span class="na">style=</span><span class="s">&quot;@style/CardTitle&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;0dp&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_weight=</span><span class="s">&quot;1&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;title&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/LinearLayout&gt;</span>

    <span class="nt">&lt;View</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;fill_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;1dp&quot;</span>
        <span class="na">android:layout_marginTop=</span><span class="s">&quot;4dp&quot;</span>
        <span class="na">android:background=</span><span class="s">&quot;@color/stroke&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;LinearLayout</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:background=</span><span class="s">&quot;@drawable/selectable_background_cardbank&quot;</span>
        <span class="na">android:gravity=</span><span class="s">&quot;center_vertical&quot;</span>
        <span class="na">android:padding=</span><span class="s">&quot;8dp&quot;</span> <span class="nt">&gt;</span>

        <span class="nt">&lt;ImageView</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/card_picture_image&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;154dp&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;127dp&quot;</span>
            <span class="na">android:adjustViewBounds=</span><span class="s">&quot;true&quot;</span>
            <span class="na">android:baselineAlignBottom=</span><span class="s">&quot;true&quot;</span>
            <span class="na">android:scaleType=</span><span class="s">&quot;centerCrop&quot;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;TextView</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/card_picture_text&quot;</span>
            <span class="na">style=</span><span class="s">&quot;@style/CardText&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
            <span class="na">android:layout_marginLeft=</span><span class="s">&quot;8dp&quot;</span>
            <span class="na">android:ellipsize=</span><span class="s">&quot;end&quot;</span>
            <span class="na">android:maxLines=</span><span class="s">&quot;7&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec viverra metus et ligula accumsan auctor. Nullam luctus neque quis nibh porttitor sagittis. Nunc dignissim quam nec quam scelerisque faucibus. Maecenas elementum ante eget felis vestibulum quis pharetra dui condimentum. In a ligula lectus, aliquet interdum diam. Fusce luctus bibendum tellus, sed iaculis mi vehicula vitae. Fusce quis ipsum in est ultricies egestas a vel orci.&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/LinearLayout&gt;</span>

<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/card_picture_large.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span> <span class="nt">&gt;</span>

    <span class="nt">&lt;LinearLayout</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:gravity=</span><span class="s">&quot;center_vertical&quot;</span>
        <span class="na">android:paddingLeft=</span><span class="s">&quot;8dp&quot;</span>
        <span class="na">android:paddingRight=</span><span class="s">&quot;8dp&quot;</span> <span class="nt">&gt;</span>

        <span class="nt">&lt;TextView</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/card_picture_title&quot;</span>
            <span class="na">style=</span><span class="s">&quot;@style/CardTitle&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;0dp&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_weight=</span><span class="s">&quot;1&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;title&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/LinearLayout&gt;</span>

    <span class="nt">&lt;View</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;fill_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;1dp&quot;</span>
        <span class="na">android:layout_marginTop=</span><span class="s">&quot;4dp&quot;</span>
        <span class="na">android:background=</span><span class="s">&quot;@color/stroke&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;LinearLayout</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:background=</span><span class="s">&quot;@drawable/selectable_background_cardbank&quot;</span>
        <span class="na">android:gravity=</span><span class="s">&quot;center_vertical&quot;</span>
        <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span>
        <span class="na">android:padding=</span><span class="s">&quot;8dp&quot;</span> <span class="nt">&gt;</span>

        <span class="nt">&lt;ImageView</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/card_picture_image&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;127dp&quot;</span>
            <span class="na">android:adjustViewBounds=</span><span class="s">&quot;true&quot;</span>
            <span class="na">android:baselineAlignBottom=</span><span class="s">&quot;true&quot;</span>
            <span class="na">android:scaleType=</span><span class="s">&quot;centerCrop&quot;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;LinearLayout</span>
            <span class="na">style=</span><span class="s">&quot;@style/button_bar&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
            <span class="na">android:divider=</span><span class="s">&quot;@drawable/divider_vertical&quot;</span>
            <span class="na">android:orientation=</span><span class="s">&quot;horizontal&quot;</span>
            <span class="na">android:showDividers=</span><span class="s">&quot;middle&quot;</span> <span class="nt">&gt;</span>

            <span class="nt">&lt;Button</span>
                <span class="na">android:id=</span><span class="s">&quot;@+id/card_picture_large_button_left&quot;</span>
                <span class="na">style=</span><span class="s">&quot;@style/button_bar_button&quot;</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;0dp&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_weight=</span><span class="s">&quot;1&quot;</span>
                <span class="na">android:drawableLeft=</span><span class="s">&quot;@drawable/action_search&quot;</span>
                <span class="na">android:text=</span><span class="s">&quot;View data&quot;</span> <span class="nt">/&gt;</span>

            <span class="nt">&lt;Button</span>
                <span class="na">android:id=</span><span class="s">&quot;@+id/card_picture_large_button_right&quot;</span>
                <span class="na">style=</span><span class="s">&quot;@style/button_bar_button&quot;</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;0dp&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_weight=</span><span class="s">&quot;1&quot;</span>
                <span class="na">android:drawableLeft=</span><span class="s">&quot;@drawable/icon_chart_blue&quot;</span>
                <span class="na">android:text=</span><span class="s">&quot;Interactive&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/LinearLayout&gt;</span>
    <span class="nt">&lt;/LinearLayout&gt;</span>

<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/card_play.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;horizontal&quot;</span>
    <span class="na">android:gravity=</span><span class="s">&quot;center_vertical&quot;</span>
    <span class="na">android:weightSum=</span><span class="s">&quot;100&quot;</span>
    <span class="na">android:paddingBottom=</span><span class="s">&quot;6dp&quot;</span> <span class="nt">&gt;</span>

        <span class="nt">&lt;ImageView</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/card_play_stripe&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;0dip&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
            <span class="na">android:layout_weight=</span><span class="s">&quot;3&quot;</span>
            <span class="na">android:adjustViewBounds=</span><span class="s">&quot;true&quot;</span>
            <span class="na">android:background=</span><span class="s">&quot;#CC0000&quot;</span>
            <span class="na">android:baselineAlignBottom=</span><span class="s">&quot;true&quot;</span>
            <span class="na">android:contentDescription=</span><span class="s">&quot;color_stripe&quot;</span>
            <span class="na">android:scaleType=</span><span class="s">&quot;centerCrop&quot;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;LinearLayout</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/contentLayout&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;0dip&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_marginLeft=</span><span class="s">&quot;8dip&quot;</span>
            <span class="na">android:layout_weight=</span><span class="s">&quot;90&quot;</span>
            <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span> <span class="nt">&gt;</span>

            <span class="nt">&lt;TextView</span>
                <span class="na">android:id=</span><span class="s">&quot;@+id/card_play_title&quot;</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_marginLeft=</span><span class="s">&quot;8dip&quot;</span>
                <span class="na">android:fontFamily=</span><span class="s">&quot;sans-serif-thin&quot;</span>
                <span class="na">android:text=</span><span class="s">&quot;title&quot;</span>
                <span class="na">android:textColor=</span><span class="s">&quot;#33B6EA&quot;</span>
                <span class="na">android:textSize=</span><span class="s">&quot;24sp&quot;</span> <span class="nt">/&gt;</span>

            <span class="nt">&lt;TextView</span>
                <span class="na">android:id=</span><span class="s">&quot;@+id/card_play_text&quot;</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_gravity=</span><span class="s">&quot;center_vertical&quot;</span>
                <span class="na">android:layout_marginLeft=</span><span class="s">&quot;8dip&quot;</span>
                <span class="na">android:layout_marginRight=</span><span class="s">&quot;48dip&quot;</span>
                <span class="na">android:ellipsize=</span><span class="s">&quot;end&quot;</span>
                <span class="na">android:fontFamily=</span><span class="s">&quot;sans-serif-light&quot;</span>
                <span class="na">android:text=</span><span class="s">&quot;desc&quot;</span>
                <span class="na">android:textSize=</span><span class="s">&quot;16sp&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/LinearLayout&gt;</span>

        <span class="nt">&lt;LinearLayout</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;0dip&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;fill_parent&quot;</span>
            <span class="na">android:layout_weight=</span><span class="s">&quot;10&quot;</span>
            <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span> <span class="nt">&gt;</span>

            <span class="nt">&lt;ImageButton</span>
                <span class="na">android:id=</span><span class="s">&quot;@+id/card_play_overflow&quot;</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:background=</span><span class="s">&quot;@drawable/selectable_background_cardbank&quot;</span>
                <span class="na">android:contentDescription=</span><span class="s">&quot;overflow&quot;</span>
                <span class="na">android:padding=</span><span class="s">&quot;2dip&quot;</span>
                <span class="na">android:src=</span><span class="s">&quot;@drawable/ic_action_overflow&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/LinearLayout&gt;</span>

<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/fragment_collection_object.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;RelativeLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:id=</span><span class="s">&quot;@+id/RelativeLayout1&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span> <span class="nt">&gt;</span>

    <span class="nt">&lt;TextView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/objectIdTextView&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_centerHorizontal=</span><span class="s">&quot;true&quot;</span>
        <span class="na">android:layout_centerVertical=</span><span class="s">&quot;true&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;Large Text&quot;</span>
        <span class="na">android:textAppearance=</span><span class="s">&quot;?android:attr/textAppearanceLarge&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/RelativeLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/fragment_demographics_summary.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:paddingLeft=</span><span class="s">&quot;@dimen/activity_horizontal_margin&quot;</span>
    <span class="na">android:paddingRight=</span><span class="s">&quot;@dimen/activity_horizontal_margin&quot;</span>
    <span class="na">android:paddingTop=</span><span class="s">&quot;@dimen/activity_vertical_margin&quot;</span>
    <span class="na">android:paddingBottom=</span><span class="s">&quot;@dimen/activity_vertical_margin&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span>
    <span class="na">tools:context=</span><span class="s">&quot;com.example.app.MainActivity$PlaceholderFragment&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;TextView</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;Demographics&quot;</span>
        <span class="na">android:textAppearance=</span><span class="s">&quot;?android:attr/textAppearanceLarge&quot;</span>
        <span class="na">android:layout_gravity=</span><span class="s">&quot;center_horizontal&quot;</span>
        <span class="na">android:layout_marginBottom=</span><span class="s">&quot;16dp&quot;</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;TableLayout</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;fill_parent&quot;</span>
        <span class="na">android:baselineAligned=</span><span class="s">&quot;false&quot;</span>
        <span class="na">android:dividerPadding=</span><span class="s">&quot;4dp&quot;</span><span class="nt">&gt;</span>

        <span class="nt">&lt;TableRow</span> <span class="na">android:paddingTop=</span><span class="s">&quot;4dp&quot;</span>
            <span class="na">android:paddingBottom=</span><span class="s">&quot;4dp&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;TextView</span>
                    <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
                    <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
                    <span class="na">android:text=</span><span class="s">&quot;Population Density (persons/sq km)&quot;</span>
                    <span class="na">android:layout_weight=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;TextView</span>
                	<span class="na">android:id=</span><span class="s">&quot;@+id/demographics_summary_pop_density_val&quot;</span>
                    <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
                    <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
                    <span class="na">android:layout_gravity=</span><span class="s">&quot;right&quot;</span>
                    <span class="na">android:text=</span><span class="s">&quot;...&quot;</span>
                    <span class="na">android:textAppearance=</span><span class="s">&quot;?android:textAppearanceLarge&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/TableRow&gt;</span>

        <span class="nt">&lt;TableRow</span> <span class="na">android:paddingTop=</span><span class="s">&quot;4dp&quot;</span>
            <span class="na">android:paddingBottom=</span><span class="s">&quot;4dp&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;TextView</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:text=</span><span class="s">&quot;Average age (years)&quot;</span>
                <span class="na">android:layout_weight=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;TextView</span>
            	<span class="na">android:id=</span><span class="s">&quot;@+id/demographics_summary_avg_age_val&quot;</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_gravity=</span><span class="s">&quot;right&quot;</span>
                <span class="na">android:text=</span><span class="s">&quot;...&quot;</span>
                <span class="na">android:textAppearance=</span><span class="s">&quot;?android:textAppearanceLarge&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/TableRow&gt;</span>

        <span class="nt">&lt;TableRow</span> <span class="na">android:paddingTop=</span><span class="s">&quot;4dp&quot;</span>
            <span class="na">android:paddingBottom=</span><span class="s">&quot;4dp&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;TextView</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:text=</span><span class="s">&quot;Population size (count)&quot;</span>
                <span class="na">android:layout_weight=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;TextView</span>
            	<span class="na">android:id=</span><span class="s">&quot;@+id/demographics_summary_pop_size_val&quot;</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_gravity=</span><span class="s">&quot;right&quot;</span>
                <span class="na">android:text=</span><span class="s">&quot;...&quot;</span>
                <span class="na">android:textAppearance=</span><span class="s">&quot;?android:textAppearanceLarge&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/TableRow&gt;</span>

        <span class="nt">&lt;TableRow</span> <span class="na">android:paddingTop=</span><span class="s">&quot;4dp&quot;</span>
            <span class="na">android:paddingBottom=</span><span class="s">&quot;4dp&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;TextView</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:text=</span><span class="s">&quot;...of which women (%)&quot;</span>
                <span class="na">android:layout_weight=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;TextView</span>
            	<span class="na">android:id=</span><span class="s">&quot;@+id/demographics_summary_pop_women_val&quot;</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_gravity=</span><span class="s">&quot;right&quot;</span>
                <span class="na">android:text=</span><span class="s">&quot;...&quot;</span>
                <span class="na">android:textAppearance=</span><span class="s">&quot;?android:textAppearanceLarge&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/TableRow&gt;</span>

        <span class="nt">&lt;TableRow</span> <span class="na">android:paddingTop=</span><span class="s">&quot;4dp&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;TextView</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:text=</span><span class="s">&quot;Primary ethnic group&quot;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;/TableRow&gt;</span>

        <span class="nt">&lt;TableRow</span> <span class="na">android:orientation=</span><span class="s">&quot;horizontal&quot;</span> <span class="na">android:paddingBottom=</span><span class="s">&quot;4dp&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;TextView</span>
            	<span class="na">android:id=</span><span class="s">&quot;@+id/demographics_summary_ethnic_group_val&quot;</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_gravity=</span><span class="s">&quot;right&quot;</span>
                <span class="na">android:layout_span=</span><span class="s">&quot;2&quot;</span>
                <span class="na">android:text=</span><span class="s">&quot;...&quot;</span>
                <span class="na">android:textAppearance=</span><span class="s">&quot;?android:textAppearanceMedium&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/TableRow&gt;</span>

        <span class="nt">&lt;TableRow</span> <span class="na">android:paddingTop=</span><span class="s">&quot;4dp&quot;</span>
            <span class="na">android:paddingBottom=</span><span class="s">&quot;4dp&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;TextView</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:text=</span><span class="s">&quot;Immigration (%)&quot;</span>
                <span class="na">android:layout_weight=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;TextView</span>
            	<span class="na">android:id=</span><span class="s">&quot;@+id/demographics_summary_immigration_val&quot;</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_gravity=</span><span class="s">&quot;right&quot;</span>
                <span class="na">android:text=</span><span class="s">&quot;...&quot;</span>
                <span class="na">android:textAppearance=</span><span class="s">&quot;?android:textAppearanceLarge&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/TableRow&gt;</span>

        <span class="nt">&lt;TableRow</span>
            <span class="na">android:layout_marginBottom=</span><span class="s">&quot;16dp&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;Button</span>
                <span class="na">style=</span><span class="s">&quot;@android:style/Holo.Light.ButtonBar.AlertDialog&quot;</span>
                <span class="na">android:id=</span><span class="s">&quot;@+id/demographics_summary_see_census_btn&quot;</span>
                <span class="na">android:layout_span=</span><span class="s">&quot;2&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;48dp&quot;</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
                <span class="na">android:text=</span><span class="s">&quot;See in Census&quot;</span>
                <span class="na">android:drawableLeft=</span><span class="s">&quot;@drawable/icon_chart_blue&quot;</span>
                <span class="na">android:textColor=</span><span class="s">&quot;@android:color/holo_blue_dark&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/TableRow&gt;</span>

    <span class="nt">&lt;/TableLayout&gt;</span>

<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/fragment_graphactivity.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span>
    <span class="na">tools:context=</span><span class="s">&quot;lamparski.areabase.GraphActivity$PlaceholderFragment&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;TextView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/subject_view_header&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;SUBJECT NAME&quot;</span>
        <span class="na">android:fontFamily=</span><span class="s">&quot;sans-serif-condensed&quot;</span>
        <span class="na">android:layout_margin=</span><span class="s">&quot;8dp&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@android:style/TextAppearance.Holo.SearchResult.Title&quot;</span> <span class="nt">/&gt;</span>


    <span class="nt">&lt;View</span>
        <span class="na">android:background=</span><span class="s">&quot;@android:color/holo_blue_dark&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;1dp&quot;</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;LinearLayout</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;fill_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;fill_parent&quot;</span>
        <span class="na">android:paddingLeft=</span><span class="s">&quot;8dp&quot;</span>
        <span class="na">android:paddingRight=</span><span class="s">&quot;8dp&quot;</span>
        <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span><span class="nt">&gt;</span>

        <span class="nt">&lt;com.echo.holographlibrary.BarGraph</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;fill_parent&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;@dimen/chart_view_height&quot;</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/graph_activity_bargraph&quot;</span><span class="nt">/&gt;</span>

        <span class="nt">&lt;ListView</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;fill_parent&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;fill_parent&quot;</span>
            <span class="na">android:layout_marginTop=</span><span class="s">&quot;8dp&quot;</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/graph_activity_legend_list&quot;</span><span class="nt">&gt;</span>

        <span class="nt">&lt;/ListView&gt;</span>
    <span class="nt">&lt;/LinearLayout&gt;</span>

<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/fragment_subject_list.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>

<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
              <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
              <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span> <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">tools:context=</span><span class="s">&quot;.AreaActivity&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;TextView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/subject_view_header&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;SUBJECT NAME&quot;</span>
        <span class="na">android:fontFamily=</span><span class="s">&quot;sans-serif-condensed&quot;</span>
        <span class="na">android:layout_margin=</span><span class="s">&quot;8dp&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@android:style/TextAppearance.Holo.SearchResult.Title&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;View</span>
        <span class="na">android:background=</span><span class="s">&quot;@android:color/holo_blue_dark&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;1dp&quot;</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;ListView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/subject_list_view&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;fill_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;fill_parent&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/fragment_subject_view.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>

<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
              <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
              <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span> <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">tools:context=</span><span class="s">&quot;.AreaActivity&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;TextView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/subject_view_header&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;SUBJECT NAME&quot;</span>
        <span class="na">android:fontFamily=</span><span class="s">&quot;sans-serif-condensed&quot;</span>
        <span class="na">android:layout_margin=</span><span class="s">&quot;8dp&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@android:style/TextAppearance.Holo.SearchResult.Title&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;View</span>
        <span class="na">android:background=</span><span class="s">&quot;@android:color/holo_blue_dark&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;1dp&quot;</span><span class="nt">/&gt;</span>


    <span class="nt">&lt;ProgressBar</span>
        <span class="na">style=</span><span class="s">&quot;?android:attr/progressBarStyleHorizontal&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/subject_view_progress_bar&quot;</span>
        <span class="na">android:layout_marginTop=</span><span class="s">&quot;-7dp&quot;</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;ExpandableListView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/subject_view_expandable_list&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;fill_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;fill_parent&quot;</span>
        <span class="na">android:fastScrollEnabled=</span><span class="s">&quot;true&quot;</span>
        <span class="na">android:fastScrollAlwaysVisible=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/fragment_summary.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span> <span class="nt">&gt;</span>

    <span class="nt">&lt;lamparski.areabase.map_support.OrdnanceSurveyMapView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/fragment_summary_OSMapView_DEFAULT&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;0dp&quot;</span>
        <span class="na">android:layout_weight=</span><span class="s">&quot;40&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;com.fima.cardsui.views.CardUI</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/fragment_summary_CardsUI_DEFAULT&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;0dp&quot;</span>
        <span class="na">android:layout_weight=</span><span class="s">&quot;60&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/navbar_list_header.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;TextView</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:id=</span><span class="s">&quot;@+id/navbar_list_header_txt_header&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;fill_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
    <span class="na">android:paddingBottom=</span><span class="s">&quot;2dp&quot;</span>
    <span class="na">android:paddingLeft=</span><span class="s">&quot;4dp&quot;</span>
    <span class="na">android:paddingTop=</span><span class="s">&quot;24dp&quot;</span>
    <span class="na">android:textAppearance=</span><span class="s">&quot;?android:attr/listSeparatorTextViewStyle&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/navbar_list_item.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;RelativeLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
    <span class="na">android:minHeight=</span><span class="s">&quot;48dp&quot;</span>
    <span class="na">android:paddingBottom=</span><span class="s">&quot;4dp&quot;</span>
    <span class="na">android:paddingLeft=</span><span class="s">&quot;4dp&quot;</span>
    <span class="na">android:paddingTop=</span><span class="s">&quot;4dp&quot;</span> <span class="nt">&gt;</span>

    <span class="nt">&lt;ImageView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/navbar_list_item_navicon&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_alignParentLeft=</span><span class="s">&quot;true&quot;</span>
        <span class="na">android:layout_alignTop=</span><span class="s">&quot;@+id/navbar_list_item_txt_item&quot;</span>
        <span class="na">android:adjustViewBounds=</span><span class="s">&quot;true&quot;</span>
        <span class="na">android:maxHeight=</span><span class="s">&quot;24dp&quot;</span>
        <span class="na">android:maxWidth=</span><span class="s">&quot;24dp&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;TextView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/navbar_list_item_txt_item&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_alignParentTop=</span><span class="s">&quot;true&quot;</span>
        <span class="na">android:layout_marginLeft=</span><span class="s">&quot;8dp&quot;</span>
        <span class="na">android:layout_toRightOf=</span><span class="s">&quot;@+id/navbar_list_item_navicon&quot;</span>
        <span class="na">android:textAppearance=</span><span class="s">&quot;?android:attr/textAppearanceLarge&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/RelativeLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/navdrawer.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:id=</span><span class="s">&quot;@+id/navdrawer_layout&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;@dimen/nav_drawer_width&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_gravity=</span><span class="s">&quot;start&quot;</span>
    <span class="na">android:background=</span><span class="s">&quot;@android:color/background_light&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span> <span class="nt">&gt;</span>

    <span class="nt">&lt;RelativeLayout</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span> <span class="nt">&gt;</span>

        <span class="nt">&lt;ImageView</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/cardsui_error_placeholder_icon&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_alignParentLeft=</span><span class="s">&quot;true&quot;</span>
            <span class="na">android:layout_alignParentTop=</span><span class="s">&quot;true&quot;</span>
            <span class="na">android:layout_marginLeft=</span><span class="s">&quot;16dp&quot;</span>
            <span class="na">android:layout_marginTop=</span><span class="s">&quot;16dp&quot;</span>
            <span class="na">android:contentDescription=</span><span class="s">&quot;@string/a11y_cd_areabase_icon&quot;</span>
            <span class="na">android:src=</span><span class="s">&quot;@drawable/ic_launcher&quot;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;TextView</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_alignTop=</span><span class="s">&quot;@+id/cardsui_error_placeholder_icon&quot;</span>
            <span class="na">android:layout_toRightOf=</span><span class="s">&quot;@+id/cardsui_error_placeholder_icon&quot;</span>
            <span class="na">android:focusable=</span><span class="s">&quot;false&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;@string/app_name&quot;</span>
            <span class="na">android:textAppearance=</span><span class="s">&quot;?android:attr/textAppearanceLarge&quot;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;TextView</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/navdrawer_link_areabaseHelp&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_alignBottom=</span><span class="s">&quot;@+id/cardsui_error_placeholder_icon&quot;</span>
            <span class="na">android:layout_alignParentRight=</span><span class="s">&quot;true&quot;</span>
            <span class="na">android:layout_marginRight=</span><span class="s">&quot;16dp&quot;</span>
            <span class="na">android:background=</span><span class="s">&quot;@drawable/selectable_background_cardbank&quot;</span>
            <span class="na">android:clickable=</span><span class="s">&quot;true&quot;</span>
            <span class="na">android:focusable=</span><span class="s">&quot;true&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;@string/action_help&quot;</span>
            <span class="na">android:textColor=</span><span class="s">&quot;@color/holoLightBlueColour&quot;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;View</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;1dp&quot;</span>
            <span class="na">android:layout_alignParentLeft=</span><span class="s">&quot;true&quot;</span>
            <span class="na">android:layout_below=</span><span class="s">&quot;@+id/cardsui_error_placeholder_icon&quot;</span>
            <span class="na">android:layout_marginTop=</span><span class="s">&quot;16dp&quot;</span>
            <span class="na">android:background=</span><span class="s">&quot;@drawable/divider_horizontal_holo_dark&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/RelativeLayout&gt;</span>

    <span class="nt">&lt;lamparski.areabase.widgets.RobotoLightTextView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/navdrawer_link_areabaseSummary&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@style/areabaseNavDrawerLink&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:background=</span><span class="s">&quot;@drawable/selectable_background_links&quot;</span>
        <span class="na">android:drawableLeft=</span><span class="s">&quot;@drawable/nav_summary_padded&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;@string/caption_summary&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;View</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;1dp&quot;</span>
        <span class="na">android:background=</span><span class="s">&quot;@drawable/divider_horizontal_holo_dark&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;lamparski.areabase.widgets.RobotoLightTextView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/navdrawer_link_areabaseCrime&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@style/areabaseNavDrawerLink&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:background=</span><span class="s">&quot;@drawable/selectable_background_links&quot;</span>
        <span class="na">android:drawableLeft=</span><span class="s">&quot;@drawable/nav_crime_padded&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;@string/caption_crime&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;View</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;1dp&quot;</span>
        <span class="na">android:background=</span><span class="s">&quot;@drawable/divider_horizontal_holo_dark&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;lamparski.areabase.widgets.RobotoLightTextView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/navdrawer_link_areabaseEconomy&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@style/areabaseNavDrawerLink&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:background=</span><span class="s">&quot;@drawable/selectable_background_links&quot;</span>
        <span class="na">android:drawableLeft=</span><span class="s">&quot;@drawable/nav_economy_padded&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;@string/caption_economy&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;View</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;1dp&quot;</span>
        <span class="na">android:background=</span><span class="s">&quot;@drawable/divider_horizontal_holo_dark&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;lamparski.areabase.widgets.RobotoLightTextView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/navdrawer_link_areabaseEnvironment&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@style/areabaseNavDrawerLink&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:background=</span><span class="s">&quot;@drawable/selectable_background_links&quot;</span>
        <span class="na">android:drawableLeft=</span><span class="s">&quot;@drawable/nav_environment_padded&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;@string/caption_environment&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;View</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;1dp&quot;</span>
        <span class="na">android:layout_marginBottom=</span><span class="s">&quot;@dimen/nav_drawer_catsep_height&quot;</span>
        <span class="na">android:background=</span><span class="s">&quot;@drawable/divider_horizontal_holo_dark&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;lamparski.areabase.widgets.RobotoLightTextView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/navdrawer_link_areabaseONSBrowser&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@style/areabaseNavDrawerLink&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:background=</span><span class="s">&quot;@drawable/selectable_background_links&quot;</span>
        <span class="na">android:drawableLeft=</span><span class="s">&quot;@drawable/nav_ons_padded&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;@string/caption_ONS&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;View</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;1dp&quot;</span>
        <span class="na">android:background=</span><span class="s">&quot;@drawable/divider_horizontal_holo_dark&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;lamparski.areabase.widgets.RobotoLightTextView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/navdrawer_link_areabasePoliceDataBrowser&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@style/areabaseNavDrawerLink&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:background=</span><span class="s">&quot;@drawable/selectable_background_links&quot;</span>
        <span class="na">android:drawableLeft=</span><span class="s">&quot;@drawable/navicon_police&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;@string/caption_Police&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;View</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;1dp&quot;</span>
        <span class="na">android:background=</span><span class="s">&quot;@drawable/divider_horizontal_holo_dark&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/police_data_fragment.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>

<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span> <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;TextView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/police_data_fragment_header&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;POLICE DATA&quot;</span>
        <span class="na">android:fontFamily=</span><span class="s">&quot;sans-serif-condensed&quot;</span>
        <span class="na">android:layout_margin=</span><span class="s">&quot;8dp&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@android:style/TextAppearance.Holo.SearchResult.Title&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;View</span>
        <span class="na">android:background=</span><span class="s">&quot;@android:color/holo_blue_dark&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;1dp&quot;</span>
        <span class="na">android:layout_marginBottom=</span><span class="s">&quot;16dp&quot;</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;com.echo.holographlibrary.PieGraph</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/police_data_fragment_crime_graph&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;0dp&quot;</span>
        <span class="na">android:layout_weight=</span><span class="s">&quot;0.5&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;ListView</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;0dp&quot;</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/listView&quot;</span>
        <span class="na">android:layout_weight=</span><span class="s">&quot;0.5&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/subject_view_groupitem.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>

<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span> <span class="na">android:minHeight=</span><span class="s">&quot;48dp&quot;</span> <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
    <span class="na">android:padding=</span><span class="s">&quot;8dp&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;TextView</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;0dp&quot;</span>
        <span class="na">android:layout_weight=</span><span class="s">&quot;1&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:minHeight=</span><span class="s">&quot;48dp&quot;</span>
        <span class="na">android:gravity=</span><span class="s">&quot;center_vertical&quot;</span>
        <span class="na">android:textAppearance=</span><span class="s">&quot;?android:attr/textAppearanceMedium&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;Child Benefit Statistics (1999 - 2012)&quot;</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/subject_view_groupitem_title&quot;</span>
        <span class="na">android:layout_marginLeft=</span><span class="s">&quot;48dp&quot;</span>
        <span class="na">android:layout_marginRight=</span><span class="s">&quot;8dp&quot;</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;ImageView</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;24dp&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;24dp&quot;</span>
        <span class="na">android:layout_gravity=</span><span class="s">&quot;center_vertical&quot;</span>
        <span class="na">android:src=</span><span class="s">&quot;@drawable/icon_chart&quot;</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/subject_view_groupitem_graphability_indicator&quot;</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;TextView</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;fill_parent&quot;</span>
        <span class="na">android:textAppearance=</span><span class="s">&quot;?android:attr/textAppearanceLarge&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;12&quot;</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/subject_view_groupitem_count&quot;</span>
        <span class="na">android:layout_marginRight=</span><span class="s">&quot;8dp&quot;</span>
        <span class="na">android:layout_marginLeft=</span><span class="s">&quot;16dp&quot;</span>
        <span class="na">android:gravity=</span><span class="s">&quot;center_horizontal|center_vertical&quot;</span>
        <span class="na">android:textColor=</span><span class="s">&quot;@android:color/holo_blue_dark&quot;</span>
        <span class="na">android:textAlignment=</span><span class="s">&quot;center&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/subject_view_listitem.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>

<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span> <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
    <span class="na">android:background=</span><span class="s">&quot;#ffefefef&quot;</span> <span class="na">android:padding=</span><span class="s">&quot;8dp&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;LinearLayout</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;0dp&quot;</span>
        <span class="na">android:layout_weight=</span><span class="s">&quot;1&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_marginLeft=</span><span class="s">&quot;8dp&quot;</span>
        <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;TextView</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:textAppearance=</span><span class="s">&quot;?android:attr/textAppearanceMedium&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;4 to 9 Years Old&quot;</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/subject_view_listitem_title&quot;</span>
            <span class="na">android:layout_marginBottom=</span><span class="s">&quot;8dp&quot;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;TextView</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:textAppearance=</span><span class="s">&quot;?android:attr/textAppearanceSmall&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;Percentage of Live enterprises between 4 and 9 years old.&quot;</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/subject_view_listitem_subtitle&quot;</span>
            <span class="na">android:textColor=</span><span class="s">&quot;@android:color/secondary_text_light&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/LinearLayout&gt;</span>

    <span class="nt">&lt;TextView</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;fill_parent&quot;</span>
        <span class="na">android:textAppearance=</span><span class="s">&quot;?android:attr/textAppearanceLarge&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;28.5%&quot;</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/subject_view_listitem_count&quot;</span>
        <span class="na">android:layout_marginRight=</span><span class="s">&quot;8dp&quot;</span>
        <span class="na">android:layout_marginLeft=</span><span class="s">&quot;16dp&quot;</span>
        <span class="na">android:gravity=</span><span class="s">&quot;center_horizontal|center_vertical&quot;</span>
        <span class="na">android:textColor=</span><span class="s">&quot;@android:color/holo_blue_dark&quot;</span>
        <span class="na">android:textAlignment=</span><span class="s">&quot;center&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/subject_view_listitem_chart.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>

<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span> <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;@dimen/chart_view_height&quot;</span>
    <span class="na">android:paddingLeft=</span><span class="s">&quot;8dp&quot;</span>
    <span class="na">android:paddingRight=</span><span class="s">&quot;8dp&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;com.echo.holographlibrary.BarGraph</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/subject_view_listitem_bargraph&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout/subject_view_listitem_chartlink.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>

<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
              <span class="na">android:orientation=</span><span class="s">&quot;horizontal&quot;</span>
              <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
              <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
              <span class="na">android:padding=</span><span class="s">&quot;8dp&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;LinearLayout</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;0dp&quot;</span>
        <span class="na">android:layout_weight=</span><span class="s">&quot;1&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_marginLeft=</span><span class="s">&quot;8dp&quot;</span>
        <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;TextView</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:textAppearance=</span><span class="s">&quot;?android:attr/textAppearanceMedium&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;@string/action_graph&quot;</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/subject_view_listitem_chartlink_title&quot;</span>
            <span class="na">android:layout_marginBottom=</span><span class="s">&quot;8dp&quot;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;TextView</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:textAppearance=</span><span class="s">&quot;?android:attr/textAppearanceSmall&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;@string/action_graph_explanation&quot;</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/subject_view_listitem_chartlink_subtitle&quot;</span>
            <span class="na">android:textColor=</span><span class="s">&quot;@android:color/secondary_text_light&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/LinearLayout&gt;</span>

    <span class="nt">&lt;ImageView</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;fill_parent&quot;</span>
        <span class="na">android:src=</span><span class="s">&quot;@drawable/icon_chart_blue&quot;</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/subject_view_listitem_chartlink_icon&quot;</span>
        <span class="na">android:layout_marginRight=</span><span class="s">&quot;8dp&quot;</span>
        <span class="na">android:layout_marginLeft=</span><span class="s">&quot;16dp&quot;</span>
        <span class="na">android:gravity=</span><span class="s">&quot;center_horizontal|center_vertical&quot;</span>
         <span class="nt">/&gt;</span>
<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout-land/fragment_graphactivity.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span>
    <span class="na">tools:context=</span><span class="s">&quot;.GraphActivity&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;TabHost</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/graph_activity_tabhost&quot;</span>
        <span class="na">android:layout_gravity=</span><span class="s">&quot;center_horizontal&quot;</span><span class="nt">&gt;</span>

        <span class="nt">&lt;LinearLayout</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;fill_parent&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;fill_parent&quot;</span>
            <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span><span class="nt">&gt;</span>

            <span class="nt">&lt;LinearLayout</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:orientation=</span><span class="s">&quot;horizontal&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;LinearLayout</span>
                    <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
                    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
                    <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;TextView</span>
                        <span class="na">android:id=</span><span class="s">&quot;@+id/subject_view_header&quot;</span>
                        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
                        <span class="na">android:layout_height=</span><span class="s">&quot;0dp&quot;</span>
                        <span class="na">android:text=</span><span class="s">&quot;SUBJECT NAME&quot;</span>
                        <span class="na">android:fontFamily=</span><span class="s">&quot;sans-serif-condensed&quot;</span>
                        <span class="na">style=</span><span class="s">&quot;@android:style/TextAppearance.Holo.SearchResult.Title&quot;</span>
                        <span class="na">android:layout_marginLeft=</span><span class="s">&quot;8dp&quot;</span>
                        <span class="na">android:layout_gravity=</span><span class="s">&quot;center_vertical&quot;</span>
                        <span class="na">android:textAlignment=</span><span class="s">&quot;gravity&quot;</span>
                        <span class="na">android:layout_marginRight=</span><span class="s">&quot;16dp&quot;</span>
                        <span class="na">android:gravity=</span><span class="s">&quot;center_vertical&quot;</span>
                        <span class="na">android:layout_weight=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;View</span>
                        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
                        <span class="na">android:layout_height=</span><span class="s">&quot;1dp&quot;</span>
                        <span class="na">android:background=</span><span class="s">&quot;@android:color/holo_blue_dark&quot;</span>
                        <span class="na">android:layout_gravity=</span><span class="s">&quot;bottom&quot;</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;/LinearLayout&gt;</span>
                <span class="nt">&lt;TabWidget</span>
                    <span class="na">android:id=</span><span class="s">&quot;@android:id/tabs&quot;</span>
                    <span class="na">android:layout_width=</span><span class="s">&quot;0dp&quot;</span>
                    <span class="na">android:layout_weight=</span><span class="s">&quot;1&quot;</span>
                    <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;/TabWidget&gt;</span>
                <span class="nt">&lt;/LinearLayout&gt;</span>

            <span class="nt">&lt;FrameLayout</span>
                <span class="na">android:id=</span><span class="s">&quot;@android:id/tabcontent&quot;</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;fill_parent&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;fill_parent&quot;</span><span class="nt">&gt;</span>

                <span class="nt">&lt;LinearLayout</span>
                    <span class="na">android:id=</span><span class="s">&quot;@+id/graph_activity_tab1&quot;</span>
                    <span class="na">android:layout_width=</span><span class="s">&quot;fill_parent&quot;</span>
                    <span class="na">android:layout_height=</span><span class="s">&quot;fill_parent&quot;</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;com.echo.holographlibrary.BarGraph</span>
                        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
                        <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
                        <span class="na">android:id=</span><span class="s">&quot;@id/graph_activity_bargraph&quot;</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;/LinearLayout&gt;</span>

                <span class="nt">&lt;LinearLayout</span>
                    <span class="na">android:id=</span><span class="s">&quot;@+id/graph_activity_tab2&quot;</span>
                    <span class="na">android:layout_width=</span><span class="s">&quot;fill_parent&quot;</span>
                    <span class="na">android:layout_height=</span><span class="s">&quot;fill_parent&quot;</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;ListView</span>
                        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
                        <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
                        <span class="na">android:id=</span><span class="s">&quot;@id/graph_activity_legend_list&quot;</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;/LinearLayout&gt;</span>
            <span class="nt">&lt;/FrameLayout&gt;</span>
        <span class="nt">&lt;/LinearLayout&gt;</span>
    <span class="nt">&lt;/TabHost&gt;</span>


<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout-land/fragment_summary.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;horizontal&quot;</span> <span class="nt">&gt;</span>

    <span class="nt">&lt;lamparski.areabase.map_support.OrdnanceSurveyMapView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/fragment_summary_OSMapView_DEFAULT_LANDSCAPE&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;0dp&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_weight=</span><span class="s">&quot;40&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;com.fima.cardsui.views.CardUI</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/fragment_summary_CardsUI_DEFAULT_LAND&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;0dp&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_weight=</span><span class="s">&quot;60&quot;</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;/com.fima.cardsui.views.CardUI&gt;</span>

<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout-land/police_data_fragment.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>

<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
              <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
              <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span> <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">tools:context=</span><span class="s">&quot;.AreaActivity&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;TextView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/police_data_fragment_header&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;POLICE DATA&quot;</span>
        <span class="na">android:fontFamily=</span><span class="s">&quot;sans-serif-condensed&quot;</span>
        <span class="na">android:layout_margin=</span><span class="s">&quot;8dp&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@android:style/TextAppearance.Holo.SearchResult.Title&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;View</span>
        <span class="na">android:background=</span><span class="s">&quot;@android:color/holo_blue_dark&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;1dp&quot;</span>
        <span class="na">android:layout_marginBottom=</span><span class="s">&quot;8dp&quot;</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;LinearLayout</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:orientation=</span><span class="s">&quot;horizontal&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;com.echo.holographlibrary.PieGraph</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/police_data_fragment_crime_graph&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;0dp&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
            <span class="na">android:layout_weight=</span><span class="s">&quot;0.4&quot;</span>
            <span class="na">android:layout_margin=</span><span class="s">&quot;8dp&quot;</span><span class="nt">/&gt;</span>

        <span class="nt">&lt;ListView</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;0dp&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/listView&quot;</span>
            <span class="na">android:layout_weight=</span><span class="s">&quot;0.6&quot;</span>
            <span class="na">android:layout_margin=</span><span class="s">&quot;8dp&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/LinearLayout&gt;</span>

<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout-large/area_activity.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;android.support.v4.widget.DrawerLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:id=</span><span class="s">&quot;@+id/tablet_area_activity_drawerLayout&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span> <span class="nt">&gt;</span>

    <span class="c">&lt;!-- Content view --&gt;</span>

    <span class="nt">&lt;FrameLayout</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/tablet_area_activity_frameLayout&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;/FrameLayout&gt;</span>
    <span class="c">&lt;!-- Nav drawer --&gt;</span>

    <span class="nt">&lt;include</span> <span class="na">layout=</span><span class="s">&quot;@layout/navdrawer&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/android.support.v4.widget.DrawerLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout-large/card_error.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_marginLeft=</span><span class="s">&quot;@dimen/activity_horizontal_margin&quot;</span>
    <span class="na">android:layout_marginRight=</span><span class="s">&quot;@dimen/activity_horizontal_margin&quot;</span>
    <span class="na">android:background=</span><span class="s">&quot;@drawable/mySemiTransparentDrawable&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span>
    <span class="na">android:paddingLeft=</span><span class="s">&quot;@dimen/activity_horizontal_margin&quot;</span>
    <span class="na">android:paddingRight=</span><span class="s">&quot;@dimen/activity_horizontal_margin&quot;</span>
    <span class="na">android:paddingTop=</span><span class="s">&quot;8dp&quot;</span> <span class="nt">&gt;</span>

    <span class="nt">&lt;ImageView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/cardsui_error_placeholder_icon&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_gravity=</span><span class="s">&quot;center_horizontal&quot;</span>
        <span class="na">android:layout_marginBottom=</span><span class="s">&quot;16dp&quot;</span>
        <span class="na">android:src=</span><span class="s">&quot;@drawable/ic_launcher&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;TextView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/cardsui_error_placeholder_title&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_gravity=</span><span class="s">&quot;center_horizontal&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;Large Text&quot;</span>
        <span class="na">android:textAppearance=</span><span class="s">&quot;?android:attr/textAppearanceLarge&quot;</span>
        <span class="na">android:textColor=</span><span class="s">&quot;@android:color/holo_orange_dark&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;TextView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/cardsui_error_placeholder_msg&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_gravity=</span><span class="s">&quot;center_horizontal&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;Medium Text&quot;</span>
        <span class="na">android:textAppearance=</span><span class="s">&quot;?android:attr/textAppearanceMedium&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout-large/fragment_summary.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;RelativeLayout</span> <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
    <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:gravity=</span><span class="s">&quot;bottom&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span> <span class="nt">&gt;</span>

    <span class="nt">&lt;lamparski.areabase.map_support.OrdnanceSurveyMapView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/fragment_summary_OSMapView_TABLET&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_alignParentLeft=</span><span class="s">&quot;true&quot;</span>
        <span class="na">android:layout_alignParentTop=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;com.fima.cardsui.views.CardUI</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/fragment_summary_CardsUI_TABLET&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_alignParentTop=</span><span class="s">&quot;true&quot;</span>
        <span class="na">android:layout_centerHorizontal=</span><span class="s">&quot;true&quot;</span>
        <span class="na">android:layout_marginTop=</span><span class="s">&quot;16dp&quot;</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;/com.fima.cardsui.views.CardUI&gt;</span>

<span class="nt">&lt;/RelativeLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/layout-large-land/fragment_summary.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;RelativeLayout</span> <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
    <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:id=</span><span class="s">&quot;@+id/RelativeLayout1&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:gravity=</span><span class="s">&quot;right&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;horizontal&quot;</span> <span class="nt">&gt;</span>

    <span class="nt">&lt;lamparski.areabase.map_support.OrdnanceSurveyMapView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/fragment_summary_OSMapView_TABLET_LANDSCAPE&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_alignParentLeft=</span><span class="s">&quot;true&quot;</span>
        <span class="na">android:layout_alignParentTop=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;com.fima.cardsui.views.CardUI</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/fragment_summary_CardsUI_TABLET_LANDSCAPE&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;480dp&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_alignParentRight=</span><span class="s">&quot;true&quot;</span>
        <span class="na">android:layout_alignParentTop=</span><span class="s">&quot;true&quot;</span>
        <span class="na">android:background=</span><span class="s">&quot;@drawable/myTransparentDrawable&quot;</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;/com.fima.cardsui.views.CardUI&gt;</span>

<span class="nt">&lt;/RelativeLayout&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/menu/areabase_opts_menu.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="nt">&lt;menu</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="nt">&gt;</span>

    <span class="nt">&lt;item</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/action_settings&quot;</span>
        <span class="na">android:orderInCategory=</span><span class="s">&quot;100&quot;</span>
        <span class="na">android:showAsAction=</span><span class="s">&quot;never&quot;</span>
        <span class="na">android:title=</span><span class="s">&quot;@string/action_settings&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;item</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/action_locate&quot;</span>
        <span class="na">android:icon=</span><span class="s">&quot;@drawable/location_place&quot;</span>
        <span class="na">android:orderInCategory=</span><span class="s">&quot;1&quot;</span>
        <span class="na">android:showAsAction=</span><span class="s">&quot;always|withText|collapseActionView&quot;</span>
        <span class="na">android:title=</span><span class="s">&quot;@string/action_locate&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/item&gt;</span>
    <span class="nt">&lt;item</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/action_search&quot;</span>
        <span class="na">android:actionLayout=</span><span class="s">&quot;@layout/action_search_edittext&quot;</span>
        <span class="na">android:icon=</span><span class="s">&quot;@drawable/action_search&quot;</span>
        <span class="na">android:orderInCategory=</span><span class="s">&quot;2&quot;</span>
        <span class="na">android:showAsAction=</span><span class="s">&quot;always|collapseActionView&quot;</span>
        <span class="na">android:title=</span><span class="s">&quot;@string/action_search&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/item&gt;</span>
    <span class="nt">&lt;item</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/action_refresh&quot;</span>
        <span class="na">android:icon=</span><span class="s">&quot;@drawable/navigation_refresh&quot;</span>
        <span class="na">android:orderInCategory=</span><span class="s">&quot;3&quot;</span>
        <span class="na">android:showAsAction=</span><span class="s">&quot;ifRoom&quot;</span>
        <span class="na">android:title=</span><span class="s">&quot;@string/action_refresh&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/item&gt;</span>
    <span class="nt">&lt;item</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/action_help&quot;</span>
        <span class="na">android:icon=</span><span class="s">&quot;@drawable/action_help&quot;</span>
        <span class="na">android:orderInCategory=</span><span class="s">&quot;101&quot;</span>
        <span class="na">android:showAsAction=</span><span class="s">&quot;never&quot;</span>
        <span class="na">android:title=</span><span class="s">&quot;@string/action_help&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/item&gt;</span>

<span class="nt">&lt;/menu&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/menu/graph.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="nt">&lt;menu</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
    <span class="na">tools:context=</span><span class="s">&quot;lamparski.areabase.GraphActivity&quot;</span> <span class="nt">&gt;</span>
    
    <span class="nt">&lt;item</span> <span class="na">android:id=</span><span class="s">&quot;@+id/action_settings&quot;</span>
        <span class="na">android:title=</span><span class="s">&quot;@string/action_settings&quot;</span>
        <span class="na">android:orderInCategory=</span><span class="s">&quot;100&quot;</span>
        <span class="na">android:showAsAction=</span><span class="s">&quot;never&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/menu&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/values/color.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;resources&gt;</span>

    <span class="nt">&lt;color</span> <span class="na">name=</span><span class="s">&quot;holoLightBlueColour&quot;</span><span class="nt">&gt;</span>#FF33B5E5<span class="nt">&lt;/color&gt;</span>

    <span class="nt">&lt;drawable</span> <span class="na">name=</span><span class="s">&quot;holoLightBlueDrawable&quot;</span><span class="nt">&gt;</span>#FF33B5E5<span class="nt">&lt;/drawable&gt;</span>

    <span class="nt">&lt;color</span> <span class="na">name=</span><span class="s">&quot;stroke&quot;</span><span class="nt">&gt;</span>#FFCCCCCC<span class="nt">&lt;/color&gt;</span>

    <span class="c">&lt;!-- Colour for areas whose score &gt;= 80 --&gt;</span>
    <span class="nt">&lt;color</span> <span class="na">name=</span><span class="s">&quot;arearank80&quot;</span><span class="nt">&gt;</span>@android:color/holo_blue_dark<span class="nt">&lt;/color&gt;</span>
    <span class="c">&lt;!-- Colour for areas whose score &gt;= 60 --&gt;</span>
    <span class="nt">&lt;color</span> <span class="na">name=</span><span class="s">&quot;arearank60&quot;</span><span class="nt">&gt;</span>@android:color/holo_green_dark<span class="nt">&lt;/color&gt;</span>
    <span class="c">&lt;!-- Colour for areas whose score &gt;= 40 --&gt;</span>
    <span class="nt">&lt;color</span> <span class="na">name=</span><span class="s">&quot;arearank40&quot;</span><span class="nt">&gt;</span>@android:color/holo_orange_dark<span class="nt">&lt;/color&gt;</span>
    <span class="c">&lt;!-- Colour for areas whose score &lt; 21 --&gt;</span>
    <span class="nt">&lt;color</span> <span class="na">name=</span><span class="s">&quot;arearank20&quot;</span><span class="nt">&gt;</span>@android:color/holo_red_dark<span class="nt">&lt;/color&gt;</span>

<span class="nt">&lt;/resources&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/values/data.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;resources&gt;</span>

    <span class="nt">&lt;item</span> <span class="na">name=</span><span class="s">&quot;pop_density&quot;</span> <span class="na">format=</span><span class="s">&quot;float&quot;</span> <span class="na">type=</span><span class="s">&quot;fraction&quot;</span><span class="nt">&gt;</span>256.0<span class="nt">&lt;/item&gt;</span>

<span class="nt">&lt;/resources&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/values/dimens.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="nt">&lt;resources&gt;</span>

    <span class="c">&lt;!-- Default screen margins, per the Android Design guidelines. --&gt;</span>
    <span class="nt">&lt;dimen</span> <span class="na">name=</span><span class="s">&quot;activity_horizontal_margin&quot;</span><span class="nt">&gt;</span>16dp<span class="nt">&lt;/dimen&gt;</span>
    <span class="nt">&lt;dimen</span> <span class="na">name=</span><span class="s">&quot;activity_vertical_margin&quot;</span><span class="nt">&gt;</span>16dp<span class="nt">&lt;/dimen&gt;</span>
    <span class="nt">&lt;dimen</span> <span class="na">name=</span><span class="s">&quot;nav_drawer_catsep_height&quot;</span><span class="nt">&gt;</span>24dp<span class="nt">&lt;/dimen&gt;</span>
    <span class="nt">&lt;dimen</span> <span class="na">name=</span><span class="s">&quot;nav_drawer_width&quot;</span><span class="nt">&gt;</span>300dp<span class="nt">&lt;/dimen&gt;</span>
    <span class="nt">&lt;dimen</span> <span class="na">name=</span><span class="s">&quot;chart_view_height&quot;</span><span class="nt">&gt;</span>180dp<span class="nt">&lt;/dimen&gt;</span>

<span class="nt">&lt;/resources&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/values/strings.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;resources&gt;</span>

    <span class="c">&lt;!-- app --&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;app_name&quot;</span><span class="nt">&gt;</span>Areabase<span class="nt">&lt;/string&gt;</span>

    <span class="c">&lt;!-- actions --&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;action_settings&quot;</span><span class="nt">&gt;</span>Settings<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;action_locate&quot;</span><span class="nt">&gt;</span>Locate<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;action_search&quot;</span><span class="nt">&gt;</span>Search<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;action_refresh&quot;</span><span class="nt">&gt;</span>Refresh<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;action_help&quot;</span><span class="nt">&gt;</span>Help<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;action_search_hint&quot;</span><span class="nt">&gt;</span>Postcode or area name…<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;action_graph&quot;</span><span class="nt">&gt;</span>Graph this data<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;action_graph_explanation&quot;</span><span class="nt">&gt;</span>Open a new window to view a graph of this dataset.<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;select_area_from_list&quot;</span><span class="nt">&gt;</span>Select area name…<span class="nt">&lt;/string&gt;</span>

    <span class="c">&lt;!-- messages --&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;toast_mapview_not_loading&quot;</span><span class="nt">&gt;</span>Could not load the map view.<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;error_illegal_url_title&quot;</span><span class="nt">&gt;</span>Something is trying to open in the map area.<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;error_illegal_url_formatstring&quot;</span><span class="nt">&gt;</span>This should not happen. If you think this is not a problem, here is the url: %1$s<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;error_illegal_url_response_dontgo&quot;</span><span class="nt">&gt;</span>Stay in Areabase<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;error_illegal_url_response_open&quot;</span><span class="nt">&gt;</span>Open in browser (caution)<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;drawer_open&quot;</span><span class="nt">&gt;</span>Open drawer<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;drawer_close&quot;</span><span class="nt">&gt;</span>Close drawer<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;error_cannot_fetch_area_data&quot;</span><span class="nt">&gt;</span>Sorry, data about this area could not be fetched.<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;error_cannot_fetch_area_data_body&quot;</span><span class="nt">&gt;</span>Please make sure you are connected to the Internet and try again later. The message associated with this error is: %1$s. Hope this helps.<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;io_exception_generic_message&quot;</span><span class="nt">&gt;</span>Please check your connection.<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;summaryactivity_cardmaker_ioerror_body&quot;</span><span class="nt">&gt;</span>Ensure that you have some form of connectivity enabled. If you are using an authenticated proxy, Areabase will not work.<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;summaryactivity_cardmaker_onserror&quot;</span><span class="nt">&gt;</span>Error processing ONS data. Sorry :(<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;summaryactivity_cardmaker_servicedisconnect_title&quot;</span><span class="nt">&gt;</span>Oh noes!<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;summaryactivity_cardmaker_servicedisconnect_message&quot;</span><span class="nt">&gt;</span>An important component of Areabase, %1$s, just broke. The app will probably crash and burn soon. Sorry :(<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;summaryactivity_cardmaker_values_not_available&quot;</span><span class="nt">&gt;</span>Areabase may not work correctly in certain areas, mostly Scotland and Northern Ireland. Office for National Statistics does not cover Scotland and NI, and Scottish National Statistics does not provide a way Areabase can access its data. Police data is not available for Northern Ireland. Lastly, datasets may not be complete in any of these databases.<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;error_cannot_resolve_postcode&quot;</span><span class="nt">&gt;</span>Could not resolve the postcode.<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;error_cannot_resolve_postcode_body&quot;</span><span class="nt">&gt;</span>The postcode for your location appears invalid. This could be because of how Google Geocoder returns postcodes. Try to walk to a different location and press the &quot;Locate&quot; button.<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;file_not_found_msg&quot;</span><span class="nt">&gt;</span>Some data could not be found.<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;areas_not_found&quot;</span><span class="nt">&gt;</span>There are no matching Local Authorities.<span class="nt">&lt;/string&gt;</span>

    <span class="c">&lt;!-- navigation --&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;navdrawer_secheader_basic_info&quot;</span><span class="nt">&gt;</span>This area<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;caption_summary&quot;</span><span class="nt">&gt;</span>Summary<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;caption_crime&quot;</span><span class="nt">&gt;</span>Crime<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;caption_economy&quot;</span><span class="nt">&gt;</span>Economy<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;caption_environment&quot;</span><span class="nt">&gt;</span>Environment<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;navdrawer_secheader_more_data&quot;</span><span class="nt">&gt;</span>Explore data<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;caption_ONS&quot;</span><span class="nt">&gt;</span>Office for National Statistics<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;caption_Police&quot;</span><span class="nt">&gt;</span>Police.uk<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;navdrawer_secheader_misc&quot;</span><span class="nt">&gt;</span>Miscellaneous<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;caption_area_hierarchy&quot;</span><span class="nt">&gt;</span>Hierarchy<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;caption_area_compare&quot;</span><span class="nt">&gt;</span>Compare areas<span class="nt">&lt;/string&gt;</span>

    <span class="c">&lt;!-- preferences --&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;title_activity_settings&quot;</span><span class="nt">&gt;</span>Preferences<span class="nt">&lt;/string&gt;</span>
    <span class="c">&lt;!-- preferences -&gt; location --&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;pref_category_location_heading&quot;</span><span class="nt">&gt;</span>Location<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;pref_category_location_autoLocate_primaryText&quot;</span><span class="nt">&gt;</span>Automatically find location<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;pref_category_location_autoLocate_infoText_enabled&quot;</span><span class="nt">&gt;</span>Areabase will automatically find your location on startup.<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;pref_category_location_autoLocate_infoText_disabled&quot;</span><span class="nt">&gt;</span>Areabase will wait until you press &quot;Locate&quot; to find your location.<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;pref_category_location_backgroundRefix_primaryText&quot;</span><span class="nt">&gt;</span>Update location in the background<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;pref_category_location_backgroundRefix_infoText_enabled&quot;</span><span class="nt">&gt;</span>Areabase will keep your location up-to-date by querying GPS periodically.<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;pref_category_location_backgroundRefix_infoText_disabled&quot;</span><span class="nt">&gt;</span>Areabase will not keep track of your location. This may save battery, but &quot;Locate&quot; may take longer.<span class="nt">&lt;/string&gt;</span>
    <span class="c">&lt;!-- preferences -&gt; testing --&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;pref_category_testing_heading&quot;</span><span class="nt">&gt;</span>Experimental<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;pref_category_testing_phoneHome_primaryText&quot;</span><span class="nt">&gt;</span>Report crashes<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;pref_category_testing_phoneHome_infoText_enabled&quot;</span><span class="nt">&gt;</span>If the application crashes, an automatic report will be sent to the developer.<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;pref_category_testing_phoneHome_infoText_disabled&quot;</span><span class="nt">&gt;</span>Areabase will not send anything to the developer. You want to turn this on though.<span class="nt">&lt;/string&gt;</span>

    <span class="c">&lt;!-- cards --&gt;</span>
    <span class="c">&lt;!-- cards -&gt; demographics --&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;card_demographics_title&quot;</span><span class="nt">&gt;</span>People of %1$s<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;card_demographics_title_base&quot;</span><span class="nt">&gt;</span>%1$s is a demographically %2$s area.<span class="nt">&lt;/string&gt;</span>

    <span class="nt">&lt;string-array</span> <span class="na">name=</span><span class="s">&quot;card_demographics_pop_size_trend_descriptors&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;item&gt;</span>collapsing<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>declining<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>stable<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>growing<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>booming<span class="nt">&lt;/item&gt;</span>
    <span class="nt">&lt;/string-array&gt;</span>

    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;card_demographics_body_base&quot;</span><span class="nt">&gt;</span>There is %1$s and average age is %2$.1f. The area is %3$s.<span class="nt">&lt;/string&gt;</span>

    <span class="nt">&lt;string-array</span> <span class="na">name=</span><span class="s">&quot;card_demographics_sex_dominance_descriptors&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;item&gt;</span>significantly more women<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>more women<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>gender balance<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>more men<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>significantly more men<span class="nt">&lt;/item&gt;</span>
    <span class="nt">&lt;/string-array&gt;</span>
    <span class="nt">&lt;string-array</span> <span class="na">name=</span><span class="s">&quot;card_demographics_pop_density_descriptors&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;item&gt;</span>very sparsely populated<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>sparsely populated<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>normally populated<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>densely populated<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>very densely populated<span class="nt">&lt;/item&gt;</span>
    <span class="nt">&lt;/string-array&gt;</span>

    <span class="c">&lt;!-- cards -&gt; economy --&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;card_economy_title&quot;</span><span class="nt">&gt;</span>Economy of %1$s<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;card_economy_body_base&quot;</span><span class="nt">&gt;</span>Most of people in %1$s are %2$s. Most people here work in %3$s. Unemployment is at %4$.1f%% and %5$s.<span class="nt">&lt;/string&gt;</span>

    <span class="nt">&lt;string-array</span> <span class="na">name=</span><span class="s">&quot;card_economy_unemployment_trend&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;item&gt;</span>sharply falling<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>falling<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>stable<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>rising<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>sharply rising<span class="nt">&lt;/item&gt;</span>
    <span class="nt">&lt;/string-array&gt;</span>

    <span class="c">&lt;!-- cards -&gt; crime (real, ie via police data) --&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;card_crime_real_title&quot;</span><span class="nt">&gt;</span>Crime in %1$s<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;card_crime_real_body_base&quot;</span><span class="nt">&gt;</span>The most commonly reported type of crime here is %1$s. Crime overall is %2$s.<span class="nt">&lt;/string&gt;</span>

    <span class="nt">&lt;string-array</span> <span class="na">name=</span><span class="s">&quot;card_crime_real_trend&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;item&gt;</span>sharply falling<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>falling<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>stable<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>rising<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>sharply rising<span class="nt">&lt;/item&gt;</span>
    <span class="nt">&lt;/string-array&gt;</span>

    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;card_environ_title&quot;</span><span class="nt">&gt;</span>Environment in %1$s<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;card_environ_body_base&quot;</span><span class="nt">&gt;</span>%1$s is %2$s area. Energy use as of %3$s was %4$.1f MWh, and it is %5$s.<span class="nt">&lt;/string&gt;</span>

    <span class="nt">&lt;string-array</span> <span class="na">name=</span><span class="s">&quot;card_environ_area_types&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;item&gt;</span>a rural<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>an urban<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>an highly urban<span class="nt">&lt;/item&gt;</span>
    <span class="nt">&lt;/string-array&gt;</span>
    <span class="nt">&lt;string-array</span> <span class="na">name=</span><span class="s">&quot;card_environ_energy_trend&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;item&gt;</span>quickly decreasing<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>decreasing<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>not changing<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>increasing<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>quickly increasing<span class="nt">&lt;/item&gt;</span>
    <span class="nt">&lt;/string-array&gt;</span>

    <span class="c">&lt;!-- cards -&gt; score --&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;card_arearank_text&quot;</span><span class="nt">&gt;</span>AreaRank for %1$s<span class="nt">&lt;/string&gt;</span>

    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;card_error_values_not_available_title&quot;</span><span class="nt">&gt;</span>Some data for this area is not available.<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;card_error_values_not_available_body&quot;</span><span class="nt">&gt;</span>Some areas may be missing data in the ONS database; Scotland and Northern Ireland are not supported.<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;a11y_cd_areabase_icon&quot;</span><span class="nt">&gt;</span>The Areabase icon<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;error_police_api&quot;</span><span class="nt">&gt;</span>Could not fetch crime data<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;error_police_api_body&quot;</span><span class="nt">&gt;</span>Please try again later. The following might be helpful: %1$s<span class="nt">&lt;/string&gt;</span>

    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;title_activity_graph&quot;</span><span class="nt">&gt;</span>Graph View<span class="nt">&lt;/string&gt;</span>

    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;tab_graph&quot;</span><span class="nt">&gt;</span>Graph<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&quot;tab_legend&quot;</span><span class="nt">&gt;</span>Legend<span class="nt">&lt;/string&gt;</span>

<span class="nt">&lt;/resources&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/values/styles.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="nt">&lt;resources</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!--</span>
<span class="c">        Base application theme, dependent on API level. This theme is replaced</span>
<span class="c">        by AppBaseTheme from res/values-vXX/styles.xml on newer devices.</span>
<span class="c">    --&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&quot;AppBaseTheme&quot;</span> <span class="na">parent=</span><span class="s">&quot;android:Theme.Light&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!--</span>
<span class="c">            Theme customizations available in newer API levels can go in</span>
<span class="c">            res/values-vXX/styles.xml, while customizations related to</span>
<span class="c">            backward-compatibility can go here.</span>
<span class="c">        --&gt;</span>
    <span class="nt">&lt;/style&gt;</span>

    <span class="c">&lt;!-- Application theme. --&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&quot;AppTheme&quot;</span> <span class="na">parent=</span><span class="s">&quot;AppBaseTheme&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- All customizations that are NOT specific to a particular API-level can go here. --&gt;</span>
    <span class="nt">&lt;/style&gt;</span>

    <span class="nt">&lt;drawable</span> <span class="na">name=</span><span class="s">&quot;myTransparentDrawable&quot;</span><span class="nt">&gt;</span>#0000<span class="nt">&lt;/drawable&gt;</span>
    <span class="nt">&lt;drawable</span> <span class="na">name=</span><span class="s">&quot;mySemiTransparentDrawable&quot;</span><span class="nt">&gt;</span>#dfff<span class="nt">&lt;/drawable&gt;</span>

    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&quot;areabaseNavDrawerLink&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;item</span> <span class="na">name=</span><span class="s">&quot;android:typeface&quot;</span><span class="nt">&gt;</span>sans<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item</span> <span class="na">name=</span><span class="s">&quot;android:drawablePadding&quot;</span><span class="nt">&gt;</span>8dp<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item</span> <span class="na">name=</span><span class="s">&quot;android:textSize&quot;</span><span class="nt">&gt;</span>24sp<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item</span> <span class="na">name=</span><span class="s">&quot;android:gravity&quot;</span><span class="nt">&gt;</span>center_vertical<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item</span> <span class="na">name=</span><span class="s">&quot;android:textStyle&quot;</span><span class="nt">&gt;</span>normal<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item</span> <span class="na">name=</span><span class="s">&quot;android:textColor&quot;</span><span class="nt">&gt;</span>@android:color/primary_text_light<span class="nt">&lt;/item&gt;</span>
    <span class="nt">&lt;/style&gt;</span>

    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&quot;button_bar_button&quot;</span> <span class="na">parent=</span><span class="s">&quot;@android:style/Widget.Holo.Light.Button.Borderless.Small&quot;</span><span class="nt">&gt;&lt;/style&gt;</span>

    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&quot;button_bar&quot;</span> <span class="na">parent=</span><span class="s">&quot;@android:style/Holo.Light.ButtonBar&quot;</span><span class="nt">&gt;&lt;/style&gt;</span>

<span class="nt">&lt;/resources&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/values-sw600dp/dimens.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="nt">&lt;resources&gt;</span>

    <span class="c">&lt;!--</span>
<span class="c">         Customize dimensions originally defined in res/values/dimens.xml (such as</span>
<span class="c">         screen margins) for sw600dp devices (e.g. 7&quot; tablets) here.</span>
<span class="c">    --&gt;</span>
    <span class="nt">&lt;dimen</span> <span class="na">name=</span><span class="s">&quot;chart_view_height&quot;</span><span class="nt">&gt;</span>320dp<span class="nt">&lt;/dimen&gt;</span>

<span class="nt">&lt;/resources&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/values-sw720dp/dimens.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;resources&gt;</span>

    <span class="nt">&lt;dimen</span> <span class="na">name=</span><span class="s">&quot;nav_drawer_catsep_height&quot;</span><span class="nt">&gt;</span>32dp<span class="nt">&lt;/dimen&gt;</span>
    <span class="nt">&lt;dimen</span> <span class="na">name=</span><span class="s">&quot;nav_drawer_width&quot;</span><span class="nt">&gt;</span>350dp<span class="nt">&lt;/dimen&gt;</span>

<span class="nt">&lt;/resources&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/values-sw720dp-land/dimens.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="nt">&lt;resources&gt;</span>

    <span class="c">&lt;!--</span>
<span class="c">         Customize dimensions originally defined in res/values/dimens.xml (such as</span>
<span class="c">         screen margins) for sw720dp devices (e.g. 10&quot; tablets) in landscape here.</span>
<span class="c">    --&gt;</span>
    <span class="nt">&lt;dimen</span> <span class="na">name=</span><span class="s">&quot;activity_horizontal_margin&quot;</span><span class="nt">&gt;</span>128dp<span class="nt">&lt;/dimen&gt;</span>

<span class="nt">&lt;/resources&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/values-v14/styles.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="nt">&lt;resources</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!--</span>
<span class="c">        Base application theme for API 14+. This theme completely replaces</span>
<span class="c">        AppBaseTheme from BOTH res/values/styles.xml and</span>
<span class="c">        res/values-v11/styles.xml on API 14+ devices.</span>
<span class="c">    --&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&quot;AppBaseTheme&quot;</span> <span class="na">parent=</span><span class="s">&quot;android:Theme.Holo.Light&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- API 14 theme customizations can go here. --&gt;</span>
    <span class="nt">&lt;/style&gt;</span>

    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&quot;ButtonBarButton&quot;</span> <span class="na">parent=</span><span class="s">&quot;@android:style/Widget.Holo.Light.Button.Borderless.Small&quot;</span><span class="nt">&gt;&lt;/style&gt;</span>

    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&quot;ButtonBar&quot;</span> <span class="na">parent=</span><span class="s">&quot;@android:style/Holo.Light.ButtonBar&quot;</span><span class="nt">&gt;&lt;/style&gt;</span>

<span class="nt">&lt;/resources&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/values-w820dp/dimens.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="nt">&lt;resources&gt;</span>
    <span class="c">&lt;!-- Example customization of dimensions originally defined in res/values/dimens.xml</span>
<span class="c">         (such as screen margins) for screens with more than 820dp of available width. This</span>
<span class="c">         would include 7&quot; and 10&quot; devices in landscape (~960dp and ~1280dp respectively). --&gt;</span>
    <span class="nt">&lt;dimen</span> <span class="na">name=</span><span class="s">&quot;activity_horizontal_margin&quot;</span><span class="nt">&gt;</span>64dp<span class="nt">&lt;/dimen&gt;</span>
<span class="nt">&lt;/resources&gt;</span>
</pre></div>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading"><h3 class="panel-title">res/xml/preferences.xml</h3></div>
<div class="panel-body"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;PreferenceScreen</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="nt">&gt;</span>

    <span class="nt">&lt;PreferenceCategory</span>
        <span class="na">android:key=</span><span class="s">&quot;pref_category_location&quot;</span>
        <span class="na">android:title=</span><span class="s">&quot;@string/pref_category_location_heading&quot;</span> <span class="nt">&gt;</span>
        <span class="nt">&lt;CheckBoxPreference</span>
            <span class="na">android:key=</span><span class="s">&quot;pref_location_autolocate&quot;</span>
            <span class="na">android:summaryOff=</span><span class="s">&quot;@string/pref_category_location_autoLocate_infoText_disabled&quot;</span>
            <span class="na">android:summaryOn=</span><span class="s">&quot;@string/pref_category_location_autoLocate_infoText_enabled&quot;</span>
            <span class="na">android:title=</span><span class="s">&quot;@string/pref_category_location_autoLocate_primaryText&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;CheckBoxPreference</span>
            <span class="na">android:key=</span><span class="s">&quot;pref_location_backgroundlocate&quot;</span>
            <span class="na">android:summaryOff=</span><span class="s">&quot;@string/pref_category_location_backgroundRefix_infoText_disabled&quot;</span>
            <span class="na">android:summaryOn=</span><span class="s">&quot;@string/pref_category_location_backgroundRefix_infoText_enabled&quot;</span>
            <span class="na">android:title=</span><span class="s">&quot;@string/pref_category_location_backgroundRefix_primaryText&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/PreferenceCategory&gt;</span>

    <span class="nt">&lt;PreferenceCategory</span>
        <span class="na">android:key=</span><span class="s">&quot;pref_category_storage&quot;</span>
        <span class="na">android:title=</span><span class="s">&quot;Storage&quot;</span><span class="nt">&gt;</span>

        <span class="nt">&lt;Preference</span>
            <span class="na">android:key=</span><span class="s">&quot;pref_storage_remove_old_data&quot;</span>
            <span class="na">android:title=</span><span class="s">&quot;Clear old data&quot;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;Preference</span>
            <span class="na">android:key=</span><span class="s">&quot;pref_storage_reset_scores&quot;</span>
            <span class="na">android:title=</span><span class="s">&quot;Reset AreaRank scores&quot;</span>
            <span class="na">android:summary=</span><span class="s">&quot;This will reset all scores. Computing them again may take time.&quot;</span><span class="nt">/&gt;</span>

        <span class="nt">&lt;/PreferenceCategory&gt;</span>

    <span class="nt">&lt;PreferenceCategory</span>
        <span class="na">android:key=</span><span class="s">&quot;pref_category_testing&quot;</span>
        <span class="na">android:title=</span><span class="s">&quot;@string/pref_category_testing_heading&quot;</span> <span class="nt">&gt;</span>
        <span class="nt">&lt;CheckBoxPreference</span>
            <span class="na">android:key=</span><span class="s">&quot;pref_testing_phonehome&quot;</span>
            <span class="na">android:summaryOff=</span><span class="s">&quot;@string/pref_category_testing_phoneHome_infoText_disabled&quot;</span>
            <span class="na">android:summaryOn=</span><span class="s">&quot;@string/pref_category_testing_phoneHome_infoText_enabled&quot;</span>
            <span class="na">android:title=</span><span class="s">&quot;@string/pref_category_testing_phoneHome_primaryText&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/PreferenceCategory&gt;</span>

<span class="nt">&lt;/PreferenceScreen&gt;</span>
</pre></div>
</div>
</div>
<!-- END CODE BLOCK -->
                </div>
		</div>
		<hr />
		<div class="row">
		<footer class="col-xs-12">
                <a href="http://flamparski.github.io/areabase">Part of Areabase</a> &bull;
                Generated in 1293.000 ms by <code>generate_prettycode.py</code>.
		</footer>
		</div>
	</div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="./js/bootstrap.min.js"></script>
  </body>
</html>
